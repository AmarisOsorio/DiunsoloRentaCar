<<<<<<< HEAD
import*as e from"../../../core/platform/platform.js";import*as t from"../../../core/common/common.js";import*as n from"../types/types.js";let r=null;class i{#e=[];#t=[];static activate(e){r=e}static createAndActivate(e){const t=new i(e);return i.activate(t),t}static getActiveManager(){if(!r)throw new Error("Attempted to get a SyntheticEventsManager without initializing");return r}static reset(){r=null}static registerSyntheticEvent(e){try{return i.getActiveManager().registerSyntheticEvent(e)}catch{return e}}constructor(e){this.#t=e}registerSyntheticEvent(e){const t=this.#t.indexOf(e.rawSourceEvent);if(t<0)throw new Error("Attempted to register a synthetic event paired to an unknown raw event.");const n=e;return this.#e[t]=n,n}syntheticEventForRawEventIndex(e){const t=this.#e.at(e);if(!t)throw new Error(`Attempted to get a synthetic event from an unknown raw event index: ${e}`);return t}getSyntheticTraces(){return this.#e}getRawTraceEvents(){return this.#t}}var a=Object.freeze({__proto__:null,SyntheticEventsManager:i});const o=e=>n.Timing.Micro(1e3*e),s=e=>n.Timing.Milli(1e3*e),c=e=>n.Timing.Milli(e/1e3);function l(e){return{startTime:e.ts,endTime:e.ts+(e.dur??0),duration:e.dur||0}}function u(e,t){const n=e.ts;return n<=t.max&&t.min<=n+(e.dur??0)}var d=Object.freeze({__proto__:null,boundsIncludeTimeRange:function(e){const{min:t,max:n}=e.bounds,{min:r,max:i}=e.timeRange;return t<=i&&n>=r},eventIsInBounds:u,eventTimingsMicroSeconds:l,eventTimingsMilliSeconds:function(e){return{startTime:e.ts/1e3,endTime:(e.ts+(e.dur??0))/1e3,duration:(e.dur||0)/1e3}},expandWindowByPercentOrToOneMillisecond:function(e,t,r){let i=e.min-e.range*(r/100)/2,a=e.max+e.range*(r/100)/2;if(a-i<1e3){const t=(e.min+e.max)/2;i=t-500,a=t+500}return i=Math.max(i,t.min),a=Math.min(a,t.max),{min:n.Timing.Micro(i),max:n.Timing.Micro(a),range:n.Timing.Micro(a-i)}},microToMilli:c,microToSeconds:e=>n.Timing.Seconds(e/1e3/1e3),milliToMicro:o,secondsToMicro:e=>o(s(e)),secondsToMilli:s,timeStampForEventAdjustedByClosestNavigation:function(e,t,r,i){let a=e.ts-t.min;if(e.args?.data?.navigationId){const t=r.get(e.args.data.navigationId);t&&(a=e.ts-t.ts)}else if(e.args?.data?.frame){const t=g(e,e.args.data.frame,i);t&&(a=e.ts-t.ts)}return n.Timing.Micro(a)},timestampIsInBounds:function(e,t){return t>=e.min&&t<=e.max},traceWindowFromEvent:function(e){return{min:e.ts,max:n.Timing.Micro(e.ts+(e.dur??0)),range:e.dur??n.Timing.Micro(0)}},traceWindowFromMicroSeconds:function(e,t){return{min:e,max:t,range:n.Timing.Micro(t-e)}},traceWindowFromMilliSeconds:function(e,t){return{min:o(e),max:o(t),range:n.Timing.Micro(o(t)-o(e))}},traceWindowMicroSecondsToMilliSeconds:function(e){return{min:c(e.min),max:c(e.max),range:c(e.range)}},traceWindowMilliSeconds:function(e){return{min:c(e.min),max:c(e.max),range:c(e.range)}},windowFitsInsideBounds:function(e){return e.window.min>=e.bounds.min&&e.window.max<=e.bounds.max},windowsEqual:function(e,t){return e.min===t.min&&e.max===t.max}});function m(e){if(e.args?.data?.stackTrace)return e.args.data.stackTrace;if(e.args?.stackTrace)return e.args.stackTrace;if(n.Events.isUpdateLayoutTree(e))return e.args.beginData?.stackTrace||null;if(n.Events.isLayout(e))return e.args.beginData.stackTrace??null;if(n.Events.isFunctionCall(e)){const t=e.args.data;if(!t)return null;const{columnNumber:n,lineNumber:r,url:i,scriptId:a,functionName:o}=t;return void 0===r||void 0===o||void 0===n||void 0===a||void 0===i?null:[{columnNumber:n,lineNumber:r,url:i,scriptId:a,functionName:o}]}if(n.Events.isProfileCall(e)){const t=e.callFrame;if(!t)return null;const{columnNumber:n,lineNumber:r,url:i,scriptId:a,functionName:o}=t;return void 0===r||void 0===o||void 0===n||void 0===a||void 0===i?null:[{columnNumber:n,lineNumber:r,url:i,scriptId:a,functionName:o}]}return null}function h(e,t){const r=e.ts,i=t.ts;if(r<i)return-1;if(r>i)return 1;const a=r+(e.dur??0),o=i+(t.dur??0);return a>o?-1:a<o?1:n.Events.isProfileCall(e)&&!n.Events.isProfileCall(t)?-1:n.Events.isProfileCall(t)&&!n.Events.isProfileCall(e)?1:0}function f(e){e.sort(h)}function p(e,t){const n=[];let r=0,i=0;for(;r<e.length&&i<t.length;){const a=e[r],o=t[i],s=h(a,o);s<=0&&(n.push(a),r++),1===s&&(n.push(o),i++)}for(;r<e.length;)n.push(e[r++]);for(;i<t.length;)n.push(t[i++]);return n}function g(t,n,r){const i=r.get(n);if(!i||""===n)return null;const a=e.ArrayUtilities.nearestIndexFromEnd(i,(e=>e.ts<=t.ts));return null===a?null:i[a]}function v(e){return e.id??e.id2?.global??e.id2?.local}function S(e,t,r,i,a,o){return{cat:"",name:"ProfileCall",nodeId:e.id,args:{},ph:"X",pid:a,tid:o,ts:i,dur:n.Timing.Micro(0),callFrame:e.callFrame,sampleIndex:r,profileId:t}}function T(t){const n=new Map;for(const r of t){const t=k(r);if(void 0===t)continue;const i=e.MapUtilities.getWithDefault(n,t,(()=>({begin:null,end:null,instant:[]}))),a="b"===r.ph,o="e"===r.ph,s="n"===r.ph;a?i.begin=r:o?i.end=r:s&&(i.instant||(i.instant=[]),i.instant.push(r))}return n}function k(e){const t=v(e);return t&&`${e.cat}:${t}:${e.name}`}function E(e,t){const r=[];for(const[a,o]of e.entries()){const s=o.begin,c=o.end,l=o.instant;if(!s||!c&&!l)continue;const u={beginEvent:s,endEvent:c,instantEvents:l};function d(e){const t=!!e.instantEvents&&e.instantEvents.some((e=>a===k(e))),n=!!e.endEvent&&a===k(e.endEvent);return Boolean(a)&&(t||n)}if(!d(u))continue;const m=c||s,h=i.registerSyntheticEvent({rawSourceEvent:u.beginEvent,cat:m.cat,ph:m.ph,pid:m.pid,tid:m.tid,id:a,name:s.name,dur:n.Timing.Micro(m.ts-s.ts),ts:s.ts,args:{data:u}});h.dur<0||(t?.(h),r.push(h))}return r.sort(((e,t)=>e.ts-t.ts))}function y(e){const t={...e};return t.lineNumber=e.lineNumber&&e.lineNumber-1,t.columnNumber=e.columnNumber&&e.columnNumber-1,t}function b(e){return"JSRoot"===e.name&&"toplevel"===e.cat||e.cat.includes("disabled-by-default-devtools.timeline")&&"RunTask"===e.name}function I(t,n){let r=e.ArrayUtilities.upperBound(t,n,((e,t)=>e-t.ts))-1;for(;r>0&&!b(t[r]);)r--;return Math.max(r,0)}const M=new Map;function C(e){if(!e.args)return null;if("beginData"in e.args){return e.args.beginData.sampleTraceId??null}return e.args?.sampleTraceId??e.args?.data?.sampleTraceId??null}const w=new Set(["AbortPostTaskCallback","Animation","AsyncTask","v8.deserializeOnBackground","BeginFrame","BeginMainThreadFrame","v8.produceModuleCache","v8.produceCache","CancelAnimationFrame","CancelIdleCallback","v8.compile","V8.CompileCode","V8.CompileModule","Commit","CompositeLayers","ComputeIntersections","ConsoleTime","TimeStamp","CppGC.IncrementalSweep","DoDecrypt","DoDecryptReply","DoDigest","DoDigestReply","DoEncrypt","DoEncryptReply","DoSign","DoSignReply","DoVerify","DoVerifyReply","Decode Image","DrawFrame","EmbedderCallback","v8.evaluateModule","EvaluateScript","EventDispatch","EventTiming","V8.FinalizeDeserialization","FireAnimationFrame","FireIdleCallback","FrameStartedLoading","FunctionCall","GCEvent","BlinkGC.AtomicPhase","GPUTask","HandlePostMessage","HitTest","InvalidateLayout","JSSample","Layerize","Layout","LayoutShift","MajorGC","MarkDOMContent","firstPaint","firstContentfulPaint","largestContentfulPaint::Candidate","MarkLoad","MinorGC","V8.OptimizeCode","Paint","PaintImage","PaintSetup","ParseAuthorStyleSheet","ParseHTML","PrePaint","ProfileCall","Program","RasterTask","RequestAnimationFrame","RequestIdleCallback","RequestMainThreadFrame","ResourceFinish","ResourceReceivedData","ResourceReceiveResponse","ResourceSendRequest","ResourceWillSendRequest","RunMicrotasks","RunPostTaskCallback","RunTask","SchedulePostMessage","SchedulePostTaskCallback","ScheduleStyleRecalculation","ScrollLayer","CpuProfiler::StartProfiling","v8.parseOnBackground","v8.parseOnBackgroundParsing","v8.parseOnBackgroundWaiting","SyntheticLayoutShift","SyntheticLayoutShiftCluster","TimerFire","TimerInstall","TimerRemove","UpdateLayer","UpdateLayerTree","UpdateLayoutTree","UserTiming","V8Console::runTask","v8.wasm.cachedModule","v8.wasm.compiledModule","v8.wasm.moduleCacheHit","v8.wasm.moduleCacheInvalid","v8.wasm.streamFromResponseCallback","WebSocketCreate","WebSocketDestroy","WebSocketReceive","WebSocketReceiveHandshakeResponse","WebSocketSend","WebSocketSendHandshakeRequest","XHRLoad","XHRReadyStateChange"]);var N=Object.freeze({__proto__:null,VISIBLE_TRACE_EVENT_TYPES:w,activeURLForFrameAtTime:function(e,t,n){const r=n.get(e);if(!r)return null;for(const e of r.values())for(const n of e)if(!(n.window.min>t||n.window.max<t))return n.frame.url;return null},addEventToProcessThread:function(e,t){const{tid:n,pid:r}=e;let i=t.get(r);i||(i=new Map);let a=i.get(n);a||(a=[]),a.push(e),i.set(e.tid,a),t.set(e.pid,i)},createMatchedSortedSyntheticEvents:function(e,t){return E(T(e),t)},createSortedSyntheticEvents:E,eventContainsTimestamp:function(e,t){return e.ts<=t&&e.ts+(e.dur||0)>=t},eventHasCategory:function(e,t){let n=M.get(e.cat);return n||(n=new Set(e.cat.split(",")||[])),n.has(t)},eventTimeComparator:h,extractId:v,extractOriginFromTrace:function(e){const n=t.ParsedURL.ParsedURL.fromString(e);return n?n.host.startsWith("www.")?n.host.slice(4):n.host:null},extractSampleTraceId:C,findNextEventAfterTimestamp:function(t,n){const r=e.ArrayUtilities.nearestIndexFromBeginning(t,(e=>n<e.ts));return null===r?null:t[r]},findPreviousEventBeforeTimestamp:function(t,n){const r=e.ArrayUtilities.nearestIndexFromEnd(t,(e=>e.ts<n));return null===r?null:t[r]},findUpdateLayoutTreeEvents:function(e,t,r){const i=[];for(let a=I(e,t);a<e.length;a++){const t=e[a];n.Events.isUpdateLayoutTree(t)&&(t.ts>=(r||1/0)||i.push(t))}return i},forEachEvent:function(e,t){const r=t.startTime??n.Timing.Micro(0),i=t.endTime||n.Timing.Micro(1/0),a=!1!==t.ignoreAsyncEvents,o=[];for(let s=I(e,r);s<e.length;s++){const c=e[s],u=l(c);if(u.endTime<r)continue;if(u.startTime>i)break;if(a&&n.Events.isPhaseAsync(c.ph)||n.Events.isFlowPhase(c.ph))continue;let d=o.at(-1),m=d?l(d).endTime:null;for(;d&&m&&m<=u.startTime;)o.pop(),t.onEndEvent(d),d=o.at(-1),m=d?l(d).endTime:null;t.eventFilter&&!t.eventFilter(c)||(u.duration?(t.onStartEvent(c),o.push(c)):t.onInstantEvent&&t.onInstantEvent(c))}for(;o.length;){const e=o.pop();e&&t.onEndEvent(e)}},frameIDForEvent:function(e){return e.args&&"beginData"in e.args&&"object"==typeof e.args.beginData&&null!==e.args.beginData&&"frame"in e.args.beginData&&"string"==typeof e.args.beginData.frame?e.args.beginData.frame:e.args?.data?.frame?e.args.data.frame:null},getNavigationForTraceEvent:g,getZeroIndexedLineAndColumnForEvent:function(e){const t=function(e){if(!e.args?.data)return{lineNumber:void 0,columnNumber:void 0};let t,n;"lineNumber"in e.args.data&&"number"==typeof e.args.data.lineNumber&&(t=e.args.data.lineNumber);"columnNumber"in e.args.data&&"number"==typeof e.args.data.columnNumber&&(n=e.args.data.columnNumber);return{lineNumber:t,columnNumber:n}}(e),{lineNumber:n,columnNumber:r}=t;switch(e.name){case"FunctionCall":case"EvaluateScript":case"v8.compile":case"v8.produceCache":return{lineNumber:"number"==typeof n?n-1:void 0,columnNumber:"number"==typeof r?r-1:void 0};case"ProfileCall":{const t=e.callFrame;return{lineNumber:"number"==typeof n?t.lineNumber-1:void 0,columnNumber:"number"==typeof r?t.columnNumber-1:void 0}}default:return t}},getZeroIndexedStackTraceForEvent:function(e){const t=m(e);return t?t.map((t=>{switch(e.name){case"ScheduleStyleRecalculation":case"InvalidateLayout":case"FunctionCall":case"Layout":case"UpdateLayoutTree":return y(t);default:if(n.Events.isUserTiming(e)||n.Extensions.isSyntheticExtensionEntry(e))return y(t)}return t})):null},isMatchingCallFrame:function(e,t){return e.columnNumber===t.columnNumber&&e.lineNumber===t.lineNumber&&String(e.scriptId)===t.scriptId&&e.url===t.url&&e.functionName===t.functionName},isTopLevelEvent:b,makeProfileCall:S,makeZeroBasedCallFrame:y,matchEvents:T,mergeEventsInOrder:p,sortTraceEventsInPlace:f,stackTraceInEvent:m});let F=0;const P=()=>++F,x=()=>({roots:new Set,maxDepth:0}),R=(e,t)=>({entry:e,id:t,parent:null,children:[],depth:0});function D(e,t){const r=new Map,i=[];F=-1;const a=x();for(let o=0;o<e.length;o++){const s=e[o];if(t&&!t.filter.has(s.name))continue;const c=s.dur||0,l=P(),u=R(s,l);if(0===i.length){a.roots.add(u),u.selfTime=n.Timing.Micro(c),i.push(u),a.maxDepth=Math.max(a.maxDepth,i.length),r.set(s,u);continue}const d=i.at(-1);if(void 0===d)throw new Error("Impossible: no parent node found in the stack");const m=d.entry,h=s.ts,f=m.ts,p=h+c,g=f+(m.dur||0);if(h<f)throw new Error("Impossible: current event starts before the parent event");if(h>=g){i.pop(),o--,F--;continue}p>g||(u.depth=i.length,u.parent=d,d.children.push(u),u.selfTime=n.Timing.Micro(c),void 0!==d.selfTime&&(d.selfTime=n.Timing.Micro(d.selfTime-(s.dur||0))),i.push(u),a.maxDepth=Math.max(a.maxDepth,i.length),r.set(s,u))}return{tree:a,entryToNode:r}}function J(e,t,r,i,a,o){if(!a||(s=a,u(t.entry,s))){var s;if(void 0!==o){if(n.Timing.Micro(t.entry.ts+n.Timing.Micro(t.entry.dur??0))<o)return}r(t.entry);for(const n of t.children)J(e,n,r,i,a,o);i(t.entry)}}function _(e){const t=[];for(const n of e){const e=n.ts,r=n.ts+(n.dur??0);let i=t.at(-1);if(void 0===i){t.push(n);continue}let a=i.ts+(i.dur??0);for(;t.length&&e>=a&&(t.pop(),i=t.at(-1),void 0!==i);)a=i.ts+(i.dur??0);if(t.length&&r>a)return!1;t.push(n)}return!0}var A=Object.freeze({__proto__:null,canBuildTreesFromEvents:_,makeEmptyTraceEntryNode:R,makeEmptyTraceEntryTree:x,makeTraceEntryNodeId:P,treify:D,walkEntireTree:function(e,t,n,r,i,a){for(const o of t.roots)J(e,o,n,r,i,a)},walkTreeFromEntry:function(e,t,n,r){const i=e.get(t);i&&J(e,i,n,r)}});var B=Object.freeze({__proto__:null,buildTrackDataFromExtensionEntries:function(t,n,r){const i=new Map;for(const n of t){const t=n.args.trackGroup||`track-name-${n.args.track}`,r=e.MapUtilities.getWithDefault(i,t,(()=>({name:n.args.trackGroup||n.args.track,isTrackGroup:Boolean(n.args.trackGroup),entriesByTrack:{[n.args.track]:[]}})));r.entriesByTrack[n.args.track]||(r.entriesByTrack[n.args.track]=[]);r.entriesByTrack[n.args.track].push(n)}for(const e of i.values()){for(const t of Object.values(e.entriesByTrack))if(f(t),_(t))for(const[e,n]of D(t).entryToNode)r.set(e,n);n.push(e)}return{extensionTrackData:n,entryToNode:r}}});const L=new Set(["non_blocking","dynamically_injected_non_blocking","potentially_blocking"]);const O=new Set(["VeryHigh","High","Medium"]);const U=new Set([200,203,206]),W=new Set(["Font","Image","Media","Script","Stylesheet"]);const j=["localhost","127.0.0.1"];var G=Object.freeze({__proto__:null,CACHEABLE_STATUS_CODES:U,NON_NETWORK_SCHEMES:["blob","data","intent","file","filesystem","chrome-extension"],STATIC_RESOURCE_TYPES:W,isSyntheticNetworkRequestEventRenderBlocking:function(e){return!L.has(e.args.data.renderBlocking)},isSyntheticNetworkRequestHighPriority:function(e){return O.has(e.args.data.priority)},isSyntheticNetworkRequestLocalhost:function(e){try{const t=new URL(e.args.data.url).hostname;return j.includes(t)||t.endsWith(".localhost")}catch{return!1}},parseCacheControl:function(e){if(!e)return null;const t=e.split(",").map((e=>e.trim())),n={};for(const e of t){const[t,r]=e.split("=").map((e=>e.trim()));switch(t){case"max-age":{const e=parseInt(r,10);isNaN(e)||(n["max-age"]=e);break}case"no-cache":n["no-cache"]=!0;break;case"no-store":n["no-store"]=!0;break;case"must-revalidate":n["must-revalidate"]=!0;break;case"private":n.private=!0}}return n}});var H=Object.freeze({__proto__:null,SamplesIntegrator:class e{#n=[];#r=[];#i;#a;#o=[];#s=!1;#c;#l=new Map;#u;#d;jsSampleEvents=[];constructor(e,t,r,i,a){this.#c=e,this.#a=i,this.#i=r,this.#u=a||n.Configuration.defaults(),this.#d=t}buildProfileCalls(e){const t=p(e,this.callsFromProfileSamples()),r=[];for(let e=0;e<t.length;e++){const i=t[e];if("I"===i.ph&&!C(i))continue;if(0===r.length){if(n.Events.isProfileCall(i)){this.#m(i);continue}r.push(i),this.#h(i);continue}const a=r.at(-1);if(void 0===a)continue;i.ts>=a.ts+(a.dur||0)?(this.#f(a),r.pop(),e--):n.Events.isProfileCall(i)?this.#m(i,a):(this.#h(i),r.push(i))}for(;r.length;){const e=r.pop();e&&this.#f(e)}return f(this.jsSampleEvents),this.#n}#h(e){"RunMicrotasks"!==e.name&&"RunTask"!==e.name||(this.#o=[],this.#p(0,e.ts),this.#s=!1),this.#s&&(this.#p(this.#o.pop()||0,e.ts),this.#s=!1),this.#g(e),this.#o.push(this.#r.length)}#m(e,t){if(t&&n.Events.isJSInvocationEvent(t)||this.#s)this.#g(e);else if(n.Events.isProfileCall(e)&&0===this.#r.length){this.#s=!0;const t=this.#r.length;this.#g(e),this.#o.push(t)}}#f(e){const t=n.Timing.Micro(e.ts+(e.dur??0));this.#p(this.#o.pop()||0,t)}callsFromProfileSamples(){const e=this.#c.samples,t=this.#c.timestamps;if(!e)return[];const r=[];let i;for(let a=0;a<e.length;a++){const e=this.#c.nodeByIndex(a),s=o(n.Timing.Milli(t[a]));if(!e)continue;const c=S(e,this.#d,a,s,this.#i,this.#a);if(r.push(c),this.#u.debugMode){const e=this.#c.traceIds?.[a];this.jsSampleEvents.push(this.#v(c,s,e))}e.id===this.#c.gcNode?.id&&i?this.#l.set(c,i):i=e}return r}#S(e,t){let n=this.#c.nodeById(e.nodeId);const r=n?.id===this.#c.gcNode?.id;if(r&&(n=this.#l.get(e)||null),!n)return[];const i=new Array(n.depth+1+Number(r));let a=i.length-1;for(r&&(i[a--]=e);n;)i[a--]=S(n,e.profileId,e.sampleIndex,t??e.ts,this.#i,this.#a),n=n.parent;return i}#T(e,t){const n=this.#c.traceIds?.[e],r=n&&this.#c.nodeById(n),i=r&&S(r,this.#d,-1,t,this.#i,this.#a);return i?(this.#u.debugMode&&this.jsSampleEvents.push(this.#v(i,t,e)),this.#S(i)):null}#g(t){let r=this.#r;n.Events.isProfileCall(t)&&(r=this.#S(t));const i=C(t),a=i&&this.#T(i,t.ts);a&&(r=a),e.filterStackFrames(r,this.#u);const o=t.ts+(t.dur||0),s=Math.min(r.length,this.#r.length);let c;for(c=this.#o.at(-1)||0;c<s;++c){const t=r[c].callFrame,i=this.#r[c].callFrame;if(!e.framesAreEqual(t,i))break;this.#r[c].dur=n.Timing.Micro(Math.max(this.#r[c].dur||0,o-this.#r[c].ts))}for(this.#p(c,t.ts);c<r.length;++c){const e=r[c];e.nodeId!==this.#c.programNode?.id&&e.nodeId!==this.#c.root?.id&&e.nodeId!==this.#c.idleNode?.id&&e.nodeId!==this.#c.gcNode?.id&&(this.#r.push(e),this.#n.push(e))}}#p(e,t){if(this.#o.length){const n=this.#o.at(-1);n&&e<n&&(console.error(`Child stack is shallower (${e}) than the parent stack (${n}) at ${t}`),e=n)}this.#r.length<e&&(console.error(`Trying to truncate higher than the current stack size at ${t}`),e=this.#r.length);for(let e=0;e<this.#r.length;++e)this.#r[e].dur=n.Timing.Micro(Math.max(t-this.#r[e].ts,0));this.#r.length=e}#v(e,t,r){return{name:"JSSample",cat:"devtools.timeline",args:{data:{traceId:r,stackTrace:this.#S(e).map((e=>e.callFrame))}},ph:"I",ts:t,dur:n.Timing.Micro(0),pid:this.#i,tid:this.#a}}static framesAreEqual(e,t){return e.scriptId===t.scriptId&&e.functionName===t.functionName&&e.lineNumber===t.lineNumber}static showNativeName(t,n){return n&&Boolean(e.nativeGroup(t))}static nativeGroup(e){return e.startsWith("Parse")?"Parse":e.startsWith("Compile")||e.startsWith("Recompile")?"Compile":null}static isNativeRuntimeFrame(e){return"native V8Runtime"===e.url}static filterStackFrames(t,n){if(n.showAllEvents)return;let r=null,i=0;for(let a=0;a<t.length;++a){const o=t[a].callFrame,s=e.isNativeRuntimeFrame(o);if(s&&!e.showNativeName(o.functionName,n.includeRuntimeCallStats))continue;const c=s?e.nativeGroup(o.functionName):null;r&&r===c||(r=c,t[i++]=t[a])}t.length=i}static createFakeTraceFromCpuProfile(e,t){const r=[],i=`Thread ${t}`;return a("TracingStartedInPage",{data:{sessionId:"1"}},0,0,"M"),a("thread_name",{name:i},0,0,"M","__metadata"),e?(a("JSRoot",{},e.startTime,e.endTime-e.startTime,"X","toplevel"),a("CpuProfile",{data:{cpuProfile:e}},e.endTime,0,"X"),{traceEvents:r,metadata:{dataOrigin:"CPUProfile"}}):{traceEvents:r,metadata:{}};function a(e,i,a,o,s,c){const l={cat:c||"disabled-by-default-devtools.timeline",name:e,ph:s||"X",pid:n.Events.ProcessID(1),tid:t,ts:n.Timing.Micro(a),args:i};return o&&(l.dur=n.Timing.Micro(o)),r.push(l),l}}}});export{B as Extensions,G as Network,H as SamplesIntegrator,a as SyntheticEvents,d as Timing,N as Trace,A as TreeHelpers};
=======
import*as t from"../../../core/platform/platform.js";import*as e from"../../../core/common/common.js";import*as n from"../types/types.js";const r=[],i=new Map;let o=null;class s{#t=[];#e=[];static initAndActivate(t){const e=i.get(t);if(e)o=e;else{const e=new s(t);i.set(t,e),o=e}return o}static getActiveManager(){if(!o)throw new Error("Attempted to get a SyntheticEventsManager without initializing");return o}static reset(){r.length=0,o=null}static registerSyntheticBasedEvent(t){try{return s.getActiveManager().registerSyntheticBasedEvent(t)}catch(e){return t}}constructor(t){this.#e=t}registerSyntheticBasedEvent(t){const e=this.#e.indexOf(t.rawSourceEvent);if(e<0)throw new Error("Attempted to register a synthetic event paired to an unknown raw event.");const n=t;return this.#t[e]=n,n}syntheticEventForRawEventIndex(t){const e=this.#t.at(t);if(!e)throw new Error(`Attempted to get a synthetic event from an unknown raw event index: ${t}`);return e}getSyntheticTraceEvents(){return this.#t}getRawTraceEvents(){return this.#e}}var a=Object.freeze({__proto__:null,SyntheticEventsManager:s});const c=t=>n.Timing.MicroSeconds(1e3*t),l=t=>n.Timing.MilliSeconds(1e3*t),u=t=>n.Timing.MilliSeconds(t/1e3),d=t=>n.Timing.Seconds(t/1e3/1e3);function m(t){return{startTime:t.ts,endTime:n.Timing.MicroSeconds(t.ts+(t.dur||n.Timing.MicroSeconds(0))),duration:n.Timing.MicroSeconds(t.dur||0),selfTime:n.TraceEvents.isSyntheticTraceEntry(t)?n.Timing.MicroSeconds(t.selfTime||0):n.Timing.MicroSeconds(t.dur||0)}}var h=Object.freeze({__proto__:null,millisecondsToMicroseconds:c,secondsToMilliseconds:l,secondsToMicroseconds:t=>c(l(t)),microSecondsToMilliseconds:u,microSecondsToSeconds:d,timeStampForEventAdjustedByClosestNavigation:function(t,e,r,i){let o=t.ts-e.min;if(t.args?.data?.navigationId){const e=r.get(t.args.data.navigationId);e&&(o=t.ts-e.ts)}else if(t.args?.data?.frame){const e=S(t,t.args.data.frame,i);e&&(o=t.ts-e.ts)}return n.Timing.MicroSeconds(o)},eventTimingsMicroSeconds:m,eventTimingsMilliSeconds:function(t){const e=m(t);return{startTime:u(e.startTime),endTime:u(e.endTime),duration:u(e.duration),selfTime:u(e.selfTime)}},eventTimingsSeconds:function(t){const e=m(t);return{startTime:d(e.startTime),endTime:d(e.endTime),duration:d(e.duration),selfTime:d(e.selfTime)}},traceWindowMilliSeconds:function(t){return{min:u(t.min),max:u(t.max),range:u(t.range)}},traceWindowMillisecondsToMicroSeconds:function(t){return{min:c(t.min),max:c(t.max),range:c(t.range)}},traceWindowFromMilliSeconds:function(t,e){return{min:c(t),max:c(e),range:n.Timing.MicroSeconds(c(e)-c(t))}},traceWindowFromMicroSeconds:function(t,e){return{min:t,max:e,range:n.Timing.MicroSeconds(e-t)}},boundsIncludeTimeRange:function(t){const{min:e,max:n}=t.bounds,{min:r,max:i}=t.timeRange;return e<=i&&n>=r},timestampIsInBounds:function(t,e){return e>=t.min&&e<=t.max}});function f(t,e){const n=t.ts,r=e.ts;if(n<r)return-1;if(n>r)return 1;const i=n+(t.dur??0),o=r+(e.dur??0);return i>o?-1:i<o?1:0}function g(t){t.sort(f)}function p(t,e){const n=[];let r=0,i=0;for(;r<t.length&&i<e.length;){const o=t[r],s=e[i],a=f(o,s);a<=0&&(n.push(o),r++),1===a&&(n.push(s),i++)}for(;r<t.length;)n.push(t[r++]);for(;i<e.length;)n.push(e[i++]);return n}function S(e,n,r){const i=r.get(n);if(!i||""===n)return null;const o=t.ArrayUtilities.nearestIndexFromEnd(i,(t=>t.ts<=e.ts));return null===o?null:i[o]}function v(t){return t.id??t.id2?.global??t.id2?.local}function T(t,e,r,i,o,s){return{cat:"",name:"ProfileCall",nodeId:t.id,args:{},ph:"X",pid:o,tid:s,ts:i,dur:n.Timing.MicroSeconds(0),selfTime:n.Timing.MicroSeconds(0),callFrame:t.callFrame,sampleIndex:r,profileId:e}}function k(e){const n=new Map;for(const r of e){const e=E(r);if(void 0===e)continue;const i=t.MapUtilities.getWithDefault(n,e,(()=>({begin:null,end:null,instant:[]}))),o="b"===r.ph,s="e"===r.ph,a="n"===r.ph;o?i.begin=r:s?i.end=r:a&&(i.instant||(i.instant=[]),i.instant.push(r))}return n}function E(t){const e=v(t);return e&&`${t.cat}:${e}:${t.name}`}function M(t,e){const r=[];for(const[o,a]of t.entries()){const c=a.begin,l=a.end,u=a.instant;if(!c||!l&&!u)continue;const d={beginEvent:c,endEvent:l,instantEvents:u};function i(t){const e=!!t.instantEvents&&t.instantEvents.some((t=>o===E(t))),n=!!t.endEvent&&o===E(t.endEvent);return Boolean(o)&&(e||n)}if(!i(d))continue;const m=l||c,h=s.registerSyntheticBasedEvent({rawSourceEvent:c,cat:m.cat,ph:m.ph,pid:m.pid,tid:m.tid,id:o,name:c.name,dur:n.Timing.MicroSeconds(m.ts-c.ts),ts:c.ts,args:{data:d}});h.dur<0||(e?.(h),r.push(h))}return r.sort(((t,e)=>t.ts-e.ts))}const y="disabled-by-default-devtools.timeline";function b(t){return"JSRoot"===t.name&&"toplevel"===t.cat||t.cat.includes(y)&&"RunTask"===t.name}function I(e,n){let r=t.ArrayUtilities.upperBound(e,n,((t,e)=>t-e.ts))-1;for(;r>0&&!b(e[r]);)r--;return Math.max(r,0)}const w=new Map;var N=Object.freeze({__proto__:null,extractOriginFromTrace:function(t){const n=e.ParsedURL.ParsedURL.fromString(t);return n?n.host.startsWith("www.")?n.host.slice(4):n.host:null},addEventToProcessThread:function(t,e){const{tid:n,pid:r}=t;let i=e.get(r);i||(i=new Map);let o=i.get(n);o||(o=[]),o.push(t),i.set(t.tid,o),e.set(t.pid,i)},eventTimeComparator:f,sortTraceEventsInPlace:g,mergeEventsInOrder:p,getNavigationForTraceEvent:S,extractId:v,activeURLForFrameAtTime:function(t,e,n){const r=n.get(t);if(!r)return null;for(const t of r.values())for(const n of t)if(!(n.window.min>e||n.window.max<e))return n.frame.url;return null},makeProfileCall:T,makeSyntheticTraceEntry:function(t,e,r,i){return{cat:"",name:t,args:{},ph:"X",pid:r,tid:i,ts:e,dur:n.Timing.MicroSeconds(0),selfTime:n.Timing.MicroSeconds(0)}},matchEvents:k,createSortedSyntheticEvents:M,createMatchedSortedSyntheticEvents:function(t,e){return M(k(t),e)},getZeroIndexedLineAndColumnForEvent:function(t){const e=function(t){if(!t.args?.data)return{lineNumber:void 0,columnNumber:void 0};let e,n;"lineNumber"in t.args.data&&"number"==typeof t.args.data.lineNumber&&(e=t.args.data.lineNumber);"columnNumber"in t.args.data&&"number"==typeof t.args.data.columnNumber&&(n=t.args.data.columnNumber);return{lineNumber:e,columnNumber:n}}(t),{lineNumber:n,columnNumber:r}=e;switch(t.name){case"FunctionCall":case"EvaluateScript":case"v8.compile":case"v8.produceCache":return{lineNumber:"number"==typeof n?n-1:void 0,columnNumber:"number"==typeof r?r-1:void 0};default:return e}},getZeroIndexedStackTraceForEvent:function(t){const e=function(t){return t.args?.data?.stackTrace?t.args.data.stackTrace:n.TraceEvents.isTraceEventUpdateLayoutTree(t)&&t.args.beginData?.stackTrace||null}(t);return e?e.map((e=>{const n={...e};switch(t.name){case"ScheduleStyleRecalculation":case"InvalidateLayout":case"UpdateLayoutTree":n.lineNumber=e.lineNumber&&e.lineNumber-1,n.columnNumber=e.columnNumber&&e.columnNumber-1}return n})):null},frameIDForEvent:function(t){return t.args&&"beginData"in t.args&&"object"==typeof t.args.beginData&&null!==t.args.beginData&&"frame"in t.args.beginData&&"string"==typeof t.args.beginData.frame?t.args.beginData.frame:t.args?.data?.frame?t.args.data.frame:null},isTopLevelEvent:b,findUpdateLayoutTreeEvents:function(t,e,r){const i=[];for(let o=I(t,e);o<t.length;o++){const e=t[o];n.TraceEvents.isTraceEventUpdateLayoutTree(e)&&(e.ts>=(r||1/0)||i.push(e))}return i},forEachEvent:function(t,e){const r=e.startTime||n.Timing.MicroSeconds(0),i=e.endTime||n.Timing.MicroSeconds(1/0),o=!1!==e.ignoreAsyncEvents,s=[];for(let a=I(t,r);a<t.length;a++){const c=t[a],l=m(c);if(l.endTime<r)continue;if(l.startTime>i)break;if(o&&n.TraceEvents.isAsyncPhase(c.ph)||n.TraceEvents.isFlowPhase(c.ph))continue;let u=s.at(-1),d=u?m(u).endTime:null;for(;u&&d&&d<=l.startTime;)s.pop(),e.onEndEvent(u),u=s.at(-1),d=u?m(u).endTime:null;e.eventFilter&&!e.eventFilter(c)||(l.duration?(e.onStartEvent(c),s.push(c)):e.onInstantEvent&&e.onInstantEvent(c))}for(;s.length;){const t=s.pop();t&&e.onEndEvent(t)}},eventHasCategory:function(t,e){let n=w.get(t.cat);return n||(n=new Set(t.cat.split(",")||[])),n.has(e)},nodeIdForInvalidationEvent:function(t){return t.args.data.nodeId??null}});let J=0;const x=()=>++J,F=()=>({roots:new Set,maxDepth:0}),C=(t,e)=>({entry:t,id:e,parent:null,children:[],depth:0});function _(t,e){const r=new Map,i=[];J=-1;const o=F();for(let s=0;s<t.length;s++){const a=t[s];if(e&&!e.filter.has(a.name))continue;const c=a.dur||0,l=x(),u=C(a,l);if(0===i.length){o.roots.add(u),a.selfTime=n.Timing.MicroSeconds(c),i.push(u),o.maxDepth=Math.max(o.maxDepth,i.length),r.set(a,u);continue}const d=i.at(-1);if(void 0===d)throw new Error("Impossible: no parent node found in the stack");const m=d.entry,h=a.ts,f=m.ts,g=h+c,p=f+(m.dur||0);if(h<f)throw new Error("Impossible: current event starts before the parent event");if(h>=p){i.pop(),s--,J--;continue}g>p||(u.depth=i.length,u.parent=d,d.children.push(u),a.selfTime=n.Timing.MicroSeconds(c),void 0!==m.selfTime&&(m.selfTime=n.Timing.MicroSeconds(m.selfTime-(a.dur||0))),i.push(u),o.maxDepth=Math.max(o.maxDepth,i.length),r.set(a,u))}return{tree:o,entryToNode:r}}function P(t,e,r,i,o,s){if(!o||function(t,e){const n=t.entry.ts,r=t.entry.ts+(t.entry.dur||0);if(n>=e.min&&n<e.max)return!0;if(r>e.min&&r<=e.max)return!0;if(n<=e.min&&r>=e.max)return!0;return!1}(e,o)){if(void 0!==s){if(n.Timing.MicroSeconds(e.entry.ts+n.Timing.MicroSeconds(e.entry.dur||0))<s)return}r(e.entry);for(const n of e.children)P(t,n,r,i,o,s);i(e.entry)}}function D(t){const e=[];for(const n of t){const t=n.ts,r=n.ts+(n.dur||0);let i=e.at(-1);if(void 0===i){e.push(n);continue}let o=i.ts+(i.dur||0);for(;e.length&&t>=o&&(e.pop(),i=e.at(-1),void 0!==i);)o=i.ts+(i.dur||0);if(e.length&&r>o)return!1;e.push(n)}return!0}var B=Object.freeze({__proto__:null,makeTraceEntryNodeId:x,makeEmptyTraceEntryTree:F,makeEmptyTraceEntryNode:C,treify:_,walkTreeFromEntry:function(t,e,n,r){const i=t.get(e);i&&P(t,i,n,r)},walkEntireTree:function(t,e,n,r,i,o){for(const s of e.roots)P(t,s,n,r,i,o)},canBuildTreesFromEvents:D});var R=Object.freeze({__proto__:null,buildTrackDataFromExtensionEntries:function(e,n){const r=new Map;for(const n of e){const e=n.args.trackGroup||`track-name-${n.args.track}`,i=t.MapUtilities.getWithDefault(r,e,(()=>({name:n.args.trackGroup||n.args.track,isTrackGroup:Boolean(n.args.trackGroup),entriesByTrack:{[n.args.track]:[]}})));i.entriesByTrack[n.args.track]||(i.entriesByTrack[n.args.track]=[]);i.entriesByTrack[n.args.track].push(n)}for(const t of r.values()){for(const e of Object.values(t.entriesByTrack))g(e),D(e)&&_(e);n.push(t)}return n}});var A=Object.freeze({__proto__:null,isSyntheticNetworkRequestEventRenderBlocking:function(t){return"non_blocking"!==t.args.data.renderBlocking}});class j{#n=[];#r=[];#i;#o;#s=[];#a=!1;#c;#l=new Map;#u;#d;jsSampleEvents=[];constructor(t,e,r,i,o){this.#c=t,this.#o=i,this.#i=r,this.#u=o||n.Configuration.defaults(),this.#d=e}buildProfileCalls(t){const e=p(t,this.callsFromProfileSamples()),r=[];for(let t=0;t<e.length;t++){const i=e[t];if("I"===i.ph)continue;if(0===r.length){if(n.TraceEvents.isProfileCall(i)){this.#m(i);continue}r.push(i),this.#h(i);continue}const o=r.at(-1);if(void 0===o)continue;i.ts>=o.ts+(o.dur||0)?(this.#f(o),r.pop(),t--):n.TraceEvents.isProfileCall(i)?this.#m(i,o):(this.#h(i),r.push(i))}for(;r.length;){const t=r.pop();t&&this.#f(t)}return this.#n}#h(t){"RunMicrotasks"!==t.name&&"RunTask"!==t.name||(this.#s=[],this.#g(0,t.ts),this.#a=!1),this.#a&&(this.#g(this.#s.pop()||0,t.ts),this.#a=!1),this.#p(t),this.#s.push(this.#r.length)}#m(t,e){if(e&&n.TraceEvents.isJSInvocationEvent(e)||this.#a)this.#p(t);else if(n.TraceEvents.isProfileCall(t)&&0===this.#r.length){this.#a=!0;const e=this.#r.length;this.#p(t),this.#s.push(e)}}#f(t){const e=n.Timing.MicroSeconds(t.ts+(t.dur||0));this.#g(this.#s.pop()||0,e)}callsFromProfileSamples(){const t=this.#c.samples,e=this.#c.timestamps,r=this.#u.debugMode;if(!t)return[];const i=[];let o;for(let s=0;s<t.length;s++){const t=this.#c.nodeByIndex(s),a=c(n.Timing.MilliSeconds(e[s]));if(!t)continue;const l=T(t,this.#d,s,a,this.#i,this.#o);i.push(l),r&&this.jsSampleEvents.push(this.#S(l,a)),t.id===this.#c.gcNode?.id&&o?this.#l.set(l,o):o=t}return i}#v(t){let e=this.#c.nodeById(t.nodeId);const n=e?.id===this.#c.gcNode?.id;if(n&&(e=this.#l.get(t)||null),!e)return[];const r=new Array(e.depth+1+Number(n));let i=r.length-1;for(n&&(r[i--]=t);e;)r[i--]=T(e,t.profileId,t.sampleIndex,t.ts,this.#i,this.#o),e=e.parent;return r}#p(t){const e=n.TraceEvents.isProfileCall(t)?this.#v(t):this.#r;j.filterStackFrames(e,this.#u);const r=t.ts+(t.dur||0),i=Math.min(e.length,this.#r.length);let o;for(o=this.#s.at(-1)||0;o<i;++o){const t=e[o].callFrame,i=this.#r[o].callFrame;if(!j.framesAreEqual(t,i))break;this.#r[o].dur=n.Timing.MicroSeconds(Math.max(this.#r[o].dur||0,r-this.#r[o].ts))}for(this.#g(o,t.ts);o<e.length;++o){const t=e[o];t.nodeId!==this.#c.programNode?.id&&t.nodeId!==this.#c.root?.id&&t.nodeId!==this.#c.idleNode?.id&&t.nodeId!==this.#c.gcNode?.id&&(this.#r.push(t),this.#n.push(t))}}#g(t,e){if(this.#s.length){const n=this.#s.at(-1);n&&t<n&&(console.error(`Child stack is shallower (${t}) than the parent stack (${n}) at ${e}`),t=n)}this.#r.length<t&&(console.error(`Trying to truncate higher than the current stack size at ${e}`),t=this.#r.length);for(let t=0;t<this.#r.length;++t)this.#r[t].dur=n.Timing.MicroSeconds(Math.max(e-this.#r[t].ts,0));this.#r.length=t}#S(t,e){return{name:"JSSample",cat:"devtools.timeline",args:{data:{stackTrace:this.#v(t).map((t=>t.callFrame))}},ph:"I",ts:e,dur:n.Timing.MicroSeconds(0),pid:this.#i,tid:this.#o}}static framesAreEqual(t,e){return t.scriptId===e.scriptId&&t.functionName===e.functionName&&t.lineNumber===e.lineNumber}static showNativeName(t,e){return e&&Boolean(j.nativeGroup(t))}static nativeGroup(t){return t.startsWith("Parse")?"Parse":t.startsWith("Compile")||t.startsWith("Recompile")?"Compile":null}static isNativeRuntimeFrame(t){return"native V8Runtime"===t.url}static filterStackFrames(t,e){if(e.showAllEvents)return;let n=null,r=0;for(let i=0;i<t.length;++i){const o=t[i].callFrame,s=j.isNativeRuntimeFrame(o);if(s&&!j.showNativeName(o.functionName,e.includeRuntimeCallStats))continue;const a=s?j.nativeGroup(o.functionName):null;n&&n===a||(n=a,t[r++]=t[i])}t.length=r}}var O=Object.freeze({__proto__:null,SamplesIntegrator:j});export{R as Extensions,A as Network,O as SamplesIntegrator,a as SyntheticEvents,h as Timing,N as Trace,B as TreeHelpers};
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
