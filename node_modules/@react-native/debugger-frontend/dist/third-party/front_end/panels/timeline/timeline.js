<<<<<<< HEAD
import*as e from"../../core/i18n/i18n.js";import*as t from"../../models/trace/trace.js";import*as i from"../../ui/legacy/components/perf_ui/perf_ui.js";import*as n from"../../ui/legacy/theme_support/theme_support.js";import*as r from"../../core/platform/platform.js";import*as a from"../../services/trace_bounds/trace_bounds.js";import*as s from"./utils/utils.js";export{s as Utils};import*as o from"../../core/sdk/sdk.js";import*as l from"../../core/common/common.js";import*as d from"../../core/root/root.js";import*as c from"./components/components.js";import*as h from"./extensions/extensions.js";import*as p from"../../ui/components/helpers/helpers.js";import*as m from"../../ui/legacy/legacy.js";import*as u from"../../models/bindings/bindings.js";import*as g from"../../models/crux-manager/crux-manager.js";import*as v from"../../ui/visual_logging/visual_logging.js";import*as T from"./components/insights/insights.js";import*as y from"./overlays/components/components.js";import*as f from"./overlays/overlays.js";import*as S from"../../ui/legacy/components/utils/utils.js";import*as w from"../../ui/legacy/components/data_grid/data_grid.js";import*as b from"../../ui/components/code_highlighter/code_highlighter.js";import*as E from"../../ui/components/buttons/buttons.js";import*as C from"../../core/host/host.js";import*as k from"../../models/workspace/workspace.js";import*as I from"../../ui/components/adorners/adorners.js";import*as M from"../../ui/components/dialogs/dialogs.js";import*as x from"../../ui/components/legacy_wrapper/legacy_wrapper.js";import*as P from"../mobile_throttling/mobile_throttling.js";import*as R from"../../ui/components/menus/menus.js";import*as F from"../../models/emulation/emulation.js";import*as L from"../../models/extensions/extensions.js";import*as A from"../../models/live-metrics/live-metrics.js";import*as N from"../../ui/components/icon_button/icon_button.js";import*as D from"../layer_viewer/layer_viewer.js";import"../../ui/components/linkifier/linkifier.js";import{render as B,html as H}from"../../ui/lit/lit.js";const U={sSelfS:"{PH1} (self {PH2})"},O=e.i18n.registerUIStrings("panels/timeline/AppenderUtils.ts",U),_=e.i18n.getLocalizedString.bind(void 0,O);function W(e){const t={padding:4,height:17,collapsible:!0,color:n.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),backgroundColor:n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"),nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}function V(e,t,i,n,r,a,s){const o={startLevel:t,name:i,style:n,selectable:r,expanded:a,showStackContextMenu:s};return null!==e&&(o.jslogContext=e),o}function G(i,n){if(!i)return"";const r=t.Helpers.Timing.microToMilli(i);if(void 0===n)return e.TimeUtilities.millisToString(r,!0);const a=t.Helpers.Timing.microToMilli(n),s=t.Types.Timing.Milli(1e-6);return Math.abs(r-a)>s&&a>s?_(U.sSelfS,{PH1:e.TimeUtilities.millisToString(r,!0),PH2:e.TimeUtilities.millisToString(a,!0)}):e.TimeUtilities.millisToString(r,!0)}function z(e,t){let i=0;const n=e.ts,r=e.ts+(e.dur||0);for(;i<t.length&&n<t[i];)++i;return t[i]=r,i}function j(e,t,i){const n=e.entryDecorations[t]||[];n.push(i),e.entryDecorations[t]=n}var $=Object.freeze({__proto__:null,addDecorationToEvent:j,buildGroupStyle:W,buildTrackHeader:V,getDurationString:G,getEventLevel:z});const K={animations:"Animations"},q=e.i18n.registerUIStrings("panels/timeline/AnimationsTrackAppender.ts",K),Y=e.i18n.getLocalizedString.bind(void 0,q);class J{appenderName="Animations";#e;#t;#i=this.#n.bind(this);constructor(e,t){this.#e=e,this.#t=t}appendTrackAtLevel(e,t){const i=this.#t.Animations.animations;return 0===i.length?e:(this.#r(e,t),this.#e.appendEventsAtLevel(i,e,this,this.#i))}#r(e,t){const i=W({useFirstLineForOverview:!1}),n=V("animations",e,Y(K.animations),i,!0,t);this.#e.registerTrackForGroup(n,this)}#n(e,i){if(e&&t.Types.Events.isSyntheticAnimation(e)){t.Insights.Models.CLSCulprits.getNonCompositedFailure(e).length&&j(this.#e.getFlameChartTimelineData(),i,{type:"WARNING_TRIANGLE"})}}colorForEvent(){return n.ThemeSupport.instance().getComputedValue("--app-color-rendering")}}var X=Object.freeze({__proto__:null,AnimationsTrackAppender:J});const Z={srEnterLabelEditMode:"Editing the annotation label text",srLabelTextUpdated:"Label updated to {PH1}",srTimeRangeBoundsUpdated:"Time range updated, starting at {PH1} and ending at {PH2}",timeRange:"time range",entryLabel:"entry label",entriesLink:"connected entries",srAnnotationRemoved:"The {PH1} annotation has been removed",srAnnotationAdded:"The {PH1} annotation has been added",srEntriesLinked:"The connected entries annotation now links from {PH1} to {PH2}"},Q=e.i18n.registerUIStrings("panels/timeline/AnnotationHelpers.ts",Z),ee=e.i18n.getLocalizedString.bind(void 0,Q);function te(e){const t=[];switch(e.type){case"ENTRY_LABEL":t.push(e.entry);break;case"TIME_RANGE":break;case"ENTRIES_LINK":t.push(e.entryFrom),e.entryTo&&t.push(e.entryTo);break;default:r.assertNever(e,"Unsupported annotation type")}return t}function ie(e){let i=null;const n=t.Types.Timing.Milli(1);switch(e.type){case"ENTRY_LABEL":{const r=e.entry.dur??t.Helpers.Timing.milliToMicro(n);i=t.Helpers.Timing.traceWindowFromMicroSeconds(e.entry.ts,t.Types.Timing.Micro(e.entry.ts+r));break}case"TIME_RANGE":i=e.bounds;break;case"ENTRIES_LINK":{if(!e.entryTo)break;const r=e.entryFrom.dur??n,a=e.entryTo.dur??n,s=e.entryFrom.ts+r,o=e.entryTo.ts+a,l=Math.max(s,o);i=t.Helpers.Timing.traceWindowFromMicroSeconds(e.entryFrom.ts,t.Types.Timing.Micro(l));break}default:r.assertNever(e,"Unsupported annotation type")}return i}function ne(e){return"TIME_RANGE"===e.type}function re(e){return"ENTRIES_LINK"===e.type}function ae(e){return"ENTRY_LABEL"===e.type}function se(e){return ne(e)?ee(Z.timeRange):re(e)?ee(Z.entriesLink):ae(e)&&e.label.length>0?ee(Z.entryLabel):null}function oe(i){const{overlay:n,action:o}=i;switch(o){case"Remove":{const e=se(n);if(e)return ee(Z.srAnnotationRemoved,{PH1:e});break}case"Add":{const e=se(n);if(e)return ee(Z.srAnnotationAdded,{PH1:e});break}case"UpdateLabel":{const e=function(e){return ne(e)||ae(e)?e.label:null}(n);if(e)return ee(Z.srLabelTextUpdated,{PH1:e});break}case"UpdateTimeRange":{if("TIME_RANGE"!==n.type)return"";const i=a.TraceBounds.BoundsManager.instance().state()?.micro.entireTraceBounds;if(!i)return"";const{min:r,max:s}=n.bounds,o=e.TimeUtilities.formatMicroSecondsAsMillisFixed(t.Types.Timing.Micro(r-i.min)),l=e.TimeUtilities.formatMicroSecondsAsMillisFixed(t.Types.Timing.Micro(s-i.min));return ee(Z.srTimeRangeBoundsUpdated,{PH1:o,PH2:l})}case"UpdateLinkToEntry":if(re(n)&&n.entryFrom&&n.entryTo){const e=s.EntryName.nameForEntry(n.entryFrom),t=s.EntryName.nameForEntry(n.entryTo);return ee(Z.srEntriesLinked,{PH1:e,PH2:t})}break;case"EnterLabelEditState":return ee(Z.srEnterLabelEditMode);default:r.assertNever(o,"Unsupported action for AnnotationModifiedEvent")}return null}var le=Object.freeze({__proto__:null,ariaAnnouncementForModifiedEvent:oe,ariaDescriptionForOverlay:se,getAnnotationEntries:te,getAnnotationWindow:ie,isEntriesLink:re,isEntryLabel:ae,isTimeRangeLabel:ne});class de extends Event{duration;static eventName="traceload";constructor(e){super(de.eventName,{bubbles:!0,composed:!0}),this.duration=e}}var ce=Object.freeze({__proto__:null,TraceLoadEvent:de});let he;class pe{static instance(e={forceNew:null}){const{forceNew:t}=e;return he&&!t||(he=new pe),he}linkify(e,t){const i=document.createElement("span"),n=e,{x:r,y:a,width:s,height:l}=n;return i.textContent=`Location: [${r},${a}], Size: [${s}x${l}]`,i.addEventListener("mouseover",(()=>o.OverlayModel.OverlayModel.highlightRect(n))),i.addEventListener("mouseleave",(()=>o.OverlayModel.OverlayModel.clearHighlight())),i}}var me=Object.freeze({__proto__:null,CLSRect:class{x;y;width;height;color;outlineColor;constructor([e,t,i,n]){this.x=e,this.y=t,this.width=i,this.height=n,this.color={r:238,g:111,b:99,a:.4},this.outlineColor={r:238,g:111,b:99,a:.7}}},Linkifier:pe});const ue={customTrackDescription:"This is a custom track added by a third party.",customTrackName:"{PH1} — Custom track"},ge=e.i18n.registerUIStrings("panels/timeline/ExtensionTrackAppender.ts",ue),ve=e.i18n.getLocalizedString.bind(void 0,ge);class Te{appenderName="Extension";#a;#e;constructor(e,t){this.#a=t,this.#e=e}appendTrackAtLevel(e,t){return 0===Object.values(this.#a.entriesByTrack).reduce(((e,t)=>t.length+e),0)?e:(this.#s(e,t),this.#o(e))}#s(e,t){const i=W({shareHeaderLine:!1,collapsible:!0}),n=V("extension",e,ve(ue.customTrackName,{PH1:this.#a.name}),i,!0,t);n.description=ve(ue.customTrackDescription),this.#e.registerTrackForGroup(n,this)}#l(e,t){const i=V("extension",e,t,W({shareHeaderLine:!1,padding:2,nestingLevel:1,collapsible:!0}),!0);this.#e.registerTrackForGroup(i,this)}#o(e){let t=e;for(const[e,i]of Object.entries(this.#a.entriesByTrack))this.#a.isTrackGroup&&this.#l(t,e),t=this.#e.appendEventsAtLevel(i,t,this);return t}colorForEvent(e){const i=n.ThemeSupport.instance().getComputedValue("--app-color-rendering");return t.Types.Extensions.isSyntheticExtensionEntry(e)?h.ExtensionUI.extensionEntryColor(e):i}titleForEvent(e){return e.name}setPopoverInfo(e,i){i.title=t.Types.Extensions.isSyntheticExtensionEntry(e)&&e.args.tooltipText?e.args.tooltipText:this.titleForEvent(e),i.formattedTime=G(e.dur)}}var ye=Object.freeze({__proto__:null,ExtensionTrackAppender:Te});const fe={gpu:"GPU"},Se=e.i18n.registerUIStrings("panels/timeline/GPUTrackAppender.ts",fe),we=e.i18n.getLocalizedString.bind(void 0,Se);class be{appenderName="GPU";#e;#t;constructor(e,t){this.#e=e,this.#t=t}appendTrackAtLevel(e,t){const i=this.#t.GPU.mainGPUThreadTasks;return 0===i.length?e:(this.#r(e,t),this.#e.appendEventsAtLevel(i,e,this))}#r(e,t){const i=W({collapsible:!1}),n=V("gpu",e,we(fe.gpu),i,!0,t);this.#e.registerTrackForGroup(n,this)}colorForEvent(e){if(!t.Types.Events.isGPUTask(e))throw new Error(`Unexpected GPU Task: The event's type is '${e.name}'`);return n.ThemeSupport.instance().getComputedValue("--app-color-painting")}}var Ee=Object.freeze({__proto__:null,GPUTrackAppender:be});const Ce={interactions:"Interactions"},ke=e.i18n.registerUIStrings("panels/timeline/InteractionsTrackAppender.ts",Ce),Ie=e.i18n.getLocalizedString.bind(void 0,ke);class Me{appenderName="Interactions";#d;#e;#t;constructor(e,t,i){this.#e=e,this.#d=i,this.#t=t}appendTrackAtLevel(e,t){return 0===this.#t.UserInteractions.interactionEvents.length?e:(this.#r(e,t),this.#c(e))}#r(e,t){const i=W({collapsible:this.#t.UserInteractions.interactionEvents.length>0,useDecoratorsForOverview:!0}),n=V("interactions",e,Ie(Ce.interactions),i,!0,t);this.#e.registerTrackForGroup(n,this)}#c(e){const{interactionEventsWithNoNesting:t,interactionsOverThreshold:i}=this.#t.UserInteractions;return this.#e.appendEventsAtLevel(t,e,this,((e,t)=>{i.has(e)&&void 0!==t&&this.#h(e,t)}))}#h(e,i){const n=this.#e.getFlameChartTimelineData().entryDecorations[i]||[];n.push({type:"CANDY",startAtTime:t.Handlers.ModelHandlers.UserInteractions.LONG_INTERACTION_THRESHOLD,endAtTime:e.processingEnd},{type:"WARNING_TRIANGLE",customEndTime:e.processingEnd}),this.#e.getFlameChartTimelineData().entryDecorations[i]=n}colorForEvent(e){let i=s.EntryName.nameForEntry(e,this.#t);return t.Types.Events.isSyntheticInteraction(e)&&(i+=e.interactionId),this.#d.colorForID(i)}setPopoverInfo(e,i){if(t.Types.Events.isSyntheticInteraction(e)){const t=new c.InteractionBreakdown.InteractionBreakdown;t.entry=e,i.additionalElements.push(t)}}}var xe=Object.freeze({__proto__:null,InteractionsTrackAppender:Me});const Pe={layoutShifts:"Layout shifts",layoutShiftCluster:"Layout shift cluster",layoutShift:"Layout shift"},Re=e.i18n.registerUIStrings("panels/timeline/LayoutShiftsTrackAppender.ts",Pe),Fe=e.i18n.getLocalizedString.bind(void 0,Re),Le=t.Types.Timing.Micro(5e3);class Ae{appenderName="LayoutShifts";#e;#t;constructor(e,t){this.#e=e,this.#t=t}appendTrackAtLevel(e,t){return 0===this.#t.LayoutShifts.clusters.length?e:(this.#r(e,t),this.#p(e))}#r(e,t){const i=W({collapsible:!1}),n=V("layout-shifts",e,Fe(Pe.layoutShifts),i,!0,t);this.#e.registerTrackForGroup(n,this)}#p(e){const t=this.#t.LayoutShifts.clusters;this.#e.appendEventsAtLevel(t,e,this);const i=this.#t.LayoutShifts.clusters.flatMap((e=>e.events));return this.preloadScreenshots(i),this.#e.appendEventsAtLevel(i,e,this)}colorForEvent(e){const i=n.ThemeSupport.instance().getComputedValue("--app-color-rendering");if(t.Types.Events.isSyntheticLayoutShiftCluster(e)){const e=l.Color.parse(i);if(e){return e.setAlpha(.5).asString("rgba")}}return i}setPopoverInfo(e,i){const n=t.Types.Events.isSyntheticLayoutShift(e)?e.args.data?.weighted_score_delta??0:t.Types.Events.isSyntheticLayoutShiftCluster(e)?e.clusterCumulativeScore:-1;if(i.formattedTime=n.toFixed(4),i.title=t.Types.Events.isSyntheticLayoutShift(e)?Fe(Pe.layoutShift):t.Types.Events.isSyntheticLayoutShiftCluster(e)?Fe(Pe.layoutShiftCluster):e.name,t.Types.Events.isSyntheticLayoutShift(e)){const t=new m.Geometry.Size(510,400),n=Ae.createShiftViz(e,this.#t,t);n&&i.additionalElements.push(n)}}getDrawOverride(e){if(t.Types.Events.isSyntheticLayoutShift(e)){const t=e.args.data?.weighted_score_delta||0,i=1-Math.min(t/.1,1);return(t,n,r,a,s,o,l)=>{const d=i*(s/3),c=s,h=c/2;return t.save(),t.beginPath(),t.moveTo(n,r+d),t.lineTo(n+h-d,r+h),t.lineTo(n,r+s-d),t.lineTo(n-h+d,r+h),t.closePath(),t.fillStyle=l(this.colorForEvent(e)),t.fill(),t.restore(),{x:n-h,width:c}}}if(t.Types.Events.isSyntheticLayoutShiftCluster(e))return(t,i,n,r,a,s,o)=>{const l=.2*a,d=n+(a-l)/2+.5;return t.fillStyle=o(this.colorForEvent(e)),t.fillRect(i,d,r-.5,l-1),{x:i,width:r,z:-1}}}preloadScreenshots(e){const t=new Set;for(const i of e){const e=i.parsedData.screenshots;e.before&&t.add(e.before),e.after&&t.add(e.after)}const i=Array.from(t);return s.ImageCache.preload(i)}titleForEvent(e){return""}static createShiftViz(e,t,i){const n=e.parsedData.screenshots,{viewportRect:r,devicePixelRatio:a}=t.Meta,o=document.createElement("div");o.classList.add("layout-shift-viz");const l=n.before&&s.ImageCache.getOrQueue(n.before),d=n.after&&s.ImageCache.getOrQueue(n.after);if(!l||!d||!r||void 0===a)return;const c=e=>new DOMRect(e[0]/a,e[1]/a,e[2]/a,e[3]/a),h=Math.min(l.naturalWidth/r.width,l.naturalHeight/r.height,1),m=Math.min(i.width/l.naturalWidth,i.height/l.naturalHeight,1);for(const e of[o,d,l])e.style.width=l.naturalWidth*m+"px",e.style.height=l.naturalHeight*m+"px";const u=e.args.data?.impacted_nodes?.map((e=>c(e.old_rect)))??[],g=e.args.data?.impacted_nodes?.map((e=>c(e.new_rect)))??[];return p.ScheduledRender.scheduleRender(o,(()=>function(){if(!l||!d)return;[l,d].flatMap((e=>e.getAnimations())).forEach((e=>e.cancel()));const e="ease-out",t={duration:3e3,iterations:1/0,fill:"forwards",easing:e};d.animate({opacity:[0,0,1,1,1],easing:e},t);const i=t=>({left:t.x*m*h+"px",top:t.y*m*h+"px",width:t.width*m*h+"px",height:t.height*m*h+"px",opacity:.7,outlineWidth:"1px",easing:e});u.forEach(((e,n)=>{const r=g[n],a=document.createElement("div");a.classList.add("layout-shift-viz-rect"),o.appendChild(a);let s=i(e),l=i(r);l.opacity=.4,[e.width,e.height,e.x,e.y].every((e=>0===e))&&(s={...l},s.opacity="0"),[r.width,r.height,r.x,r.y].every((e=>0===e))&&(l={...s},l.opacity="0"),a.animate([s,s,{...l,outlineWidth:"4px"},l,l],t)}))}())),o.append(l,d),o}}var Ne=Object.freeze({__proto__:null,LAYOUT_SHIFT_SYNTHETIC_DURATION:Le,LayoutShiftsTrackAppender:Ae});class De{#t;#m=[];#u=[];#g=new Map;constructor(e){this.#t=e}#v(e){return this.#t.Samples.entryToNode.get(e)??this.#t.Renderer.entryToNode.get(e)}findPossibleActions(e){const t=this.#v(e);if(!t)return{MERGE_FUNCTION:!1,COLLAPSE_FUNCTION:!1,COLLAPSE_REPEATING_DESCENDANTS:!1,RESET_CHILDREN:!1,UNDO_ALL_ACTIONS:!1};const i=t.parent,n=this.#T(t).filter((e=>!this.#m.includes(e))),r=this.#y(t).filter((e=>!this.#m.includes(e))),a=this.#T(t).filter((e=>this.#m.includes(e)));return{MERGE_FUNCTION:null!==i,COLLAPSE_FUNCTION:n.length>0,COLLAPSE_REPEATING_DESCENDANTS:r.length>0,RESET_CHILDREN:a.length>0,UNDO_ALL_ACTIONS:this.#m.length>0}}findHiddenDescendantsAmount(e){const t=this.#v(e);if(!t)return 0;return this.#T(t).filter((e=>this.invisibleEntries().includes(e))).length}invisibleEntries(){return this.#m}setHiddenAndExpandableEntries(e,t){this.#m.push(...e),this.#u.push(...t)}entryIsInvisible(e){return this.#m.includes(e)}expandableEntries(){return this.#u}applyFilterAction(e){const t=new Set;switch(e.type){case"MERGE_FUNCTION":{t.add(e.entry);const i=this.#v(e.entry)||null,n=i&&this.#f(i);n&&this.#S(n.entry);break}case"COLLAPSE_FUNCTION":{const i=this.#v(e.entry);if(!i)break;this.#T(i).forEach((e=>t.add(e))),this.#S(e.entry);break}case"COLLAPSE_REPEATING_DESCENDANTS":{const i=this.#v(e.entry);if(!i)break;this.#y(i).forEach((e=>t.add(e))),t.size>0&&this.#S(e.entry);break}case"UNDO_ALL_ACTIONS":this.#m=[],this.#u=[];break;case"RESET_CHILDREN":this.#w(e.entry);break;default:r.assertNever(e.type,`Unknown EntriesFilter action: ${e.type}`)}return this.#m.push(...t),this.#m}#S(e){this.#u.push(e);const t=this.#v(e);if(!t)return;const i=this.#T(t);i.length>0&&(this.#u=this.#u.filter((e=>!i.includes(e))))}firstVisibleParentEntryForEntry(e){const t=this.#v(e);if(!t)return null;const i=this.#f(t);return i?i.entry:null}#f(e){let t=e.parent;for(;t&&this.#m.includes(t.entry)||t&&!Br(t.entry);)t=t.parent;return t}#T(e){const t=this.#g.get(e);if(t)return t;const i=[],n=[...e.children];for(;n.length>0;){const e=n.shift();if(e){i.push(e.entry);const t=this.#g.get(e);t?i.push(...t):n.push(...e.children)}}return this.#g.set(e,i),i}#y(e){const i=[...e.children],n=[],r=t.Types.Events.isProfileCall(e.entry);for(;i.length>0;){const a=i.shift();if(a){const s=t.Types.Events.isProfileCall(a.entry);if(r&&s){const i=e.entry,r=a.entry;t.Helpers.SamplesIntegrator.SamplesIntegrator.framesAreEqual(i.callFrame,r.callFrame)&&n.push(a.entry)}else r||s||e.entry.name===a.entry.name&&n.push(a.entry);i.push(...a.children)}}return n}revealEntry(e){const t=this.#v(e);if(!t)return;let i=t;for(;i.parent&&!this.#u.includes(i.entry);)i=i.parent;this.#w(i.entry)}#w(e){const t=this.#v(e);if(!t)return;const i=this.#T(t);this.#m=this.#m.filter((e=>!i.includes(e))),this.#u=this.#u.filter((t=>!i.includes(t)&&t!==e))}isEntryExpandable(e){return this.#u.includes(e)}}var Be=Object.freeze({__proto__:null,EntriesFilter:De});class He{#b=new Map;keyForEvent(e){if(t.Types.Events.isProfileCall(e))return`p-${e.pid}-${e.tid}-${t.Types.Events.SampleIndex(e.sampleIndex)}-${e.nodeId}`;if(t.Types.Events.isLegacyTimelineFrame(e))return`l-${e.index}`;const i=t.Helpers.SyntheticEvents.SyntheticEventsManager.getActiveManager().getRawTraceEvents(),n=t.Types.Events.isSyntheticBased(e)?`s-${i.indexOf(e.rawSourceEvent)}`:`r-${i.indexOf(e)}`;return n.length<3?null:n}eventForKey(e,i){const n=t.Types.File.traceEventKeyToValues(e);if(He.isProfileCallKey(n))return this.#E(n,i);if(He.isLegacyTimelineFrameKey(n)){const e=i.Frames.frames.at(n.rawIndex);if(!e)throw new Error(`Could not find frame with index ${n.rawIndex}`);return e}if(He.isSyntheticEventKey(n)){const e=t.Helpers.SyntheticEvents.SyntheticEventsManager.getActiveManager().getSyntheticTraces().at(n.rawIndex);if(!e)throw new Error(`Attempted to get a synthetic event from an unknown raw event index: ${n.rawIndex}`);return e}if(He.isRawEventKey(n)){return t.Helpers.SyntheticEvents.SyntheticEventsManager.getActiveManager().getRawTraceEvents()[n.rawIndex]}throw new Error(`Unknown trace event serializable key values: ${n.join("-")}`)}static isProfileCallKey(e){return"p"===e.type}static isLegacyTimelineFrameKey(e){return"l"===e.type}static isRawEventKey(e){return"r"===e.type}static isSyntheticEventKey(e){return"s"===e.type}#E(e,t){const i=this.#b.get(e);if(i)return i;const n=t.Renderer.processes.get(e.processID)?.threads.get(e.threadID)?.profileCalls;if(!n)throw new Error(`Unknown profile call serializable key: ${e}`);const r=n?.find((t=>t.sampleIndex===e.sampleIndex&&t.nodeId===e.protocol));if(!r)throw new Error(`Unknown profile call serializable key: ${JSON.stringify(e)}`);return this.#b.set(e,r),r}}var Ue=Object.freeze({__proto__:null,EventsSerializer:He});const Oe=[];let _e;class We extends Event{overlay;action;static eventName="annotationmodifiedevent";constructor(e,t){super(We.eventName),this.overlay=e,this.action=t}}class Ve extends EventTarget{#C;#k;#I=null;#t;#M;#x;#P;static activeManager(){return _e}static reset(){Oe.length=0,_e=null}static initAndActivateModificationsManager(e,t){if(Oe[t]){if(_e===Oe[t])return _e;_e=Oe[t],Ve.activeManager()?.applyModificationsIfPresent()}const i=e.parsedTrace(t);if(!i)throw new Error("ModificationsManager was initialized without a corresponding trace data");const n=i.Meta.traceBounds,r=e.rawTraceEvents(t);if(!r)throw new Error("ModificationsManager was initialized without a corresponding raw trace events array");const a=e.syntheticTraceEventsManager(t);if(!a)throw new Error("ModificationsManager was initialized without a corresponding SyntheticEventsManager");const s=e.metadata(t),o=new Ve({parsedTrace:i,traceBounds:n,rawTraceEvents:r,modifications:s?.modifications,syntheticEvents:a.getSyntheticTraces()});return Oe[t]=o,_e=o,Ve.activeManager()?.applyModificationsIfPresent(),this.activeManager()}constructor({parsedTrace:e,traceBounds:t,modifications:i}){super(),this.#C=new De(e),this.#k=new c.Breadcrumbs.Breadcrumbs(t),this.#I=i||null,this.#t=e,this.#M=new He,this.#P=l.Settings.Settings.instance().moduleSetting("annotations-hidden"),this.#x=new Map}getEntriesFilter(){return this.#C}getTimelineBreadcrumbs(){return this.#k}deleteEmptyRangeAnnotations(){for(const e of this.#x.keys())"TIME_RANGE"===e.type&&0===e.label.length&&this.removeAnnotation(e)}createAnnotation(e,t=!1){if("ENTRY_LABEL"===e.type){const t=this.#R(e.entry);if(t)return void this.dispatchEvent(new We(t,"EnterLabelEditState"))}t||"TIME_RANGE"!==e.type&&this.#P.set(!1);const i=this.#F(e);this.#x.set(e,i),this.dispatchEvent(new We(i,"Add"))}annotationsForEntry(e){const t=[];for(const[i]of this.#x.entries())"ENTRY_LABEL"===i.type&&i.entry===e?t.push(i):"ENTRIES_LINK"!==i.type||i.entryFrom!==e&&i.entryTo!==e||t.push(i);return t}deleteEntryAnnotations(e){this.annotationsForEntry(e).forEach((e=>{this.removeAnnotation(e)}))}linkAnnotationBetweenEntriesExists(e,t){for(const i of this.#x.keys())if("ENTRIES_LINK"===i.type&&(i.entryFrom===e&&i.entryTo===t||i.entryFrom===t&&i.entryTo===e))return!0;return!1}#R(e){for(const[t,i]of this.#x.entries())if("ENTRY_LABEL"===t.type&&t.entry===e)return i;return null}#F(e){switch(e.type){case"ENTRY_LABEL":return{type:"ENTRY_LABEL",entry:e.entry,label:e.label};case"TIME_RANGE":return{type:"TIME_RANGE",label:e.label,showDuration:!0,bounds:e.bounds};case"ENTRIES_LINK":return{type:"ENTRIES_LINK",state:e.state,entryFrom:e.entryFrom,entryTo:e.entryTo};default:r.assertNever(e,"Overlay for provided annotation cannot be created")}}removeAnnotation(e){const t=this.#x.get(e);t?(this.#x.delete(e),this.dispatchEvent(new We(t,"Remove"))):console.warn("Overlay for deleted Annotation does not exist",e)}removeAnnotationOverlay(e){const t=this.getAnnotationByOverlay(e);t?this.removeAnnotation(t):console.warn("Annotation for deleted Overlay does not exist",e)}updateAnnotation(e){const i=this.#x.get(e);i&&ne(i)&&t.Types.File.isTimeRangeAnnotation(e)?(i.label=e.label,i.bounds=e.bounds,this.dispatchEvent(new We(i,"UpdateTimeRange"))):i&&re(i)&&t.Types.File.isEntriesLinkAnnotation(e)?(i.state=e.state,i.entryFrom=e.entryFrom,i.entryTo=e.entryTo,this.dispatchEvent(new We(i,"UpdateLinkToEntry"))):console.error("Annotation could not be updated")}updateAnnotationOverlay(e){const t=this.getAnnotationByOverlay(e);t?(("ENTRY_LABEL"===e.type&&"ENTRY_LABEL"===t.type||"TIME_RANGE"===e.type&&"TIME_RANGE"===t.type)&&(this.#P.set(!1),t.label=e.label,this.dispatchEvent(new We(e,"UpdateLabel"))),"ENTRIES_LINK"===e.type&&"ENTRIES_LINK"===t.type&&(this.#P.set(!1),t.state=e.state)):console.warn("Annotation for updated Overlay does not exist")}getAnnotationByOverlay(e){for(const[t,i]of this.#x.entries())if(i===e)return t;return null}getAnnotations(){return[...this.#x.keys()]}getOverlays(){return[...this.#x.values()]}applyAnnotationsFromCache(){this.#I=this.toJSON(),this.#x.clear(),this.#L(this.#I.annotations)}toJSON(){const e=this.#C.invisibleEntries().map((e=>this.#M.keyForEvent(e))).filter((e=>null!==e)),t=this.#C.expandableEntries().map((e=>this.#M.keyForEvent(e))).filter((e=>null!==e));return this.#I={entriesModifications:{hiddenEntries:e,expandableEntries:t},initialBreadcrumb:this.#k.initialBreadcrumb,annotations:this.#A()},this.#I}#A(){const e=this.getAnnotations(),i=[],n=[],r=[];for(let a=0;a<e.length;a++){const s=e[a];if(t.Types.File.isEntryLabelAnnotation(s)){const e=this.#M.keyForEvent(s.entry);e&&i.push({entry:e,label:s.label})}else if(t.Types.File.isTimeRangeAnnotation(s))n.push({bounds:s.bounds,label:s.label});else if(t.Types.File.isEntriesLinkAnnotation(s)&&s.entryTo){const e=this.#M.keyForEvent(s.entryFrom),t=this.#M.keyForEvent(s.entryTo);e&&t&&r.push({entryFrom:e,entryTo:t})}}return{entryLabels:i,labelledTimeRanges:n,linksBetweenEntries:r}}applyModificationsIfPresent(){if(!this.#I||!this.#I.annotations)return;const e=this.#I.entriesModifications.hiddenEntries,t=this.#I.entriesModifications.expandableEntries;this.#k.setInitialBreadcrumbFromLoadedModifications(this.#I.initialBreadcrumb),this.#N(e,t),this.#L(this.#I.annotations)}#L(e){try{(e.entryLabels??[]).forEach((e=>{this.createAnnotation({type:"ENTRY_LABEL",entry:this.#M.eventForKey(e.entry,this.#t),label:e.label},!0)}));(e.labelledTimeRanges??[]).forEach((e=>{this.createAnnotation({type:"TIME_RANGE",bounds:e.bounds,label:e.label},!0)}));(e.linksBetweenEntries??[]).forEach((e=>{this.createAnnotation({type:"ENTRIES_LINK",state:"connected",entryFrom:this.#M.eventForKey(e.entryFrom,this.#t),entryTo:this.#M.eventForKey(e.entryTo,this.#t)},!0)}))}catch(e){console.warn("Failed to apply stored annotations",e)}}#N(e,t){try{const i=e.map((e=>this.#M.eventForKey(e,this.#t))),n=t.map((e=>this.#M.eventForKey(e,this.#t)));this.#C.setHiddenAndExpandableEntries(i,n)}catch(e){console.warn("Failed to apply entriesFilter modifications",e),this.#C.setHiddenAndExpandableEntries([],[])}}}var Ge=Object.freeze({__proto__:null,AnnotationModifiedEvent:We,ModificationsManager:Ve});const ze={onIgnoreList:"On ignore list ({rule})",mainS:"Main — {PH1}",main:"Main",frameS:"Frame — {PH1}",workerS:"`Worker` — {PH1}",workerSS:"`Worker`: {PH1} — {PH2}",dedicatedWorker:"Dedicated `Worker`",threadS:"Thread {PH1}",raster:"Raster",threadPool:"Thread pool",rasterizerThreadS:"Rasterizer thread {PH1}",threadPoolThreadS:"Thread pool worker {PH1}",bidderWorkletS:"Bidder Worklet — {PH1}",bidderWorklet:"Bidder Worklet",sellerWorklet:"Seller Worklet",unknownWorklet:"Auction Worklet",workletService:"Auction Worklet service",sellerWorkletS:"Seller Worklet — {PH1}",unknownWorkletS:"Auction Worklet — {PH1}",workletServiceS:"Auction Worklet service — {PH1}"},je=e.i18n.registerUIStrings("panels/timeline/ThreadAppender.ts",ze),$e=e.i18n.getLocalizedString.bind(void 0,je);class Ke{appenderName="Thread";#d;#e;#t;#D=[];#B;#H;#U;#O;#_=!1;#W=!1;threadType="MAIN_THREAD";isOnMainFrame;#V=d.Runtime.experiments.isEnabled("timeline-show-all-events");#G="";#z=null;constructor(e,t,i,n,r,a,s,o){if(this.#e=e,this.#d=new l.Color.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:3},85),this.#d.setColorForID("","#f2ecdc"),this.#t=t,this.#H=i,this.#U=n,!s||!o)throw new Error(`Could not find data for thread with id ${n} in process with id ${i}`);this.#D=s,this.#B=o,this.#O=r||$e(ze.threadS,{PH1:n}),this.isOnMainFrame=Boolean(this.#t.Renderer?.processes.get(i)?.isOnMainFrame),this.threadType=a,this.#t.AuctionWorklets.worklets.has(i)&&(this.appenderName="Thread_AuctionWorklet"),this.#G=this.#t.Renderer?.processes.get(this.#H)?.url||""}processId(){return this.#H}threadId(){return this.#U}appendTrackAtLevel(e,t=!1){return 0===this.#D.length?e:(this.#_=t,this.#j(e))}setHeaderNestingLevel(e){this.#z=e}#$(e){this.#W||("RASTERIZER"===this.threadType||"THREAD_POOL"===this.threadType?this.#K(e,this.threadType):this.#r(e),this.#W=!0)}setHeaderAppended(e){this.#W=e}headerAppended(){return this.#W}#r(e){const t=W({shareHeaderLine:!1,collapsible:this.#D.length>0});null!==this.#z&&(t.nestingLevel=this.#z);const i=V(this.#q(),e,this.trackName(),t,!0,this.#_,!0);this.#e.registerTrackForGroup(i,this)}#q(){switch(this.threadType){case"MAIN_THREAD":return this.isOnMainFrame?"thread.main":"thread.frame";case"WORKER":return"thread.worker";case"RASTERIZER":return"thread.rasterizer";case"AUCTION_WORKLET":return"thread.auction-worklet";case"OTHER":return"thread.other";case"CPU_PROFILE":return"thread.cpu-profile";case"THREAD_POOL":return"thread.pool";default:return null}}#K(e,t){const i=this.#e.getCurrentTrackCountForThreadType(t);if(0===i){const t=W({shareHeaderLine:!1,collapsible:this.#D.length>0}),i=V(null,e,this.trackName(),t,!1,this.#_);this.#e.getFlameChartTimelineData().groups.push(i)}const n=W({padding:2,nestingLevel:1,collapsible:!1}),r="RASTERIZER"===this.threadType?$e(ze.rasterizerThreadS,{PH1:i+1}):$e(ze.threadPoolThreadS,{PH1:i+1}),a=V(this.#q(),e,r,n,!0,this.#_);this.#e.registerTrackForGroup(a,this)}trackName(){let e=null;switch(this.threadType){case"MAIN_THREAD":e=this.isOnMainFrame?$e(ze.mainS,{PH1:this.#G}):$e(ze.frameS,{PH1:this.#G});break;case"CPU_PROFILE":e=$e(ze.main);break;case"WORKER":e=this.#Y();break;case"RASTERIZER":e=$e(ze.raster);break;case"THREAD_POOL":e=$e(ze.threadPool);break;case"OTHER":break;case"AUCTION_WORKLET":e=this.#J();break;default:return r.assertNever(this.threadType,`Unknown thread type: ${this.threadType}`)}let t="";return this.#t.Meta.traceIsGeneric&&(t+=` (${this.threadId()})`),(e||this.#O)+t}getUrl(){return this.#G}getEntries(){return this.#D}#J(){const e=this.#t.AuctionWorklets.worklets.get(this.#H);if(!e)return $e(ze.unknownWorklet);const t=e.host?`https://${e.host}`:"",i=t.length>0,n=e.args.data.utilityThread.tid===this.#U,a=e.args.data.v8HelperThread.tid===this.#U;if(n)return i?$e(ze.workletServiceS,{PH1:t}):$e(ze.workletService);if(a)switch(e.type){case"seller":return i?$e(ze.sellerWorkletS,{PH1:t}):$e(ze.sellerWorklet);case"bidder":return i?$e(ze.bidderWorkletS,{PH1:t}):$e(ze.bidderWorklet);case"unknown":return i?$e(ze.unknownWorkletS,{PH1:t}):$e(ze.unknownWorklet);default:r.assertNever(e.type,`Unexpected Auction Worklet Type ${e.type}`)}return i?$e(ze.unknownWorkletS,{PH1:t}):$e(ze.unknownWorklet)}#Y(){const e=this.#t.Renderer?.processes.get(this.#H)?.url||"",t=this.#t.Workers.workerIdByThread.get(this.#U),i=t?this.#t.Workers.workerURLById.get(t):e;let n=i?$e(ze.workerS,{PH1:i}):$e(ze.dedicatedWorker);const r=void 0!==t&&o.TargetManager.TargetManager.instance().targetById(t);return r&&(n=$e(ze.workerSS,{PH1:r.name(),PH2:e})),n}#j(e){return this.#X(this.#B.roots,e)}#X(e,t,i=!1){const n=Ve.activeManager()?.getEntriesFilter().invisibleEntries()??[];let r=t;for(const a of e){let e=t;const o=a.entry,l=s.IgnoreList.isIgnoreListedEntry(o);!n.includes(o)&&(Br(o,this.#t)||this.#V)&&!(l&&i)&&(this.#Z(o,t),e++);const d=this.#X(a.children,e,l);r=Math.max(d,r)}return r}#Z(e,t){this.#$(t);const i=this.#e.appendEventAtLevel(e,t,this);this.#Q(e,i)}#Q(e,i){const n=this.#e.getFlameChartTimelineData();Ve.activeManager()?.getEntriesFilter().isEntryExpandable(e)&&j(n,i,{type:"HIDDEN_DESCENDANTS_ARROW"});const r=this.#t.Warnings.perEvent.get(e);r&&(j(n,i,{type:"WARNING_TRIANGLE"}),r.includes("LONG_TASK")&&j(n,i,{type:"CANDY",startAtTime:t.Handlers.ModelHandlers.Warnings.LONG_MAIN_THREAD_TASK_THRESHOLD}))}colorForEvent(e){if(this.#t.Meta.traceIsGeneric)return e.name?`hsl(${r.StringUtilities.hashCode(e.name)%300+30}, 40%, 70%)`:"#ccc";if(t.Types.Events.isProfileCall(e))return"(idle)"===e.callFrame.functionName?s.EntryStyles.getCategoryStyles().idle.getComputedColorValue():"0"===e.callFrame.scriptId?s.EntryStyles.getCategoryStyles().scripting.getComputedColorValue():this.#d.colorForID(e.callFrame.url);const i=s.EntryStyles.getEventStyle(e.name)?.category.getComputedColorValue();return i||s.EntryStyles.getCategoryStyles().other.getComputedColorValue()}titleForEvent(e){if(s.IgnoreList.isIgnoreListedEntry(e)){const t=s.IgnoreList.getIgnoredReasonString(e);return $e(ze.onIgnoreList,{rule:t})}return s.EntryName.nameForEntry(e,this.#t)}setPopoverInfo(e,i){if(t.Types.Events.isParseHTML(e)){const t=e.args.beginData.startLine,n=e.args.endData?.endLine,r=e.args.beginData.url,a=u.ResourceUtils.displayNameForURL(r),s=-1!==n||n===t?`${t}...${n}`:t;i.title+=` - ${a} [${s}]`}const n=this.#t.Renderer.entryToNode.get(e)?.selfTime;i.formattedTime=G(e.dur,n)}}var qe=Object.freeze({__proto__:null,ThreadAppender:Ke});function Ye(e,t,i,n){const r=[...Xe(e,t,e.Initiators.eventToInitiator),...Ze(t,e.Initiators.initiatorToEvents)];return r.forEach((t=>function(e,t,i,n){if(i.includes(e.event)){let i=n.Renderer.entryToNode.get(e.event)?.parent;for(;i?.entry&&!t.includes(i?.entry);)i=i.parent??void 0;e.event=i?.entry??e.event,e.isEntryHidden=!0}if(i.includes(e.initiator)){let i=n.Renderer.entryToNode.get(e.initiator)?.parent;for(;i?.entry&&!t.includes(i?.entry);)i=i.parent??void 0;e.initiator=i?.entry??e.initiator,e.isInitiatorHidden=!0}return e}(t,n,i,e))),r}function Je(e,t){return Xe(e,t,e.NetworkRequests.eventToInitiator)}function Xe(e,t,i){const n=[];let r=t;const a=new Set;for(a.add(r);r;){const t=i.get(r);if(t){if(a.has(t))break;n.push({event:r,initiator:t}),r=t,a.add(r);continue}const s=e.Renderer.entryToNode.get(r);if(!s){r=null;break}r=s.parent?.entry||null}return n}function Ze(e,t){const i=[],n=t.get(e);return n&&n.forEach((t=>{i.push({event:t,initiator:e})})),i}var Qe=Object.freeze({__proto__:null,initiatorsDataToDraw:Ye,initiatorsDataToDrawForNetwork:Je}),et={cssText:`.timeline-flamechart-popover{overflow:hidden;padding:4px;margin:-4px}.timeline-flamechart-popover devtools-interaction-breakdown{margin-top:10px}.timeline-flamechart-popover span{margin-right:5px}.timeline-flamechart-popover span.popoverinfo-network-time{color:var(--sys-color-primary)}.timeline-flamechart-popover span.popoverinfo-time{color:var(--sys-color-green)}.timeline-flamechart-popover span.popoverinfo-warning{color:var(--sys-color-error)}.timeline-flamechart-popover span.popoverinfo-url-path,\n.timeline-flamechart-popover span.popoverinfo-url-origin{color:var(--sys-color-token-subtle);font-size:11px}.timeline-flamechart-popover span.popoverinfo-url-origin{font-style:italic}.timeline-flamechart-popover span.popoverinfo-warning *{color:inherit}.layout-shift-viz{position:relative;margin:var(--sys-size-8) var(--sys-size-5);outline:1px solid var(--sys-color-divider)}.layout-shift-viz-rect{outline:1px solid color-mix(in srgb,var(--color-background-inverted) 20%,var(--app-color-rendering));background-color:color-mix(in srgb,var(--color-background-inverted-opacity-0) 50%,var(--app-color-rendering-children));position:absolute;z-index:100}.layout-shift-viz > img{position:absolute;top:0;left:0}\n/*# sourceURL=${import.meta.resolve("./timelineFlamechartPopover.css")} */\n`};const tt={jsHeap:"JS heap",documents:"Documents",nodes:"Nodes",listeners:"Listeners",gpuMemory:"GPU memory",ss:"[{PH1} – {PH2}]",noEventsFound:"No memory usage data found within selected events."},it=e.i18n.registerUIStrings("panels/timeline/CountersGraph.ts",tt),nt=e.i18n.getLocalizedString.bind(void 0,it);class rt extends m.Widget.VBox{delegate;calculator;header;toolbar;graphsContainer;canvasContainer;canvas;timelineGrid;counters;counterUI;countersByName;gpuMemoryCounter;#ee=null;currentValuesBar;markerXPosition;#te=this.#ie.bind(this);#ne=document.createElement("div");#re=!1;constructor(t){super(),this.element.id="memory-graphs-container",this.delegate=t,this.calculator=new ot,this.header=new m.Widget.HBox,this.header.element.classList.add("timeline-memory-header"),this.header.show(this.element),this.toolbar=this.header.element.createChild("devtools-toolbar","timeline-memory-toolbar"),this.graphsContainer=new m.Widget.VBox,this.graphsContainer.show(this.element);const n=new m.Widget.VBoxWithResizeCallback(this.resize.bind(this));n.show(this.graphsContainer.element),this.createCurrentValuesBar(),this.canvasContainer=n.element,this.canvasContainer.id="memory-graphs-canvas-container",this.canvas=document.createElement("canvas"),this.canvasContainer.appendChild(this.canvas),this.canvas.id="memory-counters-graph";const r=document.createElement("p");r.innerText=nt(tt.noEventsFound),this.#ne.classList.add("no-events-found"),this.#ne.setAttribute("hidden","hidden"),this.#ne.appendChild(r),this.canvasContainer.appendChild(this.#ne),this.canvasContainer.addEventListener("mouseover",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mouseleave",this.onMouseLeave.bind(this),!0),this.canvasContainer.addEventListener("click",this.onClick.bind(this),!0),this.timelineGrid=new i.TimelineGrid.TimelineGrid,this.canvasContainer.appendChild(this.timelineGrid.dividersElement),this.counters=[],this.counterUI=[],this.countersByName=new Map,this.countersByName.set("jsHeapSizeUsed",this.createCounter(nt(tt.jsHeap),"js-heap-size-used","hsl(220, 90%, 43%)",e.ByteUtilities.bytesToString)),this.countersByName.set("documents",this.createCounter(nt(tt.documents),"documents","hsl(0, 90%, 43%)")),this.countersByName.set("nodes",this.createCounter(nt(tt.nodes),"nodes","hsl(120, 90%, 43%)")),this.countersByName.set("jsEventListeners",this.createCounter(nt(tt.listeners),"js-event-listeners","hsl(38, 90%, 43%)")),this.gpuMemoryCounter=this.createCounter(nt(tt.gpuMemory),"gpu-memory-used-kb","hsl(300, 90%, 43%)",e.ByteUtilities.bytesToString),this.countersByName.set("gpuMemoryUsedKB",this.gpuMemoryCounter),a.TraceBounds.onChange(this.#te)}#ie(e){if("RESET"===e.updateType||"VISIBLE_WINDOW"===e.updateType){const t=e.state.milli.timelineTraceWindow;this.calculator.setWindow(t.min,t.max),this.#ae()}}setModel(e,i){if(this.#ee=i,!i||!e)return;const n=t.Helpers.Timing.traceWindowMilliSeconds(e.Meta.traceBounds).min;this.calculator.setZeroTime(n);for(let e=0;e<this.counters.length;++e)this.counters[e].reset(),this.counterUI[e].reset();this.#ae();let r=0;for(let e=0;e<i.length;++e){const n=i[e];if(!t.Types.Events.isUpdateCounters(n))continue;r++;const a=n.args.data;if(!a)return;for(const e in a){const i=this.countersByName.get(e);if(i){const{startTime:r}=t.Helpers.Timing.eventTimingsMilliSeconds(n);i.appendSample(r,a[e])}}void 0!==a.gpuMemoryLimitKB&&this.gpuMemoryCounter.setLimit(a.gpuMemoryLimitKB)}this.#re=0===r}createCurrentValuesBar(){this.currentValuesBar=this.graphsContainer.element.createChild("div"),this.currentValuesBar.id="counter-values-bar"}createCounter(e,t,i,n){const r=new at;return this.counters.push(r),this.counterUI.push(new st(this,e,t,i,r,n)),r}resizerElement(){return this.header.element}resize(){const e=this.canvas.parentElement;this.canvas.width=e.clientWidth*window.devicePixelRatio,this.canvas.height=e.clientHeight*window.devicePixelRatio,this.calculator.setDisplayWidth(this.canvas.width),this.refresh()}#ae(){m.UIUtils.invokeOnceAfterBatchUpdate(this,this.refresh)}draw(){this.clear(),this.#re?this.#ne.removeAttribute("hidden"):this.#ne.setAttribute("hidden","hidden");for(const e of this.counters)e.calculateVisibleIndexes(this.calculator),e.calculateXValues(this.canvas.width);for(const e of this.counterUI)e.drawGraph(this.canvas)}onClick(e){const t=e.x-this.canvasContainer.getBoundingClientRect().left;let i,n=1/0;for(const e of this.counterUI){if(!e.counter.times.length)continue;const r=e.recordIndexAt(t),a=Math.abs(t*window.devicePixelRatio-e.counter.x[r]);a<n&&(n=a,i=e.counter.times[r])}void 0!==i&&this.#ee&&this.delegate.selectEntryAtTime(this.#ee,i)}onMouseLeave(e){delete this.markerXPosition,this.clearCurrentValueAndMarker()}clearCurrentValueAndMarker(){for(let e=0;e<this.counterUI.length;e++)this.counterUI[e].clearCurrentValueAndMarker()}onMouseMove(e){const t=e.x-this.canvasContainer.getBoundingClientRect().left;this.markerXPosition=t,this.refreshCurrentValues()}refreshCurrentValues(){if(void 0!==this.markerXPosition)for(let e=0;e<this.counterUI.length;++e)this.counterUI[e].updateCurrentValue(this.markerXPosition)}refresh(){this.timelineGrid.updateDividers(this.calculator),this.draw(),this.refreshCurrentValues()}clear(){const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to get canvas context");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class at{times;values;x;minimumIndex;maximumIndex;maxTime;minTime;limitValue;constructor(){this.times=[],this.values=[],this.x=[],this.minimumIndex=0,this.maximumIndex=0,this.maxTime=0,this.minTime=0}appendSample(e,t){this.values.length&&this.values[this.values.length-1]===t||(this.times.push(e),this.values.push(t))}reset(){this.times=[],this.values=[]}setLimit(e){this.limitValue=e}calculateBounds(){let e,t;for(let i=this.minimumIndex;i<=this.maximumIndex;i++){const n=this.values[i];(void 0===t||n<t)&&(t=n),(void 0===e||n>e)&&(e=n)}return t=t||0,e=e||1,this.limitValue&&(e>.5*this.limitValue&&(e=Math.max(e,this.limitValue)),t=Math.min(t,this.limitValue)),{min:t,max:e}}calculateVisibleIndexes(e){const t=e.minimumBoundary(),i=e.maximumBoundary();this.minimumIndex=r.NumberUtilities.clamp(r.ArrayUtilities.upperBound(this.times,t,r.ArrayUtilities.DEFAULT_COMPARATOR)-1,0,this.times.length-1),this.maximumIndex=r.NumberUtilities.clamp(r.ArrayUtilities.lowerBound(this.times,i,r.ArrayUtilities.DEFAULT_COMPARATOR),0,this.times.length-1),this.minTime=t,this.maxTime=i}calculateXValues(e){if(!this.values.length)return;const t=e/(this.maxTime-this.minTime);this.x=new Array(this.values.length);for(let e=this.minimumIndex+1;e<=this.maximumIndex;e++)this.x[e]=t*(this.times[e]-this.minTime)}}class st{countersPane;counter;formatter;setting;filter;range;value;graphColor;limitColor;graphYValues;verticalPadding;currentValueLabel;marker;constructor(e,t,i,n,a,s){this.countersPane=e,this.counter=a,this.formatter=s||r.NumberUtilities.withThousandsSeparator,this.setting=l.Settings.Settings.instance().createSetting("timeline-counters-graph-"+i,!0),this.setting.setTitle(t),this.filter=new m.Toolbar.ToolbarSettingCheckbox(this.setting,t),this.filter.inputElement.classList.add("-theme-preserve-input");const o=l.Color.parse(n);if(o){const e=o.setAlpha(.5).asString("rgba"),t=this.filter.element;e&&(t.style.backgroundColor=e),t.style.borderColor="transparent"}this.filter.inputElement.addEventListener("click",this.toggleCounterGraph.bind(this)),e.toolbar.appendToolbarItem(this.filter),this.range=this.filter.element.createChild("span","range"),this.value=e.currentValuesBar.createChild("span","memory-counter-value"),this.value.style.color=n,this.graphColor=n,o&&(this.limitColor=o.setAlpha(.3).asString("rgba")),this.graphYValues=[],this.verticalPadding=10,this.currentValueLabel=t,this.marker=e.canvasContainer.createChild("div","memory-counter-marker"),this.marker.style.backgroundColor=n,this.clearCurrentValueAndMarker()}reset(){this.range.textContent=""}setRange(e,t){const i=this.formatter(e),n=this.formatter(t);this.range.textContent=nt(tt.ss,{PH1:i,PH2:n})}toggleCounterGraph(){this.value.classList.toggle("hidden",!this.filter.checked()),this.countersPane.refresh()}recordIndexAt(e){return r.ArrayUtilities.upperBound(this.counter.x,e*window.devicePixelRatio,r.ArrayUtilities.DEFAULT_COMPARATOR,this.counter.minimumIndex+1,this.counter.maximumIndex+1)-1}updateCurrentValue(e){if(!this.visible()||!this.counter.values.length||!this.counter.x)return;const t=this.recordIndexAt(e),i=r.NumberUtilities.withThousandsSeparator(this.counter.values[t]);this.value.textContent=`${this.currentValueLabel}: ${i}`;const n=this.graphYValues[t]/window.devicePixelRatio;this.marker.style.left=e+"px",this.marker.style.top=n+"px",this.marker.classList.remove("hidden")}clearCurrentValueAndMarker(){this.value.textContent="",this.marker.classList.add("hidden")}drawGraph(e){const t=e.getContext("2d");if(!t)throw new Error("Unable to get canvas context");const i=e.width,n=e.height-2*this.verticalPadding;if(n<=0)return void(this.graphYValues=[]);const r=this.verticalPadding,a=this.counter,s=a.values;if(!s.length)return;const o=a.calculateBounds(),l=o.min,d=o.max;if(this.setRange(l,d),!this.visible())return;const c=this.graphYValues,h=d-l,p=h?n/h:1;t.save(),t.lineWidth=window.devicePixelRatio,t.lineWidth%2&&t.translate(.5,.5),t.beginPath();let m=s[a.minimumIndex],u=Math.round(r+n-(m-l)*p);t.moveTo(0,u);let g=a.minimumIndex;for(;g<=a.maximumIndex;g++){const e=Math.round(a.x[g]);t.lineTo(e,u);const i=s[g];void 0!==i&&(m=i),u=Math.round(r+n-(m-l)*p),t.lineTo(e,u),c[g]=u}if(c.length=g,t.lineTo(i,u),t.strokeStyle=this.graphColor,t.stroke(),a.limitValue){const e=Math.round(r+n-(a.limitValue-l)*p);t.moveTo(0,e),t.lineTo(i,e),this.limitColor&&(t.strokeStyle=this.limitColor),t.stroke()}t.closePath(),t.restore()}visible(){return this.filter.checked()}}class ot{minimumBoundaryInternal;maximumBoundaryInternal;workingArea;zeroTimeInternal;constructor(){this.minimumBoundaryInternal=0,this.maximumBoundaryInternal=0,this.workingArea=0,this.zeroTimeInternal=0}setZeroTime(e){this.zeroTimeInternal=e}computePosition(e){return(e-this.minimumBoundaryInternal)/this.boundarySpan()*this.workingArea}setWindow(e,t){this.minimumBoundaryInternal=e,this.maximumBoundaryInternal=t}setDisplayWidth(e){this.workingArea=e}formatValue(t,i){return e.TimeUtilities.preciseMillisToString(t-this.zeroTime(),i)}maximumBoundary(){return this.maximumBoundaryInternal}minimumBoundary(){return this.minimumBoundaryInternal}zeroTime(){return this.zeroTimeInternal}boundarySpan(){return this.maximumBoundaryInternal-this.minimumBoundaryInternal}}var lt=Object.freeze({__proto__:null,Calculator:ot,Counter:at,CounterUI:st,CountersGraph:rt});function dt(e,t){const i=o.TargetManager.TargetManager.instance(),n=e.Workers.workerIdByThread.get(t.tid);return n?i.targetById(n):i.primaryPageTarget()}var ct=Object.freeze({__proto__:null,targetForEvent:dt}),ht={cssText:`.token-variable{color:var(--sys-color-token-variable)}.token-property{color:var(--sys-color-token-property)}.token-type{color:var(--sys-color-token-type)}.token-variable-special{color:var(--sys-color-token-variable-special)}.token-definition{color:var(--sys-color-token-definition)}.token-builtin{color:var(--sys-color-token-builtin)}.token-number{color:var(--sys-color-token-number)}.token-string{color:var(--sys-color-token-string)}.token-string-special{color:var(--sys-color-token-string-special)}.token-atom{color:var(--sys-color-token-atom)}.token-keyword{color:var(--sys-color-token-keyword)}.token-comment{color:var(--sys-color-token-comment)}.token-meta{color:var(--sys-color-token-meta)}.token-invalid{color:var(--sys-color-error)}.token-tag{color:var(--sys-color-token-tag)}.token-attribute{color:var(--sys-color-token-attribute)}.token-attribute-value{color:var(--sys-color-token-attribute-value)}.token-inserted{color:var(--sys-color-token-inserted)}.token-deleted{color:var(--sys-color-token-deleted)}.token-heading{color:var(--sys-color-token-variable-special);font-weight:bold}.token-link{color:var(--sys-color-token-variable-special);text-decoration:underline}.token-strikethrough{text-decoration:line-through}.token-strong{font-weight:bold}.token-emphasis{font-style:italic}\n/*# sourceURL=${import.meta.resolve("./codeHighlighter.css")} */\n`},pt={cssText:`.image-preview-container{background:transparent;text-align:center;border-spacing:0}.image-preview-container img{margin:6px 0;max-width:100px;max-height:100px;background-image:var(--image-file-checker);user-select:text;vertical-align:top;-webkit-user-drag:auto}.image-container{padding:0}.image-container > div{min-height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer}.image-container > div.start{justify-content:start}.image-preview-container .row{line-height:1.2;vertical-align:baseline}.image-preview-container .title{padding-right:0.5em;color:var(--sys-color-token-subtle);white-space:nowrap;&.start{text-align:start}&.center{text-align:end}}.image-preview-container .description{white-space:nowrap;text-align:left;color:var(--sys-color-on-surface)}.image-preview-container .description-link{max-width:20em}.image-preview-container .source-link{white-space:normal;word-break:break-all;color:var(--sys-color-primary);cursor:pointer}\n/*# sourceURL=${import.meta.resolve("./imagePreview.css")} */\n`};let mt=null;class ut{#se=new WeakSet;static instance(e={forceNew:!1}){return mt&&!e.forceNew||(mt=new ut),mt}registerFreshRecording(e){this.#se.add(e)}recordingIsFresh(e){return this.#se.has(e)}}var gt=Object.freeze({__proto__:null,Tracker:ut});let vt=null;class Tt{static instance(e={forceNew:null}){const t=Boolean(e.forceNew);return vt&&!t||(vt=new Tt),vt}static removeInstance(){vt=null}#oe=[];activeFilters(){return this.#oe}setFilters(e){this.#oe=e}isVisible(e){return this.#oe.every((t=>t.accept(e)))}}function yt(e){return{event:e}}function ft(e,i){return{bounds:t.Helpers.Timing.traceWindowFromMilliSeconds(e,i)}}function St(e){return Boolean(e&&"event"in e)}function wt(e){return Boolean(e&&"bounds"in e)}function bt(e){if(wt(e))return e.bounds;if(St(e)){const i=t.Helpers.Timing.eventTimingsMicroSeconds(e.event);return t.Helpers.Timing.traceWindowFromMicroSeconds(i.startTime,i.endTime)}r.assertNever(e,"Unknown selection type")}function Et(e,i){return St(e)&&St(i)?e.event===i.event:!(!wt(e)||!wt(i))&&t.Helpers.Timing.windowsEqual(e.bounds,i.bounds)}var Ct=Object.freeze({__proto__:null,rangeForSelection:bt,selectionFromEvent:yt,selectionFromRangeMicroSeconds:function(e,i){return{bounds:t.Helpers.Timing.traceWindowFromMicroSeconds(e,i)}},selectionFromRangeMilliSeconds:ft,selectionIsEvent:St,selectionIsRange:wt,selectionsEqual:Et});const kt={performance:"Performance",selfTime:"Self time",totalTime:"Total time",activity:"Activity",selectItemForDetails:"Select item for details.",percentPlaceholder:"{PH1} %",chromeExtensionsOverhead:"[`Chrome` extensions overhead]",vRuntime:"[`V8` Runtime]",unattributed:"[unattributed]",page:"Page",noGrouping:"No grouping",groupByActivity:"Group by activity",groupByCategory:"Group by category",groupByDomain:"Group by domain",groupByFrame:"Group by frame",groupBySubdomain:"Group by subdomain",groupByUrl:"Group by URL",groupByThirdParties:"Group by Third Parties",groupBy:"Group by",heaviestStack:"Heaviest stack",showHeaviestStack:"Show heaviest stack",hideHeaviestStack:"Hide heaviest stack",heaviestStackShown:"Heaviest stack sidebar shown",heaviestStackHidden:"Heaviest stack sidebar hidden",timelineStack:"Timeline stack",matchCase:"Match case",useRegularExpression:"Use regular expression",matchWholeWord:"Match whole word",bottomUp:"Bottom-up",viewBottomUp:"View Bottom-up",firstParty:"1st party",extension:"Extension"},It=e.i18n.registerUIStrings("panels/timeline/TimelineTreeView.ts",kt),Mt=e.i18n.getLocalizedString.bind(void 0,It);class xt extends(l.ObjectWrapper.eventMixin(m.Widget.VBox)){#le;searchResults;linkifier;dataGrid;lastHoveredProfileNode;textFilterInternal;taskFilter;startTime;endTime;splitWidget;detailsView;searchableView;currentThreadSetting;lastSelectedNodeInternal;root;currentResult;textFilterUI;caseSensitiveButton;regexButton;matchWholeWord;#t=null;#de=null;#ce=null;eventToTreeNode=new WeakMap;autoSelectFirstChildOnRefresh=!0;constructor(){super(),this.#le=null,this.element.classList.add("timeline-tree-view"),this.searchResults=[]}#he(e){const i=Tn.eventTitle(e)||e.name;return this.#t?i+":@"+t.Handlers.Helpers.getNonResolvedURL(e,this.#t):i}setSearchableView(e){this.searchableView=e}setModelWithEvents(e,t=null,i=null){this.#t=t,this.#le=e,this.#de=i,this.refreshTree()}entityMapper(){return this.#de}parsedTrace(){return this.#t}init(){this.linkifier=new S.Linkifier.Linkifier,this.taskFilter=new t.Extras.TraceFilter.ExclusiveNameFilter(["RunTask"]),this.textFilterInternal=new Pn,this.currentThreadSetting=l.Settings.Settings.instance().createSetting("timeline-tree-current-thread",0),this.currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this.splitWidget=new m.SplitWidget.SplitWidget(!0,!0,"timeline-tree-view-details-split-widget");const i=new m.Widget.VBox,n=i.element.createChild("devtools-toolbar");n.setAttribute("jslog",`${v.toolbar()}`),n.wrappable=!0,this.populateToolbar(n),this.dataGrid=new w.SortableDataGrid.SortableDataGrid({displayName:Mt(kt.performance),columns:e,refreshCallback:void 0,deleteCallback:void 0}),this.dataGrid.addEventListener("SortingChanged",this.sortingChanged,this),this.dataGrid.element.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.dataGrid.element.addEventListener("mouseleave",(()=>this.dispatchEventToListeners("TreeRowHovered",{node:null}))),this.dataGrid.addEventListener("OpenedNode",this.onGridNodeOpened,this),this.dataGrid.setResizeMethod("last"),this.dataGrid.setRowContextMenuCallback(this.onContextMenu.bind(this)),this.dataGrid.asWidget().show(i.element),this.dataGrid.addEventListener("SelectedNode",this.updateDetailsForSelection,this),this.detailsView=new m.Widget.VBox,this.detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this.splitWidget.setMainWidget(i),this.splitWidget.setSidebarWidget(this.detailsView),this.splitWidget.hideSidebar(),this.splitWidget.show(this.element),this.splitWidget.addEventListener("ShowModeChanged",this.onShowModeChanged,this)}lastSelectedNode(){return this.lastSelectedNodeInternal}updateContents(e){const i=bt(e),n=t.Helpers.Timing.traceWindowMicroSecondsToMilliSeconds(i);this.setRange(n.min,n.max)}setRange(e,t){this.startTime=e,this.endTime=t,this.refreshTree()}highlightEventInTree(e){const t=e&&this.dataGridElementForEvent(e);if((!e||t&&t!==this.#ce)&&this.#ce?.style.setProperty("background-color",""),e){const e=t;e&&(this.#ce=e,this.#ce.style.backgroundColor="var(--sys-color-yellow-container)")}}filters(){return[this.taskFilter,this.textFilterInternal,...Tt.instance().activeFilters()]}filtersWithoutTextFilter(){return[this.taskFilter,...Tt.instance().activeFilters()]}textFilter(){return this.textFilterInternal}exposePercentages(){return!1}populateToolbar(e){this.caseSensitiveButton=new m.Toolbar.ToolbarToggle(Mt(kt.matchCase),"match-case",void 0,"match-case"),this.caseSensitiveButton.addEventListener("Click",(()=>{this.#pe()}),this),e.appendToolbarItem(this.caseSensitiveButton),this.regexButton=new m.Toolbar.ToolbarToggle(Mt(kt.useRegularExpression),"regular-expression",void 0,"regular-expression"),this.regexButton.addEventListener("Click",(()=>{this.#pe()}),this),e.appendToolbarItem(this.regexButton),this.matchWholeWord=new m.Toolbar.ToolbarToggle(Mt(kt.matchWholeWord),"match-whole-word",void 0,"match-whole-word"),this.matchWholeWord.addEventListener("Click",(()=>{this.#pe()}),this),e.appendToolbarItem(this.matchWholeWord);const t=new m.Toolbar.ToolbarFilter;this.textFilterUI=t,t.addEventListener("TextChanged",this.#pe,this),e.appendToolbarItem(t)}selectedEvents(){return this.#le||[]}appendContextMenuItems(e,t){}selectProfileNode(e,t){const i=[];let n=e;for(;n;n=n.parent)i.push(n);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t?.dataGrid&&t.expand()}const r=this.dataGridNodeForTreeNode(e);r?.dataGrid&&(r.reveal(),r.select(t))}refreshTree(){if(!this.element.parentElement)return;if(this.linkifier.reset(),this.dataGrid.rootNode().removeChildren(),!this.#t)return void this.updateDetailsForSelection();this.root=this.buildTree();const e=this.root.children();let t=0,i=0;const n=this.root.totalTime-this.root.selfTime;for(const n of e.values())t=Math.max(t,n.selfTime),i=Math.max(i,n.totalTime);for(const r of e.values()){const e=new Rt(r,n,t,i,this);for(const e of r.events)this.eventToTreeNode.set(e,r);this.dataGrid.insertChild(e)}this.sortingChanged(),this.updateDetailsForSelection(),this.searchableView&&this.searchableView.refreshSearch();const r=this.dataGrid.rootNode();this.autoSelectFirstChildOnRefresh&&r.children.length>0&&r.children[0].select(!0)}buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,i){return new t.Extras.TraceTree.TopDownRootNode(this.selectedEvents(),{filters:this.filters(),startTime:this.startTime,endTime:this.endTime,doNotAggregate:e,eventGroupIdCallback:i})}populateColumns(e){e.push({id:"self",title:Mt(kt.selfTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:Mt(kt.totalTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:Mt(kt.activity),disclosure:!0,sortable:!0})}sortingChanged(){const e=this.dataGrid.sortColumnId();if(!e)return;const t=this.getSortingFunction(e);t&&this.dataGrid.sortNodes(t,!this.dataGrid.isSortOrderAscending())}getSortingFunction(e){const t=(e,t)=>{const i=t,n=e.profileNode.event,r=i.profileNode.event;if(!n||!r)return 0;const a=this.#he(n),s=this.#he(r);return a.localeCompare(s)};switch(e){case"start-time":return function(e,t){const i=t,n=e.profileNode.event,r=i.profileNode.event;if(!n||!r)return 0;return n.ts-r.ts};case"self":return function(e,t){const i=t;return e.profileNode.selfTime-i.profileNode.selfTime};case"total":return function(e,t){const i=t;return e.profileNode.totalTime-i.profileNode.totalTime};case"activity":case"site":return t;default:return console.assert(!1,"Unknown sort field: "+e),null}}#pe(){const e=this.textFilterUI?.value(),t=this.caseSensitiveButton?.isToggled()??!1,i=this.regexButton?.isToggled()??!1,n=this.matchWholeWord?.isToggled()??!1;this.textFilterInternal.setRegExp(e?r.StringUtilities.createSearchRegex(e,t,i,n):null),this.refreshTree()}onShowModeChanged(){"OnlyMain"!==this.splitWidget.showMode()&&(this.lastSelectedNodeInternal=void 0,this.updateDetailsForSelection())}updateDetailsForSelection(){const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;if(e===this.lastSelectedNodeInternal)return;if("OnlyMain"===this.splitWidget.showMode())return;if(this.detailsView.detachChildWidgets(),this.detailsView.element.removeChildren(),this.lastSelectedNodeInternal=e,e&&this.showDetailsForNode(e))return;const t=this.detailsView.element.createChild("div","full-widget-dimmed-banner");m.UIUtils.createTextChild(t,Mt(kt.selectItemForDetails))}showDetailsForNode(e){return!1}onMouseMove(e){const t=e.target&&e.target instanceof Node?this.dataGrid.dataGridNodeFromNode(e.target):null,i=t?.profileNode;i!==this.lastHoveredProfileNode&&(this.lastHoveredProfileNode=i,this.onHover(i))}onHover(e){this.dispatchEventToListeners("TreeRowHovered",{node:e})}onClick(e){this.dispatchEventToListeners("TreeRowClicked",{node:e})}wasShown(){this.dataGrid.addEventListener("SelectedNode",this.#me,this)}childWasDetached(e){this.dataGrid.removeEventListener("SelectedNode",this.#me)}#me(e){this.onClick(e.data.profileNode),this.onHover(e.data.profileNode)}onGridNodeOpened(){const e=this.dataGrid.selectedNode;this.onHover(e.profileNode),this.updateDetailsForSelection()}onContextMenu(e,t){const i=t;i.linkElement&&e.appendApplicableItems(i.linkElement);const n=i.profileNode;n&&this.appendContextMenuItems(e,n)}dataGridElementForEvent(e){if(!e)return null;const t=this.eventToTreeNode.get(e);return(t&&this.dataGridNodeForTreeNode(t)?.element())??null}dataGridNodeForTreeNode(e){return Ft.get(e)||null}onSearchCanceled(){this.searchResults=[],this.currentResult=0}performSearch(e,t,i){if(this.searchResults=[],this.currentResult=0,!this.root)return;const n=e.toSearchRegex();this.searchResults=this.root.searchTree((e=>Tn.testContentMatching(e,n.regex,this.#t||void 0))),this.searchableView.updateSearchMatchesCount(this.searchResults.length)}jumpToNextSearchResult(){this.searchResults.length&&void 0!==this.currentResult&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=r.NumberUtilities.mod(this.currentResult+1,this.searchResults.length))}jumpToPreviousSearchResult(){this.searchResults.length&&void 0!==this.currentResult&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=r.NumberUtilities.mod(this.currentResult-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}class Pt extends w.SortableDataGrid.SortableDataGridNode{populated;profileNode;treeView;grandTotalTime;maxSelfTime;maxTotalTime;linkElement;constructor(e,t,i,n,r){super(null,!1),this.populated=!1,this.profileNode=e,this.treeView=r,this.grandTotalTime=t,this.maxSelfTime=i,this.maxTotalTime=n,this.linkElement=null}createCell(e){return"activity"===e||"site"===e?this.createNameCell(e):this.createValueCell(e)||super.createCell(e)}createNameCell(e){const i=this.createTD(e),n=i.createChild("div","name-container"),r=n.createChild("div","activity-icon-container"),a=r.createChild("div","activity-icon"),s=n.createChild("div","activity-name"),o=this.profileNode.event;if(this.profileNode.isGroupNode()){const t=this.treeView.displayInfoForGroupNode(this.profileNode);if(s.textContent=t.name,a.style.backgroundColor=t.color,t.icon&&r.insertBefore(t.icon,a),"site"===e&&this.treeView instanceof _t){const e=this.treeView;let t="";if(e.nodeIsFirstParty(this.profileNode)?t=Mt(kt.firstParty):e.nodeIsExtension(this.profileNode)&&(t=Mt(kt.extension)),t){const e=n.createChild("div","entity-badge");e.textContent=t,m.ARIAUtils.setLabel(e,t)}}}else if(o){s.textContent=Tn.eventTitle(o);const e=this.treeView.parsedTrace(),i=e?dt(e,o):null,r=this.treeView.linkifier,l=Boolean(e&&ut.instance().recordingIsFresh(e));this.linkElement=Tn.linkifyTopCallFrame(o,i,r,l),this.linkElement&&n.createChild("div","activity-link").appendChild(this.linkElement),m.ARIAUtils.setLabel(a,Tn.eventStyle(o).category.title),a.style.backgroundColor=Tn.eventColor(o),t.Types.Extensions.isSyntheticExtensionEntry(o)&&(a.style.backgroundColor=h.ExtensionUI.extensionEntryColor(o))}return i}createValueCell(i){if("self"!==i&&"total"!==i&&"start-time"!==i&&"transfer-size"!==i)return null;let n,r,a,s=!1,o=!1,l=!1;const d=this.treeView;switch(i){case"start-time":{a=this.profileNode.event;const e=this.treeView.parsedTrace();if(!e)throw new Error("Unable to load trace data for tree view");const i=a&&t.Helpers.Timing.eventTimingsMilliSeconds(a);n=(i?.startTime??0)-t.Helpers.Timing.microToMilli(e.Meta.traceBounds.min)}break;case"self":n=this.profileNode.selfTime,r=this.maxSelfTime,s=!0,l=d instanceof _t;break;case"total":n=this.profileNode.totalTime,r=this.maxTotalTime,s=!0;break;case"transfer-size":n=this.profileNode.transferSize,o=!0;break;default:return null}const c=this.createTD(i);let h;return c.className="numeric-column",o?(c.setAttribute("title",e.ByteUtilities.formatBytesToKb(n)),h=c.createChild("div"),h.createChild("span").textContent=e.ByteUtilities.formatBytesToKb(n)):(c.setAttribute("title",e.TimeUtilities.preciseMillisToString(n,4)),h=c.createChild("div"),h.createChild("span").textContent=e.TimeUtilities.preciseMillisToString(n,1)),s&&this.treeView.exposePercentages()&&(h.createChild("span","percent-column").textContent=Mt(kt.percentPlaceholder,{PH1:(n/this.grandTotalTime*100).toFixed(1)})),r&&(h.classList.add("background-bar-text"),c.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*n/r).toFixed(1)+"%"),l&&this.generateBottomUpButton(h),c}generateBottomUpButton(e){const t=new E.Button.Button;t.data={variant:"icon",iconName:"account-tree",size:"SMALL",toggledIconName:Mt(kt.bottomUp)},m.ARIAUtils.setLabel(t,Mt(kt.viewBottomUp)),t.addEventListener("click",(()=>this.#ue())),m.Tooltip.Tooltip.install(t,Mt(kt.bottomUp)),e.appendChild(t)}#ue(){this.treeView.dispatchEventToListeners("TreeRowHovered",{node:null}),this.treeView.dispatchEventToListeners("BottomUpButtonClicked",this.profileNode)}}class Rt extends Pt{constructor(e,t,i,n,r){super(e,t,i,n,r),this.setHasChildren(this.profileNode.hasChildren()),Ft.set(e,this)}populate(){if(!this.populated&&(this.populated=!0,this.profileNode.children))for(const e of this.profileNode.children().values()){const t=new Rt(e,this.grandTotalTime,this.maxSelfTime,this.maxTotalTime,this.treeView);for(const t of e.events)this.treeView.eventToTreeNode.set(t,e);this.insertChildOrdered(t)}}}const Ft=new WeakMap;class Lt extends xt{groupBySetting;stackView;constructor(){super(),this.groupBySetting=l.Settings.Settings.instance().createSetting("timeline-tree-group-by",Lt.GroupBy.None),this.groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this.stackView=new Dt(this),this.stackView.addEventListener("SelectionChanged",this.onStackViewSelectionChanged,this)}setGroupBySetting(e){this.groupBySetting.set(e)}updateContents(e){super.updateContents(e);const t=this.dataGrid.rootNode();t.children.length&&t.children[0].select(!0),this.updateDetailsForSelection()}beautifyDomainName(e,t){return Lt.isExtensionInternalURL(e)?e=Mt(kt.chromeExtensionsOverhead):Lt.isV8NativeURL(e)?e=Mt(kt.vRuntime):e.startsWith("chrome-extension")&&(e=this.entityMapper()?.entityForEvent(t.event)?.name||e),e}displayInfoForGroupNode(e){const t=s.EntryStyles.getCategoryStyles(),i=Tn.eventColor(e.event),n=Mt(kt.unattributed),r="symbol"==typeof e.id?void 0:e.id;switch(this.groupBySetting.get()){case Lt.GroupBy.Category:{const e=r&&s.EntryStyles.stringIsEventCategory(r)?t[r]||t.other:{title:n,color:n};return{name:e.title,color:e.color,icon:void 0}}case Lt.GroupBy.Domain:case Lt.GroupBy.Subdomain:case Lt.GroupBy.ThirdParties:return{name:(r?this.beautifyDomainName(r,e):void 0)||n,color:i,icon:void 0};case Lt.GroupBy.EventName:if(!e.event)throw new Error("Unable to find event for group by operation");return{name:Tn.eventTitle(e.event),color:i,icon:void 0};case Lt.GroupBy.URL:break;case Lt.GroupBy.Frame:{const e=r?this.parsedTrace()?.PageFrames.frames.get(r):void 0;return{name:e?Tn.displayNameForFrame(e):Mt(kt.page),color:i,icon:void 0}}default:console.assert(!1,"Unexpected grouping type")}return{name:r||n,color:i,icon:void 0}}populateToolbar(e){super.populateToolbar(e);const t=Lt.GroupBy,i=[{label:Mt(kt.noGrouping),value:t.None},{label:Mt(kt.groupByActivity),value:t.EventName},{label:Mt(kt.groupByCategory),value:t.Category},{label:Mt(kt.groupByDomain),value:t.Domain},{label:Mt(kt.groupByFrame),value:t.Frame},{label:Mt(kt.groupBySubdomain),value:t.Subdomain},{label:Mt(kt.groupByUrl),value:t.URL},{label:Mt(kt.groupByThirdParties),value:t.ThirdParties}];e.appendToolbarItem(new m.Toolbar.ToolbarSettingComboBox(i,this.groupBySetting,Mt(kt.groupBy))),e.appendSpacer(),e.appendToolbarItem(this.splitWidget.createShowHideSidebarButton(Mt(kt.showHeaviestStack),Mt(kt.hideHeaviestStack),Mt(kt.heaviestStackShown),Mt(kt.heaviestStackHidden)))}buildHeaviestStack(e){console.assert(Boolean(e.parent),"Attempt to build stack for tree root");let t=[];for(let i=e;i?.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i?.children()?.size;){const e=Array.from(i.children().values());i=e.reduce(((e,t)=>e.totalTime>t.totalTime?e:t)),t.push(i)}return t}exposePercentages(){return!0}onStackViewSelectionChanged(){const e=this.stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}showDetailsForNode(e){const t=this.buildHeaviestStack(e);return this.stackView.setStack(t,e),this.stackView.show(this.detailsView.element),!0}groupingFunction(e){const i=Lt.GroupBy;switch(e){case i.None:return null;case i.EventName:return e=>Tn.eventStyle(e).title;case i.Category:return e=>Tn.eventStyle(e).category.name;case i.Subdomain:case i.Domain:case i.ThirdParties:return this.domainByEvent.bind(this,e);case i.URL:return e=>{const i=this.parsedTrace();return i?t.Handlers.Helpers.getNonResolvedURL(e,i)??"":""};case i.Frame:return e=>t.Helpers.Trace.frameIDForEvent(e)||this.parsedTrace()?.Meta.mainFrameId||"";default:return console.assert(!1,`Unexpected aggregation setting: ${e}`),null}}domainByEvent(e,i){const n=this.parsedTrace();if(!n)return"";const r=t.Handlers.Helpers.getNonResolvedURL(i,n);if(!r){const t=this.entityMapper()?.entityForEvent(i);if(e===Lt.GroupBy.ThirdParties&&t){if(!t)return"";const e=t.domains[0],i=l.ParsedURL.ParsedURL.fromString(e);return"chrome-extension"===i?.scheme?`${i.scheme}://${i.host}`:t.name}return""}if(Lt.isExtensionInternalURL(r))return Lt.extensionInternalPrefix;if(Lt.isV8NativeURL(r))return Lt.v8NativePrefix;const a=l.ParsedURL.ParsedURL.fromString(r);if(!a)return"";if("chrome-extension"===a.scheme)return a.scheme+"://"+a.host;if(e===Lt.GroupBy.ThirdParties){const e=this.entityMapper()?.entityForEvent(i);return e?e.name:""}if(e===Lt.GroupBy.Subdomain)return a.host;if(/^[.0-9]+$/.test(a.host))return a.host;const s=/([^.]*\.)?[^.]*$/.exec(a.host);return s?.[0]||""}static isExtensionInternalURL(e){return e.startsWith(Lt.extensionInternalPrefix)}static isV8NativeURL(e){return e.startsWith(Lt.v8NativePrefix)}static extensionInternalPrefix="extensions::";static v8NativePrefix="native ";onHover(e){if(null===e||this.groupBySetting.get()!==Lt.GroupBy.ThirdParties)this.dispatchEventToListeners("TreeRowHovered",{node:e});else{const t=this.#ge(e);this.dispatchEventToListeners("TreeRowHovered",{node:e,events:t})}}onClick(e){if(null===e||this.groupBySetting.get()!==Lt.GroupBy.ThirdParties)this.dispatchEventToListeners("TreeRowClicked",{node:e});else{const t=this.#ge(e);this.dispatchEventToListeners("TreeRowClicked",{node:e,events:t})}}#ge(e){if(!e.event)return;const t=this.entityMapper()?.entityForEvent(e.event);if(!t)return e.events;const i=this.entityMapper()?.eventsForEntity(t);return i}}!function(e){let t;!function(e){e.None="None",e.EventName="EventName",e.Category="Category",e.Domain="Domain",e.Subdomain="Subdomain",e.URL="URL",e.Frame="Frame",e.ThirdParties="ThirdParties"}(t=e.GroupBy||(e.GroupBy={}))}(Lt||(Lt={}));class At extends Lt{constructor(){super(),this.element.setAttribute("jslog",`${v.pane("call-tree").track({resize:!0})}`),this.dataGrid.markColumnAsSortedBy("total",w.DataGrid.Order.Descending)}buildTree(){const e=this.groupBySetting.get();return this.buildTopDownTree(!1,this.groupingFunction(e))}}class Nt extends Lt{constructor(){super(),this.element.setAttribute("jslog",`${v.pane("bottom-up").track({resize:!0})}`),this.dataGrid.markColumnAsSortedBy("self",w.DataGrid.Order.Descending)}buildTree(){return new t.Extras.TraceTree.BottomUpRootNode(this.selectedEvents(),{textFilter:this.textFilter(),filters:this.filtersWithoutTextFilter(),startTime:this.startTime,endTime:this.endTime,eventGroupIdCallback:this.groupingFunction(this.groupBySetting.get()),calculateTransferSize:!0,forceGroupIdCallback:this.groupBySetting.get()===Lt.GroupBy.ThirdParties})}}class Dt extends(l.ObjectWrapper.eventMixin(m.Widget.VBox)){treeView;dataGrid;constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=Mt(kt.heaviestStack),this.treeView=e;const t=[{id:"total",title:Mt(kt.totalTime),fixedWidth:!0,width:"110px"},{id:"activity",title:Mt(kt.activity)}];this.dataGrid=new w.ViewportDataGrid.ViewportDataGrid({displayName:Mt(kt.timelineStack),columns:t,deleteCallback:void 0,refreshCallback:void 0}),this.dataGrid.setResizeMethod("last"),this.dataGrid.addEventListener("SelectedNode",this.onSelectionChanged,this),this.dataGrid.element.addEventListener("mouseenter",this.onMouseMove.bind(this),!0),this.dataGrid.element.addEventListener("mouseleave",(()=>this.dispatchEventToListeners("TreeRowHovered",null))),this.dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this.dataGrid.rootNode();i.removeChildren();let n=null;const r=Math.max.apply(Math,e.map((e=>e.totalTime)));for(const a of e){const e=new Pt(a,r,r,r,this.treeView);i.appendChild(e),a===t&&(n=e)}n&&n.revealAndSelect()}onMouseMove(e){const t=e.target&&e.target instanceof Node?this.dataGrid.dataGridNodeFromNode(e.target):null,i=t?.profileNode;this.dispatchEventToListeners("TreeRowHovered",i)}selectedTreeNode(){const e=this.dataGrid.selectedNode;return e&&e.profileNode}onSelectionChanged(){this.dispatchEventToListeners("SelectionChanged")}}var Bt=Object.freeze({__proto__:null,get AggregatedTimelineTreeView(){return Lt},BottomUpTimelineTreeView:Nt,CallTreeTimelineTreeView:At,GridNode:Pt,TimelineStackView:Dt,TimelineTreeView:xt,TreeGridNode:Rt});const Ht={unattributed:"[unattributed]",firstOrThirdPartyName:"1st / 3rd party",transferSize:"Transfer size",mainThreadTime:"Main thread time"},Ut=e.i18n.registerUIStrings("panels/timeline/ThirdPartyTreeView.ts",Ht),Ot=e.i18n.getLocalizedString.bind(void 0,Ut);class _t extends xt{#ve=null;autoSelectFirstChildOnRefresh=!1;constructor(){super(),this.element.setAttribute("jslog",`${v.pane("third-party-tree").track({hover:!0})}`),this.init(),this.dataGrid.markColumnAsSortedBy("self",w.DataGrid.Order.Descending),this.dataGrid.setResizeMethod("nearest"),this.dataGrid.expandNodesWhenArrowing=!1}buildTree(){const e=this.parsedTrace(),i=this.entityMapper();if(!e||!i)return new t.Extras.TraceTree.BottomUpRootNode([],{textFilter:this.textFilter(),filters:this.filtersWithoutTextFilter(),startTime:this.startTime,endTime:this.endTime,eventGroupIdCallback:this.groupingFunction.bind(this)});const n=this.selectedEvents().sort(t.Helpers.Trace.eventTimeComparator),r=new t.Extras.TraceFilter.VisibleEventsFilter(s.EntryStyles.visibleTypes().concat(["SyntheticNetworkRequest"]));return new t.Extras.TraceTree.BottomUpRootNode(n,{textFilter:this.textFilter(),filters:[r],startTime:this.startTime,endTime:this.endTime,eventGroupIdCallback:this.groupingFunction.bind(this),calculateTransferSize:!0,forceGroupIdCallback:!0})}selectProfileNode(){}groupingFunction(e){const t=this.entityMapper()?.entityForEvent(e);return t?t.name:""}populateColumns(e){e.push({id:"site",title:Ot(Ht.firstOrThirdPartyName),width:"345px",sortable:!0},{id:"transfer-size",title:Ot(Ht.transferSize),width:"100px",fixedWidth:!0,sortable:!0},{id:"self",title:Ot(Ht.mainThreadTime),width:"120px",fixedWidth:!0,sortable:!0})}populateToolbar(){}compareTransferSize(e,t){const i=t;return(e.profileNode.transferSize??0)-(i.profileNode.transferSize??0)}sortingChanged(){const e=this.dataGrid.sortColumnId();if(!e)return;let t;if("transfer-size"===e)t=this.compareTransferSize.bind(this);else t=super.getSortingFunction(e);t&&this.dataGrid.sortNodes(t,!this.dataGrid.isSortOrderAscending())}onHover(e){if(!e)return void this.dispatchEventToListeners("TreeRowHovered",{node:null});this.#Te(e);const t=this.#Te(e);this.dispatchEventToListeners("TreeRowHovered",{node:e,events:t&&t.length>0?t:void 0})}onClick(e){if(!e)return void this.dispatchEventToListeners("TreeRowClicked",{node:null});const t=this.#Te(e);this.dispatchEventToListeners("TreeRowClicked",{node:e,events:t&&t.length>0?t:void 0})}#Te(e){const t=this.entityMapper();if(!t)return null;const i=t.entityForEvent(e.event);return i?t.eventsForEntity(i)??[]:[]}displayInfoForGroupNode(e){const t=Ot(Ht.unattributed),i="symbol"==typeof e.id?void 0:e.id;return{name:(i?this.entityMapper()?.entityForEvent(e.event)?.name||i:void 0)||t,color:"gray",icon:void 0}}extractThirdPartySummary(e){if(!this.#ve)return{transferSize:0};const t=this.#ve.entityByEvent.get(e.event);if(!t)return{transferSize:0};const i=this.#ve.summaries.byEntity.get(t);return i?{transferSize:i.transferSize}:{transferSize:0}}nodeIsFirstParty(e){const t=this.entityMapper();if(!t)return!1;return t.firstPartyEntity()===t.entityForEvent(e.event)}nodeIsExtension(e){const t=this.entityMapper();if(!t)return!1;const i=t.entityForEvent(e.event);return Boolean(i)&&"Chrome Extension"===i?.category}}class Wt extends m.Widget.WidgetElement{#ye;set treeView(e){this.#ye=e}constructor(){super(),this.style.display="contents"}createWidget(){const e=new m.Widget.Widget(!1,void 0,this);return e.contentElement.style.display="contents",this.#ye&&this.#ye.show(e.contentElement),e}}customElements.define("devtools-performance-third-party-tree-view",Wt);var Vt=Object.freeze({__proto__:null,ThirdPartyTreeElement:Wt,ThirdPartyTreeViewWidget:_t});const Gt={empty:"(empty)",selectJavascriptVmInstance:"Select JavaScript VM instance"},zt=e.i18n.registerUIStrings("panels/timeline/IsolateSelector.ts",Gt),jt=e.i18n.getLocalizedString.bind(void 0,zt);class $t extends m.Toolbar.ToolbarItem{menu;options;items;itemByIsolate=new Map;constructor(){const e=new R.SelectMenu.SelectMenu;super(e),this.menu=e,e.buttonTitle=jt(Gt.selectJavascriptVmInstance),e.showArrow=!0,e.style.whiteSpace="normal",e.addEventListener("selectmenuselected",this.#fe.bind(this)),o.IsolateManager.IsolateManager.instance().observeIsolates(this),o.TargetManager.TargetManager.instance().addEventListener("NameChanged",this.targetChanged,this),o.TargetManager.TargetManager.instance().addEventListener("InspectedURLChanged",this.targetChanged,this)}#Se(e,t){const i=new Map;for(const t of e.models()){const e=t.target(),n=o.TargetManager.TargetManager.instance().rootTarget()!==e?e.name():"",r=new l.ParsedURL.ParsedURL(e.inspectedURL()),a=r.isValid?r.domain():"",s=e.decorateLabel(a&&n?`${a}: ${n}`:n||a||jt(Gt.empty));i.set(s,(i.get(s)||0)+1)}t.removeChildren();for(const[e,n]of i){const i=n>1?`${e} (${n})`:e;t.createChild("div").textContent=i}}#fe(e){this.itemByIsolate.forEach(((t,i)=>{if(t.selected=t.value===e.itemValue,t.selected){const e=t.textContent?.slice(0,29);this.menu.buttonTitle=e||jt(Gt.empty);const n=i.runtimeModel();m.Context.Context.instance().setFlavor(o.CPUProfilerModel.CPUProfilerModel,n?.target().model(o.CPUProfilerModel.CPUProfilerModel)??null)}}))}isolateAdded(e){const t=new R.Menu.MenuItem;this.menu.appendChild(t),t.value=e.id(),this.itemByIsolate.set(e,t),this.#Se(e,t)}isolateRemoved(e){const t=this.itemByIsolate.get(e);t&&(t.selected&&(this.menu.buttonTitle=jt(Gt.selectJavascriptVmInstance),m.Context.Context.instance().setFlavor(o.CPUProfilerModel.CPUProfilerModel,null)),this.menu.removeChild(t))}isolateChanged(e){const t=this.itemByIsolate.get(e);t&&this.#Se(e,t)}targetChanged(e){const t=e.data.model(o.RuntimeModel.RuntimeModel);if(!t)return;const i=o.IsolateManager.IsolateManager.instance().isolateByModel(t);i&&this.isolateChanged(i)}}const Kt={learnmore:"Learn more",wasd:"WASD",clickTheRecordButtonSOrHitSTo:"Click the record button {PH1} or hit {PH2} to start a new recording.",afterRecordingSelectAnAreaOf:"After recording, select an area of interest in the overview by dragging. Then, zoom and pan the timeline with the mousewheel or {PH1} keys. {PH2}"},qt=e.i18n.registerUIStrings("panels/timeline/ReactNativeTimelineLandingPage.ts",Kt),Yt=e.i18n.getLocalizedString.bind(void 0,qt);class Jt extends m.Widget.VBox{toggleRecordAction;constructor(e){super(),this.toggleRecordAction=e,this.contentElement.classList.add("timeline-landing-page","fill"),this.renderLegacyLandingPage()}renderLegacyLandingPage(){function t(e,t){const i=document.createElement(e);return i.textContent=t,i}const i=m.XLink.XLink.create("https://developer.chrome.com/docs/devtools/evaluate-performance/",Yt(Kt.learnmore),void 0,void 0,"learn-more"),n=t("b",m.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.toggle-recording")[0].title()),r=t("b",Yt(Kt.wasd));this.contentElement.classList.add("legacy");const a=this.contentElement.createChild("div"),s=m.UIUtils.createInlineButton(m.Toolbar.Toolbar.createActionButton(this.toggleRecordAction));a.createChild("p").appendChild(e.i18n.getFormatLocalizedString(qt,Kt.clickTheRecordButtonSOrHitSTo,{PH1:s,PH2:n})),a.createChild("p").appendChild(e.i18n.getFormatLocalizedString(qt,Kt.afterRecordingSelectAnAreaOf,{PH1:r,PH2:i}))}}function*Xt(e){if(yield"[\n",e.length>0){const t=e[Symbol.iterator](),i=t.next().value;yield`  ${JSON.stringify(i)}`;let n=1e4,r="";for(const e of t)r+=`,\n  ${JSON.stringify(e)}`,n--,0===n&&(yield r,n=1e4,r="");yield r}yield"\n]"}function*Zt(e,t){t?.enhancedTraceVersion&&(t={enhancedTraceVersion:t.enhancedTraceVersion,...t}),yield`{"metadata": ${JSON.stringify(t||{},null,2)}`,yield',\n"traceEvents": ',yield*Xt(e),yield"}\n"}function Qt(e){return JSON.stringify(e)}var ei=Object.freeze({__proto__:null,arrayOfObjectsJsonGenerator:Xt,cpuprofileJsonGenerator:Qt,traceJsonGenerator:Zt});const ti={tracingNotSupported:"Performance trace recording not supported for this type of target"},ii=e.i18n.registerUIStrings("panels/timeline/TimelineController.ts",ti),ni=e.i18n.getLocalizedString.bind(void 0,ii);class ri{primaryPageTarget;rootTarget;tracingManager;#we=[];#be=[];#Ee=null;#Ce=null;client;tracingCompletePromise=null;constructor(e,i,n){this.primaryPageTarget=i,this.rootTarget=e,this.tracingManager=e.model(t.TracingManager.TracingManager),this.client=n}async dispose(){this.tracingManager&&await this.tracingManager.reset()}async startRecording(e){function i(e){return"disabled-by-default-"+e}const n=[d.Runtime.experiments.isEnabled("timeline-show-all-events")?"*":"-*",t.Types.Events.Categories.Console,t.Types.Events.Categories.Loading,t.Types.Events.Categories.UserTiming,"devtools.timeline",i("devtools.target-rundown"),i("devtools.timeline.frame"),i("devtools.timeline.stack"),i("devtools.timeline"),i("devtools.v8-source-rundown"),i("v8.compile"),i("v8.inspector"),i("v8.cpu_profiler.hires"),i("lighthouse"),"v8.execute","v8","cppgc","navigation,rail"];d.Runtime.experiments.isEnabled("timeline-compiled-sources")&&n.push(i("devtools.v8-source-rundown-sources")),d.Runtime.experiments.isEnabled("timeline-v8-runtime-call-stats")&&e.enableJSSampling&&n.push(i("v8.runtime_stats_sampling")),e.enableJSSampling&&n.push(i("v8.cpu_profiler")),d.Runtime.experiments.isEnabled("timeline-invalidation-tracking")&&n.push(i("devtools.timeline.invalidationTracking")),e.capturePictures&&n.push(i("devtools.timeline.layers"),i("devtools.timeline.picture"),i("blink.graphics_context_annotations")),e.captureFilmStrip&&n.push(i("devtools.screenshot")),e.captureSelectorStats&&n.push(i("blink.debug")),await A.LiveMetrics.instance().disable(),o.TargetManager.TargetManager.instance().addModelListener(o.ResourceTreeModel.ResourceTreeModel,o.ResourceTreeModel.Events.FrameNavigated,this.#ke,this),this.#be=[],this.#Ee=null,this.#Ce=Date.now();const r=await this.startRecordingWithCategories(n.join(","));return r.getError()&&await o.TargetManager.TargetManager.instance().resumeAllTargets(),r}async#ke(e){e.data.isPrimaryFrame()&&this.#be.push(e.data.url)}async stopRecording(){this.tracingManager&&this.tracingManager.stop(),o.TargetManager.TargetManager.instance().removeModelListener(o.ResourceTreeModel.ResourceTreeModel,o.ResourceTreeModel.Events.FrameNavigated,this.#ke,this);const e=o.CPUThrottlingManager.CPUThrottlingManager.instance(),t=e.cpuThrottlingOption();e.setCPUThrottlingOption(o.CPUThrottlingManager.NoThrottlingOption),this.client.loadingStarted(),o.SourceMap.SourceMap.retainRawSourceMaps=!0;const[i]=await Promise.all([this.fetchFieldData(),o.TargetManager.TargetManager.instance().resumeAllTargets(),this.waitForTracingToStop()]).catch((e=>{throw o.SourceMap.SourceMap.retainRawSourceMaps=!1,e}));this.#Ee=i,e.setCPUThrottlingOption(t),await this.allSourcesFinished(),await A.LiveMetrics.instance().enable()}async fetchFieldData(){const e=g.CrUXManager.instance();if(!e.isEnabled()||!navigator.onLine)return null;const t=[...new Set(this.#be)];return await Promise.all(t.map((t=>e.getFieldDataForPage(t))))}async createMetadata(){const e=F.DeviceModeModel.DeviceModeModel.tryInstance();let i;return e?.type()===F.DeviceModeModel.Type.Device?i=e.device()?.title??void 0:e?.type()===F.DeviceModeModel.Type.Responsive&&(i="Responsive"),await t.Extras.Metadata.forNewRecording(!1,this.#Ce??void 0,i,this.#Ee??void 0)}async waitForTracingToStop(){this.tracingManager&&await(this.tracingCompletePromise?.promise)}async startRecordingWithCategories(e){if(!this.tracingManager)throw new Error(ni(ti.tracingNotSupported));await o.TargetManager.TargetManager.instance().suspendAllTargets("performance-timeline"),this.tracingCompletePromise=Promise.withResolvers();const t=await this.tracingManager.start(this,e,"");return await this.warmupJsProfiler(),L.ExtensionServer.ExtensionServer.instance().profilingStarted(),t}async warmupJsProfiler(){const e=this.primaryPageTarget.model(o.RuntimeModel.RuntimeModel);e&&await e.agent.invoke_evaluate({expression:"(async function(){ await 1; })()",throwOnSideEffect:!0})}traceEventsCollected(e){this.#we.push(...e)}tracingComplete(){this.tracingCompletePromise&&(this.tracingCompletePromise.resolve(void 0),this.tracingCompletePromise=null)}async allSourcesFinished(){L.ExtensionServer.ExtensionServer.instance().profilingStopped(),this.client.processingStarted();const e=await this.createMetadata();await this.client.loadingComplete(this.#we,null,e),this.client.loadingCompleteForTest(),o.SourceMap.SourceMap.retainRawSourceMaps=!1}tracingBufferUsage(e){this.client.recordingProgress(e)}eventsRetrievalProgress(e){this.client.loadingProgress(e)}}var ai=Object.freeze({__proto__:null,TimelineController:ri});const si={net:"NET",cpu:"CPU",heap:"HEAP",sSDash:"{PH1} – {PH2}"},oi=e.i18n.registerUIStrings("panels/timeline/TimelineEventOverview.ts",si),li=e.i18n.getLocalizedString.bind(void 0,oi);class di extends i.TimelineOverviewPane.TimelineOverviewBase{constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}renderBar(e,t,i,n,r){const a=e,s=t-e,o=this.context();o.fillStyle=r,o.fillRect(a,i,s,n)}}class ci extends di{#t;constructor(e){super("network",li(si.net)),this.#t=e}update(e,t){this.resetCanvas(),this.#Ie(e,t)}#Ie(e,i){if(!this.#t)return;const n=e&&i?{min:e,max:i,range:i-e}:t.Helpers.Timing.traceWindowMilliSeconds(this.#t.Meta.traceBounds),r=this.height()/2,a=this.width(),s=a/n.range,o=new Path2D,l=new Path2D;for(const e of this.#t.NetworkRequests.byTime){const i=t.Helpers.Network.isSyntheticNetworkRequestHighPriority(e)?o:l,{startTime:d,endTime:c}=t.Helpers.Timing.eventTimingsMilliSeconds(e),h=Math.max(Math.floor((d-n.min)*s),0),p=Math.min(Math.ceil((c-n.min)*s+1),a);i.rect(h,0,p-h,r-1)}const d=this.context();d.save(),d.fillStyle="hsl(214, 60%, 60%)",d.fill(o),d.translate(0,r),d.fillStyle="hsl(214, 80%, 80%)",d.fill(l),d.restore()}}const hi=new WeakMap;class pi extends di{backgroundCanvas;#t;#Me=!1;#xe;#Pe;constructor(e){super("cpu-activity",li(si.cpu)),this.#t=e,this.backgroundCanvas=this.element.createChild("canvas","fill background"),this.#xe=t.Helpers.Timing.traceWindowMilliSeconds(e.Meta.traceBounds).min,this.#Pe=t.Helpers.Timing.traceWindowMilliSeconds(e.Meta.traceBounds).max}#Re(e){if(t.Types.Events.isProfileCall(e)&&"(idle)"===e.callFrame.functionName)return s.EntryStyles.EventCategory.IDLE;return(s.EntryStyles.getEventStyle(e.name)?.category||s.EntryStyles.getCategoryStyles().other).name}resetCanvas(){super.resetCanvas(),this.#Me=!1,this.backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this.backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}#Fe(e){const i=4*window.devicePixelRatio,n=this.width(),r=this.height(),a=r,o=this.#Pe-this.#xe,l=i/(n/o),d=s.EntryStyles.getCategoryStyles(),c=s.EntryStyles.getTimelineMainEventCategories(),h=c.indexOf(s.EntryStyles.EventCategory.OTHER);console.assert(0===c.indexOf(s.EntryStyles.EventCategory.IDLE));for(let e=0;e<c.length;++e)hi.set(d[c[e]],e);const p=(e,s)=>{const p=new vi(this.#xe,l,(function(e){let t=a;for(let n=1;n<c.length;++n){t-=(e[n]||0)/l*r,g[n].bezierCurveTo(m,v[n],m,t,m+i/2,t),v[n]=t}m+=i}));let m=0;const u=[],g=[],v=[];for(let e=0;e<c.length;++e)g[e]=new Path2D,g[e].moveTo(0,r),v[e]=r;const T=t.Helpers.Timing.milliToMicro(this.#xe),y=t.Helpers.Timing.milliToMicro(this.#Pe),f={min:T,max:y,range:t.Types.Timing.Micro(y-T)},S=t.Types.Timing.Micro(f.range>2e5?16e3:0);t.Helpers.TreeHelpers.walkEntireTree(s.entryToNode,s.tree,(e=>{const i=this.#Re(e);if(!i||"idle"===i)return;const n=t.Helpers.Timing.microToMilli(e.ts),r=u.length?u[u.length-1]:0;p.appendInterval(n,r);const a=c.indexOf(i);u.push(a||h)}),(function(e){const i=t.Helpers.Timing.microToMilli(e.ts)+t.Helpers.Timing.microToMilli(t.Types.Timing.Micro(e.dur||0)),n=u.pop();void 0!==i&&n&&p.appendInterval(i,n)}),f,S),p.appendInterval(this.#xe+o+l,0);for(let t=c.length-1;t>0;--t){g[t].lineTo(n,r);const i=d[c[t]].getComputedColorValue();e.fillStyle=i,e.fill(g[t]),e.strokeStyle="white",e.lineWidth=1,e.stroke(g[t])}},m=this.backgroundCanvas.getContext("2d");if(!m)throw new Error("Could not find 2d canvas");const u=t.Handlers.Threads.threadsInTrace(e),g=this.context();for(const e of u){p("MAIN_THREAD"===e.type||"CPU_PROFILE"===e.type?g:m,e)}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let i=.5;i<n+r;i+=t)e.moveTo(i,0),e.lineTo(i-r,r);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(m)}update(){const e=a.TraceBounds.BoundsManager.instance().state(),t=e?.milli.minimapTraceBounds;t&&(t.min===this.#xe&&t.max===this.#Pe&&this.#Me||(this.#xe=t.min,this.#Pe=t.max,this.resetCanvas(),this.#Me=!0,this.#Fe(this.#t)))}}class mi extends di{#t;constructor(e){super("responsiveness",null),this.#t=e}#Le(){const{topLevelRendererIds:e}=this.#t.Meta,t=new Set(["LONG_TASK","FORCED_REFLOW","IDLE_CALLBACK_OVER_TIME"]),i=new Set;for(const n of t){const t=this.#t.Warnings.perWarning.get(n);if(t)for(const n of t)e.has(n.pid)&&i.add(n)}return i}update(e,i){this.resetCanvas();const n=this.height(),r=e&&i?{min:t.Helpers.Timing.milliToMicro(e),max:t.Helpers.Timing.milliToMicro(i),range:t.Helpers.Timing.milliToMicro(t.Types.Timing.Milli(i-e))}:this.#t.Meta.traceBounds,a=r.range,s=this.width()/a,o=this.context(),l=new Path2D,d=new Path2D,c=this.#Le();for(const e of c)h(e);function h(e){const{startTime:i,duration:a}=t.Helpers.Timing.eventTimingsMicroSeconds(e),o=Math.round(s*(i-r.min)),c=Math.round(s*a);l.rect(o,0,c,n),d.moveTo(o+c,0),d.lineTo(o+c,n)}o.fillStyle="hsl(0, 80%, 90%)",o.strokeStyle="red",o.lineWidth=2*window.devicePixelRatio,o.fill(l),o.stroke(d)}}class ui extends di{frameToImagePromise;lastFrame=null;lastElement;drawGeneration;emptyImage;#Ae=null;constructor(e){super("filmstrip",null),this.element.setAttribute("jslog",`${v.section("film-strip")}`),this.frameToImagePromise=new Map,this.#Ae=e,this.lastFrame=null,this.lastElement=null,this.reset()}update(e,t){this.resetCanvas();const i=this.#Ae?this.#Ae.frames:[];if(!i.length)return;if(0===this.height())return void console.warn("TimelineFilmStrip could not be drawn as its canvas height is 0");const n=Symbol("drawGeneration");this.drawGeneration=n,this.imageByFrame(i[0]).then((i=>{if(this.drawGeneration!==n)return;if(!i?.naturalWidth||!i.naturalHeight)return;const r=this.height()-2*ui.Padding,a=Math.ceil(r*i.naturalWidth/i.naturalHeight),s=Math.min(200/i.naturalWidth,1);this.emptyImage=new Image(i.naturalWidth*s,i.naturalHeight*s),this.drawFrames(a,r,e,t)}))}async imageByFrame(e){let i=this.frameToImagePromise.get(e);if(!i){const n=t.Handlers.ModelHandlers.Screenshots.screenshotImageDataUri(e.screenshotEvent);i=m.UIUtils.loadImage(n),this.frameToImagePromise.set(e,i)}return await i}drawFrames(e,i,n,r){if(!e)return;if(!this.#Ae||this.#Ae.frames.length<1)return;const a=ui.Padding,s=this.width(),o=n??t.Helpers.Timing.microToMilli(this.#Ae.zeroTime),l=(r?r-o:t.Helpers.Timing.microToMilli(this.#Ae.spanTime))/s,d=this.context(),c=this.drawGeneration;d.beginPath();for(let n=a;n<s;n+=e+2*a){const r=t.Types.Timing.Milli(o+(n+e/2)*l),a=t.Helpers.Timing.milliToMicro(r),s=t.Extras.FilmStrip.frameClosestToTimestamp(this.#Ae,a);s&&(d.rect(n-.5,.5,e+1,i+1),this.imageByFrame(s).then(h.bind(this,n)))}function h(t,n){this.drawGeneration===c&&n&&d.drawImage(n,t,1,e,i)}d.strokeStyle="#ddd",d.stroke()}async overviewInfoPromise(e){if(!this.#Ae||0===this.#Ae.frames.length)return null;const i=this.calculator();if(!i)return null;const n=i.positionToTime(e),r=t.Helpers.Timing.milliToMicro(n),a=t.Extras.FilmStrip.frameClosestToTimestamp(this.#Ae,r);if(a===this.lastFrame)return this.lastElement;const s=a?this.imageByFrame(a):Promise.resolve(this.emptyImage),o=await s,l=document.createElement("div");return l.classList.add("frame"),o&&l.createChild("div","thumbnail").appendChild(o),this.lastFrame=a,this.lastElement=l,l}reset(){this.lastFrame=null,this.lastElement=null,this.frameToImagePromise=new Map}static Padding=2}class gi extends di{heapSizeLabel;#t;constructor(e){super("memory",li(si.heap)),this.heapSizeLabel=this.element.createChild("div","memory-graph-label"),this.#t=e}resetHeapSizeLabels(){this.heapSizeLabel.textContent=""}update(i,n){this.resetCanvas();const r=window.devicePixelRatio;if(0===this.#t.Memory.updateCountersByProcess.size)return void this.resetHeapSizeLabels();const a=Array.from(this.#t.Meta.topLevelRendererIds).map((e=>this.#t.Memory.updateCountersByProcess.get(e)||[])).filter((e=>e.length>0)),s=3*r;let o=0,l=1e11;const d=i&&n?{min:i,max:n,range:n-i}:t.Helpers.Timing.traceWindowMilliSeconds(this.#t.Meta.traceBounds),c=d.min,h=d.max;function p(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(o=Math.max(o,t.jsHeapSizeUsed),l=Math.min(l,t.jsHeapSizeUsed))}for(let e=0;e<a.length;e++)a[e].forEach(p);l=Math.min(l,o);const m=this.width(),u=this.height()-s,g=m/(h-c),v=(u-1)/Math.max(o-l,1),T=new Array(m);function y(e){const i=e.args.data;if(!i||!i.jsHeapSizeUsed)return;const{startTime:n}=t.Helpers.Timing.eventTimingsMilliSeconds(e),r=Math.round((n-c)*g),a=Math.round((i.jsHeapSizeUsed-l)*v);T[r]=Math.max(T[r]||0,a)}for(let e=0;e<a.length;e++)a[e].forEach(y);const f=this.context(),S=u+s+1;f.translate(.5,.5),f.beginPath(),f.moveTo(-1,S);let w=0,b=!0,E=0;for(let e=0;e<T.length;e++){if(void 0===T[e])continue;b&&(b=!1,w=T[e],f.lineTo(-1,u-w));const t=T[e];Math.abs(t-w)>2&&Math.abs(e-E)>1&&f.lineTo(e,u-w),w=t,f.lineTo(e,u-w),E=e}f.lineTo(m+1,u-w),f.lineTo(m+1,S),f.closePath(),f.fillStyle="hsla(220, 90%, 70%, 0.2)",f.fill(),f.lineWidth=1,f.strokeStyle="hsl(220, 90%, 70%)",f.stroke(),this.heapSizeLabel.textContent=li(si.sSDash,{PH1:e.ByteUtilities.bytesToString(l),PH2:e.ByteUtilities.bytesToString(o)})}}class vi{lastTime;quantDuration;callback;counters;remainder;constructor(e,t,i){this.lastTime=e,this.quantDuration=t,this.callback=i,this.counters=[],this.remainder=t}appendInterval(e,t){let i=e-this.lastTime;if(i<=this.remainder)return this.counters[t]=(this.counters[t]||0)+i,this.remainder-=i,void(this.lastTime=e);for(this.counters[t]=(this.counters[t]||0)+this.remainder,this.callback(this.counters),i-=this.remainder;i>=this.quantDuration;){const e=[];e[t]=this.quantDuration,this.callback(e),i-=this.quantDuration}this.counters=[],this.counters[t]=i,this.lastTime=e,this.remainder=this.quantDuration-i}}var Ti=Object.freeze({__proto__:null,Quantizer:vi,TimelineEventOverview:di,TimelineEventOverviewCPUActivity:pi,TimelineEventOverviewMemory:gi,TimelineEventOverviewNetwork:ci,TimelineEventOverviewResponsiveness:mi,TimelineFilmStripOverview:ui}),yi={cssText:`.drop-down{box-shadow:var(--drop-shadow);background:var(--sys-color-cdt-base-container)}.preview-item{border-bottom:1px solid var(--sys-color-divider);&:first-child{border-top:1px solid var(--sys-color-divider)}padding:6px 10px;position:relative;.metadata{margin-left:3px}&.selected::before{content:" ";position:absolute;top:0;bottom:0;left:0;width:2px;background-color:var(--sys-color-primary)}}.preview-item canvas{width:100%;height:100%}.text-details{flex-wrap:wrap;justify-content:space-between}.text-details > span{padding-left:var(--sys-size-5);padding-right:var(--sys-size-5)}.text-details .name{font:var(--sys-typescale-body4-medium)}.text-details .metadata{color:var(--sys-color-token-subtle);font:var(--sys-typescale-body4-regular);text-align:right}.screenshot-thumb{display:flex;border:1px solid var(--sys-color-surface3);margin:2px 4px}.screenshot-thumb img{margin:auto;max-width:100%;max-height:100%}.landing-page-item{font:var(--sys-typescale-body4-regular);display:flex;align-items:center;gap:var(--sys-size-5)}\n/*# sourceURL=${import.meta.resolve("./timelineHistoryManager.css")} */\n`};const fi=1/0,Si={currentSessionSS:"Current session: {PH1}. {PH2}",landingPageTitle:"Live metrics",nodeLandingPageTitle:"New recording",sD:"{PH1} #{PH2}",selectTimelineSession:"Select timeline session",dSlowdown:"{PH1}× slowdown"},wi=e.i18n.registerUIStrings("panels/timeline/TimelineHistoryManager.ts",Si),bi=e.i18n.getLocalizedString.bind(void 0,wi),Ei=function(){let t;return{format(...i){if(!t){const i={type:"unit",style:"short"};t=new Intl.ListFormat(e.DevToolsLocale.DevToolsLocale.instance().locale,i)}return t.format(...i)}}}();class Ci{recordings;action;nextNumberByDomain;buttonInternal;allOverviews;totalHeight;enabled;lastActiveTrace=null;#Ne;#De;constructor(e,t){this.recordings=[],this.#Ne=e,this.action=m.ActionRegistry.ActionRegistry.instance().getAction("timeline.show-history"),this.nextNumberByDomain=new Map,this.buttonInternal=new Pi(this.action),this.#De=bi(t?Si.nodeLandingPageTitle:Si.landingPageTitle),m.ARIAUtils.markAsMenuButton(this.buttonInternal.element),this.clear(),this.allOverviews=[{constructor:e=>{const t=this.#Ne?.getControls().find((e=>e instanceof mi));return t||new mi(e)},height:3},{constructor:e=>{const t=this.#Ne?.getControls().find((e=>e instanceof pi));return t||new pi(e)},height:20},{constructor:e=>{const t=this.#Ne?.getControls().find((e=>e instanceof ci));return t||new ci(e)},height:8}],this.totalHeight=this.allOverviews.reduce(((e,t)=>e+t.height),0),this.enabled=!0}addRecording(e){const t=e.filmStripForPreview;this.lastActiveTrace=e.data,this.recordings.unshift(e.data),this.#Be(e.data.parsedTraceIndex,e.parsedTrace,e.metadata,t);const i=this.title(e.data);this.buttonInternal.setText(i);const n=this.action.title();if(m.ARIAUtils.setLabel(this.buttonInternal.element,bi(Si.currentSessionSS,{PH1:i,PH2:n})),this.updateState(),this.recordings.length<=ki)return;const r=this.recordings.reduce(((e,t)=>a(e.parsedTraceIndex)<a(t.parsedTraceIndex)?e:t));function a(e){const t=Ci.dataForTraceIndex(e);if(!t)throw new Error("Unable to find data for model");return t.lastUsed}this.recordings.splice(this.recordings.indexOf(r),1)}setEnabled(e){this.enabled=e,this.updateState()}button(){return this.buttonInternal}clear(){this.recordings=[],this.lastActiveTrace=null,this.updateState(),this.buttonInternal.setText(this.#De),this.nextNumberByDomain.clear()}#He(){return this.lastActiveTrace?"LANDING_PAGE"===this.lastActiveTrace.type?fi:this.lastActiveTrace.parsedTraceIndex:-1}async showHistoryDropDown(){if(this.recordings.length<1||!this.enabled)return null;const e=await xi.show(this.recordings.map((e=>e.parsedTraceIndex)),this.#He(),this.buttonInternal.element,this.#De);if(null===e)return null;if(e===fi)return this.#Ue({type:"LANDING_PAGE"}),{type:"LANDING_PAGE"};const t=this.recordings.findIndex((t=>t.parsedTraceIndex===e));return t<0?(console.assert(!1,"selected recording not found"),null):(this.#Ue(this.recordings[t]),this.recordings[t])}cancelIfShowing(){xi.cancelIfShowing()}navigate(e){if(!this.enabled||null===this.lastActiveTrace)return null;if(!this.lastActiveTrace||"LANDING_PAGE"===this.lastActiveTrace.type)return null;const t=this.recordings.findIndex((e=>"TRACE_INDEX"===this.lastActiveTrace?.type&&"TRACE_INDEX"===e.type&&e.parsedTraceIndex===this.lastActiveTrace.parsedTraceIndex));if(t<0)return null;const i=r.NumberUtilities.clamp(t+e,0,this.recordings.length-1);return this.#Ue(this.recordings[i]),this.recordings[i]}navigateToLandingPage(){this.#Ue({type:"LANDING_PAGE"})}#Ue(e){if("TRACE_INDEX"===e.type){const t=Ci.dataForTraceIndex(e.parsedTraceIndex);if(!t)throw new Error("Unable to find data for model");t.lastUsed=Date.now()}this.lastActiveTrace=e;const t=this.title(e),i=this.action.title();this.buttonInternal.setText(t),m.ARIAUtils.setLabel(this.buttonInternal.element,bi(Si.currentSessionSS,{PH1:t,PH2:i}))}updateState(){this.action.setEnabled(this.recordings.length>=1&&this.enabled)}static previewElement(e){const t=Ci.dataForTraceIndex(e);if(!t)throw new Error("Unable to find data for model");return t.preview}title(e){if("LANDING_PAGE"===e.type)return this.#De;const t=Ci.dataForTraceIndex(e.parsedTraceIndex);if(!t)throw new Error("Unable to find data for model");return t.title}#Be(e,t,i,n){const r=l.ParsedURL.ParsedURL.fromString(t.Meta.mainFrameURL),a=r?r.host:"",s=this.nextNumberByDomain.get(a)||1,o=bi(Si.sD,{PH1:a,PH2:s});this.nextNumberByDomain.set(a,s+1);const d=document.createElement("div");d.classList.add("preview-item"),d.classList.add("vbox"),d.setAttribute("jslog",`${v.dropDown("timeline.history-item").track({click:!0})}`),d.style.width=`${Ii}px`;const c={preview:d,title:o,lastUsed:Date.now()};Mi.set(e,c),d.appendChild(this.#Oe(i,a));const h=d.createChild("div","hbox");return h.appendChild(this.#_e(n)),h.appendChild(this.#We(t)),c.preview}#Oe(e,t){const i=document.createElement("div");i.classList.add("text-details"),i.classList.add("hbox");const n=i.createChild("span","name");if(n.textContent=t,m.ARIAUtils.setLabel(n,t),e){const t=[e.emulatedDeviceTitle,e.cpuThrottling?bi(Si.dSlowdown,{PH1:e.cpuThrottling}):void 0,e.networkThrottling].filter(Boolean);i.createChild("span","metadata").textContent=Ei.format(t)}return i}#_e(e){const i=document.createElement("div");i.classList.add("screenshot-thumb");if(i.style.width=1.5*this.totalHeight+"px",i.style.height=this.totalHeight+"px",!e)return i;const n=e.frames.at(-1);if(!n)return i;const r=t.Handlers.ModelHandlers.Screenshots.screenshotImageDataUri(n.screenshotEvent);return m.UIUtils.loadImage(r).then((e=>{e&&i.appendChild(e)})),i}#We(e){const t=document.createElement("div"),i=window.devicePixelRatio;t.style.width=Ii+"px",t.style.height=this.totalHeight+"px";const n=t.createChild("canvas");n.width=i*Ii,n.height=i*this.totalHeight;const r=n.getContext("2d");let a=0;for(const t of this.allOverviews){const n=t.constructor(e);n.update(),r&&r.drawImage(n.context().canvas,0,a,i*Ii,t.height*i),a+=t.height*i}return t}static dataForTraceIndex(e){return Mi.get(e)||null}}const ki=5,Ii=500,Mi=new Map;class xi{glassPane;listControl;focusRestorer;selectionDone;#De;constructor(e,t){this.#De=t,this.glassPane=new m.GlassPane.GlassPane,this.glassPane.setSizeBehavior("MeasureContent"),this.glassPane.setOutsideClickCallback((()=>this.close(null))),this.glassPane.setPointerEventsBehavior("BlockedByGlassPane"),this.glassPane.setAnchorBehavior("PreferBottom"),this.glassPane.element.addEventListener("blur",(()=>this.close(null)));const i=m.UIUtils.createShadowRootWithCoreStyles(this.glassPane.contentElement,{cssFile:yi}).createChild("div","drop-down"),n=new m.ListModel.ListModel;this.listControl=new m.ListControl.ListControl(n,this,m.ListControl.ListMode.NonViewport),this.listControl.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),n.replaceAll(e),m.ARIAUtils.markAsMenu(this.listControl.element),m.ARIAUtils.setLabel(this.listControl.element,bi(Si.selectTimelineSession)),i.appendChild(this.listControl.element),i.addEventListener("keydown",this.onKeyDown.bind(this),!1),i.addEventListener("click",this.onClick.bind(this),!1),this.focusRestorer=new m.UIUtils.ElementFocusRestorer(this.listControl.element),this.selectionDone=null}static show(e,t,i,n=bi(Si.landingPageTitle)){if(xi.instance)return Promise.resolve(null);const r=[...e];r.unshift(fi);return new xi(r,n).show(i,t)}static cancelIfShowing(){xi.instance&&xi.instance.close(null)}show(e,t){return xi.instance=this,this.glassPane.setContentAnchorBox(e.boxInWindow()),this.glassPane.show(this.glassPane.contentElement.ownerDocument),this.listControl.element.focus(),this.listControl.selectItem(t),new Promise((e=>{this.selectionDone=e}))}onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("preview-item"),i=t&&this.listControl.itemForNode(t);null!==i&&this.listControl.selectItem(i)}onClick(e){e.target.enclosingNodeOrSelfWithClass("preview-item")&&this.close(this.listControl.selectedItem())}onKeyDown(e){switch(e.key){case"Tab":case"Escape":this.close(null);break;case"Enter":this.close(this.listControl.selectedItem());break;default:return}e.consume(!0)}close(e){this.selectionDone&&this.selectionDone(e),this.focusRestorer.restore(),this.glassPane.hide(),xi.instance=null}createElementForItem(e){if(e===fi)return this.#Ve();const t=Ci.previewElement(e);return m.ARIAUtils.markAsMenuItem(t),t.classList.remove("selected"),t}#Ve(){const e=document.createElement("div");m.ARIAUtils.markAsMenuItem(e),e.classList.remove("selected"),e.classList.add("preview-item"),e.classList.add("landing-page-item"),e.style.width=`${Ii}px`;const t=N.Icon.create("arrow-back");e.appendChild(t);const i=document.createElement("span");return i.innerText=this.#De,e.appendChild(i),e}heightForItem(e){return console.assert(!1,"Should not be called"),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,n){i&&i.classList.remove("selected"),n&&n.classList.add("selected")}updateSelectedItemARIA(e,t){return!1}static instance=null}class Pi extends m.Toolbar.ToolbarItem{contentElement;constructor(e){const t=document.createElement("button");t.classList.add("history-dropdown-button"),t.setAttribute("jslog",`${v.dropDown("history")}`),super(t),this.contentElement=this.element.createChild("span","content"),this.element.addEventListener("click",(()=>{e.execute()}),!1),this.setEnabled(e.enabled()),e.addEventListener("Enabled",(e=>this.setEnabled(e.data))),this.setTitle(e.title())}setText(e){this.contentElement.textContent=e}}var Ri=Object.freeze({__proto__:null,DropDown:xi,LANDING_PAGE_INDEX_DROPDOWN_CHOICE:fi,TimelineHistoryManager:Ci,ToolbarButton:Pi,maxRecordings:ki,previewWidth:Ii});const Fi={malformedTimelineDataS:"Malformed timeline data: {PH1}"},Li=e.i18n.registerUIStrings("panels/timeline/TimelineLoader.ts",Fi),Ai=e.i18n.getLocalizedString.bind(void 0,Li);class Ni{client;canceledCallback;buffer;firstRawChunk;totalSize;filter;#Ge;#we=[];#ze;#je;#$e;constructor(e){this.client=e,this.canceledCallback=null,this.buffer="",this.firstRawChunk=!0,this.filter=null,this.#Ge=!1,this.#ze=null,this.#$e=new Promise((e=>{this.#je=e}))}static async loadFromFile(e,t){const i=new Ni(t),n=new u.FileUtils.ChunkedFileReader(e);return i.canceledCallback=n.cancel.bind(n),i.totalSize=e.size,setTimeout((async()=>{!await n.read(i)&&n.error()&&i.reportErrorAndCancelLoading(n.error().message)})),i}static loadFromEvents(e,t){const i=new Ni(t);return window.setTimeout((async()=>{i.addEvents(e)})),i}static loadFromCpuProfile(e,i){const n=new Ni(i);n.#Ge=!0;try{const i=t.Helpers.SamplesIntegrator.SamplesIntegrator.createFakeTraceFromCpuProfile(e,t.Types.Events.ThreadID(1));window.setTimeout((async()=>{n.addEvents(i.traceEvents)}))}catch(e){console.error(e.stack)}return n}static async loadFromURL(e,t){const i=new Ni(t),n=new l.StringOutputStream.StringOutputStream;t.loadingStarted();const r=l.Settings.Settings.instance().moduleSetting("network.enable-remote-file-loading").get();return C.ResourceLoader.loadAsStream(e,null,n,(async function(e,t,r){if(!e)return i.reportErrorAndCancelLoading(r.message);try{const e=n.data(),t=JSON.parse(e);i.#Ke(t),await i.close()}catch(e){await i.close();const t=e instanceof Error?e.message:"";return i.reportErrorAndCancelLoading(Ai(Fi.malformedTimelineDataS,{PH1:t}))}}),r),i}#Ke(e){if("traceEvents"in e||Array.isArray(e)){const t=Array.isArray(e)?e:e.traceEvents;this.#qe(t)}else{if(!e.nodes)return void this.reportErrorAndCancelLoading(Ai(Fi.malformedTimelineDataS));this.#Ye(e),this.#Ge=!0}if("metadata"in e){this.#ze=e.metadata,1===this.#ze.cpuThrottling&&(this.#ze.cpuThrottling=void 0);const t="string"==typeof o.NetworkManager.NoThrottlingConditions.title?o.NetworkManager.NoThrottlingConditions.title:o.NetworkManager.NoThrottlingConditions.title();"No throttling"!==this.#ze.networkThrottling&&this.#ze.networkThrottling!==t||(this.#ze.networkThrottling=void 0)}}async addEvents(e){this.client?.loadingStarted();const t=15e4;for(let i=0;i<e.length;i+=t){const n=e.slice(i,i+t);this.#qe(n),this.client?.loadingProgress((i+n.length)/e.length),await new Promise((e=>window.setTimeout(e,0)))}this.close()}async cancel(){this.client&&(await this.client.loadingComplete([],null,null),this.client=null),this.canceledCallback&&this.canceledCallback()}async write(e,t){if(!this.client)return await Promise.resolve();if(this.buffer+=e,this.firstRawChunk)this.client.loadingStarted(),await new Promise((e=>requestAnimationFrame((()=>requestAnimationFrame(e))))),this.firstRawChunk=!1;else{let e;e=this.buffer.length/this.totalSize,e=e>1?e-Math.floor(e):e,this.client.loadingProgress(e)}if(t){let e;try{e=JSON.parse(this.buffer),this.#Ke(e)}catch(e){this.reportErrorAndCancelLoading(Ai(Fi.malformedTimelineDataS,{PH1:e.toString()}))}}else;}reportErrorAndCancelLoading(e){e&&l.Console.Console.instance().error(e),this.cancel()}async close(){this.client&&(this.client.processingStarted(),await this.finalizeTrace())}async finalizeTrace(){!this.#ze&&this.#Ge&&(this.#ze={dataOrigin:"CPUProfile"}),await this.client.loadingComplete(this.#we,this.filter,this.#ze),this.#je?.()}traceFinalizedForTest(){return this.#$e}#Ye(e){const i=t.Helpers.SamplesIntegrator.SamplesIntegrator.createFakeTraceFromCpuProfile(e,t.Types.Events.ThreadID(1));this.#qe(i.traceEvents)}#qe(e){this.#we=this.#we.concat(e)}}var Di=Object.freeze({__proto__:null,TimelineLoader:Ni}),Bi={cssText:`.timeline-minimap{position:relative}.timeline-sidebar-floating-icon{position:absolute;top:5px;left:10px;z-index:999;border:none;width:36px;height:36px;border-radius:50%;box-shadow:var(--drop-shadow-depth-1);background:var(--sys-color-cdt-base-container);&:hover{background:var(--sys-color-base-container-elevated)}}.timeline-minimap .overview-strip{margin-top:2px;justify-content:center}.timeline-minimap .overview-strip .timeline-overview-strip-title{color:var(--sys-color-token-subtle);font-size:10px;font-weight:bold;z-index:100;background-color:var(--sys-color-cdt-base-container);padding:0 4px;position:absolute;top:-2px;right:0}.timeline-minimap #timeline-overview-cpu-activity{flex-basis:20px}.timeline-minimap #timeline-overview-network{flex-basis:8px}.timeline-minimap #timeline-overview-filmstrip{flex-basis:30px}.timeline-minimap #timeline-overview-memory{flex-basis:20px}.timeline-minimap #timeline-overview-network::before,\n.timeline-minimap #timeline-overview-cpu-activity::before{content:"";position:absolute;left:0;right:0;bottom:0;border-bottom:1px solid var(--divider-line);z-index:-200}.timeline-minimap .overview-strip .background{z-index:-10}.timeline-minimap #timeline-overview-responsiveness{flex-basis:5px;margin-top:0!important}.timeline-minimap #timeline-overview-input{flex-basis:6px}.timeline-minimap #timeline-overview-pane{flex:auto;position:relative;overflow:hidden}.timeline-minimap #timeline-overview-container{display:flex;flex-direction:column;flex:none;position:relative;overflow:hidden}.timeline-minimap #timeline-overview-container canvas{width:100%;height:100%}.timeline-minimap-dim-highlight-svg{width:100%;position:absolute;height:100%}.timeline-minimap .memory-graph-label{position:absolute;right:0;bottom:0;font-size:9px;color:var(--sys-color-token-subtle);white-space:nowrap;padding:0 4px;background-color:var(--sys-color-cdt-base-container)}\n/*# sourceURL=${import.meta.resolve("./timelineMiniMap.css")} */\n`};class Hi extends(l.ObjectWrapper.eventMixin(m.Widget.VBox)){#Je=new i.TimelineOverviewPane.TimelineOverviewPane("timeline");#Xe=[];breadcrumbs=null;#Ze;#Qe=null;#te=this.#ie.bind(this);constructor(){super(),this.registerRequiredCSS(Bi),this.element.classList.add("timeline-minimap"),this.#Ze=new c.BreadcrumbsUI.BreadcrumbsUI,this.element.prepend(this.#Ze),this.#Je.show(this.element),this.#Je.addEventListener("OverviewPaneWindowChanged",(e=>{this.#et(e)})),this.#Je.addEventListener("OverviewPaneBreadcrumbAdded",(e=>{this.addBreadcrumb(e.data)})),this.#Je.addEventListener("OverviewPaneMouseMove",(e=>{this.dispatchEventToListeners("OverviewPaneMouseMove",e.data)})),this.#Je.addEventListener("OverviewPaneMouseLeave",(()=>{this.dispatchEventToListeners("OverviewPaneMouseLeave")})),this.#Ze.addEventListener(c.BreadcrumbsUI.BreadcrumbActivatedEvent.eventName,(e=>{const{breadcrumb:t,childBreadcrumbsRemoved:i}=e;this.#tt(t,{removeChildBreadcrumbs:Boolean(i),updateVisibleWindow:!0})})),this.#Je.enableCreateBreadcrumbsButton(),a.TraceBounds.onChange(this.#te)}#et(e){const i=this.#Qe?.parsedTrace;if(!i)return;const n=a.TraceBounds.BoundsManager.instance().state();if(!n)return;const r=e.data.startTime>0?e.data.startTime:n.milli.entireTraceBounds.min,s=Number.isFinite(e.data.endTime)?e.data.endTime:n.milli.entireTraceBounds.max;a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(t.Helpers.Timing.traceWindowFromMilliSeconds(t.Types.Timing.Milli(r),t.Types.Timing.Milli(s)),{shouldAnimate:!0})}#ie(e){if("RESET"===e.updateType||"VISIBLE_WINDOW"===e.updateType){this.#Je.setWindowTimes(e.state.milli.timelineTraceWindow.min,e.state.milli.timelineTraceWindow.max);t.Helpers.Timing.windowFitsInsideBounds({window:e.state.micro.timelineTraceWindow,bounds:e.state.micro.minimapTraceBounds})||this.#it(e.state.micro.timelineTraceWindow)}"RESET"!==e.updateType&&"MINIMAP_BOUNDS"!==e.updateType||this.#Je.setBounds(e.state.milli.minimapTraceBounds.min,e.state.milli.minimapTraceBounds.max)}#it(e){if(!this.breadcrumbs)return;let i=this.breadcrumbs.initialBreadcrumb,n=this.breadcrumbs.initialBreadcrumb;for(;i;){if(!t.Helpers.Timing.windowFitsInsideBounds({window:e,bounds:i.window}))break;n=i,i=i.child}this.#tt(n,{removeChildBreadcrumbs:!1,updateVisibleWindow:!1})}addBreadcrumb({startTime:e,endTime:i}){if(!this.breadcrumbs)return void console.warn("ModificationsManager has not been created, therefore Breadcrumbs can not be added");const n=a.TraceBounds.BoundsManager.instance().state();if(!n)return;const r=n.milli.minimapTraceBounds,s={startTime:t.Types.Timing.Milli(Math.max(e,r.min)),endTime:t.Types.Timing.Milli(Math.min(i,r.max))},o=t.Helpers.Timing.traceWindowFromMilliSeconds(s.startTime,s.endTime),l=this.breadcrumbs.add(o);this.#Ze.data={initialBreadcrumb:this.breadcrumbs.initialBreadcrumb,activeBreadcrumb:l}}highlightBounds(e,t=!1){this.#Je.highlightBounds(e,t)}clearBoundsHighlight(){this.#Je.clearBoundsHighlight()}#tt(e,t){this.breadcrumbs&&(this.breadcrumbs.setActiveBreadcrumb(e,t),this.#Ze.data={initialBreadcrumb:this.breadcrumbs.initialBreadcrumb,activeBreadcrumb:e})}reset(){this.#Qe=null,this.#Je.reset()}#nt(e){const i=new Map,{Meta:n}=e,r=n.mainFrameNavigations,a=t.Helpers.Timing.microToMilli(n.traceBounds.min);for(const e of r){const{startTime:n}=t.Helpers.Timing.eventTimingsMilliSeconds(e);i.set(n,Tn.createEventDivider(e,a))}this.#Je.setMarkers(i)}#rt(e){this.#Je.setNavStartTimes(e.Meta.mainFrameNavigations)}getControls(){return this.#Xe}setData(e){if(this.#Qe?.parsedTrace!==e.parsedTrace){if(this.#Qe=e,this.#Xe=[],this.#nt(e.parsedTrace),this.#rt(e.parsedTrace),this.#Xe.push(new mi(e.parsedTrace)),this.#Xe.push(new pi(e.parsedTrace)),this.#Xe.push(new ci(e.parsedTrace)),e.settings.showScreenshots){const i=t.Extras.FilmStrip.fromParsedTrace(e.parsedTrace);i.frames.length&&this.#Xe.push(new ui(i))}e.settings.showMemory&&this.#Xe.push(new gi(e.parsedTrace)),this.#Je.setOverviewControls(this.#Xe),this.#Je.showingScreenshots=e.settings.showScreenshots,this.#at()}}#at(){if(this.breadcrumbs=Ve.activeManager()?.getTimelineBreadcrumbs()??null,!this.breadcrumbs)return;let e=this.breadcrumbs.initialBreadcrumb;for(;null!==e.child;)e=e.child;this.#Ze.data={initialBreadcrumb:this.breadcrumbs.initialBreadcrumb,activeBreadcrumb:e}}}var Ui=Object.freeze({__proto__:null,TimelineMiniMap:Hi}),Oi={cssText:`.timeline-toolbar-container{display:flex;align-items:flex-start;flex:none;background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider);& > :first-child{flex:1 1 auto}}.timeline-settings-pane{display:grid;grid-template-columns:50% 50%;flex:none;background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider);& > div{margin-left:5px;display:flex;align-items:center;gap:5px;& > select{height:var(--sys-size-9);min-width:var(--sys-size-14);border:none}}}#timeline-overview-panel{flex:none;position:relative;border-bottom:1px solid var(--sys-color-divider)}#timeline-overview-grid{background-color:var(--sys-color-cdt-base-container)}#timeline-overview-grid .timeline-grid-header{height:12px}#timeline-overview-grid .resources-dividers-label-bar{pointer-events:auto;height:12px}#timeline-overview-grid .resources-divider-label{top:1px}.timeline-details-split{flex:auto}.timeline.panel .status-pane-container{z-index:1000;display:flex;align-items:center;pointer-events:none}.timeline.panel .status-pane-container.tinted{background-color:var(--sys-color-cdt-base-container);pointer-events:auto}.timeline-landing-page.legacy > div > p{flex:none;white-space:pre-line;line-height:18px}.popover ul{margin:0;padding:0;list-style-type:none}#memory-graphs-canvas-container{overflow:hidden;flex:auto;position:relative;.no-events-found{position:absolute;font:var(--sys-typescale-body4-regular);left:var(--sys-size-5);bottom:var(--sys-size-5);p{margin:0}}}#memory-counters-graph{flex:auto}#memory-graphs-canvas-container .memory-counter-marker{position:absolute;border-radius:3px;width:5px;height:5px;margin-left:-3px;margin-top:-2px}#memory-graphs-container .timeline-memory-header{flex:0 0 26px;background-color:var(--sys-color-surface2);border-bottom:1px solid var(--sys-color-divider);justify-content:space-between}#memory-graphs-container .timeline-memory-header::after{content:"";background-image:var(--image-file-toolbarResizerVertical);background-repeat:no-repeat;background-position:right center,center;flex:20px 0 0;margin:0 4px}.timeline-memory-toolbar{flex-shrink:1}.memory-counter-value{margin:8px}#counter-values-bar{flex:0 0 20px;border-top:solid 1px var(--sys-color-divider);width:100%;overflow:hidden;line-height:18px}.timeline-details{vertical-align:top}.timeline-details-view{color:var(--sys-color-on-surface);overflow:hidden}.timeline-details-view-body{flex:auto;overflow:auto;position:relative;background-color:var(--sys-color-cdt-base-container);user-select:text}.timeline-details-view-block{flex:none;display:flex;background-color:var(--sys-color-cdt-base-container);flex-direction:column;padding-bottom:5px;border-bottom:1px solid var(--sys-color-divider)}.timeline-details-view-row{padding-left:10px;min-height:20px;line-height:16px}.timeline-details-view-block .timeline-details-stack-values{flex-direction:column!important}.timeline-details-chip-title{font-size:12px;padding:8px;display:flex;align-items:center}.timeline-details-view-block:first-child > .timeline-details-chip-title{font-size:13px}.timeline-details-view-row-title:not(:empty){color:var(--sys-color-token-subtle);overflow:hidden;padding-right:10px;display:inline-block;vertical-align:top}.timeline-details-warning{--override-details-warning-background-color:rgb(250 209 209/48%);background-color:var(--override-details-warning-background-color)}.theme-with-dark-background .timeline-details-warning,\n:host-context(.theme-with-dark-background) .timeline-details-warning{--override-details-warning-background-color:rgb(87 10 10/48%)}.timeline-details-warning .timeline-details-view-row-title{color:var(--sys-color-error)}.timeline-details-view-row-value{display:inline-block;user-select:text;text-overflow:ellipsis;overflow:visible}.timeline-details-warning .timeline-details-view-row-value{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.timeline-details-view-pie-chart-wrapper{margin:4px 0}.timeline-details-view-pie-chart{margin-top:5px}.timeline-flamechart{overflow:hidden}.brick-game{background-color:var(--sys-color-neutral-container);position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999}.game-close-button{display:flex;align-items:center;justify-content:center;width:25px;height:25px;position:absolute;right:15px;top:15px;border-radius:50%;cursor:pointer}.scorePanel{display:flex;align-items:center;justify-content:center;flex-direction:column;white-space:pre-line;padding:15px;position:absolute;left:15px;bottom:15px;border:double 7px transparent;border-radius:20px;background-origin:border-box;background-clip:content-box,border-box;font-weight:200}.confetti-100{display:block;top:0;left:0;width:100%;height:100%}.confetti-100 > .confetti-100-particle{opacity:0%;position:fixed;animation:confetti-100-animation 1s none ease-out;font-size:30px}@keyframes confetti-100-animation{0%{opacity:100%;transform:translateY(0%) translateY(0%) rotate(0deg)}100%{opacity:0%;transform:translateY(var(--to-Y)) translateX(var(--to-X)) rotate(var(--rotation))}}@media (prefers-reduced-motion){.confetti-100 > .confetti-100-particle{animation-name:dissolve}}.timeline-flamechart-resizer{flex:8px 0 0;background-color:var(--sys-color-surface2);border:1px var(--sys-color-divider);border-style:solid none;display:flex;flex-direction:row;align-items:flex-end;justify-content:center}.timeline-network-resizer-disabled > .timeline-flamechart-resizer{display:none}.timeline-flamechart-resizer::after{content:"...";font-size:14px;margin-bottom:-1px}.timeline-layers-view-properties table{width:100%;border-collapse:collapse}.timeline-layers-view-properties td{border:1px solid var(--sys-color-divider);line-height:22px}.timeline-filmstrip-preview > img{max-width:500px;max-height:300px;cursor:pointer;border:1px solid var(--sys-color-divider)}.timeline-tree-view{display:flex;overflow:hidden}.timeline-tree-view devtools-toolbar{background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider)}.timeline-tree-view .data-grid{flex:auto}.timeline-tree-view .data-grid .data-container{overflow-y:scroll}.timeline-tree-view .data-grid.data-grid-fits-viewport .corner{display:table-cell}.timeline-tree-view .data-grid table.data{background:var(--sys-color-cdt-base-container)}.timeline-tree-view .data-grid .odd{background-color:var(--sys-color-surface1)}.timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:var(--sys-color-state-hover-on-subtle)}.timeline-tree-view .data-grid td.numeric-column{text-align:right;position:relative}.timeline-tree-view .data-grid div.background-bar-text{position:relative;z-index:1}.timeline-tree-view .data-grid span.percent-column{color:var(--sys-color-token-subtle);width:45px;display:inline-block}.timeline-tree-view .data-grid tr.selected span{color:inherit}.timeline-tree-view .data-grid tr.selected{background-color:var(--sys-color-tonal-container)}.timeline-tree-view .data-grid .name-container{display:flex;align-items:center}.timeline-tree-view .data-grid .name-container .activity-icon{width:12px;height:12px;border:1px solid var(--divider-line);margin:3px 0}.timeline-tree-view .data-grid .name-container .activity-icon-container{margin-right:3px;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;width:18px;height:18px;overflow:hidden}.timeline-tree-view .data-grid .name-container .activity-warning::after{content:"[deopt]";margin:0 4px;line-height:12px;font-size:10px;color:var(--sys-color-state-disabled)}.timeline-tree-view .data-grid tr.selected .name-container .activity-warning::after{color:var(--sys-color-on-tonal-container)}.timeline-tree-view .data-grid .name-container .activity-link{flex:auto;text-align:right;overflow:hidden;text-overflow:ellipsis;margin-left:5px}.timeline-tree-view .data-grid .background-bar-container{position:absolute;inset:0 0 0 2px}.timeline-tree-view .data-grid .background-bar{height:18px;background-color:var(--sys-color-surface-yellow);border-bottom:1px solid var(--sys-color-yellow-outline);position:absolute;right:0}.timeline-tree-view .data-grid .selected .background-bar{background-color:var(--app-color-selected-progress-bar);border-bottom:1px solid var(--app-border-selected-progress-bar)}.timeline-tree-view .timeline-details-view-body .full-widget-dimmed-banner{background-color:inherit}.timeline-details .filter-input-field{width:120px}.timeline-tree-view .data-grid thead{height:21px;z-index:2}.timeline-stack-view-header{height:27px;background-color:var(--sys-color-cdt-base-container);padding:6px 10px;color:var(--sys-color-on-surface);white-space:nowrap;border-bottom:1px solid var(--sys-color-divider)}.timeline-landing-page{position:absolute;background-color:var(--sys-color-cdt-base-container)}.timeline-landing-page.legacy{justify-content:center;align-items:center;overflow:auto;font-size:13px;color:var(--sys-color-on-surface-subtle)}@media (forced-colors: active){.timeline-tree-view .data-grid .name-container .activity-icon{forced-color-adjust:none}.timeline-tree-view .data-grid tr.selected span.percent-column,\n  .timeline-tree-view .data-grid tr.selected div.background-bar-text span,\n  .timeline-tree-view .data-grid tr.selected .name-container .activity-link .devtools-link .timeline-link{color:HighlightText}.timeline-tree-view .data-grid .background-bar,\n  .timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:transparent}.timeline-tree-view .data-grid tr.selected .background-bar{background-color:transparent;border-bottom-color:HighlightText}}.timeline-details-range-summary{height:100%;margin:var(--sys-size-4) 0 0;& > devtools-performance-timeline-summary{min-width:192px}}.timeline-details-range-summary > devtools-related-insight-chips{display:none}.timeline-details-chip-title > div{width:12px;height:12px;border:1px solid var(--sys-color-divider);display:inline-block;margin-right:4px;content:" "}.timeline-landing-page.legacy > div{max-width:450px;margin:10px}.timeline-paint-profiler-log-split > div:last-child{background-color:var(--color-background-elevation-1);z-index:0}.timeline-layers-view > div:last-child,\n.timeline-layers-view-properties > div:last-child{background-color:var(--color-background-elevation-1)}.timeline.panel .status-pane-container > div{pointer-events:auto}.timeline-tree-view .data-grid .name-container div{flex:none}devtools-performance-third-party-tree-view{.background-bar-container{display:none}.timeline-tree-view devtools-toolbar{border:0}.timeline-tree-view .data-grid .odd{background:none}.timeline-tree-view .data-grid{border-width:0!important;th{background-color:var(--sys-color-cdt-base-container);font-weight:var(--ref-typeface-weight-medium);text-align:center;&.site-column{text-align:left}}tr .numeric-column,\n    tr .site-column{border-left:none;border-bottom:var(--sys-size-1) solid var(--sys-color-divider);contain:strict;padding:0;line-height:21px}.bottom-filler-td,\n    th.sortable{border:none}tr{height:22px}devtools-button{display:inline-flex;visibility:hidden;margin:0 8px 0 4px;vertical-align:top}tr.revealed:hover,\n    tr.selected{devtools-button{visibility:visible}}.corner,\n    &.data-grid-fits-viewport .corner{display:none}.data-grid-resizer:hover{background:linear-gradient(to right,transparent,transparent 2px,var(--sys-color-divider) 2px,var(--sys-color-divider) 3px,transparent 3px) no-repeat 0 0 /100% 100%}}.widget.vbox.timeline-tree-view{max-width:min(100%,550px);min-width:350px;padding:0 0 0 var(--sys-size-6);border-left:var(--sys-size-1) solid var(--sys-color-divider)}.timeline-tree-view .data-grid .name-container{display:block;padding-left:2px;.activity-name{display:inline}.activity-icon-container{display:none}.entity-badge{margin-left:var(--sys-size-4);font-weight:var(--ref-typeface-weight-medium);padding:0 var(--sys-size-2);background-color:var(--sys-color-tonal-container);border-radius:var(--sys-shape-corner-extra-small);height:16px;line-height:16px;font-size:var(--sys-typescale-body5-size);display:inline-block}}}devtools-feedback-button{float:right}devtools-toolbar{.history-dropdown-button{width:var(--sys-size-23);height:var(--sys-size-9);border-radius:var(--sys-shape-corner-extra-small);text-align:left;display:flex;padding-right:var(--sys-size-5);&:hover{background-color:var(--sys-color-state-hover-on-subtle)}&:active{background-color:var(--sys-color-state-ripple-neutral-on-subtle)}&:hover:active{background:linear-gradient(var(--sys-color-state-hover-on-subtle),var(--sys-color-state-hover-on-subtle)),linear-gradient(var(--sys-color-state-ripple-neutral-on-subtle),var(--sys-color-state-ripple-neutral-on-subtle))}&:focus-visible{outline:var(--sys-size-2) solid var(--sys-color-state-focus-ring)}&[disabled]{pointer-events:none;color:var(--sys-color-state-disabled);background-color:var(--sys-color-state-disabled-container);.content::after{background-color:var(--sys-color-state-disabled)}}& > .content{margin-left:5px;padding-right:5px;overflow:hidden;text-overflow:ellipsis;flex:1 1;min-width:35px;&::after{float:right;user-select:none;mask-image:var(--image-file-triangle-down);width:14px;height:14px;content:"";position:absolute;background-color:var(--icon-default);right:var(--sys-size-3);top:var(--sys-size-3)}}}@media (forced-colors: active){.history-dropdown-button[disabled]{opacity:100%}.history-dropdown-button > .content::after{background-color:ButtonText}.history-dropdown-button[disabled] > .content::after{background-color:GrayText}}}\n/*# sourceURL=${import.meta.resolve("./timelinePanel.css")} */\n`},_i={cssText:`.timeline-status-dialog{display:flex;flex-direction:column;padding:16px 16px 12px;align-self:center;background-color:var(--sys-color-cdt-base-container);box-shadow:var(--drop-shadow);border-radius:10px}.status-dialog-line{margin:2px;height:14px;min-height:auto;display:flex;align-items:baseline;font-variant-numeric:tabular-nums}.status-dialog-line .label{display:inline-block;width:80px;text-align:right;color:var(--sys-color-on-surface);margin-right:10px}.timeline-status-dialog .progress .indicator-container{display:inline-block;width:200px;height:8px;background-color:var(--sys-color-surface5)}.timeline-status-dialog .progress .indicator{background-color:var(--sys-color-primary);height:100%;width:0;margin:0}.timeline-status-dialog .stop-button{margin-top:8px;height:100%;align-self:flex-end}.timeline-status-dialog .stop-button button{border-radius:12px}@media (forced-colors: active){.timeline-status-dialog{border:1px solid canvastext}.timeline-status-dialog .progress .indicator-container{border:1px solid ButtonText;background-color:ButtonFace}.timeline-status-dialog .progress .indicator{forced-color-adjust:none;background-color:ButtonText}}:host{container-type:inline-size}@container (max-width: 326px){.timeline-status-dialog{box-shadow:none;.stop-button{align-self:center}}.status-dialog-line{flex-direction:column;.label{display:none}}}\n/*# sourceURL=${import.meta.resolve("./timelineStatusDialog.css")} */\n`};const Wi={frameStart:"Frame start",drawFrame:"Draw frame",layout:"Layout",rasterizing:"Rasterizing",drawing:"Drawing",painting:"Painting",system:"System",idle:"Idle",loading:"Loading",experience:"Experience",scripting:"Scripting",rendering:"Rendering",gpu:"GPU",async:"Async",messaging:"Messaging"},Vi=e.i18n.registerUIStrings("panels/timeline/UIDevtoolsUtils.ts",Wi),Gi=e.i18n.getLocalizedString.bind(void 0,Vi);let zi=null,ji=null;class $i{static isUiDevTools(){return"true"===d.Runtime.Runtime.queryParam("uiDevTools")}static categorizeEvents(){if(zi)return zi;const e=Ki,t=$i.categories(),i=t.drawing,n=t.rasterizing,r=t.layout,a=t.painting,o=t.other,l={},{TimelineRecordStyle:d}=s.EntryStyles;return l[e.ViewPaint]=new d("View::Paint",a),l[e.ViewOnPaint]=new d("View::OnPaint",a),l[e.ViewPaintChildren]=new d("View::PaintChildren",a),l[e.ViewOnPaintBackground]=new d("View::OnPaintBackground",a),l[e.ViewOnPaintBorder]=new d("View::OnPaintBorder",a),l[e.LayerPaintContentsToDisplayList]=new d("Layer::PaintContentsToDisplayList",a),l[e.ViewLayout]=new d("View::Layout",r),l[e.ViewLayoutBoundsChanged]=new d("View::Layout(bounds_changed)",r),l[e.RasterTask]=new d("RasterTask",n),l[e.RasterizerTaskImplRunOnWorkerThread]=new d("RasterizerTaskImpl::RunOnWorkerThread",n),l[e.DirectRendererDrawFrame]=new d("DirectRenderer::DrawFrame",i),l[e.BeginFrame]=new d(Gi(Wi.frameStart),i,!0),l[e.DrawFrame]=new d(Gi(Wi.drawFrame),i,!0),l[e.NeedsBeginFrameChanged]=new d("NeedsBeginFrameChanged",i,!0),l[e.ThreadControllerImplRunTask]=new d("ThreadControllerImpl::RunTask",o),zi=l,l}static categories(){if(ji)return ji;const{TimelineCategory:e,EventCategory:t}=s.EntryStyles;return ji={layout:new e(t.LAYOUT,Gi(Wi.layout),!0,"--app-color-loading-children","--app-color-loading"),rasterizing:new e(t.RASTERIZING,Gi(Wi.rasterizing),!0,"--app-color-children","--app-color-scripting"),drawing:new e(t.DRAWING,Gi(Wi.drawing),!0,"--app-color-rendering-children","--app-color-rendering"),painting:new e(t.PAINTING,Gi(Wi.painting),!0,"--app-color-painting-children","--app-color-painting"),other:new e(t.OTHER,Gi(Wi.system),!1,"--app-color-system-children","--app-color-system"),idle:new e(t.IDLE,Gi(Wi.idle),!1,"--app-color-idle-children","--app-color-idle"),loading:new e(t.LOADING,Gi(Wi.loading),!1,"--app-color-loading-children","--app-color-loading"),experience:new e(t.EXPERIENCE,Gi(Wi.experience),!1,"--app-color-rendering-children","--pp-color-rendering"),messaging:new e(t.MESSAGING,Gi(Wi.messaging),!1,"--app-color-messaging-children","--pp-color-messaging"),scripting:new e(t.SCRIPTING,Gi(Wi.scripting),!1,"--app-color-scripting-children","--pp-color-scripting"),rendering:new e(t.RENDERING,Gi(Wi.rendering),!1,"--app-color-rendering-children","--pp-color-rendering"),gpu:new e(t.GPU,Gi(Wi.gpu),!1,"--app-color-painting-children","--app-color-painting"),async:new e(t.ASYNC,Gi(Wi.async),!1,"--app-color-async-children","--app-color-async")},ji}static getMainCategoriesList(){return["idle","drawing","painting","rasterizing","layout","other"]}}var Ki;!function(e){e.ViewPaint="View::Paint",e.ViewOnPaint="View::OnPaint",e.ViewPaintChildren="View::PaintChildren",e.ViewOnPaintBackground="View::OnPaintBackground",e.ViewOnPaintBorder="View::OnPaintBorder",e.ViewLayout="View::Layout",e.ViewLayoutBoundsChanged="View::Layout(bounds_changed)",e.LayerPaintContentsToDisplayList="Layer::PaintContentsToDisplayList",e.DirectRendererDrawFrame="DirectRenderer::DrawFrame",e.RasterTask="RasterTask",e.RasterizerTaskImplRunOnWorkerThread="RasterizerTaskImpl::RunOnWorkerThread",e.BeginFrame="BeginFrame",e.DrawFrame="DrawFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.ThreadControllerImplRunTask="ThreadControllerImpl::RunTask"}(Ki||(Ki={}));var qi=Object.freeze({__proto__:null,get RecordType(){return Ki},UIDevtoolsUtils:$i});class Yi extends ri{constructor(e,t,i){super(e,t,i),s.EntryStyles.setEventStylesMap($i.categorizeEvents()),s.EntryStyles.setCategories($i.categories()),s.EntryStyles.setTimelineMainEventCategories($i.getMainCategoriesList().filter(s.EntryStyles.stringIsEventCategory))}}var Ji=Object.freeze({__proto__:null,UIDevtoolsController:Yi});const Xi={dropTimelineFileOrUrlHere:"Drop timeline file or URL here",disableJavascriptSamples:"Disable JavaScript samples",enableAdvancedPaint:"Enable advanced paint instrumentation (slow)",enableSelectorStats:"Enable CSS selector stats (slow)",screenshots:"Screenshots",memory:"Memory",clear:"Clear",fixMe:"Fix me",loadProfile:"Load profile…",saveProfile:"Save profile…",saveTraceWithAnnotationsMenuOption:"Save trace",saveTraceWithoutAnnotationsMenuOption:"Save trace without annotations",captureScreenshots:"Capture screenshots",showMemoryTimeline:"Show memory timeline",captureSettings:"Capture settings",disablesJavascriptSampling:"Disables JavaScript sampling, reduces overhead when running against mobile devices",capturesAdvancedPaint:"Captures advanced paint instrumentation, introduces significant performance overhead",capturesSelectorStats:"Captures CSS selector statistics",network:"Network:",cpu:"CPU:",networkConditions:"Network conditions",failedToSaveTimelineSS:"Failed to save timeline: {PH1} ({PH2})",CpuThrottlingIsEnabled:"- CPU throttling is enabled",NetworkThrottlingIsEnabled:"- Network throttling is enabled",SignificantOverheadDueToPaint:"- Significant overhead due to paint instrumentation",SelectorStatsEnabled:"- Selector stats is enabled",JavascriptSamplingIsDisabled:"- JavaScript sampling is disabled",stoppingTimeline:"Stopping timeline…",received:"Received",processed:"Processed",close:"Close",downloadAfterError:"Download trace",recordingFailed:"Recording failed",profiling:"Profiling…",bufferUsage:"Buffer usage",loadingProfile:"Loading profile…",processingProfile:"Processing profile…",initializingProfiler:"Initializing profiler…",status:"Status",time:"Time",description:"Description",stop:"Stop",exportNormalTraces:"Basic performance traces",exportEnhancedTraces:"Enhanced performance traces",showDataAddedByExtensions:"Show data added by extensions of the Performance panel",showCustomtracks:"Show custom tracks",showSidebar:"Show sidebar",hideSidebar:"Hide sidebar",sidebarShown:"Performance sidebar shown",sidebarHidden:"Performance sidebar hidden",selectionCleared:"Selection cleared",frameSelected:"Frame selected",eventSelected:"Event {PH1} selected",learnMore:"Learn more",backToLiveMetrics:"Go back to the live metrics page",timelineScrollUpDown:"Move up/down",timelinePanLeftRight:"Move left/right",timelineZoomInOut:"Zoom in/out",timelineFastZoomInOut:"Fast zoom in/out",dimThirdParties:"Dim 3rd parties",thirdPartiesByThirdPartyWeb:"3rd parties classified by third-party-web"},Zi=e.i18n.registerUIStrings("panels/timeline/TimelinePanel.ts",Xi),Qi=e.i18n.getLocalizedString.bind(void 0,Zi);let en,tn,nn;class rn extends m.Panel.Panel{dropTarget;recordingOptionUIControls;state;recordingPageReload;millisecondsToRecordAfterLoadEvent;toggleRecordAction;recordReloadAction;#st;disableCaptureJSProfileSetting;captureLayersAndPicturesSetting;captureSelectorStatsSetting;#ot;showScreenshotsSetting;showMemorySetting;panelToolbar;panelRightToolbar;timelinePane;#Ne=new Hi;#lt={mode:"LANDING_PAGE"};#dt=null;#ct=null;#ht=new Map;#pt=new m.SplitWidget.SplitWidget(!0,!1,"timeline-panel-sidebar-state",c.Sidebar.DEFAULT_SIDEBAR_WIDTH_PX);statusPaneContainer;flameChart;searchableViewInternal;showSettingsPaneButton;showSettingsPaneSetting;settingsPane;controller;cpuProfiler;clearButton;loadButton;saveButton;homeButton;statusPane;landingPage;loader;showScreenshotsToolbarCheckbox;showMemoryToolbarCheckbox;networkThrottlingSelect;cpuThrottlingSelect;fileSelectorElement;selection=null;traceLoadStart;primaryPageTargetPromiseCallback=e=>{};primaryPageTargetPromise=new Promise((e=>{this.primaryPageTargetPromiseCallback=e}));#mt;#ut=null;#de=null;#gt=this.#vt.bind(this);#Tt=this.#pt.createShowHideSidebarButton(Qi(Xi.showSidebar),Qi(Xi.hideSidebar),Qi(Xi.sidebarShown),Qi(Xi.sidebarHidden),"timeline.sidebar");#yt=new c.Sidebar.SidebarWidget;#ft=!1;#St=null;#wt=new Map;#bt=new M.ShortcutDialog.ShortcutDialog;#Et=l.Settings.Settings.instance().createSetting("timeline.user-had-shortcuts-dialog-opened-once",!1);#Ct=document.createElement("form");#kt=m.UIUtils.createRadioButton("flamechart-selected-navigation","Modern","timeline.select-modern-navigation");#It=m.UIUtils.createRadioButton("flamechart-selected-navigation","Classic","timeline.select-classic-navigation");#Mt;constructor(e){super("timeline"),this.registerRequiredCSS(Oi);const t=document.createElement("span");t.innerHTML='<div style="\n      font-size: 12px;\n      transform: scale(1.25);\n      color: transparent;\n      background: linear-gradient(90deg,CLICK255 0 0 / 100%) 0%, rgb(255 154 0 / 100%) 10%, rgb(208 222 33 / 100%) 20%, rgb(79 220 74 / 100%) 30%, rgb(63 218 216 / 100%) 40%, rgb(47 201 226 / 100%) 50%, rgb(28 127 238 / 100%) 60%, rgb(95 21 242 / 100%) 70%, rgb(186 12 248 / 100%) 80%, rgb(251 7 217 / 100%) 90%, rgb(255 0 0 / 100%) 100%);\n      -webkit-background-clip: text;\n      ">💫</div>';const i=new I.Adorner.Adorner;i.classList.add("fix-perf-icon"),i.data={name:Qi(Xi.fixMe),content:t},this.#mt=e||this.#xt(),this.#Pt(),this.element.addEventListener("contextmenu",this.contextMenu.bind(this),!1),this.dropTarget=new m.DropTarget.DropTarget(this.element,[m.DropTarget.Type.File,m.DropTarget.Type.URI],Qi(Xi.dropTimelineFileOrUrlHere),this.handleDrop.bind(this)),this.recordingOptionUIControls=[],this.state="Idle",this.recordingPageReload=!1,this.millisecondsToRecordAfterLoadEvent=5e3,this.toggleRecordAction=m.ActionRegistry.ActionRegistry.instance().getAction("timeline.toggle-recording"),this.recordReloadAction=nn?null:m.ActionRegistry.ActionRegistry.instance().getAction("timeline.record-reload"),this.#st=new Ci(this.#Ne,tn),this.traceLoadStart=null,this.disableCaptureJSProfileSetting=l.Settings.Settings.instance().createSetting("timeline-disable-js-sampling",!1,"Session"),this.disableCaptureJSProfileSetting.setTitle(Qi(Xi.disableJavascriptSamples)),this.captureLayersAndPicturesSetting=l.Settings.Settings.instance().createSetting("timeline-capture-layers-and-pictures",!1,"Session"),this.captureLayersAndPicturesSetting.setTitle(Qi(Xi.enableAdvancedPaint)),this.captureSelectorStatsSetting=l.Settings.Settings.instance().createSetting("timeline-capture-selector-stats",!1,"Session"),this.captureSelectorStatsSetting.setTitle(Qi(Xi.enableSelectorStats)),this.showScreenshotsSetting=l.Settings.Settings.instance().createSetting("timeline-show-screenshots",!tn&&!nn),this.showScreenshotsSetting.setTitle(Qi(Xi.screenshots)),this.showScreenshotsSetting.addChangeListener(this.updateMiniMap,this),nn?this.showMemorySetting=null:(this.showMemorySetting=l.Settings.Settings.instance().createSetting("timeline-show-memory",!1),this.showMemorySetting.setTitle(Qi(Xi.memory)),this.showMemorySetting.addChangeListener(this.onMemoryModeChanged,this)),nn||(this.#dt=l.Settings.Settings.instance().createSetting("timeline-dim-third-parties",!1,"Session"),this.#dt.setTitle(Qi(Xi.dimThirdParties)),this.#dt.addChangeListener(this.onDimThirdPartiesChanged,this)),this.#ot=rn.extensionDataVisibilitySetting(),this.#ot.addChangeListener(this.#Rt,this),this.#ot.setTitle(Qi(Xi.showCustomtracks));const n=this.element.createChild("div","timeline-toolbar-container");n.setAttribute("jslog",`${v.toolbar()}`),n.role="toolbar",this.panelToolbar=n.createChild("devtools-toolbar","timeline-main-toolbar"),this.panelToolbar.role="presentation",this.panelToolbar.wrappable=!0,this.panelRightToolbar=n.createChild("devtools-toolbar"),this.panelRightToolbar.role="presentation",tn||nn||(this.createSettingsPane(),this.updateShowSettingsToolbarButton()),this.timelinePane=new m.Widget.VBox;const r=this.timelinePane.element.createChild("div","hbox");r.id="timeline-overview-panel",this.#Ne.show(r),this.#Ne.addEventListener("OverviewPaneMouseMove",(e=>{this.flameChart.addTimestampMarkerOverlay(e.data.timeInMicroSeconds)})),this.#Ne.addEventListener("OverviewPaneMouseLeave",(async()=>{await this.flameChart.removeTimestampMarkerOverlay()})),this.statusPaneContainer=this.timelinePane.element.createChild("div","status-pane-container fill"),this.createFileSelector(),o.TargetManager.TargetManager.instance().addModelListener(o.ResourceTreeModel.ResourceTreeModel,o.ResourceTreeModel.Events.Load,this.loadEventFired,this),this.flameChart=new Tr(this),this.element.addEventListener("toggle-popover",(e=>this.flameChart.togglePopover(e.detail))),this.#Mt=this.#Ft.bind(this,this.flameChart.getMainDataProvider()),this.flameChart.getMainFlameChart().addEventListener("EntryHovered",this.#Mt),this.flameChart.addEventListener("EntryLabelAnnotationClicked",(e=>{const t=yt(e.data.entry);this.select(t)})),this.searchableViewInternal=new m.SearchableView.SearchableView(this.flameChart,null),this.searchableViewInternal.setMinimumSize(0,100),this.searchableViewInternal.setMinimalSearchQuerySize(2),this.searchableViewInternal.element.classList.add("searchable-view"),this.searchableViewInternal.show(this.timelinePane.element),this.flameChart.show(this.searchableViewInternal.element),this.flameChart.setSearchableView(this.searchableViewInternal),this.searchableViewInternal.hideWidget(),this.#pt.setMainWidget(this.timelinePane),this.#pt.setSidebarWidget(this.#yt),this.#pt.enableShowModeSaving(),this.#pt.show(this.element),this.flameChart.overlays().addEventListener(f.Overlays.TimeRangeMouseOverEvent.eventName,(e=>{const{overlay:t}=e,i=f.Overlays.traceWindowContainingOverlays([t]);i&&this.#Ne.highlightBounds(i,!1)})),this.flameChart.overlays().addEventListener(f.Overlays.TimeRangeMouseOutEvent.eventName,(()=>{this.#Ne.clearBoundsHighlight()})),this.#yt.element.addEventListener(T.SidebarInsight.InsightDeactivated.eventName,(()=>{this.#Lt(null)})),this.#yt.element.addEventListener(T.SidebarInsight.InsightActivated.eventName,(e=>{const{model:t,insightSetKey:i}=e;this.#Lt({model:t,insightSetKey:i}),"ThirdParties"===t.insightKey&&window.scheduler.postTask((()=>{this.#At()}),{priority:"background"})})),this.#yt.element.addEventListener(T.SidebarInsight.InsightProvideOverlays.eventName,(e=>{const{overlays:t,options:i}=e;window.scheduler.postTask((()=>{this.flameChart.setOverlays(t,i);const e=f.Overlays.traceWindowContainingOverlays(t);e?this.#Ne.highlightBounds(e,!0):this.#Ne.clearBoundsHighlight()}),{priority:"user-visible"})})),this.#yt.contentElement.addEventListener(T.EventRef.EventReferenceClick.eventName,(e=>{this.select(yt(e.event))})),this.#yt.element.addEventListener(c.Sidebar.RemoveAnnotation.eventName,(e=>{const{removedAnnotation:t}=e;Ve.activeManager()?.removeAnnotation(t)})),this.#yt.element.addEventListener(c.Sidebar.RevealAnnotation.eventName,(e=>{this.flameChart.revealAnnotation(e.annotation)})),this.#yt.element.addEventListener(T.SidebarInsight.InsightSetHovered.eventName,(e=>{e.bounds?this.#Ne.highlightBounds(e.bounds,!0):this.#Ne.clearBoundsHighlight()})),this.#yt.element.addEventListener(T.SidebarInsight.InsightSetZoom.eventName,(e=>{a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(e.bounds,{ignoreMiniMapBounds:!0,shouldAnimate:!0})})),this.onMemoryModeChanged(),this.populateToolbar(),this.#Nt(),this.updateTimelineControls(),o.TargetManager.TargetManager.instance().addEventListener("SuspendStateChanged",this.onSuspendStateChanged,this);const s=o.TargetManager.TargetManager.instance().models(o.CPUProfilerModel.CPUProfilerModel);for(const e of s)for(const t of e.registeredConsoleProfileMessages)this.consoleProfileFinished(t);o.TargetManager.TargetManager.instance().observeModels(o.CPUProfilerModel.CPUProfilerModel,{modelAdded:e=>{e.addEventListener("ConsoleProfileFinished",(e=>this.consoleProfileFinished(e.data)))},modelRemoved:e=>{}}),o.TargetManager.TargetManager.instance().observeTargets({targetAdded:e=>{e===o.TargetManager.TargetManager.instance().primaryPageTarget()&&this.primaryPageTargetPromiseCallback(e)},targetRemoved:e=>{}})}#Lt(e){if(e&&this.#pt.showBoth(),this.#yt.setActiveInsight(e),this.flameChart.setActiveInsight(e),e){const t=new ln(e);m.Context.Context.instance().setFlavor(ln,t)}else m.Context.Context.instance().setFlavor(ln,null)}set3PCheckboxDisabled(e){d.Runtime.experiments.isEnabled("timeline-dim-unrelated-events")&&(this.#ct?.applyEnabledState(!e),this.#ct?.setIndeterminate(e))}static instance(e={forceNew:null,isNode:!1}){const{forceNew:t,isNode:i}=e;return tn=i,nn=d.Runtime.experiments.isEnabled("react-native-specific-ui"),en&&!t||(en=new rn(e.traceModel)),en}static removeInstance(){s.SourceMapsResolver.SourceMapsResolver.clearResolvedNodeNames(),t.Helpers.SyntheticEvents.SyntheticEventsManager.reset(),a.TraceBounds.BoundsManager.removeInstance(),Ve.reset(),Tt.removeInstance(),en=void 0}#xt(){const e=t.Types.Configuration.defaults();return e.showAllEvents=d.Runtime.experiments.isEnabled("timeline-show-all-events"),e.includeRuntimeCallStats=d.Runtime.experiments.isEnabled("timeline-v8-runtime-call-stats"),e.debugMode=d.Runtime.experiments.isEnabled("timeline-debug-mode"),t.TraceModel.Model.createWithAllHandlers(e)}static extensionDataVisibilitySetting(){return l.Settings.Settings.instance().createSetting("timeline-show-extension-data",!0)}searchableView(){return this.searchableViewInternal}wasShown(){super.wasShown(),m.Context.Context.instance().setFlavor(rn,this),C.userMetrics.panelLoaded("timeline","DevTools.Launch.Timeline");g.CrUXManager.instance().addEventListener("field-data-changed",this.#Dt,this),this.#Dt()}willHide(){m.Context.Context.instance().setFlavor(rn,null),this.#st.cancelIfShowing();g.CrUXManager.instance().removeEventListener("field-data-changed",this.#Dt,this)}#Dt(){const e=s.Helpers.getThrottlingRecommendations();this.cpuThrottlingSelect?.updateRecommendedOption(e.cpuOption),this.networkThrottlingSelect?.updateRecommendedConditions(e.networkConditions)}loadFromEvents(e){"Idle"===this.state&&(this.prepareToLoadTimeline(),this.loader=Ni.loadFromEvents(e,this))}getFlameChart(){return this.flameChart}getMinimap(){return this.#Ne}#Bt(e,t){return"LANDING_PAGE"===e.mode&&"LANDING_PAGE"===t.mode||("STATUS_PANE_OVERLAY"===e.mode&&"STATUS_PANE_OVERLAY"===t.mode||"VIEWING_TRACE"===e.mode&&"VIEWING_TRACE"===t.mode&&e.traceIndex===t.traceIndex)}#Ht(){this.#ut&&(s.SourceMapsResolver.SourceMapsResolver.clearResolvedNodeNames(),this.#ut.removeEventListener(s.SourceMapsResolver.SourceMappingsUpdated.eventName,this.#gt),this.#ut.uninstall(),this.#ut=null)}#Ut(){this.statusPane&&this.statusPane.remove(),this.statusPane=null}#Ot(e){if(!this.#Bt(this.#lt,e))switch("VIEWING_TRACE"===this.#lt.mode&&(this.#Ht(),this.#_t()),this.#lt=e,this.updateTimelineControls(),e.mode){case"LANDING_PAGE":return this.#Ut(),this.#Nt(),void this.searchableViewInternal.hideWidget();case"VIEWING_TRACE":return this.#Wt(),this.#Vt(),this.#Ut(),this.#Gt(),void this.flameChart.dimThirdPartiesIfRequired();case"STATUS_PANE_OVERLAY":return this.#Wt(),void this.#zt();default:r.assertNever(e,"Unsupported TimelinePanel viewMode")}}#jt(){return"VIEWING_TRACE"===this.#lt.mode?this.#lt.traceIndex:null}getParsedTraceForLayoutTests(){const e=this.#jt();if(null===e)throw new Error("No trace index active.");const t=this.#mt.parsedTrace(e);if(null===t)throw new Error("No trace engine data found.");return t}getTraceEngineRawTraceEventsForLayoutTests(){const e=this.#jt();if(null===e)throw new Error("No trace index active.");const t=this.#mt.rawTraceEvents(e);if(null===t)throw new Error("No trace engine data found.");return t}#Ft(e,i){const n=i.data;if(-1===n)return void this.#Ne.clearBoundsHighlight();const r=e.eventByIndex(n);if(!r)return;const a=t.Helpers.Timing.traceWindowFromEvent(r);this.#Ne.highlightBounds(a,!1)}loadFromCpuProfile(e){"Idle"===this.state&&null!==e&&(this.prepareToLoadTimeline(),this.loader=Ni.loadFromCpuProfile(e,this))}setState(e){this.state=e,this.updateTimelineControls()}createSettingCheckbox(e,t){const i=new m.Toolbar.ToolbarSettingCheckbox(e,t);return this.recordingOptionUIControls.push(i),i}#$t(){this.panelToolbar.hasItem(this.#Tt)||this.panelToolbar.prependToolbarItem(this.#Tt)}#Kt(){this.panelToolbar.removeToolbarItem(this.#Tt)}#qt(e){e.viewSection().appendItem(Qi(Xi.saveTraceWithAnnotationsMenuOption),(()=>{C.userMetrics.actionTaken(C.UserMetrics.Action.PerfPanelTraceExported),this.saveToFile(!1,!0)}),{jslogContext:"timeline.save-to-file-with-annotations"}),e.viewSection().appendItem(Qi(Xi.saveTraceWithoutAnnotationsMenuOption),(()=>{C.userMetrics.actionTaken(C.UserMetrics.Action.PerfPanelTraceExported),this.saveToFile()}),{jslogContext:"timeline.save-to-file-without-annotations"})}populateToolbar(){this.panelToolbar.appendToolbarItem(m.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),nn||null===this.recordReloadAction||this.panelToolbar.appendToolbarItem(m.Toolbar.Toolbar.createActionButton(this.recordReloadAction)),this.clearButton=new m.Toolbar.ToolbarButton(Qi(Xi.clear),"clear",void 0,"timeline.clear"),this.clearButton.addEventListener("Click",(()=>this.onClearButton())),this.panelToolbar.appendToolbarItem(this.clearButton),this.loadButton=new m.Toolbar.ToolbarButton(Qi(Xi.loadProfile),"import",void 0,"timeline.load-from-file"),this.loadButton.addEventListener("Click",(()=>{C.userMetrics.actionTaken(C.UserMetrics.Action.PerfPanelTraceImported),this.selectFileToLoad()})),this.saveButton=new m.Toolbar.ToolbarMenuButton(this.#qt.bind(this),!0,!0,"timeline.save-to-file-more-options","download"),this.saveButton.setTitle(Qi(Xi.saveProfile)),d.Runtime.experiments.isEnabled("timeline-enhanced-traces")&&this.saveButton.element.addEventListener("contextmenu",(e=>{if(e.preventDefault(),e.stopPropagation(),e.ctrlKey||2===e.button){const t=new m.ContextMenu.ContextMenu(e);t.saveSection().appendItem(Qi(Xi.exportNormalTraces),(()=>{this.saveToFile()})),t.saveSection().appendItem(Qi(Xi.exportEnhancedTraces),(()=>{this.saveToFile(!0)})),t.show()}else this.saveToFile()})),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.loadButton),this.panelToolbar.appendToolbarItem(this.saveButton),this.panelToolbar.appendSeparator(),tn||(this.homeButton=new m.Toolbar.ToolbarButton(Qi(Xi.backToLiveMetrics),"home",void 0,"timeline.back-to-live-metrics"),this.homeButton.addEventListener("Click",(()=>{this.#Ot({mode:"LANDING_PAGE"}),this.#st.navigateToLandingPage()})),this.panelToolbar.appendToolbarItem(this.homeButton),this.panelToolbar.appendSeparator()),this.panelToolbar.appendToolbarItem(this.#st.button()),this.panelToolbar.appendSeparator(),this.panelToolbar.appendSeparator(),tn||nn||(this.showScreenshotsToolbarCheckbox=this.createSettingCheckbox(this.showScreenshotsSetting,Qi(Xi.captureScreenshots)),this.panelToolbar.appendToolbarItem(this.showScreenshotsToolbarCheckbox)),nn||null===this.showMemorySetting||(this.showMemoryToolbarCheckbox=this.createSettingCheckbox(this.showMemorySetting,Qi(Xi.showMemoryTimeline)),this.panelToolbar.appendToolbarItem(this.showMemoryToolbarCheckbox)),this.panelToolbar.appendToolbarItem(m.Toolbar.Toolbar.createActionButton("components.collect-garbage")),this.panelToolbar.appendSeparator();const e=new c.IgnoreListSetting.IgnoreListSetting;if(this.panelToolbar.appendToolbarItem(new m.Toolbar.ToolbarItem(e)),this.#dt){const e=this.createSettingCheckbox(this.#dt,Qi(Xi.thirdPartiesByThirdPartyWeb));this.#ct=e,this.panelToolbar.appendToolbarItem(e)}if(tn){const e=new $t;this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(e)}tn||nn||(this.panelRightToolbar.appendSeparator(),this.panelRightToolbar.appendToolbarItem(this.showSettingsPaneButton))}#Yt(){const e=l.Settings.moduleSetting("flamechart-selected-navigation").get(),t=localStorage.getItem("hide-shortcuts-dialog-for-test"),i=this.#Et.get();this.#bt.prependElement(this.#Ct);const n=new m.Toolbar.ToolbarItem(this.#bt);return n.element.setAttribute("jslog",`${v.action().track({click:!0}).context("timeline.shortcuts-dialog-toggle")}`),this.panelRightToolbar.appendToolbarItem(n),this.#Jt(),this.#bt.addEventListener("click",this.#Jt.bind(this)),this.#bt.data={shortcuts:this.#Xt("classic"===e),open:!i&&"true"!==t&&!C.InspectorFrontendHost.isUnderTest()},this.#Ct.classList.add("nav-radio-buttons"),m.ARIAUtils.markAsRadioGroup(this.#Ct),this.#kt.radio.addEventListener("change",(()=>{this.#bt.data={shortcuts:this.#Xt(!1)},l.Settings.moduleSetting("flamechart-selected-navigation").set("modern")})),this.#It.radio.addEventListener("change",(()=>{this.#bt.data={shortcuts:this.#Xt(!0)},l.Settings.moduleSetting("flamechart-selected-navigation").set("classic")})),this.#Ct.appendChild(this.#kt.label),this.#Ct.appendChild(this.#It.label),this.#Et.set(!0),this.#Ct}#Jt(){const e=l.Settings.moduleSetting("flamechart-selected-navigation").get();"classic"===e?(this.#It.radio.checked=!0,C.userMetrics.navigationSettingAtFirstTimelineLoad(2)):"modern"===e&&(this.#kt.radio.checked=!0,C.userMetrics.navigationSettingAtFirstTimelineLoad(3))}#Xt(e){return e?[{title:Qi(Xi.timelineScrollUpDown),bindings:[["Shift","Scroll up/down"],["Shift","↑/↓"]]},{title:Qi(Xi.timelinePanLeftRight),bindings:[["Shift","←/→"],["Scroll left/right"],["A/D"]]},{title:Qi(Xi.timelineZoomInOut),bindings:[["Scroll up/down"],["W/S"],["+/-"]]},{title:Qi(Xi.timelineFastZoomInOut),bindings:[["Shift","W/S"],["Shift","+/-"]]}]:[{title:Qi(Xi.timelineScrollUpDown),bindings:[["Scroll up/down"],["Shift","↑/↓"]]},{title:Qi(Xi.timelinePanLeftRight),bindings:[["Shift","Scroll up/down"],["Scroll left/right"],["Shift","←/→"],["A/D"]]},{title:Qi(Xi.timelineZoomInOut),bindings:[[C.Platform.isMac()?"⌘":"Ctrl","Scroll up/down"],["W/S"],["+/-"]]},{title:Qi(Xi.timelineFastZoomInOut),bindings:[["Shift","W/S"],["Shift","+/-"]]}]}createSettingsPane(){this.showSettingsPaneSetting=l.Settings.Settings.instance().createSetting("timeline-show-settings-toolbar",!1),this.showSettingsPaneButton=new m.Toolbar.ToolbarSettingToggle(this.showSettingsPaneSetting,"gear",Qi(Xi.captureSettings),"gear-filled","timeline-settings-toggle"),o.NetworkManager.MultitargetNetworkManager.instance().addEventListener("ConditionsChanged",this.updateShowSettingsToolbarButton,this),o.CPUThrottlingManager.CPUThrottlingManager.instance().addEventListener("RateChanged",this.updateShowSettingsToolbarButton,this),this.disableCaptureJSProfileSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.captureLayersAndPicturesSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.captureSelectorStatsSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.settingsPane=this.element.createChild("div","timeline-settings-pane"),this.settingsPane.setAttribute("jslog",`${v.pane("timeline-settings-pane").track({resize:!0})}`),this.settingsPane.append(m.SettingsUI.createSettingCheckbox(this.disableCaptureJSProfileSetting.title(),this.disableCaptureJSProfileSetting,Qi(Xi.disablesJavascriptSampling)));const e=this.settingsPane.createChild("div");e.append(Qi(Xi.cpu)),this.cpuThrottlingSelect=P.ThrottlingManager.throttlingManager().createCPUThrottlingSelector(),e.append(this.cpuThrottlingSelect.control.element),this.settingsPane.append(m.SettingsUI.createSettingCheckbox(this.captureLayersAndPicturesSetting.title(),this.captureLayersAndPicturesSetting,Qi(Xi.capturesAdvancedPaint)));const t=this.settingsPane.createChild("div");t.append(Qi(Xi.network)),t.append(this.createNetworkConditionsSelectToolbarItem().element),this.settingsPane.append(m.SettingsUI.createSettingCheckbox(this.captureSelectorStatsSetting.title(),this.captureSelectorStatsSetting,Qi(Xi.capturesSelectorStats)));const i=this.createSettingCheckbox(this.#ot,Qi(Xi.showDataAddedByExtensions)),n=m.XLink.XLink.create("https://developer.chrome.com/docs/devtools/performance/extension",Qi(Xi.learnMore));n.style.marginLeft="5px",i.element.shadowRoot?.appendChild(n),this.settingsPane.append(i.element),this.showSettingsPaneSetting.addChangeListener(this.updateSettingsPaneVisibility.bind(this)),this.updateSettingsPaneVisibility()}createNetworkConditionsSelectToolbarItem(){const e=new m.Toolbar.ToolbarComboBox(null,Qi(Xi.networkConditions));return this.networkThrottlingSelect=P.ThrottlingManager.throttlingManager().createNetworkThrottlingSelector(e.element),e}prepareToLoadTimeline(){console.assert("Idle"===this.state),this.setState("Loading")}createFileSelector(){this.fileSelectorElement&&this.fileSelectorElement.remove(),this.fileSelectorElement=m.UIUtils.createFileSelectorElement(this.loadFromFile.bind(this),".json,.gz,.gzip,.cpuprofile"),this.timelinePane.element.appendChild(this.fileSelectorElement)}contextMenu(e){const t=e;if(-1!==this.flameChart.getMainFlameChart().coordinatesToEntryIndex(t.offsetX,t.offsetY))return;const i=new m.ContextMenu.ContextMenu(e,{useSoftMenu:!0});i.appendItemsAtLocation("timelineMenu"),i.show()}async saveToFile(e=!1,t=!1){if("Idle"!==this.state)return;if("VIEWING_TRACE"!==this.#lt.mode)return;let i=this.#mt.rawTraceEvents(this.#lt.traceIndex);const n=this.#mt.metadata(this.#lt.traceIndex);if(!i)return;e&&d.Runtime.experiments.isEnabled("timeline-compiled-sources")||(i=i.filter((e=>"disabled-by-default-devtools.v8-source-rundown-sources"!==e.cat))),n&&(n.modifications=t?Ve.activeManager()?.toJSON():void 0,n.enhancedTraceVersion=e?o.EnhancedTracesParser.EnhancedTracesParser.enhancedTraceVersion:void 0);const a=r.DateUtilities.toISO8601Compact(new Date);let s;s="CPUProfile"===n?.dataOrigin?`CPU-${a}.cpuprofile`:n?.enhancedTraceVersion?`EnhancedTraces-${a}.json`:`Trace-${a}.json`;try{let t;if("CPUProfile"===n?.dataOrigin){const e=i.find((e=>"CpuProfile"===e.name));if(!e?.args?.data)return;const n=e.args?.data;if(n.hasOwnProperty("cpuProfile")){t=Qt(n.cpuProfile)}}else{const r=Zt(i,{...n,sourceMaps:e?n?.sourceMaps:void 0});t=Array.from(r).join("")}if(!t)throw new Error("Trace content empty");await k.FileManager.FileManager.instance().save(s,t,!0,!1),k.FileManager.FileManager.instance().close(s)}catch(e){if(console.error(e.stack),"AbortError"===e.name)return;l.Console.Console.instance().error(Qi(Xi.failedToSaveTimelineSS,{PH1:e.message,PH2:e.name}))}}async showHistoryDropdown(){const e=await this.#st.showHistoryDropDown();e&&("LANDING_PAGE"===e.type?this.#Ot({mode:"LANDING_PAGE"}):this.#Ot({mode:"VIEWING_TRACE",traceIndex:e.parsedTraceIndex}))}navigateHistory(e){const t=this.#st.navigate(e);return t&&"TRACE_INDEX"===t.type&&this.#Ot({mode:"VIEWING_TRACE",traceIndex:t.parsedTraceIndex}),!0}#_t(){if("VIEWING_TRACE"!==this.#lt.mode)return;const e=Ve.activeManager()?.toJSON();e&&this.#mt.overrideModifications(this.#lt.traceIndex,e)}selectFileToLoad(){this.fileSelectorElement&&this.fileSelectorElement.click()}async loadFromFile(e){if("Idle"!==this.state)return;const t=e.slice(0,5e3);(await t.text()).includes("enhancedTraceVersion")?await window.scheduler.postTask((()=>{this.#Zt(e)}),{priority:"background"}):(this.loader=await Ni.loadFromFile(e,this),this.prepareToLoadTimeline()),this.createFileSelector()}#Zt(e){let t=null,i=null;const n=new URL(window.location.href),r=n.pathname.slice(0,n.pathname.lastIndexOf("/"));n.pathname=`${r}/rehydrated_devtools_app.html`,i=n.toString();const a=window;a.addEventListener("message",(function i(r){n&&r.data&&"REHYDRATING_WINDOW_READY"===r.data.type&&t?.postMessage({type:"REHYDRATING_TRACE_FILE",traceFile:e},n.origin),a.removeEventListener("message",i)})),t=a.open(i,void 0,"noopener=false,popup=true")}async loadFromURL(e){"Idle"===this.state&&(this.prepareToLoadTimeline(),this.loader=await Ni.loadFromURL(e,this))}updateMiniMap(){if("VIEWING_TRACE"!==this.#lt.mode)return;const e=this.#mt.parsedTrace(this.#lt.traceIndex),t="CPUProfile"===this.#mt.metadata(this.#lt.traceIndex)?.dataOrigin;e&&this.#Ne.setData({parsedTrace:e,isCpuProfile:t,settings:{showScreenshots:this.showScreenshotsSetting.get(),showMemory:!nn&&(this.showMemorySetting?.get()||!1)}})}onMemoryModeChanged(){this.flameChart.updateCountersGraphToggle(!nn&&(this.showMemorySetting?.get()||!1)),this.updateMiniMap(),this.doResize(),this.select(null)}onDimThirdPartiesChanged(){"VIEWING_TRACE"===this.#lt.mode&&this.flameChart.dimThirdPartiesIfRequired()}#Rt(){this.flameChart.rebuildDataForTrace()}updateSettingsPaneVisibility(){tn||nn||(this.showSettingsPaneSetting.get()?(this.showSettingsPaneButton.setToggled(!0),this.settingsPane?.classList.remove("hidden")):(this.showSettingsPaneButton.setToggled(!1),this.settingsPane?.classList.add("hidden")))}updateShowSettingsToolbarButton(){const e=[];if(1!==o.CPUThrottlingManager.CPUThrottlingManager.instance().cpuThrottlingRate()&&e.push(Qi(Xi.CpuThrottlingIsEnabled)),o.NetworkManager.MultitargetNetworkManager.instance().isThrottling()&&e.push(Qi(Xi.NetworkThrottlingIsEnabled)),this.captureLayersAndPicturesSetting.get()&&e.push(Qi(Xi.SignificantOverheadDueToPaint)),this.captureSelectorStatsSetting.get()&&e.push(Qi(Xi.SelectorStatsEnabled)),this.disableCaptureJSProfileSetting.get()&&e.push(Qi(Xi.JavascriptSamplingIsDisabled)),this.showSettingsPaneButton.setChecked(e.length>0),this.showSettingsPaneButton.element.style.setProperty("--dot-toggle-top","16px"),this.showSettingsPaneButton.element.style.setProperty("--dot-toggle-left","15px"),e.length){const t=document.createElement("div");e.forEach((e=>{t.createChild("div").textContent=e})),this.showSettingsPaneButton.setTitle(t.textContent||"")}else this.showSettingsPaneButton.setTitle(Qi(Xi.captureSettings))}setUIControlsEnabled(e){this.recordingOptionUIControls.forEach((t=>t.setEnabled(e)))}async#Qt(){if(!this.controller)return r.DevToolsPath.EmptyUrlString;const e=this.controller.primaryPageTarget.inspectedURL(),t=this.controller.primaryPageTarget.model(o.ResourceTreeModel.ResourceTreeModel),i=t&&await t.navigationHistory();if(!t||!i)return e;const{currentIndex:n,entries:a}=i;return a[n].url}async#ei(){const e=new Promise((async(e,t)=>{if(!this.controller)return void t("Could not find TimelineController");const i=this.controller.primaryPageTarget.model(o.ResourceTreeModel.ResourceTreeModel);i?(i.addEventListener(o.ResourceTreeModel.Events.FrameNavigated,(function n(r){"about:blank"===r.data.url?e():t(`Unexpected navigation to ${r.data.url}`),i?.removeEventListener(o.ResourceTreeModel.Events.FrameNavigated,n)})),await i.navigate("about:blank")):t("Could not load resourceModel")}));await e}async#ti(){try{if(this.cpuProfiler=m.Context.Context.instance().flavor(o.CPUProfilerModel.CPUProfilerModel),!this.cpuProfiler){const e=o.TargetManager.TargetManager.instance().targets().find((e=>e.type()===o.Target.Type.NODE));if(!e)throw new Error("Could not load any Node target.");e&&(this.cpuProfiler=e.model(o.CPUProfilerModel.CPUProfilerModel))}if(this.setUIControlsEnabled(!1),this.#Ot({mode:"STATUS_PANE_OVERLAY"}),!this.cpuProfiler)throw new Error("No Node target is found.");await o.TargetManager.TargetManager.instance().suspendAllTargets("performance-timeline"),await this.cpuProfiler.startRecording(),this.recordingStarted()}catch(e){await this.recordingFailed(e.message)}}async#ii(){try{const e=o.TargetManager.TargetManager.instance().rootTarget(),t=o.TargetManager.TargetManager.instance().primaryPageTarget();if(!t)throw new Error("Could not load primary page target.");if(!e)throw new Error("Could not load root target.");if($i.isUiDevTools()?this.controller=new Yi(e,t,this):this.controller=new ri(e,t,this),this.setUIControlsEnabled(!1),this.#Ot({mode:"STATUS_PANE_OVERLAY"}),!this.controller)throw new Error("Could not create Timeline controller");const i=await this.#Qt();this.recordingPageReload&&await this.#ei();const n={enableJSSampling:!this.disableCaptureJSProfileSetting.get(),capturePictures:this.captureLayersAndPicturesSetting.get(),captureFilmStrip:this.showScreenshotsSetting.get(),captureSelectorStats:this.captureSelectorStatsSetting.get()},r=await this.controller.startRecording(n);if(r.getError())throw new Error(r.getError());const a=this.recordingPageReload?{navigateToUrl:i}:void 0;this.recordingStarted(a)}catch(e){await this.recordingFailed(e.message)}}async startRecording(){console.assert(!this.statusPane,"Status pane is already opened."),this.setState("StartPending"),this.showRecordingStarted(),tn?await this.#ti():await this.#ii()}async stopRecording(){if(this.statusPane&&(this.statusPane.finish(),this.statusPane.updateStatus(Qi(Xi.stoppingTimeline)),this.statusPane.updateProgressBar(Qi(Xi.received),0)),this.setState("StopPending"),this.controller)return await this.controller.stopRecording(),this.setUIControlsEnabled(!0),await this.controller.dispose(),void(this.controller=null);if(this.cpuProfiler){const e=await this.cpuProfiler.stopRecording();this.setState("Idle"),this.loadFromCpuProfile(e),this.setUIControlsEnabled(!0),this.cpuProfiler=null,await o.TargetManager.TargetManager.instance().resumeAllTargets()}}async recordingFailed(e,t){this.statusPane&&this.statusPane.remove(),this.statusPane=new an({description:e,buttonText:Qi(Xi.close),hideStopButton:!0,showProgress:void 0,showTimer:void 0},(async()=>{this.statusPane?.remove(),await this.loadingComplete([],null,null)})),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Qi(Xi.recordingFailed)),t&&this.statusPane.enableDownloadOfEvents(t),this.setState("RecordingFailed"),this.traceLoadStart=null,this.setUIControlsEnabled(!0),this.controller&&(await this.controller.dispose(),this.controller=null),o.TargetManager.TargetManager.instance().resumeAllTargets()}onSuspendStateChanged(){this.updateTimelineControls()}consoleProfileFinished(e){this.loadFromCpuProfile(e.cpuProfile),m.InspectorView.InspectorView.instance().showPanel("timeline")}updateTimelineControls(){this.toggleRecordAction.setToggled("Recording"===this.state),this.toggleRecordAction.setEnabled("Recording"===this.state||"Idle"===this.state),nn||null===this.recordReloadAction||this.recordReloadAction.setEnabled(!tn&&"Idle"===this.state),this.#st.setEnabled("Idle"===this.state),this.clearButton.setEnabled("Idle"===this.state),this.panelToolbar.setEnabled("Loading"!==this.state),this.panelRightToolbar.setEnabled("Loading"!==this.state),this.dropTarget.setEnabled("Idle"===this.state),this.loadButton.setEnabled("Idle"===this.state),this.saveButton.setEnabled("Idle"===this.state&&this.#ni()),this.homeButton?.setEnabled("Idle"===this.state&&this.#ni()),"VIEWING_TRACE"===this.#lt.mode&&this.#$t()}async toggleRecording(){"Idle"===this.state?(this.recordingPageReload=!1,await this.startRecording(),C.userMetrics.actionTaken(C.UserMetrics.Action.TimelineStarted)):"Recording"===this.state&&await this.stopRecording()}recordReload(){"Idle"===this.state&&(this.recordingPageReload=!0,this.startRecording(),C.userMetrics.actionTaken(C.UserMetrics.Action.TimelinePageReloadStarted))}onClearButton(){this.#st.clear(),this.#mt=this.#xt(),Ve.reset(),this.#Ht(),this.flameChart.getMainDataProvider().reset(),this.flameChart.getNetworkDataProvider().reset(),this.flameChart.reset(),this.#Ot({mode:"LANDING_PAGE"})}#ni(){return"VIEWING_TRACE"===this.#lt.mode}#ri(e,t=null){if(e||d.Runtime.experiments.isEnabled("timeline-show-all-events"))return;const i=t?[t]:[Tn.visibleEventsFilter()];Tt.instance().setFilters(i)}#ai=l.Debouncer.debounce((()=>{this.#St&&(m.ARIAUtils.alert(this.#St),this.#St=null)}),1e3);#si(e){e!==this.#St&&(this.#St&&m.ARIAUtils.alert(this.#St),this.#St=e,this.#ai())}#Vt(){if("VIEWING_TRACE"!==this.#lt.mode)return;const{traceIndex:e}=this.#lt,n=this.#mt.parsedTrace(e),r=this.#mt.metadata(e),c=this.#mt.syntheticTraceEventsManager(e);if(!n||!c)return console.error(`setModelForActiveTrace was called with an invalid trace index: ${e}`),void this.#Ot({mode:"LANDING_PAGE"});t.Helpers.SyntheticEvents.SyntheticEventsManager.activate(c),i.LineLevelProfile.Performance.instance().reset(),this.#Ne.reset(),a.TraceBounds.BoundsManager.instance().resetWithNewBounds(n.Meta.traceBounds);const h=Ve.initAndActivateModificationsManager(this.#mt,e);h||console.error("ModificationsManager could not be created or activated."),this.statusPane?.updateProgressBar(Qi(Xi.processed),70);const p=this.#mt.traceInsights(e);this.flameChart.setInsights(p,this.#wt),this.flameChart.setModel(n,r),this.flameChart.resizeToPreferredHeights(),this.flameChart.setSelectionAndReveal(null),this.#yt.setParsedTrace(n,r),this.searchableViewInternal.showWidget();const m=this.#ht.get(e)??null;this.#ri(n.Meta.traceIsGeneric,m),h?.addEventListener(We.eventName,(e=>{const t=oe(e);t&&this.#si(t);const{overlay:i,action:n}=e;"Add"===n?this.flameChart.addOverlay(i):"Remove"===n?this.flameChart.removeOverlay(i):"UpdateTimeRange"===n&&ne(i)?this.flameChart.updateExistingOverlay(i,{bounds:i.bounds}):"UpdateLinkToEntry"===n&&re(i)?this.flameChart.updateExistingOverlay(i,{entryTo:i.entryTo}):"EnterLabelEditState"===n&&ae(i)&&this.flameChart.enterLabelEditMode(i);const r=h.getAnnotations(),a=this.buildColorsAnnotationsMap(r);this.#yt.setAnnotations(r,a)}));const u=this.flameChart.getMainDataProvider().compatibilityTracksAppenderInstance().threadAppenders().at(0);if(u){const e=t.Extras.MainThreadActivity.calculateWindow(n.Meta.traceBounds,u.getEntries());a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(e)}const g=Ve.activeManager();if(g){const e=g.getAnnotations(),t=this.buildColorsAnnotationsMap(e);this.#yt.setAnnotations(e,t),this.flameChart.bulkAddOverlays(g.getOverlays())}if(i.LineLevelProfile.Performance.instance().reset(),n?.Samples.profilesInProcess.size){const e=o.TargetManager.TargetManager.instance().primaryPageTarget(),t=Array.from(n.Samples.profilesInProcess).flatMap((([e,t])=>Array.from(t.values()).map((e=>e.parsedProfile))));for(const n of t)i.LineLevelProfile.Performance.instance().appendCPUProfile(n,e)}if(this.#de=new s.EntityMapper.EntityMapper(n),this.#ut=new s.SourceMapsResolver.SourceMapsResolver(n,this.#de),this.#ut.addEventListener(s.SourceMapsResolver.SourceMappingsUpdated.eventName,this.#gt),this.#ut.install(),this.#de=new s.EntityMapper.EntityMapper(n),this.statusPane?.updateProgressBar(Qi(Xi.processed),80),this.updateMiniMap(),this.statusPane?.updateProgressBar(Qi(Xi.processed),90),this.updateTimelineControls(),this.#Lt(null),this.#yt.setInsights(p),this.#wt.clear(),p)for(const[e,t]of p)for(const i of Object.values(t.model)){let t=i.relatedEvents;t?Array.isArray(t)&&(t=new Map(t.map((e=>[e,[]])))):t=new Map;for(const[n,r]of t.entries()){const t=this.#wt.get(n)??[];this.#wt.set(n,t),t.push({insightLabel:i.title,messages:r,activateInsight:()=>{this.#Lt({model:i,insightSetKey:e})}})}}this.#Gt(),1===this.#mt.size()&&d.Runtime.experiments.isEnabled("timeline-alternative-navigation")&&(this.#Yt(),"classic"===l.Settings.moduleSetting("flamechart-selected-navigation").get()?C.userMetrics.navigationSettingAtFirstTimelineLoad(0):C.userMetrics.navigationSettingAtFirstTimelineLoad(1))}#Gt(){if(null!==d.Runtime.Runtime.queryParam("disable-auto-performance-sidebar-reveal"))return;const e=this.#ft;this.#yt.userHasOpenedSidebarOnce()&&!e||this.#pt.showBoth(),this.#ft=!1}buildColorsAnnotationsMap(e){const i=new Map;for(const n of e)t.Types.File.isEntryLabelAnnotation(n)?i.set(n.entry,this.getEntryColorByEntry(n.entry)):t.Types.File.isEntriesLinkAnnotation(n)&&(i.set(n.entryFrom,this.getEntryColorByEntry(n.entryFrom)),n.entryTo&&i.set(n.entryTo,this.getEntryColorByEntry(n.entryTo)));return i}getEntryColorByEntry(e){const t=this.flameChart.getMainDataProvider().indexForEvent(e),i=this.flameChart.getNetworkDataProvider().indexForEvent(e);if(null!==t){const e=this.flameChart.getMainDataProvider().entryColor(t);return"white"===e?n.ThemeSupport.instance().getComputedValue("--app-color-system"):e}if(null!==i){return this.flameChart.getNetworkDataProvider().entryColor(i)}return console.warn("Could not get entry color for ",e),n.ThemeSupport.instance().getComputedValue("--app-color-system")}recordingStarted(e){if(e&&this.recordingPageReload&&this.controller){const t=this.controller?.primaryPageTarget.model(o.ResourceTreeModel.ResourceTreeModel);if(!t)return void this.recordingFailed("Could not navigate to original URL");t.navigate(e.navigateToUrl)}this.#Ot({mode:"STATUS_PANE_OVERLAY"}),this.setState("Recording"),this.showRecordingStarted(),this.statusPane&&(this.statusPane.enableAndFocusButton(),this.statusPane.updateStatus(Qi(Xi.profiling)),this.statusPane.updateProgressBar(Qi(Xi.bufferUsage),0),this.statusPane.startTimer())}recordingProgress(e){this.statusPane&&this.statusPane.updateProgressBar(Qi(Xi.bufferUsage),100*e)}#zt(){this.#pt.sidebarIsShowing()&&(this.#ft=!0,this.#pt.hideSidebar())}#Nt(){if(this.updateSettingsPaneVisibility(),this.#Kt(),this.#zt(),this.landingPage)this.landingPage.show(this.statusPaneContainer);else{if(nn)this.landingPage=new Jt(this.toggleRecordAction);else{const e=new c.LiveMetricsView.LiveMetricsView;e.isNode=tn,this.landingPage=x.LegacyWrapper.legacyWrapper(m.Widget.Widget,e)}this.landingPage.element.classList.add("timeline-landing-page","fill"),this.landingPage.contentElement.classList.add("fill"),this.landingPage.show(this.statusPaneContainer)}}#Wt(){this.landingPage.detach(),this.showSettingsPaneButton?.setToggled(!1),this.settingsPane?.classList.add("hidden")}async loadingStarted(){this.#Ot({mode:"STATUS_PANE_OVERLAY"}),this.statusPane&&this.statusPane.remove(),this.statusPane=new an({showProgress:!0,showTimer:void 0,hideStopButton:!0,buttonText:void 0,description:void 0},(()=>this.cancelLoading())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Qi(Xi.loadingProfile)),this.loader||this.statusPane.finish(),this.traceLoadStart=t.Types.Timing.Milli(performance.now()),await this.loadingProgress(0)}async loadingProgress(e){"number"==typeof e&&this.statusPane&&this.statusPane.updateProgressBar(Qi(Xi.received),100*e)}async processingStarted(){this.statusPane?.updateStatus(Qi(Xi.processingProfile))}#Pt(){this.#mt.addEventListener(t.TraceModel.ModelUpdateEvent.eventName,(e=>{const t=e,i=Qi(Xi.processed);if("COMPLETE"===t.data.type)this.statusPane?.updateProgressBar(i,70);else if("PROGRESS_UPDATE"===t.data.type){const e=t.data.data;this.statusPane?.updateProgressBar(i,100*e.percent*.7)}}))}#vt(){this.flameChart.getMainDataProvider().timelineData(!0),this.flameChart.getMainFlameChart().update()}async loadingComplete(e,i=null,n){this.#mt.resetProcessor(),delete this.loader;const r="StopPending"===this.state;if(this.setState("Idle"),0!==e.length)try{await this.#oi(e,r,n);const a=this.#mt.lastTraceIndex();i&&this.#ht.set(a,i),this.#Ot({mode:"VIEWING_TRACE",traceIndex:a});const s=this.#mt.parsedTrace(a);if(!s)throw new Error(`Could not get trace data at index ${a}`);r&&ut.instance().registerFreshRecording(s),this.#st.addRecording({data:{parsedTraceIndex:a,type:"TRACE_INDEX"},filmStripForPreview:t.Extras.FilmStrip.fromParsedTrace(s),parsedTrace:s,metadata:n})}catch(t){this.recordingFailed(t.message,e),console.error(t)}finally{this.recordTraceLoadMetric()}else this.#mt.size()?this.#Ot({mode:"VIEWING_TRACE",traceIndex:this.#mt.lastTraceIndex()}):this.#Ot({mode:"LANDING_PAGE"})}recordTraceLoadMetric(){if(!this.traceLoadStart)return;const e=this.traceLoadStart;requestAnimationFrame((()=>{setTimeout((()=>{const i=t.Types.Timing.Milli(performance.now()),n=performance.measure("TraceLoad",{start:e,end:i}),r=t.Types.Timing.Milli(n.duration);this.element.dispatchEvent(new de(r)),C.userMetrics.performanceTraceLoad(n)}),0)}))}async#li(e,t){const i=async e=>{if(!e.sourceMapUrl||e.sourceMapUrl.startsWith("data:"))return;if(t.sourceMaps?.find((t=>t.sourceMapUrl===e.sourceMapUrl)))return;let i=e.sourceMap?.json();if(!i){const t={target:null,frameId:e.frame,initiatorUrl:e.url};i=await o.SourceMapManager.tryLoadSourceMap(e.sourceMapUrl,t)}e.url&&i&&t.sourceMaps?.push({url:e.url,sourceMapUrl:e.sourceMapUrl,sourceMap:i})};t.sourceMaps=[];const n=[];for(const t of e?.Scripts.scripts.values()??[])n.push(i(t));await Promise.all(n)}#di(e,t){if(!d.Runtime.experiments.isEnabled("timeline-experimental-insights"))return;const i=new Map;for(const e of o.TargetManager.TargetManager.instance().targets()){const t=e.model(o.DebuggerModel.DebuggerModel);if(!t)continue;const n=e.model(o.ResourceTreeModel.ResourceTreeModel),r=(n?.frames()??[]).map((e=>e.id));for(const e of r)i.set(e,t)}return async function(n){const{scriptId:r,scriptUrl:a,sourceMapUrl:s,frame:l,cachedRawSourceMap:d}=n;if(d)return new o.SourceMap.SourceMap(a,s,d);if(e){const e=await async function(e,t,n){const r=i.get(e);if(!r)return;const a=r.scriptForId(t);return!a||n&&n!==a.sourceURL?void 0:await r.sourceMapManager().sourceMapForClientPromise(a)}(l,r,a);if(e)return e}const c=s.startsWith("data:");if(!e&&t?.sourceMaps&&!c){const e=t.sourceMaps.find((e=>e.sourceMapUrl===s));if(e)return new o.SourceMap.SourceMap(a,s,e.sourceMap)}if(!e&&!c)return null;if(!a)return null;const h={target:null,frameId:l,initiatorUrl:a},p=await o.SourceMapManager.tryLoadSourceMap(s,h);return p?new o.SourceMap.SourceMap(a,s,p):null}}async#oi(e,t,i){if(await this.#mt.parse(e,{metadata:i??void 0,isFreshRecording:t,resolveSourceMap:this.#di(t,i)}),t&&i&&d.Runtime.experiments.isEnabled("timeline-enhanced-traces")){const e=this.#mt.lastTraceIndex(),t=this.#mt.parsedTrace(e);t&&await this.#li(t,i)}}loadingCompleteForTest(){}showRecordingStarted(){this.#Ot({mode:"STATUS_PANE_OVERLAY"}),this.statusPane&&this.statusPane.remove(),this.statusPane=new an({showTimer:!0,showProgress:!0,hideStopButton:!1,description:void 0,buttonText:void 0},(()=>this.stopRecording())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Qi(Xi.initializingProfiler))}cancelLoading(){this.loader&&this.loader.cancel()}async loadEventFired(e){if("Recording"!==this.state||!this.recordingPageReload||!this.controller||this.controller.primaryPageTarget!==e.data.resourceTreeModel.target())return;const t=this.controller;await new Promise((e=>window.setTimeout(e,this.millisecondsToRecordAfterLoadEvent))),t===this.controller&&"Recording"===this.state&&this.stopRecording()}frameForSelection(e){if("VIEWING_TRACE"!==this.#lt.mode)return null;if(wt(e))return null;if(t.Types.Events.isSyntheticNetworkRequest(e.event))return null;const i=this.#mt.parsedTrace(this.#lt.traceIndex);if(!i)return null;const n=bt(e).max;return t.Handlers.ModelHandlers.Frames.framesWithinWindow(i.Frames.frames,n,n).at(0)||null}jumpToFrame(e){if("VIEWING_TRACE"!==this.#lt.mode)return;const i=this.selection&&this.frameForSelection(this.selection);if(!i)return;const n=this.#mt.parsedTrace(this.#lt.traceIndex);if(!n)return;let a=n.Frames.frames.indexOf(i);console.assert(a>=0,"Can't find current frame in the frame list"),a=r.NumberUtilities.clamp(a+e,0,n.Frames.frames.length-1);const s=n.Frames.frames[a];return this.#ci(t.Helpers.Timing.microToMilli(s.startTime),t.Helpers.Timing.microToMilli(s.endTime)),this.select(yt(s)),!0}#hi(e,i){if(null!==e&&null===i&&m.ARIAUtils.alert(Qi(Xi.selectionCleared)),null===i)return;if(e&&Et(e,i))return;if(wt(i))return;if(t.Types.Events.isLegacyTimelineFrame(i.event))return void m.ARIAUtils.alert(Qi(Xi.frameSelected));const n=s.EntryName.nameForEntry(i.event);m.ARIAUtils.alert(Qi(Xi.eventSelected,{PH1:n}))}select(e){this.#hi(this.selection,e),this.selection=e,this.flameChart.setSelectionAndReveal(e)}selectEntryAtTime(e,i){if(e)if(0!==e.length){for(let n=r.ArrayUtilities.upperBound(e,i,((e,t)=>e-t.ts))-1;n>=0;--n){const r=e[n],{endTime:a}=t.Helpers.Timing.eventTimingsMilliSeconds(r);if(t.Helpers.Trace.isTopLevelEvent(r)&&a<i)break;if(Tt.instance().isVisible(r)&&a>=i)return void this.select(yt(r))}this.select(null)}else this.select(null)}highlightEvent(e){this.flameChart.highlightEvent(e)}#ci(e,i){const n=a.TraceBounds.BoundsManager.instance().state();if(!n)return;const r=n.milli.timelineTraceWindow;let s=0;r.max<i?s=i-r.max:r.min>e&&(s=e-r.min),a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(t.Helpers.Timing.traceWindowFromMilliSeconds(t.Types.Timing.Milli(r.min+s),t.Types.Timing.Milli(r.max+s)),{shouldAnimate:!0})}handleDrop(e){const t=e.items;if(!t.length)return;const i=t[0];if(C.userMetrics.actionTaken(C.UserMetrics.Action.PerfPanelTraceImported),"string"===i.kind){const t=e.getData("text/uri-list");new l.ParsedURL.ParsedURL(t).isValid&&this.loadFromURL(t)}else if("file"===i.kind){const e=t[0].getAsFile();if(!e)return;this.loadFromFile(e)}}#At(){this.flameChart.setSelectionAndReveal(null),this.flameChart.selectDetailsViewTab(ir.Details,null)}}class an extends m.Widget.VBox{status;time;progressLabel;progressBar;description;button;downloadTraceButton;startTime;timeUpdateTimer;#pi;constructor(e,t){super(!0),this.contentElement.classList.add("timeline-status-dialog"),this.contentElement.setAttribute("jslog",`${v.dialog("timeline-status").track({resize:!0})}`);const i=this.contentElement.createChild("div","status-dialog-line status");if(i.createChild("div","label").textContent=Qi(Xi.status),this.status=i.createChild("div","content"),m.ARIAUtils.markAsStatus(this.status),e.showTimer){const e=this.contentElement.createChild("div","status-dialog-line time");e.createChild("div","label").textContent=Qi(Xi.time),this.time=e.createChild("div","content")}if(e.showProgress){const e=this.contentElement.createChild("div","status-dialog-line progress");this.progressLabel=e.createChild("div","label"),this.progressBar=e.createChild("div","indicator-container").createChild("div","indicator"),m.ARIAUtils.markAsProgressBar(this.progressBar)}if("string"==typeof e.description){const t=this.contentElement.createChild("div","status-dialog-line description");t.createChild("div","label").textContent=Qi(Xi.description),this.description=t.createChild("div","content"),this.description.innerText=e.description}const n=this.contentElement.createChild("div","stop-button");this.downloadTraceButton=m.UIUtils.createTextButton(Qi(Xi.downloadAfterError),(()=>{this.#mi()}),{jslogContext:"timeline.download-after-error"}),this.downloadTraceButton.disabled=!0,this.downloadTraceButton.classList.add("hidden");const r=e.buttonText||Qi(Xi.stop);this.button=m.UIUtils.createTextButton(r,t,{jslogContext:"timeline.stop-recording"}),this.button.classList.toggle("hidden",e.hideStopButton),n.append(this.downloadTraceButton),n.append(this.button)}finish(){this.stopTimer(),this.button.classList.add("hidden")}async#mi(){if(!this.#pi||0===this.#pi.length)return;const e=`Trace-Load-Error-${r.DateUtilities.toISO8601Compact(new Date)}.json`,t=Zt(this.#pi,{}),i=Array.from(t).join("");await k.FileManager.FileManager.instance().save(e,i,!0,!1),k.FileManager.FileManager.instance().close(e)}enableDownloadOfEvents(e){this.#pi=e,this.downloadTraceButton.disabled=!1,this.downloadTraceButton.classList.remove("hidden")}remove(){this.element.parentNode?.classList.remove("tinted"),this.stopTimer(),this.element.remove()}showPane(e){this.show(e),e.classList.add("tinted")}enableAndFocusButton(){this.button.classList.remove("hidden"),this.button.focus()}updateStatus(e){this.status.textContent=e}updateProgressBar(e,t){this.progressLabel.textContent=e,this.progressBar.style.width=t.toFixed(1)+"%",m.ARIAUtils.setValueNow(this.progressBar,t),this.updateTimer()}startTimer(){this.startTime=Date.now(),this.timeUpdateTimer=window.setInterval(this.updateTimer.bind(this),100),this.updateTimer()}stopTimer(){this.timeUpdateTimer&&(clearInterval(this.timeUpdateTimer),this.updateTimer(),delete this.timeUpdateTimer)}updateTimer(){if(!this.timeUpdateTimer||!this.time)return;const t=(Date.now()-this.startTime)/1e3;this.time.textContent=e.TimeUtilities.preciseSecondsToString(t,1)}wasShown(){super.wasShown(),this.registerRequiredCSS(_i)}}let sn;class on{static instance(e={forceNew:null}){const{forceNew:t}=e;return sn&&!t||(sn=new on),sn}handleQueryParam(e){m.ViewManager.ViewManager.instance().showView("timeline").then((async()=>{await rn.instance().loadFromURL(window.decodeURIComponent(e))}))}}class ln{insight;constructor(e){this.insight=e}}var dn=Object.freeze({__proto__:null,ActionDelegate:class{handleAction(e,t){const i=e.flavor(rn);if(null===i)return!1;switch(t){case"timeline.toggle-recording":return i.toggleRecording(),!0;case"timeline.record-reload":return i.recordReload(),!0;case"timeline.save-to-file":return i.saveToFile(),!0;case"timeline.load-from-file":return i.selectFileToLoad(),!0;case"timeline.jump-to-previous-frame":return i.jumpToFrame(-1),!0;case"timeline.jump-to-next-frame":return i.jumpToFrame(1),!0;case"timeline.show-history":return i.showHistoryDropdown(),!0;case"timeline.previous-recording":return i.navigateHistory(1),!0;case"timeline.next-recording":return i.navigateHistory(-1),!0}return!1}},EventRevealer:class{async reveal(e){await m.ViewManager.ViewManager.instance().showView("timeline"),rn.instance().select(yt(e.event))}},LoadTimelineHandler:on,SelectedInsight:ln,StatusPane:an,TimelinePanel:rn,TraceRevealer:class{async reveal(e){await m.ViewManager.ViewManager.instance().showView("timeline"),rn.instance().loadFromEvents(e.traceEvents)}},headerHeight:20,rowHeight:18});const cn=new CSSStyleSheet;cn.replaceSync(pt.cssText);const hn={emptyPlaceholder:"{PH1}",timestamp:"Timestamp",interactionID:"ID",inputDelay:"Input delay",processingDuration:"Processing duration",presentationDelay:"Presentation delay",compile:"Compile",parse:"Parse",sS:"{PH1}: {PH2}",sCollected:"{PH1} collected",sSs:"{PH1} [{PH2}…{PH3}]",sSSquareBrackets:"{PH1} [{PH2}…]",learnMore:"Learn more",compilationCacheStatus:"Compilation cache status",compilationCacheSize:"Compilation cache size",compilationCacheKind:"Compilation cache kind",scriptLoadedFromCache:"script loaded from cache",failedToLoadScriptFromCache:"failed to load script from cache",scriptNotEligibleToBeLoadedFromCache:"script not eligible",collected:"Collected",function:"Function",timerId:"Timer ID",timeout:"Timeout",repeats:"Repeats",callbackId:"Callback ID",module:"Module",script:"Script",streamed:"Streamed",eagerCompile:"Compiling all functions eagerly",url:"Url",producedCacheSize:"Produced cache size",consumedCacheSize:"Consumed cache size",location:"Location",sSCurlyBrackets:"({PH1}, {PH2})",dimensions:"Dimensions",sSDimensions:"{PH1} × {PH2}",layerRoot:"Layer root",ownerElement:"Owner element",imageUrl:"Image URL",stylesheetUrl:"Stylesheet URL",elementsAffected:"Elements affected",nodesThatNeedLayout:"Nodes that need layout",sOfS:"{PH1} of {PH2}",layoutRoot:"Layout root",message:"Message",callbackFunction:"Callback function",range:"Range",allottedTime:"Allotted time",invokedByTimeout:"Invoked by timeout",type:"Type",size:"Size",details:"Details",warning:"Warning",relatedNode:"Related node",preview:"Preview",aggregatedTime:"Aggregated time",duration:"Duration",initiatorStackTrace:"Initiator stack trace",initiatedBy:"Initiated by",initiatorFor:"Initiator for",traceEvent:"Trace event",timerInstalled:"Timer installed",animationFrameRequested:"Animation frame requested",idleCallbackRequested:"Idle callback requested",recalculationForced:"Recalculation forced",firstLayoutInvalidation:"First layout invalidation",layoutForced:"Layout forced",animating:"Animating",compositingFailed:"Compositing failed",compositingFailedAcceleratedAnimationsDisabled:"Accelerated animations disabled",compositingFailedEffectSuppressedByDevtools:"Effect suppressed by DevTools ",compositingFailedInvalidAnimationOrEffect:"Invalid animation or effect",compositingFailedEffectHasUnsupportedTimingParams:"Effect has unsupported timing parameters",compositingFailedEffectHasNonReplaceCompositeMode:'Effect has composite mode other than "replace"',compositingFailedTargetHasInvalidCompositingState:"Target has invalid compositing state",compositingFailedTargetHasIncompatibleAnimations:"Target has another animation which is incompatible",compositingFailedTargetHasCSSOffset:"Target has CSS offset",compositingFailedAnimationAffectsNonCSSProperties:"Animation affects non-CSS properties",compositingFailedTransformRelatedPropertyCannotBeAcceleratedOnTarget:"Transform-related property cannot be accelerated on target",compositingFailedTransformDependsBoxSize:"Transform-related property depends on box size",compositingFailedFilterRelatedPropertyMayMovePixels:"Filter-related property may move pixels",compositingFailedUnsupportedCSSProperty:"{propertyCount, plural,\n    =1 {Unsupported CSS property: {properties}}\n    other {Unsupported CSS properties: {properties}}\n  }",compositingFailedMixedKeyframeValueTypes:"Mixed keyframe value types",compositingFailedTimelineSourceHasInvalidCompositingState:"Timeline source has invalid compositing state",compositingFailedAnimationHasNoVisibleChange:"Animation has no visible change",compositingFailedAffectsImportantProperty:"Effect affects a property with !important",compositingFailedSVGTargetHasIndependentTransformProperty:"SVG target has independent transform property",compositingFailedUnknownReason:"Unknown Reason",stackTrace:"Stack trace",invalidations:"Invalidations ({PH1} total)",pendingFor:"Pending for",firstInvalidated:"First invalidated",paintProfiler:"Paint profiler",sAtS:"{PH1} at {PH2}",sSelf:"{PH1} (self)",sChildren:"{PH1} (children)",timeSpentInRendering:"Time spent in rendering",frame:"Frame",sAtSParentheses:"{PH1} (at {PH2})",UnknownNode:"[ unknown node ]",invalidationWithCallFrame:"{PH1} at {PH2}",outsideBreadcrumbRange:"(outside of the breadcrumb range)",entryIsHidden:"(entry is hidden)",selectorStatsTitle:"Selector stats",sSelectorStatsInfo:'Select "{PH1}" to collect detailed CSS selector matching statistics.',delay:"Delay",priority:"Priority",thirdPartyTable:"1st / 3rd party table",source:"Source",origin:"Origin"},pn=e.i18n.registerUIStrings("panels/timeline/TimelineUIUtils.ts",hn),mn=e.i18n.getLocalizedString.bind(void 0,pn);let un,gn;const{SamplesIntegrator:vn}=t.Helpers.SamplesIntegrator;class Tn{static debugModeEnabled=void 0;static getGetDebugModeEnabled(){return void 0===Tn.debugModeEnabled&&(Tn.debugModeEnabled=d.Runtime.experiments.isEnabled("timeline-debug-mode")),Tn.debugModeEnabled}static frameDisplayName(e){const t=s.SourceMapsResolver.SourceMapsResolver.resolvedCodeLocationForCallFrame(e),i=t?.name||e.functionName;if(!vn.isNativeRuntimeFrame(e))return m.UIUtils.beautifyFunctionName(i);switch(vn.nativeGroup(i)){case"Compile":return mn(hn.compile);case"Parse":return mn(hn.parse)}return i}static testContentMatching(e,i,n){const r=[Tn.eventStyle(e).title];if(t.Types.Events.isProfileCall(e)&&(n?.Samples?r.push(t.Handlers.ModelHandlers.Samples.getProfileCallFunctionName(n.Samples,e)):r.push(e.callFrame.functionName)),n){const i=t.Handlers.Helpers.getNonResolvedURL(e,n);i&&r.push(i)}Tn.getGetDebugModeEnabled()?s(e,4):s(e.args,2);const a=r.join("|").match(i);return!!a&&a.length>0;function s(e,t){if(t)for(const i in e){const n=e[i];"string"==typeof n?r.push(n):"number"==typeof n?r.push(String(n)):"object"==typeof n&&null!==n&&s(n,t-1)}}}static eventStyle(e){return t.Types.Events.isProfileCall(e)&&"(idle)"===e.callFrame.functionName?new s.EntryStyles.TimelineRecordStyle(e.name,s.EntryStyles.getCategoryStyles().idle):e.cat===t.Types.Events.Categories.Console||e.cat===t.Types.Events.Categories.UserTiming?new s.EntryStyles.TimelineRecordStyle(e.name,s.EntryStyles.getCategoryStyles().scripting):s.EntryStyles.getEventStyle(e.name)??new s.EntryStyles.TimelineRecordStyle(e.name,s.EntryStyles.getCategoryStyles().other)}static eventColor(e){if(t.Types.Events.isProfileCall(e)){const t=e.callFrame;if(Tn.isUserFrame(t))return Tn.colorForId(t.url)}if(t.Types.Extensions.isSyntheticExtensionEntry(e))return h.ExtensionUI.extensionEntryColor(e);let i=Tn.eventStyle(e).category.getComputedColorValue();if("v8.parseOnBackgroundWaiting"===e.name&&(i=s.EntryStyles.getCategoryStyles().scripting.getComputedColorValue(),!i))throw new Error("Unable to parse color from getCategoryStyles().scripting.color");return i}static eventTitle(e){if(t.Types.Events.isProfileCall(e)){const t=s.SourceMapsResolver.SourceMapsResolver.resolvedCodeLocationForEntry(e);return t?.name||Tn.frameDisplayName(e.callFrame)}if("EventTiming"===e.name&&t.Types.Events.isSyntheticInteraction(e))return s.EntryName.nameForEntry(e);const i=Tn.eventStyle(e).title;return t.Helpers.Trace.eventHasCategory(e,t.Types.Events.Categories.Console)?i:t.Types.Events.isConsoleTimeStamp(e)&&e.args.data?mn(hn.sS,{PH1:i,PH2:e.args.data.name??e.args.data.message}):t.Types.Events.isAnimation(e)&&e.args.data.name?mn(hn.sS,{PH1:i,PH2:e.args.data.name}):t.Types.Events.isDispatch(e)?mn(hn.sS,{PH1:i,PH2:e.args.data.type}):i}static isUserFrame(e){return"0"!==e.scriptId&&!e.url?.startsWith("native ")}static async buildDetailsTextForTraceEvent(i,n){let r;const a=i.args,s=i.args?.data;switch(i.name){case"GCEvent":case"MajorGC":case"MinorGC":{const t=a.usedHeapSizeBefore-a.usedHeapSizeAfter;r=mn(hn.sCollected,{PH1:e.ByteUtilities.bytesToString(t)});break}case"FunctionCall":{const{lineNumber:e,columnNumber:n}=t.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(i);void 0!==e&&void 0!==n&&(r=s.url+":"+(e+1)+":"+(n+1));break}case"EventDispatch":r=s?s.type:null;break;case"Paint":{const e=Tn.quadWidth(s.clip),t=Tn.quadHeight(s.clip);e&&t&&(r=mn(hn.sSDimensions,{PH1:e,PH2:t}));break}case"ParseHTML":{const e=a.beginData.startLine,t=a.endData?.endLine,i=u.ResourceUtils.displayNameForURL(a.beginData.url);r=t>=0?mn(hn.sSs,{PH1:i,PH2:e+1,PH3:t+1}):mn(hn.sSSquareBrackets,{PH1:i,PH2:e+1});break}case"V8.CompileModule":case"v8.produceModuleCache":r=u.ResourceUtils.displayNameForURL(a.fileName);break;case"V8.CompileScript":case"v8.produceCache":case"EvaluateScript":{const{lineNumber:e}=t.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(i),n=s?.url;n&&(r=u.ResourceUtils.displayNameForURL(n)+":"+((e||0)+1));break}case"v8.wasm.compiledModule":case"v8.wasm.moduleCacheHit":{const e=a.url;e&&(r=u.ResourceUtils.displayNameForURL(e));break}case"v8.parseOnBackground":case"v8.deserializeOnBackground":case"XHRReadyStateChange":case"XHRLoad":{const e=s.url;e&&(r=u.ResourceUtils.displayNameForURL(e));break}case"TimeStamp":r=s.message;break;case"WebSocketCreate":case"WebSocketSendHandshakeRequest":case"WebSocketReceiveHandshakeResponse":case"WebSocketSend":case"WebSocketReceive":case"WebSocketDestroy":case"ResourceWillSendRequest":case"ResourceSendRequest":case"ResourceReceivedData":case"ResourceReceiveResponse":case"ResourceFinish":case"PaintImage":case"Decode Image":case"Decode LazyPixelRef":{const e=t.Handlers.Helpers.getNonResolvedURL(i,n);e&&(r=u.ResourceUtils.displayNameForURL(e));break}case"EmbedderCallback":r=s.callbackName;break;case"AsyncTask":r=s?s.name:null;break;default:r=t.Helpers.Trace.eventHasCategory(i,t.Types.Events.Categories.Console)?null:function(){const e=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(i)?.at(0)??null;if(!e)return null;return e.url+":"+(e.lineNumber+1)+":"+(e.columnNumber+1)}()}return r}static async buildDetailsNodeForTraceEvent(e,i,n,r=!1,a){let s,o=null;const l=e.args,d=e.args?.data;switch(e.name){case"GCEvent":case"MajorGC":case"MinorGC":case"EventDispatch":case"Paint":case"Animation":case"EmbedderCallback":case"ParseHTML":case"v8.wasm.streamFromResponseCallback":case"v8.wasm.compiledModule":case"v8.wasm.moduleCacheHit":case"v8.wasm.cachedModule":case"v8.wasm.moduleCacheInvalid":case"WebSocketCreate":case"WebSocketSendHandshakeRequest":case"WebSocketReceiveHandshakeResponse":case"WebSocketSend":case"WebSocketReceive":case"WebSocketDestroy":s=await Tn.buildDetailsTextForTraceEvent(e,a);break;case"PaintImage":case"Decode Image":case"Decode LazyPixelRef":case"XHRReadyStateChange":case"XHRLoad":case"ResourceWillSendRequest":case"ResourceSendRequest":case"ResourceReceivedData":case"ResourceReceiveResponse":case"ResourceFinish":{const i=t.Handlers.Helpers.getNonResolvedURL(e,a);if(i){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};o=S.Linkifier.Linkifier.linkifyURL(i,e)}break}case"FunctionCall":{o=document.createElement("span");const a=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(e)?.at(0);t.Types.Events.isFunctionCall(e)&&a&&m.UIUtils.createTextChild(o,Tn.frameDisplayName({...a,scriptId:String(a.scriptId)}));const s=this.linkifyLocation({scriptId:d.scriptId,url:d.url,lineNumber:a?.lineNumber||0,columnNumber:a?.columnNumber,target:i,isFreshRecording:r,linkifier:n,omitOrigin:!0});s&&(m.UIUtils.createTextChild(o," @ "),o.appendChild(s));break}case"V8.CompileModule":case"v8.produceModuleCache":o=this.linkifyLocation({scriptId:null,url:l.fileName,lineNumber:0,columnNumber:0,target:i,isFreshRecording:r,linkifier:n});break;case"V8.CompileScript":case"v8.produceCache":case"EvaluateScript":{const a=d.url;if(a){const{lineNumber:s}=t.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(e);o=this.linkifyLocation({scriptId:null,url:a,lineNumber:s||0,columnNumber:0,target:i,isFreshRecording:r,linkifier:n,omitOrigin:!0})}break}case"v8.deserializeOnBackground":case"v8.parseOnBackground":{const e=d.url;e&&(o=this.linkifyLocation({scriptId:null,url:e,lineNumber:0,columnNumber:0,target:i,isFreshRecording:r,linkifier:n,omitOrigin:!0}));break}default:t.Helpers.Trace.eventHasCategory(e,t.Types.Events.Categories.Console)||t.Types.Events.isUserTiming(e)||t.Types.Extensions.isSyntheticExtensionEntry(e)||t.Types.Events.isProfileCall(e)?s=null:o=this.linkifyTopCallFrame(e,i,n,r)??null}return!o&&s&&(o=document.createTextNode(s)),o}static linkifyLocation(e){const{scriptId:t,url:i,lineNumber:n,columnNumber:r,isFreshRecording:a,linkifier:s,target:o,omitOrigin:l}=e,d={lineNumber:n,columnNumber:r,showColumnNumber:!0,inlineFrameIndex:0,className:"timeline-details",tabStop:!0,omitOrigin:l};return a?s.linkifyScriptLocation(o,t,i,n,d):S.Linkifier.Linkifier.linkifyURL(i,d)}static linkifyTopCallFrame(e,i,n,r=!1){let a=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(e)?.[0];if(t.Types.Events.isProfileCall(e)&&(a=e.callFrame),!a)return null;const s={className:"timeline-details",tabStop:!0,inlineFrameIndex:0,showColumnNumber:!0,columnNumber:a.columnNumber,lineNumber:a.lineNumber};return r?n.maybeLinkifyConsoleCallFrame(i,a,{showColumnNumber:!0,inlineFrameIndex:0}):S.Linkifier.Linkifier.linkifyURL(a.url,s)}static buildDetailsNodeForMarkerEvents(e){let t="https://web.dev/user-centric-performance-metrics/",i="page performance metrics";switch(e.name){case"largestContentfulPaint::Candidate":t="https://web.dev/lcp/",i="largest contentful paint";break;case"firstContentfulPaint":t="https://web.dev/first-contentful-paint/",i="first contentful paint"}return m.Fragment.html`<div>${m.XLink.XLink.create(t,mn(hn.learnMore),void 0,void 0,"learn-more")} about ${i}.</div>`}static buildConsumeCacheDetails(t,i){if("number"==typeof t.consumedCacheSize){i.appendTextRow(mn(hn.compilationCacheStatus),mn(hn.scriptLoadedFromCache)),i.appendTextRow(mn(hn.compilationCacheSize),e.ByteUtilities.bytesToString(t.consumedCacheSize));const n=t.cacheKind;n&&i.appendTextRow(mn(hn.compilationCacheKind),n)}else"cacheRejected"in t&&t.cacheRejected?i.appendTextRow(mn(hn.compilationCacheStatus),mn(hn.failedToLoadScriptFromCache)):i.appendTextRow(mn(hn.compilationCacheStatus),mn(hn.scriptNotEligibleToBeLoadedFromCache))}static async buildTraceEventDetails(i,n,r,a,o){const h=dt(i,n),{duration:p}=t.Helpers.Timing.eventTimingsMicroSeconds(n),m=kn(n,i),u=await t.Extras.FetchNodes.extractRelatedDOMNodesFromEvent(i,n);let g,v=!1;if(h&&void 0===n[fn]){let e=null;const r=t.Handlers.Helpers.getNonResolvedURL(n,i);r?e=await S.ImagePreview.ImagePreview.build(h,r,!1,{imageAltText:S.ImagePreview.ImagePreview.defaultAltTextForImageURL(r),precomputedFeatures:void 0,align:"start"}):t.Types.Events.isPaint(n)&&(e=await Tn.buildPicturePreviewContent(i,n,h)),n[fn]=e}const T=new wn(dt(i,n),r),y=this.eventColor(n),f=i&&Cn(i,n)?Tn.markerStyleForEvent(n).color:y;T.addSection(Tn.eventTitle(n),f);const w=n.args,b=n.args?.data,E=i.Initiators.eventToInitiator.get(n)??null,C=i.Initiators.initiatorToEvents.get(n)??null;let k=null;if(i){const e=c.DetailsView.buildWarningElementsForEvent(n,i);for(const t of e)T.appendElementRow(mn(hn.warning),t,!0)}if(t.Helpers.Trace.eventHasCategory(n,t.Types.Events.Categories.UserTiming)){const t=En(n,i);T.appendTextRow(mn(hn.timestamp),e.TimeUtilities.preciseMillisToString(t,1))}if(0!==p&&!Number.isNaN(p)){const e=G(p,m);T.appendTextRow(mn(hn.duration),e)}if(t.Types.Events.isPerformanceMark(n)&&n.args.data?.detail){const e=Tn.renderObjectJson(JSON.parse(n.args.data?.detail));T.appendElementRow(mn(hn.details),e)}if(t.Types.Events.isSyntheticUserTiming(n)&&n.args?.data?.beginEvent.args.detail){const e=Tn.renderObjectJson(JSON.parse(n.args?.data?.beginEvent.args.detail));T.appendElementRow(mn(hn.details),e)}if(i.Meta.traceIsGeneric)return Tn.renderEventJson(n,T),T.fragment;if(t.Types.Events.isV8Compile(n)){if(k=n.args.data?.url,k){const{lineNumber:e,columnNumber:r}=t.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(n);T.appendLocationRow(mn(hn.script),k,e||0,r,void 0,!0);const a=this.getOriginWithEntity(o,i,n);a&&T.appendElementRow(mn(hn.origin),a),v=!0}Boolean(n.args.data?.eager)&&T.appendTextRow(mn(hn.eagerCompile),!0);const e=Boolean(n.args.data?.streamed);T.appendTextRow(mn(hn.streamed),e+(e?"":`: ${n.args.data?.notStreamedReason||""}`)),n.args.data&&Tn.buildConsumeCacheDetails(n.args.data,T)}if(t.Types.Extensions.isSyntheticExtensionEntry(n))for(const[e,t]of n.args.properties||[])T.appendTextRow(e,t);const I=Boolean(i&&ut.instance().recordingIsFresh(i));switch(n.name){case"GCEvent":case"MajorGC":case"MinorGC":{const t=w.usedHeapSizeBefore-w.usedHeapSizeAfter;T.appendTextRow(mn(hn.collected),e.ByteUtilities.bytesToString(t));break}case"ProfileCall":{const e=n,t=s.SourceMapsResolver.SourceMapsResolver.resolvedURLForEntry(i,e);if(!t)break;const r=e.callFrame,a=d.Runtime.experiments.isEnabled("react-native-specific-ui");if(a?T.reactNativeAppendLocationRow(mn(hn.source),t,r.scriptId,r.lineNumber||0,r.columnNumber,void 0,!0):T.appendLocationRow(mn(hn.source),t,r.lineNumber||0,r.columnNumber,void 0,!0),!a){const t=this.getOriginWithEntity(o,i,e);t&&T.appendElementRow(mn(hn.origin),t)}v=!0;break}case"FunctionCall":{const e=await Tn.buildDetailsNodeForTraceEvent(n,dt(i,n),r,I,i);if(e){T.appendElementRow(mn(hn.function),e);const t=this.getOriginWithEntity(o,i,n);t&&T.appendElementRow(mn(hn.origin),t),v=!0}break}case"TimerFire":case"TimerInstall":case"TimerRemove":T.appendTextRow(mn(hn.timerId),b.timerId),"TimerInstall"===n.name&&(T.appendTextRow(mn(hn.timeout),e.TimeUtilities.millisToString(b.timeout)),T.appendTextRow(mn(hn.repeats),!b.singleShot));break;case"SchedulePostTaskCallback":case"RunPostTaskCallback":T.appendTextRow(mn(hn.delay),e.TimeUtilities.millisToString(b.delay)),T.appendTextRow(mn(hn.priority),b.priority);break;case"FireAnimationFrame":T.appendTextRow(mn(hn.callbackId),b.id);break;case"V8.CompileModule":T.appendLocationRow(mn(hn.module),w.fileName,0);break;case"V8.CompileScript":break;case"v8.produceModuleCache":k=b&&b.url,T.appendTextRow(mn(hn.compilationCacheSize),e.ByteUtilities.bytesToString(b.producedCacheSize));break;case"v8.produceCache":if(k=b&&b.url,k){const{lineNumber:e,columnNumber:r}=t.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(n);T.appendLocationRow(mn(hn.script),k,e||0,r,void 0,!0);const a=this.getOriginWithEntity(o,i,n);a&&T.appendElementRow(mn(hn.origin),a),v=!0}T.appendTextRow(mn(hn.compilationCacheSize),e.ByteUtilities.bytesToString(b.producedCacheSize));break;case"EvaluateScript":if(k=b&&b.url,k){const{lineNumber:e,columnNumber:r}=t.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(n);T.appendLocationRow(mn(hn.script),k,e||0,r,void 0,!0);const a=this.getOriginWithEntity(o,i,n);a&&T.appendElementRow(mn(hn.origin),a),v=!0}break;case"v8.wasm.streamFromResponseCallback":case"v8.wasm.compiledModule":case"v8.wasm.cachedModule":case"v8.wasm.moduleCacheHit":case"v8.wasm.moduleCacheInvalid":if(b){k=w.url,k&&T.appendTextRow(mn(hn.url),k);const e=w.producedCachedSize;e&&T.appendTextRow(mn(hn.producedCacheSize),e);const t=w.consumedCachedSize;t&&T.appendTextRow(mn(hn.consumedCacheSize),t)}break;case"Paint":{const e=b.clip;T.appendTextRow(mn(hn.location),mn(hn.sSCurlyBrackets,{PH1:e[0],PH2:e[1]}));const t=Tn.quadWidth(e),i=Tn.quadHeight(e);T.appendTextRow(mn(hn.dimensions),mn(hn.sSDimensions,{PH1:t,PH2:i}))}case"PaintSetup":case"Rasterize":case"ScrollLayer":g=mn(hn.layerRoot);break;case"PaintImage":case"Decode LazyPixelRef":case"Decode Image":case"Draw LazyPixelRef":if(g=mn(hn.ownerElement),k=t.Handlers.Helpers.getNonResolvedURL(n,i),k){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};T.appendElementRow(mn(hn.imageUrl),S.Linkifier.Linkifier.linkifyURL(k,e))}break;case"ParseAuthorStyleSheet":if(k=b.styleSheetUrl,k){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};T.appendElementRow(mn(hn.stylesheetUrl),S.Linkifier.Linkifier.linkifyURL(k,e))}break;case"UpdateLayoutTree":{T.appendTextRow(mn(hn.elementsAffected),w.elementCount);const e=l.Settings.Settings.instance().createSetting("timeline-capture-selector-stats",!1);if(!e.get()){const t=document.createElement("span");t.textContent=mn(hn.sSelectorStatsInfo,{PH1:e.title()}),T.appendElementRow(mn(hn.selectorStatsTitle),t)}break}case"Layout":{const e=w.beginData;T.appendTextRow(mn(hn.nodesThatNeedLayout),mn(hn.sOfS,{PH1:e.dirtyObjects,PH2:e.totalObjects})),g=mn(hn.layoutRoot);break}case"ConsoleTime":T.appendTextRow(mn(hn.message),n.name);break;case"WebSocketCreate":case"WebSocketSendHandshakeRequest":case"WebSocketReceiveHandshakeResponse":case"WebSocketSend":case"WebSocketReceive":case"WebSocketDestroy":if(t.Types.Events.isWebSocketTraceEvent(n)){const e=c.DetailsView.buildRowsForWebSocketEvent(n,i);for(const{key:t,value:i}of e)T.appendTextRow(t,i)}break;case"EmbedderCallback":T.appendTextRow(mn(hn.callbackFunction),b.callbackName);break;case"Animation":{if(!t.Types.Events.isSyntheticAnimation(n))break;const{displayName:e,nodeName:i}=n.args.data.beginEvent.args.data;e&&T.appendTextRow(mn(hn.animating),e),!u?.size&&i&&T.appendTextRow(mn(hn.relatedNode),i);const r=t.Insights.Models.CLSCulprits.getNonCompositedFailure(n);if(!r.length)break;const a=new Set(r.map((e=>e.failureReasons)).flat().filter(Boolean)),s=new Set(r.map((e=>e.unsupportedProperties)).flat().filter(Boolean));if(0===a.size)T.appendElementRow(mn(hn.compositingFailed),mn(hn.compositingFailedUnknownReason),!0);else for(const e of a){let t;switch(e){case"ACCELERATED_ANIMATIONS_DISABLED":t=mn(hn.compositingFailedAcceleratedAnimationsDisabled);break;case"EFFECT_SUPPRESSED_BY_DEVTOOLS":t=mn(hn.compositingFailedEffectSuppressedByDevtools);break;case"INVALID_ANIMATION_OR_EFFECT":t=mn(hn.compositingFailedInvalidAnimationOrEffect);break;case"EFFECT_HAS_UNSUPPORTED_TIMING_PARAMS":t=mn(hn.compositingFailedEffectHasUnsupportedTimingParams);break;case"EFFECT_HAS_NON_REPLACE_COMPOSITE_MODE":t=mn(hn.compositingFailedEffectHasNonReplaceCompositeMode);break;case"TARGET_HAS_INVALID_COMPOSITING_STATE":t=mn(hn.compositingFailedTargetHasInvalidCompositingState);break;case"TARGET_HAS_INCOMPATIBLE_ANIMATIONS":t=mn(hn.compositingFailedTargetHasIncompatibleAnimations);break;case"TARGET_HAS_CSS_OFFSET":t=mn(hn.compositingFailedTargetHasCSSOffset);break;case"ANIMATION_AFFECTS_NON_CSS_PROPERTIES":t=mn(hn.compositingFailedAnimationAffectsNonCSSProperties);break;case"TRANSFORM_RELATED_PROPERTY_CANNOT_BE_ACCELERATED_ON_TARGET":t=mn(hn.compositingFailedTransformRelatedPropertyCannotBeAcceleratedOnTarget);break;case"TRANSFROM_BOX_SIZE_DEPENDENT":t=mn(hn.compositingFailedTransformDependsBoxSize);break;case"FILTER_RELATED_PROPERTY_MAY_MOVE_PIXELS":t=mn(hn.compositingFailedFilterRelatedPropertyMayMovePixels);break;case"UNSUPPORTED_CSS_PROPERTY":t=mn(hn.compositingFailedUnsupportedCSSProperty,{propertyCount:s.size,properties:new Intl.ListFormat(void 0,{style:"short",type:"conjunction"}).format(s)});break;case"MIXED_KEYFRAME_VALUE_TYPES":t=mn(hn.compositingFailedMixedKeyframeValueTypes);break;case"TIMELINE_SOURCE_HAS_INVALID_COMPOSITING_STATE":t=mn(hn.compositingFailedTimelineSourceHasInvalidCompositingState);break;case"ANIMATION_HAS_NO_VISIBLE_CHANGE":t=mn(hn.compositingFailedAnimationHasNoVisibleChange);break;case"AFFECTS_IMPORTANT_PROPERTY":t=mn(hn.compositingFailedAffectsImportantProperty);break;case"SVG_TARGET_HAS_INDEPENDENT_TRANSFORM_PROPERTY":t=mn(hn.compositingFailedSVGTargetHasIndependentTransformProperty);break;default:t=mn(hn.compositingFailedUnknownReason)}t&&T.appendElementRow(mn(hn.compositingFailed),t,!0)}break}case"ParseHTML":{const e=w.beginData,t=e.startLine-1,i=w.endData?w.endData.endLine-1:void 0;k=e.url,k&&T.appendLocationRange(mn(hn.range),k,t,i);break}case"FireIdleCallback":T.appendTextRow(mn(hn.allottedTime),e.TimeUtilities.millisToString(b.allottedMilliseconds)),T.appendTextRow(mn(hn.invokedByTimeout),b.timedOut);case"RequestIdleCallback":case"CancelIdleCallback":T.appendTextRow(mn(hn.callbackId),b.id);break;case"EventDispatch":T.appendTextRow(mn(hn.type),b.type);break;case"largestContentfulPaint::Candidate":T.appendTextRow(mn(hn.type),String(b.type)),T.appendTextRow(mn(hn.size),String(b.size));case"firstPaint":case"firstContentfulPaint":case"MarkLoad":case"MarkDOMContent":{const r=En(n,i);T.appendTextRow(mn(hn.timestamp),e.TimeUtilities.preciseMillisToString(r,1)),t.Types.Events.isMarkerEvent(n)&&T.appendElementRow(mn(hn.details),Tn.buildDetailsNodeForMarkerEvents(n));break}case"EventTiming":{const a=await Tn.buildDetailsNodeForTraceEvent(n,dt(i,n),r,I,i);if(a&&T.appendElementRow(mn(hn.details),a),t.Types.Events.isSyntheticInteraction(n)){const t=e.TimeUtilities.formatMicroSecondsAsMillisFixed(n.inputDelay),i=e.TimeUtilities.formatMicroSecondsAsMillisFixed(n.mainThreadHandling),r=e.TimeUtilities.formatMicroSecondsAsMillisFixed(n.presentationDelay);T.appendTextRow(mn(hn.interactionID),n.interactionId),T.appendTextRow(mn(hn.inputDelay),t),T.appendTextRow(mn(hn.processingDuration),i),T.appendTextRow(mn(hn.presentationDelay),r)}break}default:{const e=await Tn.buildDetailsNodeForTraceEvent(n,dt(i,n),r,I,i);e&&T.appendElementRow(mn(hn.details),e);break}}const M=u?.values()||[];for(const e of M)if(e){const t=await l.Linkifier.Linkifier.linkify(e);T.appendElementRow(g||mn(hn.relatedNode),t)}if(n[fn]&&(T.addSection(mn(hn.preview)),T.appendElementRow("",n[fn])),!v){const e=this.getOriginWithEntity(o,i,n);e&&T.appendElementRow(mn(hn.origin),e)}const x=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(n);(t.Types.Events.isUserTiming(n)||t.Types.Extensions.isSyntheticExtensionEntry(n)||t.Types.Events.isProfileCall(n)||E||C||x||i?.Invalidations.invalidationsForEvent.get(n))&&await Tn.generateCauses(n,T,i),d.Runtime.experiments.isEnabled("timeline-debug-mode")&&Tn.renderEventJson(n,T);const P={};if(a&&i&&Tn.aggregatedStatsForTraceEvent(P,i,n)){T.addSection(mn(hn.aggregatedTime));const e=Tn.generatePieChart(P,Tn.eventStyle(n).category,m);T.appendElementRow("",e)}return T.fragment}static statsForTimeRange(e,i,n){if(!e.length)return{idle:n-i};!function(e){if(e[bn])return;const i={},n=[];let r=0;function a(e,t){let n=i[e];if(n||(n={time:[],value:[]},i[e]=n),n.time.length&&n.time[n.time.length-1]===t||r>t)return;const a=n.value.length>0?n.value[n.value.length-1]:0;n.value.push(a+t-r),n.time.push(t)}function o(e,t,i){e&&a(e,i),r=i,t&&a(t,i)}t.Helpers.Trace.forEachEvent(e,{onStartEvent:function(e){const{startTime:i}=t.Helpers.Timing.eventTimingsMilliSeconds(e),r=s.EntryStyles.getEventStyle(e.name)?.category.name||s.EntryStyles.getCategoryStyles().other.name,a=n.length?n[n.length-1]:null;r!==a&&o(a||null,r,i),n.push(r)},onEndEvent:function(e){const{endTime:i}=t.Helpers.Timing.eventTimingsMilliSeconds(e),r=n.pop(),a=n.length?n[n.length-1]:null;r!==a&&o(r||null,a||null,i||0)}});const l=e;l[bn]=i}(e);const a=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(l(n),l(i)),o=Object.values(a).reduce(((e,t)=>e+t),0);return a.idle=Math.max(0,n-i-o),a;function l(t){const i={},n=e[bn];for(const e in n){const a=n[e],s=r.ArrayUtilities.upperBound(a.time,t,r.ArrayUtilities.DEFAULT_COMPARATOR);let o;if(0===s)o=0;else if(s===a.time.length)o=a.value[a.value.length-1];else{const e=a.time[s-1],i=a.time[s],n=a.value[s-1];o=n+(a.value[s]-n)*(t-e)/(i-e)}i[e]=o}return i}}static renderEventJson(e,t){t.addSection(mn(hn.traceEvent));const i={args:e.args,...e},n=Tn.renderObjectJson(i);t.appendElementRow("",n)}static renderObjectJson(e){const t=l.Settings.Settings.instance().moduleSetting("text-editor-indent").get().length,i=JSON.stringify(e,null,t).slice(0,1e4).replace(/{\n  /,"{ "),n=document.createElement("div"),r=m.UIUtils.createShadowRootWithCoreStyles(n,{cssFile:ht}).createChild("div");return r.classList.add("monospace","source-code"),r.textContent=i,b.CodeHighlighter.highlightNode(r,"text/javascript"),n}static stackTraceFromCallFrames(e){return{callFrames:e}}static async generateCauses(i,n,r){const{startTime:a}=t.Helpers.Timing.eventTimingsMilliSeconds(i);let s=mn(hn.initiatorStackTrace),o=mn(hn.stackTrace);const l=t.Extras.StackTraceForEvent.get(i,r),c=d.Runtime.experiments.isEnabled("react-native-specific-ui");if(l&&!c)n.addSection(mn(hn.stackTrace)),n.createChildStackTraceElement(l);else if(!c){const e=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(i);e?.length&&(n.addSection(o),n.createChildStackTraceElement(Tn.stackTraceFromCallFrames(e)))}switch(i.name){case"TimerFire":s=mn(hn.timerInstalled);break;case"FireAnimationFrame":s=mn(hn.animationFrameRequested);break;case"FireIdleCallback":s=mn(hn.idleCallbackRequested);break;case"UpdateLayoutTree":s=mn(hn.firstInvalidated),o=mn(hn.recalculationForced);break;case"Layout":s=mn(hn.firstLayoutInvalidation),o=mn(hn.layoutForced)}const h=r.Initiators.eventToInitiator.get(i),p=r.Initiators.initiatorToEvents.get(i),m=r.Invalidations.invalidationsForEvent.get(i);if(h){const i=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(h);i&&(n.addSection(s),n.createChildStackTraceElement(Tn.stackTraceFromCallFrames(i.map((e=>({...e,scriptId:String(e.scriptId)}))))));const r=this.createEntryLink(h);n.appendElementRow(mn(hn.initiatedBy),r);const{startTime:o}=t.Helpers.Timing.eventTimingsMilliSeconds(h),l=a-o;n.appendTextRow(mn(hn.pendingFor),e.TimeUtilities.preciseMillisToString(l,1))}if(p){const e=document.createElement("div");p.map(((t,i)=>{e.appendChild(this.createEntryLink(t)),i<p.length-1&&e.append(" ")})),n.appendElementRow(hn.initiatorFor,e)}if(m?.length){const e=r.Invalidations.invalidationCountForEvent.get(i)??0;n.addSection(mn(hn.invalidations,{PH1:e})),await Tn.generateInvalidationsList(m,n)}}static createEntryLink(e){const t=document.createElement("span"),i=a.TraceBounds.BoundsManager.instance().state();if(!i)return console.error("Tried to link to an entry without any traceBoundsState. This should never happen."),t;const n=i.micro.minimapTraceBounds.min>e.ts+(e.dur||0)||i.micro.minimapTraceBounds.max<e.ts,s=Ve.activeManager()?.getEntriesFilter().entryIsInvisible(e);return n||(t.classList.add("timeline-link"),m.ARIAUtils.markAsLink(t),t.tabIndex=0,t.addEventListener("click",(()=>{rn.instance().select(yt(e))})),t.addEventListener("keydown",(t=>{t.key===r.KeyboardUtilities.ENTER_KEY&&(rn.instance().select(yt(e)),t.consume(!0))}))),t.textContent=s?this.eventTitle(e)+" "+mn(hn.entryIsHidden):n?this.eventTitle(e)+" "+mn(hn.outsideBreadcrumbRange):this.eventTitle(e),t}static async generateInvalidationsList(e,t){const{groupedByReason:i,backendNodeIds:n}=c.DetailsView.generateInvalidationsList(e);let r=null;const a=o.TargetManager.TargetManager.instance().primaryPageTarget(),s=a?.model(o.DOMModel.DOMModel);s&&(r=await s.pushNodesByBackendIdsToFrontend(n)),Object.keys(i).forEach((e=>{Tn.generateInvalidationsForReason(e,i[e],r,t)}))}static generateInvalidationsForReason(i,n,r,a){function s(e){const t=e.args.data.nodeId&&r?r.get(e.args.data.nodeId):null;if(t){const e=document.createElement("span");return l.Linkifier.Linkifier.linkify(t).then((t=>e.appendChild(t))),e}if(e.args.data.nodeName){const t=document.createElement("span");return t.textContent=e.args.data.nodeName,t}const i=document.createElement("span");return m.UIUtils.createTextChild(i,mn(hn.UnknownNode)),i}const d=new Set;for(const r of n){const n=t.Helpers.Trace.getZeroIndexedStackTraceForEvent(r);let l=null;const c=n?.at(0);c&&(l=a.linkifier()?.maybeLinkifyScriptLocation(o.TargetManager.TargetManager.instance().rootTarget(),c.scriptId,c.url,c.lineNumber)||null);const h=s(r),p=l?e.i18n.getFormatLocalizedString(pn,hn.invalidationWithCallFrame,{PH1:h,PH2:l}):h,m="string"==typeof p?p:p.innerText;d.has(m)||(d.add(m),a.appendElementRow(i,p))}}static aggregatedStatsForTraceEvent(e,i,n){const a=i.Renderer?.allTraceEntries||[],{startTime:s,endTime:o}=t.Helpers.Timing.eventTimingsMicroSeconds(n);const l=r.ArrayUtilities.binaryIndexOf(a,s,(function(e,t){return e-t.ts}));if(l<0)return!1;let d=!1;if(o)for(let t=l;t<a.length;t++){const r=a[t];if(r.ts>=o)break;const s=kn(r,i);if(!s)continue;if(r.tid!==n.tid)continue;t>l&&(d=!0);const c=Tn.eventStyle(r).category.name;e[c]=(e[c]||0)+s}if(t.Types.Events.isPhaseAsync(n.ph)){if(o){let t=0;for(const i in e)t+=e[i];const i=o-s;e.idle=Math.max(0,i-t)}return!1}for(const i in e){const n=e[i];e[i]=t.Helpers.Timing.microToMilli(n)}return d}static async buildPicturePreviewContent(e,t,i){const n=e.LayerTree.paintsToSnapshots.get(t);if(!n)return null;const a=i.model(o.PaintProfiler.PaintProfilerModel);if(!a)return null;const s=await a.loadSnapshot(n.args.snapshot.skp64);if(!s)return null;const l={snapshot:s,rect:n.args.snapshot.params?.layer_rect};if(!l)return null;const d=l.snapshot.replay();l.snapshot.release();const c=await d;if(!c)return null;const h=document.createElement("div"),p=h.attachShadow({mode:"open"});p.adoptedStyleSheets=[cn];const u=p.createChild("div");u.classList.add("image-preview-container","vbox","link");const g=u.createChild("img");g.src=c,g.alt=S.ImagePreview.ImagePreview.defaultAltTextForImageURL(c);return u.createChild("a").textContent=mn(hn.paintProfiler),m.ARIAUtils.markAsLink(u),u.tabIndex=0,u.addEventListener("click",(()=>rn.instance().select(yt(t))),!1),u.addEventListener("keydown",(e=>{e.key===r.KeyboardUtilities.ENTER_KEY&&(rn.instance().select(yt(t)),e.consume(!0))})),h}static createEventDivider(i,n){const r=document.createElement("div");r.classList.add("resources-event-divider");const{startTime:a}=t.Helpers.Timing.eventTimingsMilliSeconds(i),s=e.TimeUtilities.millisToString(a-n);m.Tooltip.Tooltip.install(r,mn(hn.sAtS,{PH1:Tn.eventTitle(i),PH2:s}));const o=Tn.markerStyleForEvent(i);return o.tall&&(r.style.backgroundColor=o.color),r}static visibleEventsFilter(){return new t.Extras.TraceFilter.VisibleEventsFilter(s.EntryStyles.visibleTypes())}static categories(){return s.EntryStyles.getCategoryStyles()}static generatePieChart(n,r,a){let o=0;for(const e in n)o+=n[e];const l=document.createElement("div");l.classList.add("timeline-details-view-pie-chart-wrapper"),l.classList.add("hbox");const d=new i.PieChart.PieChart,c=[];function h(e,t,i,n){i&&c.push({value:i,color:n,title:t})}if(r){const e=t.Helpers.Timing.microToMilli(a||0);a&&h(r.name,mn(hn.sSelf,{PH1:r.title}),e,r.getCSSValue());const i=n[r.name]-(e||0);i>0&&h(r.name,mn(hn.sChildren,{PH1:r.title}),i,r.getCSSValue())}for(const e in s.EntryStyles.getCategoryStyles()){const t=s.EntryStyles.getCategoryStyles()[e];e!==r?.name&&h(t.name,t.title,n[t.name],t.getCSSValue())}d.data={chartName:mn(hn.timeSpentInRendering),size:110,formatter:t=>e.TimeUtilities.preciseMillisToString(t),showLegend:!0,total:o,slices:c};return l.createChild("div","vbox").appendChild(d),l}static generateSummaryDetails(e,i,n,r,a){const o=document.createElement("div");o.classList.add("timeline-details-range-summary","hbox");let l=0,d=[];for(const t in e)l+=e[t];for(const t in s.EntryStyles.getCategoryStyles()){const i=s.EntryStyles.getCategoryStyles()[t];if(i.name===s.EntryStyles.EventCategory.IDLE)continue;const n=e[i.name];if(!n)continue;const r=i.title,a=i.getCSSValue();d.push({value:n,color:a,title:r})}d=d.sort(((e,t)=>t.value-e.value));const h=t.Types.Timing.Milli(i),p=t.Types.Timing.Milli(n),u=new c.TimelineSummary.CategorySummary;u.data={rangeStart:h,rangeEnd:p,total:l,categories:d,selectedEvents:r},o.append(u);const g=new Wt;return g.treeView=a,m.ARIAUtils.setLabel(g,mn(hn.thirdPartyTable)),o.append(g),o}static generateDetailsContentForFrame(e,n,r){const a=new wn(null,null);a.addSection(mn(hn.frame));const s=Tn.frameDuration(e);if(a.appendElementRow(mn(hn.duration),s),n&&r){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview");const s=t.Handlers.ModelHandlers.Screenshots.screenshotImageDataUri(r.screenshotEvent);m.UIUtils.loadImage(s).then((t=>t&&e.appendChild(t))),a.appendElementRow("",e),e.addEventListener("click",function(e,t){i.FilmStripView.Dialog.fromFilmStrip(e,t.index)}.bind(null,n,r),!1)}return a.fragment}static frameDuration(i){const n=t.Helpers.Timing.microToMilli(i.startTimeOffset),r=t.Helpers.Timing.microToMilli(t.Types.Timing.Micro(i.endTime-i.startTime)),a=mn(hn.sAtSParentheses,{PH1:e.TimeUtilities.millisToString(r,!0),PH2:e.TimeUtilities.millisToString(n,!0)});return e.i18n.getFormatLocalizedString(pn,hn.emptyPlaceholder,{PH1:a})}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(un)return un;const e="hsl(40,100%,80%)",t="hsl(40,100%,50%)";return un=[new Sn(1,e,["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new Sn(1,e,["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new Sn(2,"hsl(90,100%,40%)",["wheel"]),new Sn(3,t,["click","mousedown","mouseup"]),new Sn(3,t,["touchstart","touchend","touchmove","touchcancel"]),new Sn(3,t,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new Sn(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],un}static markerStyleForEvent(e){const i=[6,4],n=Tn.eventTitle(e);if("navigationStart"!==e.name&&(t.Helpers.Trace.eventHasCategory(e,t.Types.Events.Categories.Console)||t.Helpers.Trace.eventHasCategory(e,t.Types.Events.Categories.UserTiming)))return{title:n,dashStyle:i,lineWidth:.5,color:t.Helpers.Trace.eventHasCategory(e,t.Types.Events.Categories.Console)?"purple":"orange",tall:!1,lowPriority:!1};let r=!1,a="grey";switch(e.name){case"navigationStart":a="var(--color-text-primary)",r=!0;break;case"FrameStartedLoading":a="green",r=!0;break;case"MarkDOMContent":case"MarkLoad":a="var(--color-text-disabled)",r=!0;break;case"firstPaint":a="#228847",r=!0;break;case"firstContentfulPaint":a="var(--sys-color-green-bright)",r=!0;break;case"largestContentfulPaint::Candidate":a="var(--sys-color-green)",r=!0;break;case"TimeStamp":a="orange"}return{title:n,dashStyle:i,lineWidth:.5,color:a,tall:r,lowPriority:!1}}static colorForId(e){return gn||(gn=new l.Color.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:3},85),gn.setColorForID("","#f2ecdc")),gn.colorForID(e)}static displayNameForFrame(e,t=80){const i=e.url;return l.ParsedURL.schemeIs(i,"about:")?`"${r.StringUtilities.trimMiddle(e.name,t)}"`:e.url.slice(0,t)}static getOriginWithEntity(e,t,i){const n=s.SourceMapsResolver.SourceMapsResolver.resolvedURLForEntry(t,i);if(!n)return null;const r=URL.parse(n);if(!r)return null;const a=e?.entityForEvent(i)??null;if(!a)return null;return s.Helpers.formatOriginWithEntity(r,a,!0)}}const yn=Symbol("aggregatedStats"),fn=Symbol("previewElement");class Sn{priority;color;eventTypes;constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}class wn{fragment;linkifierInternal;target;element;tableElement;constructor(e,t){this.fragment=document.createDocumentFragment(),this.linkifierInternal=t,this.target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this.tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),m.UIUtils.createTextChild(i,e)}this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this.linkifierInternal}appendTextRow(e,t){const i=this.tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t.toString()}appendElementRow(e,t,i,n){const r=this.tableElement.createChild("div","timeline-details-view-row");r.setAttribute("data-row-title",e),i&&r.classList.add("timeline-details-warning"),n&&r.classList.add("timeline-details-stack-values");r.createChild("div","timeline-details-view-row-title").textContent=e;const a=r.createChild("div","timeline-details-view-row-value");t instanceof Node?a.appendChild(t):m.UIUtils.createTextChild(a,t||"")}appendLocationRow(e,t,i,n,r,a){if(!this.linkifierInternal)return;const s={tabStop:!0,columnNumber:n,showColumnNumber:!0,inlineFrameIndex:0,text:r,omitOrigin:a},o=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,s);o&&this.appendElementRow(e,o)}reactNativeAppendLocationRow(e,t,i,n,r,a,s){if(!this.linkifierInternal)return;const o={tabStop:!0,columnNumber:r,showColumnNumber:!0,inlineFrameIndex:0,text:a,omitOrigin:s},l=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,i,t,n,o);l&&this.appendElementRow(e,l)}appendLocationRange(e,t,i,n){if(!this.linkifierInternal||!this.target)return;const a=document.createElement("span"),s=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,{tabStop:!0,inlineFrameIndex:0});s&&(a.appendChild(s),m.UIUtils.createTextChild(a,r.StringUtilities.sprintf(" [%s…%s]",i+1,(n||0)+1||"")),this.appendElementRow(e,a))}createChildStackTraceElement(e){if(!this.linkifierInternal)return;const t=structuredClone(e);let i=t;for(;i;)i.callFrames=i.callFrames.map((e=>({...e,functionName:s.SourceMapsResolver.SourceMapsResolver.resolvedCodeLocationForCallFrame(e)?.name||e.functionName}))),i=i.parent;const n=this.tableElement.createChild("div","timeline-details-view-row timeline-details-stack-values"),r=S.JSPresentationUtils.buildStackTracePreviewContents(this.target,this.linkifierInternal,{stackTrace:t,tabStops:!0,showColumnNumber:!0});n.appendChild(r.element)}}const bn=Symbol("categoryBreakdownCache");function En(e,i){if(!i){const{startTime:i}=t.Helpers.Timing.eventTimingsMilliSeconds(e);return i}const n=t.Helpers.Timing.timeStampForEventAdjustedByClosestNavigation(e,i.Meta.traceBounds,i.Meta.navigationsByNavigationId,i.Meta.navigationsByFrameId);return t.Helpers.Timing.microToMilli(n)}function Cn(e,i){const{Name:n}=t.Types.Events;if("TimeStamp"===i.name||"navigationStart"===i.name)return!0;if(t.Types.Events.isFirstContentfulPaint(i)||t.Types.Events.isFirstPaint(i))return i.args.frame===e.Meta.mainFrameId;if(t.Types.Events.isMarkDOMContent(i)||t.Types.Events.isMarkLoad(i)||t.Types.Events.isLargestContentfulPaintCandidate(i)){if(!i.args.data)return!1;const{isOutermostMainFrame:e,isMainFrame:t}=i.args.data;return void 0!==e?e:Boolean(t)}return!1}function kn(e,i){const n=t.Types.Extensions.isSyntheticExtensionEntry(e)?i.ExtensionTraceData.entryToNode:i.Renderer.entryToNode,r=n.get(e)?.selfTime;return r||t.Types.Timing.Micro(0)}var In=Object.freeze({__proto__:null,EventDispatchTypeDescriptor:Sn,TimelineDetailsContentHelper:wn,TimelineUIUtils:Tn,aggregatedStatsKey:yn,categoryBreakdownCacheSymbol:bn,isMarkerEvent:Cn,previewElementSymbol:fn,timeStampForEventAdjustedForClosestNavigationIfPossible:En});class Mn extends t.Extras.TraceFilter.TraceFilter{#ui=t.Types.Timing.Milli(0);constructor(){super()}setMinimumRecordDuration(e){this.#ui=e}accept(e){const{duration:i}=t.Helpers.Timing.eventTimingsMilliSeconds(e);return i>=this.#ui}}class xn extends t.Extras.TraceFilter.TraceFilter{constructor(){super()}accept(e){return!Tn.eventStyle(e).category.hidden}}class Pn extends t.Extras.TraceFilter.TraceFilter{regExpInternal;constructor(e){super(),this.setRegExp(e||null)}setRegExp(e){this.regExpInternal=e}regExp(){return this.regExpInternal}accept(e,t){return!this.regExpInternal||Tn.testContentMatching(e,this.regExpInternal,t)}}var Rn=Object.freeze({__proto__:null,Category:xn,IsLong:Mn,TimelineRegExp:Pn});const Fn={startTime:"Start time",durationFilter:"Duration filter",all:"All"},Ln=e.i18n.registerUIStrings("panels/timeline/EventsTimelineTreeView.ts",Fn),An=e.i18n.getLocalizedString.bind(void 0,Ln);class Nn extends xt{filtersControl;delegate;currentTree;constructor(e){super(),this.element.setAttribute("jslog",`${v.pane("event-log").track({resize:!0})}`),this.filtersControl=new Dn,this.filtersControl.addEventListener("FilterChanged",this.onFilterChanged,this),this.init(),this.delegate=e,this.dataGrid.markColumnAsSortedBy("start-time",w.DataGrid.Order.Ascending),this.splitWidget.showBoth()}filters(){return[...super.filters(),...this.filtersControl.filters()]}updateContents(e){super.updateContents(e),St(e)&&this.selectEvent(e.event,!0)}buildTree(){return this.currentTree=this.buildTopDownTree(!0,null),this.currentTree}onFilterChanged(){const e=this.lastSelectedNode(),t=e?.event;this.refreshTree(),t&&this.selectEvent(t,!1)}findNodeWithEvent(e){if("RunTask"===e.name)return null;const t=[this.currentTree.children().values()];for(;t.length;){const{done:i,value:n}=t[t.length-1].next();if(i)t.pop();else{if(n.event===e)return n;t.push(n.children().values())}}return null}selectEvent(e,t){const i=this.findNodeWithEvent(e);if(i&&(this.selectProfileNode(i,!1),t)){const e=this.dataGridNodeForTreeNode(i);e&&e.expand()}}populateColumns(e){e.push({id:"start-time",title:An(Fn.startTime),width:"80px",fixedWidth:!0,sortable:!0}),super.populateColumns(e),e.filter((e=>e.fixedWidth)).forEach((e=>{e.width="80px"}))}populateToolbar(e){super.populateToolbar(e),this.filtersControl.populateToolbar(e)}showDetailsForNode(e){const t=this.parsedTrace();if(!t)return!1;const i=e.event;return!!i&&(Tn.buildTraceEventDetails(t,i,this.linkifier,!1,null).then((e=>this.detailsView.element.appendChild(e))),!0)}onHover(e){this.delegate.highlightEvent(e?.event??null)}}class Dn extends l.ObjectWrapper.ObjectWrapper{categoryFilter;durationFilter;filtersInternal;constructor(){super(),this.categoryFilter=new xn,this.durationFilter=new Mn,this.filtersInternal=[this.categoryFilter,this.durationFilter]}filters(){return this.filtersInternal}populateToolbar(i){const n=new m.Toolbar.ToolbarComboBox(function(){const e=n.selectedOption().value,i=parseInt(e,10);this.durationFilter.setMinimumRecordDuration(t.Types.Timing.Milli(i)),this.notifyFiltersChanged()}.bind(this),An(Fn.durationFilter),void 0,"duration");for(const t of Dn.durationFilterPresetsMs)n.addOption(n.createOption(t?`≥ ${e.TimeUtilities.millisToString(t)}`:An(Fn.all),String(t)));i.appendToolbarItem(n);const r=new Map,a=s.EntryStyles.getCategoryStyles();for(const e in a){const t=a[e];if(!t.visible)continue;const n=new m.Toolbar.ToolbarCheckbox(t.title,void 0,o.bind(this,e),e);n.setChecked(!0),n.inputElement.style.backgroundColor=t.color,r.set(t.name,n),i.appendToolbarItem(n)}function o(e){const t=s.EntryStyles.getCategoryStyles(),i=r.get(e);t[e].hidden=!i?.checked(),this.notifyFiltersChanged()}}notifyFiltersChanged(){this.dispatchEventToListeners("FilterChanged")}static durationFilterPresetsMs=[0,1,15]}var Bn=Object.freeze({__proto__:null,EventsTimelineTreeView:Nn,Filters:Dn});class Hn extends m.SplitWidget.SplitWidget{showPaintProfilerCallback;rightSplitWidget;layerViewHost;layers3DView;frameLayerTree;updateWhenVisible;constructor(e){super(!0,!1,"timeline-layers-view"),this.showPaintProfilerCallback=e,this.element.classList.add("timeline-layers-view"),this.rightSplitWidget=new m.SplitWidget.SplitWidget(!0,!0,"timeline-layers-view-details"),this.rightSplitWidget.element.classList.add("timeline-layers-view-properties"),this.setMainWidget(this.rightSplitWidget);const t=new m.Widget.VBox;this.setSidebarWidget(t),this.layerViewHost=new D.LayerViewHost.LayerViewHost;const i=new D.LayerTreeOutline.LayerTreeOutline(this.layerViewHost);t.element.appendChild(i.element),this.layers3DView=new D.Layers3DView.Layers3DView(this.layerViewHost),this.layers3DView.addEventListener("PaintProfilerRequested",this.onPaintProfilerRequested,this),this.rightSplitWidget.setMainWidget(this.layers3DView);const n=new D.LayerDetailsView.LayerDetailsView(this.layerViewHost);this.rightSplitWidget.setSidebarWidget(n),n.addEventListener("PaintProfilerRequested",this.onPaintProfilerRequested,this)}showLayerTree(e){this.frameLayerTree=e,this.isShowing()?this.update():this.updateWhenVisible=!0}wasShown(){this.updateWhenVisible&&(this.updateWhenVisible=!1,this.update())}async onPaintProfilerRequested(e){const t=e.data,i=await this.layers3DView.snapshotForSelection(t);i&&this.showPaintProfilerCallback(i.snapshot)}update(){this.frameLayerTree&&this.frameLayerTree.layerTreePromise().then((e=>this.layerViewHost.setLayerTree(e)))}}var Un=Object.freeze({__proto__:null,TimelineLayersView:Hn}),On={cssText:`.paint-profiler-image-view{overflow:hidden}.paint-profiler-image-view .paint-profiler-image-container{transform-origin:0 0}.paint-profiler-image-view .paint-profiler-image-container div{border-color:1px solid var(--sys-color-divider);border-style:solid;z-index:100;position:absolute;top:0;left:0}.paint-profiler-image-view img{border:solid 1px var(--sys-color-inverse-surface)}\n/*# sourceURL=${import.meta.resolve("./timelinePaintProfiler.css")} */\n`};class _n extends o.LayerTreeBase.LayerTreeBase{tileById=new Map;paintProfilerModel;constructor(e){super(e),this.paintProfilerModel=e?.model(o.PaintProfiler.PaintProfilerModel)??null}async setLayers(e,t,i){const n=new Set;if(e)this.extractNodeIdsToResolve(n,{},e);else if(t)for(let e=0;e<t.length;++e)this.extractNodeIdsToResolve(n,{},t[e]);await this.resolveBackendNodeIds(n);const r=this.layersById;if(this.layersById=new Map,this.setContentRoot(null),e){const t=this.innerSetLayers(r,e);this.setRoot(t)}else if(t){const e=t.map(this.innerSetLayers.bind(this,r)),i=this.contentRoot();if(!i)throw new Error("Content root is not set.");this.setRoot(i);for(let t=0;t<e.length;++t)e[t].id()!==i.id()&&i.addChild(e[t])}this.setPaints(i)}setTiles(e){this.tileById=new Map;for(const t of e)this.tileById.set(t.id,t)}pictureForRasterTile(e){const t=this.tileById.get("cc::Tile/"+e);if(!t)return l.Console.Console.instance().error(`Tile ${e} is missing`),Promise.resolve(null);const i=this.layerById(t.layer_id);return i?i.pictureForRect(t.content_rect):(l.Console.Console.instance().error(`Layer ${t.layer_id} for tile ${e} is not found`),Promise.resolve(null))}setPaints(e){for(let t=0;t<e.length;++t){const i=this.layersById.get(e[t].layerId());i&&i.addPaintEvent(e[t])}}innerSetLayers(e,t){let i=e.get(t.layer_id);i?i.reset(t):i=new Vn(this.paintProfilerModel,t),this.layersById.set(t.layer_id,i),t.owner_node&&i.setNode(this.backendNodeIdToNode().get(t.owner_node)||null),!this.contentRoot()&&i.drawsContent()&&this.setContentRoot(i);for(let n=0;t.children&&n<t.children.length;++n)i.addChild(this.innerSetLayers(e,t.children[n]));return i}extractNodeIdsToResolve(e,t,i){const n=i.owner_node;n&&!this.backendNodeIdToNode().has(n)&&e.add(n);for(let n=0;i.children&&n<i.children.length;++n)this.extractNodeIdsToResolve(e,t,i.children[n])}}class Wn{#gi;#vi;#Ti=[];constructor(e,t){this.#gi=e,this.#vi=t.entry,this.#Ti=t.paints}async layerTreePromise(){const e=this.#vi.args.snapshot,t=e.device_viewport_size,i=e.active_tiles,n=e.active_tree.root_layer,r=e.active_tree.layers,a=new _n(this.#gi);return a.setViewportSize(t),a.setTiles(i),await a.setLayers(n,r,this.#Ti||[]),a}paints(){return this.#Ti}}class Vn{parentLayerId;parentInternal;layerId;nodeInternal;offsetXInternal;offsetYInternal;widthInternal;heightInternal;childrenInternal;quadInternal;scrollRectsInternal;gpuMemoryUsageInternal;paints;compositingReasons;compositingReasonIds;drawsContentInternal;paintProfilerModel;constructor(e,t){this.parentLayerId=null,this.parentInternal=null,this.layerId="",this.nodeInternal=null,this.offsetXInternal=-1,this.offsetYInternal=-1,this.widthInternal=-1,this.heightInternal=-1,this.childrenInternal=[],this.quadInternal=[],this.scrollRectsInternal=[],this.gpuMemoryUsageInternal=-1,this.paints=[],this.compositingReasons=[],this.compositingReasonIds=[],this.drawsContentInternal=!1,this.paintProfilerModel=e,this.reset(t)}reset(e){this.nodeInternal=null,this.layerId=String(e.layer_id),this.offsetXInternal=e.position[0],this.offsetYInternal=e.position[1],this.widthInternal=e.bounds.width,this.heightInternal=e.bounds.height,this.childrenInternal=[],this.parentLayerId=null,this.parentInternal=null,this.quadInternal=e.layer_quad||[],this.createScrollRects(e),this.compositingReasons=e.compositing_reasons||[],this.compositingReasonIds=e.compositing_reason_ids||[],this.drawsContentInternal=Boolean(e.draws_content),this.gpuMemoryUsageInternal=e.gpu_memory_usage,this.paints=[]}id(){return this.layerId}parentId(){return this.parentLayerId}parent(){return this.parentInternal}isRoot(){return!this.parentId()}children(){return this.childrenInternal}addChild(e){const t=e;t.parentInternal&&console.assert(!1,"Child already has a parent"),this.childrenInternal.push(t),t.parentInternal=this,t.parentLayerId=this.layerId}setNode(e){this.nodeInternal=e}node(){return this.nodeInternal}nodeForSelfOrAncestor(){let e=this;for(;e;e=e.parent())if(e.node())return e.node();return null}offsetX(){return this.offsetXInternal}offsetY(){return this.offsetYInternal}width(){return this.widthInternal}height(){return this.heightInternal}transform(){return null}quad(){return this.quadInternal}anchorPoint(){return[.5,.5,0]}invisible(){return!1}paintCount(){return 0}lastPaintRect(){return null}scrollRects(){return this.scrollRectsInternal}stickyPositionConstraint(){return null}gpuMemoryUsage(){return this.gpuMemoryUsageInternal}snapshots(){return this.paints.map((async e=>{if(!this.paintProfilerModel)return null;const t=await async function(e,t){const i=t.picture();if(!i||!e)return null;const n=await e.loadSnapshot(i.serializedPicture);return n?{rect:i.rect,snapshot:n}:null}(this.paintProfilerModel,e);if(!t)return null;return{rect:{x:t.rect[0],y:t.rect[1],width:t.rect[2],height:t.rect[3]},snapshot:t.snapshot}}))}async pictureForRect(e){return await Promise.all(this.paints.map((e=>e.picture()))).then((i=>{const n=i.filter((i=>{return i&&(n=i.rect,r=e,t(n[0],n[0]+n[2],r[0],r[0]+r[2])&&t(n[1],n[1]+n[3],r[1],r[1]+r[3]));var n,r})).map((e=>({x:e.rect[0],y:e.rect[1],picture:e.serializedPicture})));if(!n.length||!this.paintProfilerModel)return null;const r=n.reduce(((e,t)=>Math.min(e,t.x)),1/0),a=n.reduce(((e,t)=>Math.min(e,t.y)),1/0),s={x:e[0]-r,y:e[1]-a,width:e[2],height:e[3]};return this.paintProfilerModel.loadSnapshotFromFragments(n).then((e=>e?{rect:s,snapshot:e}:null))}));function t(e,t,i,n){return console.assert(e<=t&&i<=n,"segments should be specified as ordered pairs"),t>i&&e<n}}scrollRectsFromParams(e,t){return{rect:{x:e[0],y:e[1],width:e[2],height:e[3]},type:t}}createScrollRects(e){const t=[];e.non_fast_scrollable_region&&t.push(this.scrollRectsFromParams(e.non_fast_scrollable_region,"NonFastScrollable")),e.touch_event_handler_region&&t.push(this.scrollRectsFromParams(e.touch_event_handler_region,"TouchEventHandler")),e.wheel_event_handler_region&&t.push(this.scrollRectsFromParams(e.wheel_event_handler_region,"WheelEventHandler")),e.scroll_event_handler_region&&t.push(this.scrollRectsFromParams(e.scroll_event_handler_region,"RepaintsOnScroll")),this.scrollRectsInternal=t}addPaintEvent(e){this.paints.push(e)}requestCompositingReasons(){return Promise.resolve(this.compositingReasons)}requestCompositingReasonIds(){return Promise.resolve(this.compositingReasonIds)}drawsContent(){return this.drawsContentInternal}}class Gn extends m.SplitWidget.SplitWidget{logAndImageSplitWidget;imageView;paintProfilerView;logTreeView;needsUpdateWhenVisible;pendingSnapshot;event;paintProfilerModel;lastLoadedSnapshot;#t;constructor(e){super(!1,!1),this.element.classList.add("timeline-paint-profiler-view"),this.setSidebarSize(60),this.setResizable(!1),this.#t=e,this.logAndImageSplitWidget=new m.SplitWidget.SplitWidget(!0,!1),this.logAndImageSplitWidget.element.classList.add("timeline-paint-profiler-log-split"),this.setMainWidget(this.logAndImageSplitWidget),this.imageView=new zn,this.logAndImageSplitWidget.setMainWidget(this.imageView),this.paintProfilerView=new D.PaintProfilerView.PaintProfilerView(this.imageView.showImage.bind(this.imageView)),this.paintProfilerView.addEventListener("WindowChanged",this.onWindowChanged,this),this.setSidebarWidget(this.paintProfilerView),this.logTreeView=new D.PaintProfilerView.PaintProfilerCommandLogView,this.logAndImageSplitWidget.setSidebarWidget(this.logTreeView),this.needsUpdateWhenVisible=!1,this.pendingSnapshot=null,this.event=null,this.paintProfilerModel=null,this.lastLoadedSnapshot=null}wasShown(){super.wasShown(),this.needsUpdateWhenVisible&&(this.needsUpdateWhenVisible=!1,this.update())}setSnapshot(e){this.releaseSnapshot(),this.pendingSnapshot=e,this.event=null,this.updateWhenVisible()}#yi(e){const t=e.args.tileData;if(!t)return!1;const i=this.#t.Frames.framesById[t.sourceFrameNumber];return!!i?.layerTree}setEvent(e,i){if(this.releaseSnapshot(),this.paintProfilerModel=e,this.pendingSnapshot=null,this.event=i,this.updateWhenVisible(),t.Types.Events.isPaint(i)){const e=this.#t.LayerTree.paintsToSnapshots.get(i);return Boolean(e)}return!!t.Types.Events.isRasterTask(i)&&this.#yi(i)}updateWhenVisible(){this.isShowing()?this.update():this.needsUpdateWhenVisible=!0}async#fi(e){const t=e.args.tileData;if(!t)return null;if(!t.tileId.id_ref)return null;const i=o.TargetManager.TargetManager.instance().rootTarget();if(!i)return null;const n=this.#t.Frames.framesById[t.sourceFrameNumber];if(!n?.layerTree)return null;const r=new Wn(i,n.layerTree),a=await r.layerTreePromise();return a?await a.pictureForRasterTile(t.tileId.id_ref):null}update(){let e;if(this.logTreeView.setCommandLog([]),this.paintProfilerView.setSnapshotAndLog(null,[],null),this.pendingSnapshot)e=Promise.resolve({rect:null,snapshot:this.pendingSnapshot});else if(this.event&&this.paintProfilerModel&&t.Types.Events.isPaint(this.event)){const t=this.#t.LayerTree.paintsToSnapshots.get(this.event);if(t){const i=t.args.snapshot.skp64;e=this.paintProfilerModel.loadSnapshot(i).then((e=>e&&{rect:null,snapshot:e}))}else e=Promise.resolve(null)}else{if(!this.event||!t.Types.Events.isRasterTask(this.event))return void console.assert(!1,"Unexpected event type or no snapshot");e=this.#fi(this.event)}function i(e,t,i){this.logTreeView.setCommandLog(i||[]),this.paintProfilerView.setSnapshotAndLog(e,i||[],t)}e.then((e=>{if(this.releaseSnapshot(),!e)return void this.imageView.showImage();const t=e.snapshot;this.lastLoadedSnapshot=t,this.imageView.setMask(e.rect),t.commandLog().then((n=>i.call(this,t,e.rect,n||[])))}))}releaseSnapshot(){this.lastLoadedSnapshot&&(this.lastLoadedSnapshot.release(),this.lastLoadedSnapshot=null)}onWindowChanged(){this.logTreeView.updateWindow(this.paintProfilerView.selectionWindow())}}class zn extends m.Widget.Widget{imageContainer;imageElement;maskElement;transformController;maskRectangle;constructor(){super(!0),this.registerRequiredCSS(On),this.contentElement.classList.add("fill","paint-profiler-image-view"),this.imageContainer=this.contentElement.createChild("div","paint-profiler-image-container"),this.imageElement=this.imageContainer.createChild("img"),this.maskElement=this.imageContainer.createChild("div"),this.imageElement.addEventListener("load",this.updateImagePosition.bind(this),!1),this.transformController=new D.TransformController.TransformController(this.contentElement,!0),this.transformController.addEventListener("TransformChanged",this.updateImagePosition,this)}onResize(){this.imageElement.src&&this.updateImagePosition()}updateImagePosition(){const e=this.imageElement.naturalWidth,t=this.imageElement.naturalHeight,i=this.contentElement.clientWidth,n=this.contentElement.clientHeight,r=.1*i,a=.1*n,s=(i-r)/e,o=(n-a)/t,l=Math.min(s,o);if(this.maskRectangle){const i=this.maskElement.style;i.width=e+"px",i.height=t+"px",i.borderLeftWidth=this.maskRectangle.x+"px",i.borderTopWidth=this.maskRectangle.y+"px",i.borderRightWidth=e-this.maskRectangle.x-this.maskRectangle.width+"px",i.borderBottomWidth=t-this.maskRectangle.y-this.maskRectangle.height+"px"}this.transformController.setScaleConstraints(.5,10/l);let d=(new WebKitCSSMatrix).scale(this.transformController.scale(),this.transformController.scale()).translate(i/2,n/2).scale(l,l).translate(-e/2,-t/2);const c=m.Geometry.boundsForTransformedPoints(d,[0,0,0,e,t,0]);this.transformController.clampOffsets(r-c.maxX,i-r-c.minX,a-c.maxY,n-a-c.minY),d=(new WebKitCSSMatrix).translate(this.transformController.offsetX(),this.transformController.offsetY()).multiply(d),this.imageContainer.style.webkitTransform=d.toString()}showImage(e){this.imageContainer.classList.toggle("hidden",!e),e&&(this.imageElement.src=e)}setMask(e){this.maskRectangle=e,this.maskElement.classList.toggle("hidden",!e)}}var jn=Object.freeze({__proto__:null,TimelinePaintImageView:zn,TimelinePaintProfilerView:Gn}),$n={cssText:`devtools-data-grid{flex:auto}\n/*# sourceURL=${import.meta.resolve("./timelineSelectorStatsView.css")} */\n`};const Kn={selectorStats:"Selector stats",elapsed:"Elapsed (ms)",rejectPercentage:"% of slow-path non-matches",rejectPercentageExplanation:"The percentage of non-matching nodes (Match Attempts - Match Count) that couldn't be quickly ruled out by the bloom filter due to high selector complexity. Lower is better.",matchAttempts:"Match attempts",matchCount:"Match count",selector:"Selector",styleSheetId:"Style Sheet",copyTable:"Copy table",unableToLink:"Unable to link",unableToLinkViaStyleSheetId:"Unable to link via {PH1}",tableCopiedToClipboard:"Table copied to clipboard",totalForAllSelectors:"(Totals for all selectors)",lineNumber:"Line {PH1}:{PH2}"},qn=e.i18n.registerUIStrings("panels/timeline/TimelineSelectorStatsView.ts",Kn),Yn=e.i18n.getLocalizedString.bind(void 0,qn),Jn=t.Types.Events.SelectorTimingsKey;class Xn extends m.Widget.VBox{#Si;#t=null;#wi=null;#bi;#Ei=[];constructor(e,t=(e,t,i)=>{B(H`
      <devtools-data-grid striped name=${Yn(Kn.selectorStats)}
          @contextmenu=${e.onContextMenu.bind(e)}>
        <table>
          <tr>
            <th id=${Jn.Elapsed} weight="1" sortable hideable align="right">
              ${Yn(Kn.elapsed)}
            </th>
            <th id=${Jn.MatchAttempts} weight="1" sortable hideable align="right">
              ${Yn(Kn.matchAttempts)}
            </th>
            <th id=${Jn.MatchCount} weight="1" sortable hideable align="right">
              ${Yn(Kn.matchCount)}
            </th>
            <th id=${Jn.RejectPercentage} weight="1" sortable hideable align="right">
              <span title=${Yn(Kn.rejectPercentageExplanation)}>${Yn(Kn.rejectPercentage)}</span>
            </th>
            <th id=${Jn.Selector} weight="3" sortable hideable>
              ${Yn(Kn.selector)}
            </th>
            <th id=${Jn.StyleSheetId} weight="1.5" sortable hideable>
              ${Yn(Kn.styleSheetId)}
            </th>
          </tr>
          ${e.timings.map((e=>{const t=e[Jn.MatchAttempts]-e[Jn.MatchCount],i=100*(t?e[Jn.FastRejectCount]/t:1),n=e[Jn.StyleSheetId],r=e.locations,a=r?null:null===r?"":Yn(Kn.unableToLinkViaStyleSheetId,{PH1:n});return H`<tr>
            <td data-value=${e[Jn.Elapsed]}>
              ${(e[Jn.Elapsed]/1e3).toFixed(3)}
            </td>
            <td>${e[Jn.MatchAttempts]}</td>
            <td>${e[Jn.MatchCount]}</td>
            <td data-value=${i}>
              ${i.toFixed(1)}
            </td>
            <td title=${e[Jn.Selector]}>
             ${e[Jn.Selector]}
            </td>
            <td data-value=${n}>${r?H`${r.map(((e,t)=>H`
                <devtools-linkifier .data=${e}></devtools-linkifier
                >${t!==r.length-1?",":""}`))}`:a}
            </td>
          </tr>`}))}
        </table>
      </devtools-data-grid>`,i,{host:this})}){super(),this.registerRequiredCSS($n),this.#bi=t,this.element.setAttribute("jslog",`${v.pane("selector-stats").track({resize:!0})}`),this.#Si=new Map,this.#t=e,this.performUpdate()}#Ci(e){const{menu:t}=e.detail;t.defaultSection().appendItem(Yn(Kn.copyTable),(()=>{const e=[],t=[Yn(Kn.elapsed),Yn(Kn.matchAttempts),Yn(Kn.matchCount),Yn(Kn.rejectPercentage),Yn(Kn.selector),Yn(Kn.styleSheetId)];e.push(t.join("\t"));for(const t of this.#Ei){const i=t[Jn.MatchAttempts]-t[Jn.MatchCount],n=100*(i?t[Jn.FastRejectCount]/i:1),r=t[Jn.StyleSheetId];let a="";const s=o.TargetManager.TargetManager.instance().primaryPageTarget(),l=s?.model(o.CSSModel.CSSModel);if(l){const e=l.styleSheetHeaderForId(r);e&&(a=e.resourceURL().toString())}a||(a=Yn(Kn.unableToLink)),e.push([t[Jn.Elapsed]/1e3,t[Jn.MatchAttempts],t[Jn.MatchCount],n,t[Jn.Selector],a].join("\t"))}const i=e.join("\n");navigator.clipboard.writeText(i),m.ARIAUtils.alert(Yn(Kn.tableCopiedToClipboard))}))}performUpdate(){const e={timings:this.#Ei,onContextMenu:e=>{this.#Ci(e)}};this.#bi(e,{},this.contentElement)}setEvent(e){if(!this.#t)return!1;if(this.#wi===e)return!1;this.#wi=e;const t=this.#t.SelectorStats.dataForUpdateLayoutEvent.get(e);return t?(this.processSelectorTimings(t.timings).then((e=>{this.#Ei=e,this.requestUpdate()})),!0):(this.#Ei=[],this.requestUpdate(),!1)}setAggregatedEvents(e){const t=[],i=new Map;if(!this.#t)return;const n={[Jn.Elapsed]:0,[Jn.MatchAttempts]:0,[Jn.MatchCount]:0,[Jn.FastRejectCount]:0};if(!Array.isArray(this.#wi)||this.#wi.length!==e.length||!e.every(((e,t)=>e===this.#wi[t]))){this.#wi=e;for(let t=0;t<e.length;t++){const r=e[t],a=r?this.#t.SelectorStats.dataForUpdateLayoutEvent.get(r):void 0;if(a){const e=a.timings;for(const t of e){const e=t[Jn.Selector]+"_"+t[Jn.StyleSheetId],r=i.get(e);void 0!==r?(r[Jn.Elapsed]+=t[Jn.Elapsed],r[Jn.FastRejectCount]+=t[Jn.FastRejectCount],r[Jn.MatchAttempts]+=t[Jn.MatchAttempts],r[Jn.MatchCount]+=t[Jn.MatchCount]):i.set(e,structuredClone(t)),n[Jn.Elapsed]+=t[Jn.Elapsed],n[Jn.MatchAttempts]+=t[Jn.MatchAttempts],n[Jn.MatchCount]+=t[Jn.MatchCount],n[Jn.FastRejectCount]+=t[Jn.FastRejectCount]}}}if(!(i.size>0))return this.#Ei=[],void this.requestUpdate();i.forEach((e=>{t.push(e)})),i.clear(),t.unshift({[Jn.Elapsed]:n[Jn.Elapsed],[Jn.FastRejectCount]:n[Jn.FastRejectCount],[Jn.MatchAttempts]:n[Jn.MatchAttempts],[Jn.MatchCount]:n[Jn.MatchCount],[Jn.Selector]:Yn(Kn.totalForAllSelectors),[Jn.StyleSheetId]:"n/a"}),this.processSelectorTimings(t).then((e=>{this.#Ei=e,this.requestUpdate()}))}}async processSelectorTimings(e){const t=o.TargetManager.TargetManager.instance().primaryPageTarget(),i=t?.model(o.CSSModel.CSSModel);return i?await Promise.all(e.sort(((e,t)=>t[Jn.Elapsed]-e[Jn.Elapsed])).map((async e=>{const t=e[Jn.StyleSheetId],n=e[Jn.Selector].trim(),r="n/a"===t?null:await async function(e,t,i,n){if(!e)return;const r=e.styleSheetHeaderForId(t);if(!r||!r.resourceURL())return;const a=JSON.stringify({selectorText:i,styleSheetId:t});let s=n.get(a);if(!s){const r=await e.agent.invoke_getLocationForSelector({styleSheetId:t,selectorText:i});if(r.getError()||!r.ranges)return;s=r.ranges,n.set(a,s)}return s.map((e=>({url:r.resourceURL(),lineNumber:e.startLine,columnNumber:e.startColumn,linkText:Yn(Kn.lineNumber,{PH1:e.startLine+1,PH2:e.startColumn+1}),title:`${r.id} line ${e.startLine+1}:${e.startColumn+1}`})))}(i,t,n,this.#Si);return{...e,locations:r}}))):[]}}const Zn={summary:"Summary",bottomup:"Bottom-up",callTree:"Call tree",eventLog:"Event log",paintProfiler:"Paint profiler",layers:"Layers",selectorStats:"Selector stats"},Qn=e.i18n.registerUIStrings("panels/timeline/TimelineDetailsView.ts",Zn),er=e.i18n.getLocalizedString.bind(void 0,Qn);class tr extends(l.ObjectWrapper.eventMixin(m.Widget.VBox)){detailsLinkifier;tabbedPane;defaultDetailsWidget;defaultDetailsContentWidget;rangeDetailViews;#le;lazyPaintProfilerView;lazyLayersView;preferredTabId;selection;updateContentsScheduled;lazySelectorStatsView;#t=null;#ki=null;#Ii=null;#Ae=null;#Mi;#xi;#te=this.#ie.bind(this);#Pi=new c.RelatedInsightChips.RelatedInsightChips;#Ri=new _t;#de=null;constructor(e){super(),this.element.classList.add("timeline-details"),this.detailsLinkifier=new S.Linkifier.Linkifier,this.tabbedPane=new m.TabbedPane.TabbedPane,this.tabbedPane.show(this.element),this.tabbedPane.headerElement().setAttribute("jslog",`${v.toolbar("sidebar").track({keydown:"ArrowUp|ArrowLeft|ArrowDown|ArrowRight|Enter|Space"})}`),this.defaultDetailsWidget=new m.Widget.VBox,this.defaultDetailsWidget.element.classList.add("timeline-details-view"),this.defaultDetailsWidget.element.setAttribute("jslog",`${v.pane("details").track({resize:!0})}`),this.defaultDetailsContentWidget=this.#Fi(),this.appendTab(ir.Details,er(Zn.summary),this.defaultDetailsWidget),this.setPreferredTab(ir.Details),this.rangeDetailViews=new Map,this.updateContentsScheduled=!1;const t=new Nt;this.appendTab(ir.BottomUp,er(Zn.bottomup),t),this.rangeDetailViews.set(ir.BottomUp,t);const i=new At;this.appendTab(ir.CallTree,er(Zn.callTree),i),this.rangeDetailViews.set(ir.CallTree,i);const n=new Nn(e);this.appendTab(ir.EventLog,er(Zn.eventLog),n),this.rangeDetailViews.set(ir.EventLog,n),this.rangeDetailViews.values().forEach((e=>{e.addEventListener("TreeRowHovered",(e=>this.dispatchEventToListeners("TreeRowHovered",e.data))),e.addEventListener("TreeRowClicked",(e=>{this.dispatchEventToListeners("TreeRowClicked",e.data)})),e instanceof Lt&&e.stackView.addEventListener("TreeRowHovered",(e=>this.dispatchEventToListeners("TreeRowHovered",{node:e.data})))})),this.#Ri.addEventListener("TreeRowHovered",(e=>{this.dispatchEventToListeners("TreeRowHovered",{node:e.data.node,events:e.data.events??void 0})})),this.#Ri.addEventListener("BottomUpButtonClicked",(e=>{this.selectTab(ir.BottomUp,e.data,Lt.GroupBy.ThirdParties)})),this.#Ri.addEventListener("TreeRowClicked",(e=>{this.dispatchEventToListeners("TreeRowClicked",{node:e.data.node,events:e.data.events??void 0})})),this.#Mi=new c.NetworkRequestDetails.NetworkRequestDetails(this.detailsLinkifier),this.#xi=new c.LayoutShiftDetails.LayoutShiftDetails,this.tabbedPane.addEventListener(m.TabbedPane.Events.TabSelected,this.tabSelected,this),a.TraceBounds.onChange(this.#te),this.lazySelectorStatsView=null}selectTab(e,t,i){switch(this.tabbedPane.selectTab(e,!0,!0),this.tabbedPane.focusSelectedTabHeader(),e){case ir.CallTree:case ir.EventLog:case ir.PaintProfiler:case ir.LayerViewer:case ir.SelectorStats:break;case ir.Details:this.updateContentsFromWindow();break;case ir.BottomUp:{if(!(this.tabbedPane.visibleView instanceof Nt))return;const e=this.tabbedPane.visibleView;if(i&&(e.setGroupBySetting(i),e.refreshTree()),!t)return;const n=e.eventToTreeNode.get(t.event);if(!n)return;e.selectProfileNode(n,!0);const r=e.dataGridNodeForTreeNode(n);r&&r.expand();break}default:r.assertNever(e,`Unknown Tab: ${e}. Add new case to switch.`)}}#Fi(){const e=new m.Widget.VBox;return e.element.classList.add("timeline-details-view-body"),e.show(this.defaultDetailsWidget.element),e}selectorStatsView(){return this.lazySelectorStatsView||(this.lazySelectorStatsView=new Xn(this.#t)),this.lazySelectorStatsView}getDetailsContentElementForTest(){return this.defaultDetailsContentWidget.element}revealEventInTreeView(e){this.tabbedPane.visibleView instanceof xt&&this.tabbedPane.visibleView.highlightEventInTree(e)}async#ie(e){"MINIMAP_BOUNDS"===e.updateType&&this.selection&&await this.setSelection(this.selection),"RESET"!==e.updateType&&"VISIBLE_WINDOW"!==e.updateType||this.selection||this.scheduleUpdateContentsFromWindow()}async setModel(e){this.#t!==e.parsedTrace&&(this.lazySelectorStatsView=null,this.#t=e.parsedTrace),e.parsedTrace&&(this.#Ae=t.Extras.FilmStrip.fromParsedTrace(e.parsedTrace),this.#de=new s.EntityMapper.EntityMapper(e.parsedTrace)),this.#le=e.selectedEvents,this.#ki=e.traceInsightsSets,this.#Ii=e.eventToRelatedInsightsMap,e.eventToRelatedInsightsMap&&(this.#Pi.eventToRelatedInsightsMap=e.eventToRelatedInsightsMap),this.tabbedPane.closeTabs([ir.PaintProfiler,ir.LayerViewer],!1);for(const t of this.rangeDetailViews.values())t.setModelWithEvents(e.selectedEvents,e.parsedTrace,e.entityMapper);this.#Ri.setModelWithEvents(e.selectedEvents,e.parsedTrace,e.entityMapper),this.lazyPaintProfilerView=null,this.lazyLayersView=null,await this.setSelection(null)}setSummaryContent(e){const t=this.tabbedPane.otherTabs(ir.Details);for(let e=0;e<t.length;++e)this.rangeDetailViews.has(t[e])||this.tabbedPane.closeTab(t[e]);(e instanceof Element&&e.shadowRoot||e).appendChild(this.#Pi),this.defaultDetailsContentWidget.detach(),this.defaultDetailsContentWidget=this.#Fi(),this.defaultDetailsContentWidget.contentElement.append(e)}updateContents(){const e=a.TraceBounds.BoundsManager.instance().state();if(!e)return;const t=e.milli.timelineTraceWindow,i=this.rangeDetailViews.get(this.tabbedPane.selectedTabId||"");i&&i.updateContents(this.selection||ft(t.min,t.max))}appendTab(e,t,i,n){this.tabbedPane.appendTab(e,t,i,void 0,void 0,n),this.preferredTabId!==this.tabbedPane.selectedTabId&&this.tabbedPane.selectTab(e)}headerElement(){return this.tabbedPane.headerElement()}setPreferredTab(e){this.preferredTabId=e}scheduleUpdateContentsFromWindow(e=!1){this.#t?e?this.updateContentsFromWindow():this.updateContentsScheduled||(this.updateContentsScheduled=!0,setTimeout((()=>{this.updateContentsScheduled=!1,this.updateContentsFromWindow()}),100)):this.setSummaryContent(m.Fragment.html`<div/>`)}updateContentsFromWindow(){const e=a.TraceBounds.BoundsManager.instance().state();if(!e)return;const t=e.milli.timelineTraceWindow;this.updateSelectedRangeStats(t.min,t.max),this.updateContents()}#Li(e){if(!this.#Ae)return null;const i=e.idle?e.startTime:e.endTime,n=t.Extras.FilmStrip.frameClosestToTimestamp(this.#Ae,i);if(!n)return null;return t.Helpers.Timing.microToMilli(n.screenshotEvent.ts)-t.Helpers.Timing.microToMilli(e.endTime)<10?n:null}#Ai(e){const t=this.#Li(e);this.setSummaryContent(Tn.generateDetailsContentForFrame(e,this.#Ae,t));const i=o.TargetManager.TargetManager.instance().rootTarget();if(e.layerTree&&i){const t=new Wn(i,e.layerTree),n=this.layersView();n.showLayerTree(t),this.tabbedPane.hasTab(ir.LayerViewer)||this.appendTab(ir.LayerViewer,er(Zn.layers),n)}}async#Ni(e){if(!this.#t)return;const t=dt(this.#t,e);await this.#Mi.setData(this.#t,e,t,this.#de),this.#Pi.activeEvent=e,this.#Ii&&(this.#Pi.eventToRelatedInsightsMap=this.#Ii),this.setSummaryContent(this.#Mi)}async#Di(e){if(!this.#t)return;if(this.#Pi.activeEvent=e,this.#Ii&&(this.#Pi.eventToRelatedInsightsMap=this.#Ii),t.Types.Events.isSyntheticLayoutShift(e)||t.Types.Events.isSyntheticLayoutShiftCluster(e)){const t=Boolean(this.#t&&ut.instance().recordingIsFresh(this.#t));return this.#xi.setData(e,this.#ki,this.#t,t),void this.setSummaryContent(this.#xi)}const i=await Tn.buildTraceEventDetails(this.#t,e,this.detailsLinkifier,!0,this.#de);this.appendDetailsTabsForTraceEventAndShowDetails(e,i)}async setSelection(e){if(this.#t)if(this.detailsLinkifier.reset(),this.selection=e,this.#Pi.activeEvent=null,this.selection){if(St(e))t.Types.Events.isSyntheticNetworkRequest(e.event)?await this.#Ni(e.event):t.Types.Events.isLegacyTimelineFrame(e.event)?this.#Ai(e.event):await this.#Di(e.event);else if(wt(e)){const i=t.Helpers.Timing.traceWindowMicroSecondsToMilliSeconds(e.bounds);this.updateSelectedRangeStats(i.min,i.max)}this.updateContents()}else this.scheduleUpdateContentsFromWindow(!0)}tabSelected(e){e.data.isUserGesture&&(this.setPreferredTab(e.data.tabId),this.updateContents())}layersView(){return this.lazyLayersView||(this.lazyLayersView=new Hn(this.showSnapshotInPaintProfiler.bind(this))),this.lazyLayersView}paintProfilerView(){return this.lazyPaintProfilerView?this.lazyPaintProfilerView:this.#t?(this.lazyPaintProfilerView=new Gn(this.#t),this.lazyPaintProfilerView):null}showSnapshotInPaintProfiler(e){const t=this.paintProfilerView();t&&(t.setSnapshot(e),this.tabbedPane.hasTab(ir.PaintProfiler)||this.appendTab(ir.PaintProfiler,er(Zn.paintProfiler),t,!0),this.tabbedPane.selectTab(ir.PaintProfiler,!0))}showSelectorStatsForIndividualEvent(e){this.showAggregatedSelectorStats([e])}showAggregatedSelectorStats(e){const t=this.selectorStatsView();t.setAggregatedEvents(e),this.tabbedPane.hasTab(ir.SelectorStats)||this.appendTab(ir.SelectorStats,er(Zn.selectorStats),t)}appendDetailsTabsForTraceEventAndShowDetails(e,i){this.setSummaryContent(i),(t.Types.Events.isPaint(e)||t.Types.Events.isRasterTask(e))&&this.showEventInPaintProfiler(e),t.Types.Events.isUpdateLayoutTree(e)&&this.showSelectorStatsForIndividualEvent(e)}showEventInPaintProfiler(e){const t=o.TargetManager.TargetManager.instance().models(o.PaintProfiler.PaintProfilerModel)[0];if(!t)return;const i=this.paintProfilerView();if(!i)return;i.setEvent(t,e)&&(this.tabbedPane.hasTab(ir.PaintProfiler)||this.appendTab(ir.PaintProfiler,er(Zn.paintProfiler),i))}updateSelectedRangeStats(e,i){if(!this.#le||!this.#t||!this.#de)return;const n=t.Helpers.Timing.traceWindowMilliSeconds(this.#t.Meta.traceBounds).min,r=Tn.statsForTimeRange(this.#le,e,i),a=e-n,s=i-n,o=Tn.generateSummaryDetails(r,a,s,this.#le,this.#Ri);this.#Ri.updateContents(this.selection||ft(e,i)),this.setSummaryContent(o);const d=l.Settings.Settings.instance().createSetting("timeline-capture-selector-stats",!1).get();if(this.#le&&d){const n=t.Helpers.Trace.findUpdateLayoutTreeEvents(this.#le,t.Helpers.Timing.milliToMicro(e),t.Helpers.Timing.milliToMicro(i));n.length>0&&this.showAggregatedSelectorStats(n)}}}var ir;!function(e){e.Details="details",e.EventLog="event-log",e.CallTree="call-tree",e.BottomUp="bottom-up",e.PaintProfiler="paint-profiler",e.LayerViewer="layer-viewer",e.SelectorStats="selector-stats"}(ir||(ir={}));var nr=Object.freeze({__proto__:null,get Tab(){return ir},TimelineDetailsPane:tr});const rr={network:"Network"},ar=e.i18n.registerUIStrings("panels/timeline/NetworkTrackAppender.ts",rr),sr=e.i18n.getLocalizedString.bind(void 0,ar);class or{appenderName="Network";#Bi;webSocketIdToLevel=new Map;#ee=[];#Hi;#Ui;constructor(e,t){this.#Bi=e,this.#ee=t,this.#Hi=`${i.Font.DEFAULT_FONT_SIZE} ${i.Font.getFontFamilyForCanvas()}`,n.ThemeSupport.instance().addEventListener(n.ThemeChangeEvent.eventName,(()=>{this.#Ui&&(this.#Ui.style.color=n.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),this.#Ui.style.backgroundColor=n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"))}))}group(){return this.#Ui}font(){return this.#Hi}appendTrackAtLevel(e,t){return 0===this.#ee.length?e:(this.#r(e,t),this.#Oi(this.#ee,e))}#r(e,t){const i=W({shareHeaderLine:!1,useFirstLineForOverview:!1,useDecoratorsForOverview:!0});this.#Ui=V("network",0,sr(rr.network),i,!0,t,!1),this.#Bi.groups.push(this.#Ui)}#Oi(e,i){for(let n=0;n<e.length;++n){const r=e[n];this.#_i(r,i),t.Types.Events.isSyntheticNetworkRequest(r)&&t.Helpers.Network.isSyntheticNetworkRequestEventRenderBlocking(r)&&j(this.#Bi,n,{type:"WARNING_TRIANGLE",customStartTime:r.args.data.syntheticData.sendStartTime,customEndTime:r.args.data.syntheticData.finishTime})}return this.relayoutEntriesWithinBounds(e,t.Types.Timing.Milli(-1/0),t.Types.Timing.Milli(1/0))}#_i(e,i){const n=this.#Bi.entryLevels.length;this.#Bi.entryLevels[n]=i,this.#Bi.entryStartTimes[n]=t.Helpers.Timing.microToMilli(e.ts);const r=e.dur||t.Helpers.Timing.milliToMicro(Mr);return this.#Bi.entryTotalTimes[n]=t.Helpers.Timing.microToMilli(r),i}relayoutEntriesWithinBounds(e,i,n){if(!this.#Bi||0===e.length)return 0;const r=[];this.webSocketIdToLevel=new Map;let a=0;for(let s=0;s<e.length;++s){const o=e[s],l=t.Helpers.Timing.microToMilli(o.ts),d=o.dur?t.Helpers.Timing.microToMilli(o.dur):Mr;if(!(l<n&&l+d>i)){this.#Bi.entryLevels[s]=-1;continue}let c;c="identifier"in o.args.data&&t.Types.Events.isWebSocketEvent(o)?this.getWebSocketLevel(o,r):z(o,r),this.#Bi.entryLevels[s]=c,a=Math.max(a,r.length,c)}for(let t=0;t<e.length;++t)-1===this.#Bi.entryLevels[t]&&(this.#Bi.entryLevels[t]=a);return a}getWebSocketLevel(e,t){const i=e.args.data.identifier;let n;return this.webSocketIdToLevel.has(i)?n=this.webSocketIdToLevel.get(i)||0:(n=z(e,t),this.webSocketIdToLevel.set(i,n)),n}colorForEvent(e){if(t.Types.Events.isSyntheticWebSocketConnection(e))return"";if(t.Types.Events.isWebSocketTraceEvent(e))return c.Utils.colorForNetworkCategory(c.Utils.NetworkCategory.JS);if(!t.Types.Events.isSyntheticNetworkRequest(e))throw new Error(`Unexpected Network Request: The event's type is '${e.name}'`);return c.Utils.colorForNetworkRequest(e)}}var lr=Object.freeze({__proto__:null,NetworkTrackAppender:or});class dr{#Wi=0;#Vi=0;#ee=[];#Gi=0;#zi=null;#ji=null;#$i=null;#t=null;#Ki=new Map;#qi=-1;#Yi=[];#de=null;constructor(){this.reset()}reset(){this.#Gi=0,this.#Wi=0,this.#Vi=0,this.#Ki.clear(),this.#ee=[],this.#ji=null,this.#t=null,this.#zi=null}setModel(e,t){this.reset(),this.#t=e,this.#de=t,this.setEvents(this.#t),this.#Ji(this.#t)}setEvents(e){e.NetworkRequests.webSocket&&e.NetworkRequests.webSocket.forEach((e=>{e.syntheticConnection&&this.#ee.push(e.syntheticConnection),this.#ee.push(...e.events)})),e.NetworkRequests.byTime&&this.#ee.push(...e.NetworkRequests.byTime)}isEmpty(){return this.timelineData(),!this.#ee.length}maxStackDepth(){return this.#Gi}hasTrackConfigurationMode(){return!1}timelineData(){return this.#ji&&0!==this.#ji.entryLevels.length?this.#ji:(this.#ji=i.FlameChart.FlameChartTimelineData.createEmpty(),this.#t?(this.#ee.length||this.setEvents(this.#t),this.#zi=new or(this.#ji,this.#ee),this.#Gi=this.#zi.appendTrackAtLevel(0),this.#ji):this.#ji)}minimumBoundary(){return this.#Wi}totalTime(){return this.#Vi}setWindowTimes(e,t){this.#Xi(e,t)}createSelection(e){if(-1===e)return null;const t=this.#ee[e];return this.#$i=new yr(yt(t),e),this.#$i.timelineSelection}customizedContextMenu(e,i,n){const r=this.eventByIndex(i);if(!r||!t.Types.Events.isSyntheticNetworkRequest(r))return;const a=o.TraceObject.RevealableNetworkRequest.create(r),s=new m.ContextMenu.ContextMenu(e);return s.appendApplicableItems(a),s}indexForEvent(e){if(!t.Types.Events.isNetworkTrackEntry(e))return null;const i=this.#Ki.get(e);if(void 0!==i)return i;const n=this.#ee.indexOf(e),r=n>-1?n:null;return this.#Ki.set(e,r),r}eventByIndex(e){return this.#ee.at(e)??null}entryHasAnnotations(e){const t=this.eventByIndex(e);if(!t)return!1;const i=Ve.activeManager()?.annotationsForEntry(t);return void 0!==i&&i.length>0}deleteAnnotationsForEntry(e){const t=this.eventByIndex(e);t&&Ve.activeManager()?.deleteEntryAnnotations(t)}entryIndexForSelection(e){if(!e||wt(e))return-1;if(this.#$i&&Et(this.#$i.timelineSelection,e))return this.#$i.entryIndex;if(!t.Types.Events.isNetworkTrackEntry(e.event))return-1;const i=this.#ee.indexOf(e.event);return-1!==i&&(this.#$i=new yr(yt(e.event),i)),i}groupForEvent(e){return this.#zi?.group()??null}entryColor(e){if(!this.#zi)throw new Error("networkTrackAppender should not be empty");return this.#zi.colorForEvent(this.#ee[e])}textColor(e){return fr.textColor}entryTitle(e){const t=this.#ee[e];return s.EntryName.nameForEntry(t)}entryFont(e){return this.#zi?.font()||null}getDecorationPixels(e,i,n){const r=t.Helpers.Timing.microToMilli(e.ts),a=e=>i+(e-r)*n,s=t.Helpers.Timing.microToMilli(e.ts),o=t.Helpers.Timing.microToMilli(e.ts+e.dur),l=t.Helpers.Timing.microToMilli(e.args.data.syntheticData.sendStartTime),d=t.Helpers.Timing.microToMilli(e.args.data.syntheticData.downloadStart),c=Math.max(a(l),i),h=Math.max(a(d),c),p=Math.max(a(t.Helpers.Timing.microToMilli(e.args.data.syntheticData.finishTime)),h);return{sendStart:c,headersEnd:h,finish:p,start:a(s),end:Math.max(a(o),p)}}decorateEntry(e,i,n,r,a,s,o,l,d){const c=this.#ee[e];return t.Types.Events.isSyntheticWebSocketConnection(c)?this.#Zi(e,i,a,o,l,d):!!t.Types.Events.isSyntheticNetworkRequest(c)&&this.#Qi(e,i,n,r,a,s,o,l,d)}#Qi(e,i,r,a,s,o,l,d,c){const h=this.#ee[e];if(!t.Types.Events.isSyntheticNetworkRequest(h))return!1;const{sendStart:p,headersEnd:u,finish:g,start:v,end:T}=this.getDecorationPixels(h,d,c);function y(e,t,n){i.moveTo(e,n-3),i.lineTo(e,n+3),i.moveTo(e,n),i.lineTo(t,n)}i.fillStyle="hsla(0, 100%, 100%, 0.8)",i.fillRect(p+.5,s+.5,u-p-.5,l-2),i.fillStyle=n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"),i.fillRect(a,s-.5,p-a,l),i.fillRect(g,s-.5,a+o-g,l),i.beginPath(),i.lineWidth=1,i.strokeStyle="#ccc";const f=Math.floor(s+l/2)+.5,S=T-.5;y(v+.5,p,f),y(S,g,f),i.stroke();const w=Math.max(p,0),b=g-w;if(b>=20){let t=this.entryTitle(e)||"";if(h.args.data.fromServiceWorker&&(t="⚙ "+t),t){const e=4,n=l-5,r=m.UIUtils.trimTextEnd(i,t,b-2*e);i.fillStyle="#333",i.fillText(r,w+e,s+n)}}return!0}#Zi(e,i,r,a,s,o){i.save();const l=this.#ee[e],d=t.Helpers.Timing.microToMilli(l.ts),c=e=>Math.floor(s+(e-d)*o),h=t.Helpers.Timing.microToMilli(l.ts+l.dur),p=c(d)+.5,m=c(h)-.5;i.strokeStyle=n.ThemeSupport.instance().getComputedValue("--app-color-rendering");const u=Math.floor(r+a/2)+.5;return i.setLineDash([3,2]),i.moveTo(p,u-1),i.lineTo(m,u-1),i.moveTo(p,u+1),i.lineTo(m,u+1),i.stroke(),i.restore(),!0}forceDecoration(e){return!0}forceDrawableLevel(e){return this.#zi?.webSocketIdToLevel.has(e)||!1}preparePopoverElement(e){const i=this.#ee[e];if(t.Types.Events.isSyntheticNetworkRequest(i)){const e=document.createElement("div"),t=m.UIUtils.createShadowRootWithCoreStyles(e,{cssFile:et}).createChild("div","timeline-flamechart-popover"),n=new c.NetworkRequestTooltip.NetworkRequestTooltip;return n.data={networkRequest:i,entityMapper:this.#de},t.appendChild(n),e}return null}#Ji(e){const{traceBounds:i}=e.Meta,n=t.Helpers.Timing.microToMilli(i.min),r=t.Helpers.Timing.microToMilli(i.max);this.#Wi=n,this.#Vi=n===r?1e3:r-this.#Wi}#Xi(e,t){this.#zi&&this.#ji&&(this.#Gi=this.#zi.relayoutEntriesWithinBounds(this.#ee,e,t),this.#ji=i.FlameChart.FlameChartTimelineData.create({entryLevels:this.#ji?.entryLevels,entryTotalTimes:this.#ji?.entryTotalTimes,entryStartTimes:this.#ji?.entryStartTimes,groups:this.#ji?.groups,initiatorsData:this.#ji.initiatorsData,entryDecorations:this.#ji.entryDecorations}))}preferredHeight(){if(!this.#zi||0===this.#Gi)return 0;const e=this.#zi.group();return e?e.style.height*(this.isExpanded()?r.NumberUtilities.clamp(this.#Gi+1,7,8.5):1):0}isExpanded(){return Boolean(this.#zi?.group()?.expanded)}formatValue(t,i){return e.TimeUtilities.preciseMillisToString(t,i)}canJumpToEntry(e){return!1}search(e,i){const n=[];for(let r=0;r<this.#ee.length;r++){const a=this.#ee.at(r);if(a&&(t.Helpers.Timing.eventIsInBounds(a,e)&&(!i||i.accept(a,this.#t??void 0)))){const e=t.Helpers.Timing.microToMilli(a.ts);n.push({startTimeMilli:e,index:r,provider:"network"})}}return n}mainFrameNavigationStartEvents(){return this.#t?this.#t.Meta.mainFrameNavigations:[]}buildFlowForInitiator(e){if(!this.#t)return!1;if(!this.#ji)return!1;if(this.#qi===e)return this.#Yi&&(this.#ji.initiatorsData=this.#Yi),!0;if(!this.#zi)return!1;const t=this.#ji.initiatorsData.length;if(-1===e)return this.#qi=e,0!==t&&(this.#ji.resetFlowData(),!0);const i=this.#ee[e];this.#ji.resetFlowData(),this.#qi=e;const n=Je(this.#t,i);if(0===t&&0===n.length)return!1;for(const e of n){const t=this.indexForEvent(e.event),i=this.indexForEvent(e.initiator);null!==t&&null!==i&&this.#ji.initiatorsData.push({initiatorIndex:i,eventIndex:t})}return this.#Yi=this.#ji.initiatorsData,!0}}var cr=Object.freeze({__proto__:null,TimelineFlameChartNetworkDataProvider:dr}),hr={cssText:`.timeline-overlays-container{position:absolute;inset:0;z-index:200;pointer-events:none}.overlay-item{position:absolute;top:0;left:0}.overlay-type-ENTRY_LABEL{z-index:2;&:has([data-user-editing-label]){z-index:3}}.overlay-type-ENTRY_SELECTED,\n.overlay-type-ENTRY_OUTLINE{pointer-events:none;border:2px solid var(--sys-color-primary);background-color:var(--sys-color-state-ripple-primary);&.cut-off-top{border-top:none}&.cut-off-bottom{border-bottom:none}&.cut-off-right{border-right:none}&.cut-off-left{border-left:none}}.overlay-type-ENTRY_SELECTED{z-index:1}.overlay-type-ENTRY_OUTLINE{background-color:transparent;border-width:1px;z-index:0;&.outline-reason-ERROR{border-color:var(--sys-color-error-bright)}&.outline-reason-INFO{border-color:var(--sys-color-primary)}}.overlay-type-CANDY_STRIPED_TIME_RANGE{--red-stripe-width:2px;--white-stripe-width:7px;background-image:repeating-linear-gradient(315deg,var(--sys-color-error-bright),var(--sys-color-error-bright) var(--red-stripe-width),transparent var(--red-stripe-width),transparent var(--white-stripe-width));border:1px solid var(--sys-color-error-bright);&.cut-off-bottom{border-bottom:none}&.cut-off-top{border-top:none}&.cut-off-right{border-right:none}&.cut-off-left{border-left:none}}.overlay-type-ENTRIES_LINK{height:100%;width:100%}.overlay-type-TIME_RANGE{top:0;bottom:0;&.overlap-1{bottom:55px}&.overlap-2{bottom:105px}}.overlay-type-TIMESTAMP_MARKER{top:0;bottom:0;width:2px;background-color:var(--sys-color-primary);pointer-events:none}.timeline-entry-tooltip-element:not(:empty){z-index:2000;position:absolute;contain:content;background-color:var(--sys-color-cdt-base-container);pointer-events:none;padding:var(--sys-size-4);border-radius:var(--sys-shape-corner-small);white-space:nowrap;max-width:80%;box-shadow:var(--sys-elevation-level2)}.overlay-type-TIMESPAN_BREAKDOWN{top:unset;bottom:0;height:100px}.overlay-type-TIMINGS_MARKER{bottom:0;width:0.5px;pointer-events:auto}.marker-title{display:flex;justify-content:center;padding:0 var(--sys-size-3);font-size:var(--sys-typescale-body4-size);color:var(--sys-color-base);&:hover{cursor:default;transition:opacity 0.2s ease}}.markers{position:fixed;display:flex;bottom:0}.overlay-popover span{margin-right:var(--sys-size-3)}.overlay-popover span.overlay-popover-time{color:var(--sys-color-green)}\n/*# sourceURL=${import.meta.resolve("./timelineFlameChartView.css")} */\n`};const pr={sAtS:"{PH1} at {PH2}"},mr=e.i18n.registerUIStrings("panels/timeline/TimelineFlameChartView.ts",pr),ur=e.i18n.getLocalizedString.bind(void 0,mr),gr={navigationStart:0,MarkLoad:1,firstContentfulPaint:2,MarkDOMContent:3,"largestContentfulPaint::Candidate":4},vr=t.Types.Timing.Micro(10);class Tr extends(l.ObjectWrapper.eventMixin(m.Widget.VBox)){delegate;searchResults=void 0;eventListeners;networkSplitWidget;mainDataProvider;mainFlameChart;networkFlameChartGroupExpansionSetting;networkDataProvider;networkFlameChart;networkPane;splitResizer;chartSplitWidget;brickGame;countersView;detailsSplitWidget;detailsView;onMainAddEntryLabelAnnotation;onNetworkAddEntryLabelAnnotation;#en;#tn;onMainEntrySelected;onNetworkEntrySelected;#in;#le;groupBySetting;searchableView;needsResizeToPreferredHeights;selectedSearchResult;searchRegex;#t;#nn;#rn=null;#Ii=null;#an=null;#te=this.#ie.bind(this);#sn=0;#on=setTimeout((()=>({})),0);#ln=document.createElement("div");#dn;#cn=null;#hn=null;#pn=[];#mn=null;#un=[];#gn=document.createElement("div");#vn=new Map;#Tn;#yn;#fn=null;#de=null;#Sn=[];#wn=this.#bn({inclusive:!1,outline:!0});#En=this.#bn({inclusive:!1,outline:!0});#Cn=this.#bn({inclusive:!1,outline:!1});#kn=this.#bn({inclusive:!1,outline:!0});#In=this.#bn({inclusive:!0,outline:!1});constructor(e){super(),this.registerRequiredCSS(hr),this.element.classList.add("timeline-flamechart"),this.delegate=e,this.eventListeners=[],this.#t=null,this.#nn=null;const t=new m.Widget.VBox;t.element.classList.add("flame-charts-container"),this.networkSplitWidget=new m.SplitWidget.SplitWidget(!1,!1,"timeline-flamechart-main-view",150),this.networkSplitWidget.show(t.element),this.#ln.classList.add("timeline-overlays-container"),t.element.appendChild(this.#ln),this.#gn.classList.add("timeline-entry-tooltip-element"),t.element.appendChild(this.#gn),this.networkSplitWidget.sidebarElement().style.zIndex="120";const n=l.Settings.Settings.instance().createSetting("timeline-flamechart-main-view-group-expansion",{});this.mainDataProvider=new Ir,this.mainDataProvider.addEventListener("DataChanged",(()=>this.mainFlameChart.scheduleUpdate())),this.mainDataProvider.addEventListener("FlameChartItemHovered",(e=>this.detailsView.revealEventInTreeView(e.data))),this.mainFlameChart=new i.FlameChart.FlameChart(this.mainDataProvider,this,{groupExpansionSetting:n,selectedElementOutline:!1,tooltipElement:this.#gn,useOverlaysForCursorRuler:!0}),this.mainFlameChart.alwaysShowVerticalScroll(),this.mainFlameChart.enableRuler(!1),this.mainFlameChart.addEventListener("LatestDrawDimensions",(e=>{this.#dn.updateChartDimensions("main",e.data.chart),this.#dn.updateVisibleWindow(e.data.traceWindow),this.#dn.update()})),this.networkFlameChartGroupExpansionSetting=l.Settings.Settings.instance().createSetting("timeline-flamechart-network-view-group-expansion",{}),this.networkDataProvider=new dr,this.networkFlameChart=new i.FlameChart.FlameChart(this.networkDataProvider,this,{groupExpansionSetting:this.networkFlameChartGroupExpansionSetting,selectedElementOutline:!1,tooltipElement:this.#gn,useOverlaysForCursorRuler:!0}),this.networkFlameChart.alwaysShowVerticalScroll(),this.networkFlameChart.addEventListener("LatestDrawDimensions",(e=>{this.#dn.updateChartDimensions("network",e.data.chart),this.#dn.updateVisibleWindow(e.data.traceWindow),this.#dn.update(),this.mainFlameChart.setTooltipYPixelAdjustment(this.#dn.networkChartOffsetHeight())})),this.mainFlameChart.addEventListener("MouseMove",(e=>{this.#Mn(e.data)})),this.networkFlameChart.addEventListener("MouseMove",(e=>{this.#Mn(e.data)})),this.#dn=new f.Overlays.Overlays({container:this.#ln,flameChartsContainers:{main:this.mainFlameChart.element,network:this.networkFlameChart.element},charts:{mainChart:this.mainFlameChart,mainProvider:this.mainDataProvider,networkChart:this.networkFlameChart,networkProvider:this.networkDataProvider},entryQueries:{parsedTrace:()=>this.#t,isEntryCollapsedByUser:e=>Ve.activeManager()?.getEntriesFilter().entryIsInvisible(e)??!1,firstVisibleParentForEntry:e=>Ve.activeManager()?.getEntriesFilter().firstVisibleParentEntryForEntry(e)??null}}),this.#dn.addEventListener(f.Overlays.ConsentDialogVisibilityChange.eventName,(e=>{e.isVisible?this.element.setAttribute("inert","inert"):this.element.removeAttribute("inert")})),this.#dn.addEventListener(f.Overlays.EntryLabelMouseClick.eventName,(e=>{const{overlay:t}=e;this.dispatchEventToListeners("EntryLabelAnnotationClicked",{entry:t.entry})})),this.#dn.addEventListener(f.Overlays.AnnotationOverlayActionEvent.eventName,(e=>{const{overlay:t,action:i}=e;"Remove"===i?(Ve.activeManager()?.getAnnotationByOverlay(t)===this.#cn&&(this.#cn=null),Ve.activeManager()?.removeAnnotationOverlay(t)):"Update"===i&&Ve.activeManager()?.updateAnnotationOverlay(t)})),this.element.addEventListener(y.EntriesLinkOverlay.EntryLinkStartCreating.eventName,(()=>{this.focus()})),this.element.setAttribute("jslog",`${v.section("timeline.flame-chart-view")}`),this.networkPane=new m.Widget.VBox,this.networkPane.setMinimumSize(23,23),this.networkFlameChart.show(this.networkPane.element),this.splitResizer=this.networkPane.element.createChild("div","timeline-flamechart-resizer"),this.networkSplitWidget.hideDefaultResizer(!0),this.networkSplitWidget.installResizer(this.splitResizer),this.networkSplitWidget.setMainWidget(this.mainFlameChart),this.networkSplitWidget.setSidebarWidget(this.networkPane),this.chartSplitWidget=new m.SplitWidget.SplitWidget(!1,!0,"timeline-counters-split-view-state"),this.countersView=new rt(this.delegate),this.chartSplitWidget.setMainWidget(t),this.chartSplitWidget.setSidebarWidget(this.countersView),this.chartSplitWidget.hideDefaultResizer(),this.chartSplitWidget.installResizer(this.countersView.resizerElement()),this.detailsSplitWidget=new m.SplitWidget.SplitWidget(!1,!0,"timeline-panel-details-split-view-state"),this.detailsSplitWidget.element.classList.add("timeline-details-split"),this.detailsView=new tr(e),this.detailsSplitWidget.installResizer(this.detailsView.headerElement()),this.detailsSplitWidget.setMainWidget(this.chartSplitWidget),this.detailsSplitWidget.setSidebarWidget(this.detailsView),this.detailsSplitWidget.show(this.element),this.onMainAddEntryLabelAnnotation=this.onAddEntryLabelAnnotation.bind(this,this.mainDataProvider),this.onNetworkAddEntryLabelAnnotation=this.onAddEntryLabelAnnotation.bind(this,this.networkDataProvider),this.#en=e=>this.onEntriesLinkAnnotationCreate(this.mainDataProvider,e.data.entryFromIndex),this.#tn=e=>this.onEntriesLinkAnnotationCreate(this.networkDataProvider,e.data.entryFromIndex),this.mainFlameChart.addEventListener("EntryLabelAnnotationAdded",this.onMainAddEntryLabelAnnotation,this),this.networkFlameChart.addEventListener("EntryLabelAnnotationAdded",this.onNetworkAddEntryLabelAnnotation,this),this.mainFlameChart.addEventListener("EntriesLinkAnnotationCreated",this.#en,this),this.networkFlameChart.addEventListener("EntriesLinkAnnotationCreated",this.#tn,this),this.mainFlameChart.addEventListener("TracksReorderStateChange",(e=>{this.#dn.toggleAllOverlaysDisplayed(!e.data)})),this.detailsView.addEventListener("TreeRowHovered",(e=>{if(!d.Runtime.experiments.isEnabled("timeline-dim-unrelated-events"))return;if(e.data.events)return void this.#xn(this.#En,e.data.events);const t=e?.data?.node?.events??null;this.#xn(this.#En,t)})),this.detailsView.addEventListener("TreeRowClicked",(e=>{if(e.data.events)return void this.#xn(this.#Cn,e.data.events);const t=e?.data?.node?.events??null;this.#xn(this.#Cn,t)})),this.onMainEntrySelected=this.onEntrySelected.bind(this,this.mainDataProvider),this.onNetworkEntrySelected=this.onEntrySelected.bind(this,this.networkDataProvider),this.mainFlameChart.addEventListener("EntrySelected",this.onMainEntrySelected,this),this.networkFlameChart.addEventListener("EntrySelected",this.onNetworkEntrySelected,this),this.#Tn=this.#Pn.bind(this,this.mainDataProvider),this.#yn=this.#Pn.bind(this,this.networkDataProvider),this.mainFlameChart.addEventListener("EntryInvoked",this.#Tn,this),this.networkFlameChart.addEventListener("EntryInvoked",this.#yn,this),this.mainFlameChart.addEventListener("EntryHovered",(e=>{this.onEntryHovered(e),this.updateLinkSelectionAnnotationWithToEntry(this.mainDataProvider,e.data)}),this),this.networkFlameChart.addEventListener("EntryHovered",(e=>{this.updateLinkSelectionAnnotationWithToEntry(this.networkDataProvider,e.data)}),this),this.#dn.addEventListener(f.Overlays.EventReferenceClick.eventName,(e=>{const t=yt(e.event);this.openSelectionDetailsView(t)})),this.element.addEventListener(T.EventRef.EventReferenceClick.eventName,(e=>{this.setSelectionAndReveal(yt(e.event))})),this.element.addEventListener("keydown",this.#Rn.bind(this)),this.element.addEventListener("pointerdown",this.#Fn.bind(this)),this.#in=this.#Ln.bind(this),this.#le=null,this.groupBySetting=l.Settings.Settings.instance().createSetting("timeline-tree-group-by",Lt.GroupBy.None),this.groupBySetting.addChangeListener(this.refreshMainFlameChart,this),this.refreshMainFlameChart(),a.TraceBounds.onChange(this.#te)}containingElement(){return this.element}dimThirdPartiesIfRequired(){if(!this.#t)return;const e=l.Settings.Settings.instance().createSetting("timeline-dim-third-parties",!1).get(),t=this.#de?.thirdPartyEvents()??[];e&&t.length?this.#xn(this.#In,t):this.#xn(this.#In,null)}#bn(e){const t={active:!1,mainChartIndices:[],networkChartIndices:[],inclusive:e.inclusive,outline:e.outline};return this.#Sn.push(t),t}#xn(e,t){t?(e.active=!0,e.mainChartIndices=t.map((e=>this.mainDataProvider.indexForEvent(e)??-1)),e.networkChartIndices=t.map((e=>this.networkDataProvider.indexForEvent(e)??-1))):(e.active=!1,e.mainChartIndices=[],e.networkChartIndices=[]),this.#An()}#Nn(e,t,i){e.active=!0,e.mainChartIndices=t,e.networkChartIndices=i,this.#An()}#An(){const e=this.#Sn.find((e=>e.active));if(this.delegate.set3PCheckboxDisabled(Boolean(e&&e!==this.#In)),!e)return this.mainFlameChart.disableDimming(),void this.networkFlameChart.disableDimming();const t="boolean"==typeof e.outline?e.outline:e.outline.main,i="boolean"==typeof e.outline?e.outline:e.outline.network;this.mainFlameChart.enableDimming(e.mainChartIndices,e.inclusive,t),this.networkFlameChart.enableDimming(e.networkChartIndices,e.inclusive,i)}#Dn(e){const i=e.map((e=>this.mainDataProvider.indexForEvent(e)??-1)),n=e.map((e=>this.networkDataProvider.indexForEvent(e)??-1));this.#kn.outline={main:[...i],network:[...n]};for(const e of this.#pn){let r,a,s;if("TIMESPAN_BREAKDOWN"===e.type){const i=e.sections.at(0),n=e.sections.at(-1);i&&n&&(r=t.Helpers.Timing.traceWindowFromMicroSeconds(i.bounds.min,n.bounds.max))}else"TIME_RANGE"===e.type&&(r=e.bounds);if(!r)continue;const o=f.Overlays.entriesForOverlay(e).at(0);o?null!==this.mainDataProvider.indexForEvent(o)?(a=this.mainDataProvider,s=i):null!==this.networkDataProvider.indexForEvent(o)&&(a=this.networkDataProvider,s=n):"TIMESPAN_BREAKDOWN"===e.type&&(a=this.mainDataProvider,s=i),a&&s&&s.push(...a.search(r).map((e=>e.index)))}this.#Nn(this.#kn,i,n)}#Bn(e){e.sort(((e,t)=>(gr[e.name]??1/0)-(gr[t.name]??1/0)))}#Hn(){if(!this.#nn?.cruxFieldData||!this.#rn)return;const e=new Map;for(const[i,n]of this.#rn)n.navigation&&e.set(i,t.Insights.Common.getFieldMetricsForInsightSet(n,this.#nn,g.CrUXManager.instance().getSelectedScope()));for(const t of this.#un)for(const i of t.entries){const n=i.args?.data?.navigationId;if(!n)continue;const r=e.get(n);if(!r)continue;let a;"firstContentfulPaint"===i.name?a=r.fcp:"largestContentfulPaint::Candidate"===i.name&&(a=r.lcp),a&&t.entryToFieldResult.set(i,a)}}setMarkers(e){if(!e)return;this.bulkRemoveOverlays(this.#un);const i=e.PageLoadMetrics.allMarkerEvents.filter((e=>"navigationStart"===e.name||"largestContentfulPaint::Candidate"===e.name||"firstContentfulPaint"===e.name||"MarkDOMContent"===e.name||"MarkLoad"===e.name));this.#Bn(i);const n=new Map;i.forEach((i=>{const r=t.Helpers.Timing.timeStampForEventAdjustedByClosestNavigation(i,e.Meta.traceBounds,e.Meta.navigationsByNavigationId,e.Meta.navigationsByFrameId);let a=!1;for(const[e,t]of n.entries())if(Math.abs(i.ts-e)<=vr){t.entries.push(i),a=!0;break}if(!a){const e={type:"TIMINGS_MARKER",entries:[i],entryToFieldResult:new Map,adjustedTimestamp:r};n.set(i.ts,e)}}));const r=[...n.values()];this.#un=r,0!==this.#un.length&&(this.#Hn(),this.bulkAddOverlays(this.#un))}setOverlays(e,i){if(this.bulkRemoveOverlays(this.#pn),this.#pn=e,0===this.#pn.length)return;const n=a.TraceBounds.BoundsManager.instance().state()?.micro.entireTraceBounds;if(!n)return;this.bulkAddOverlays(this.#pn);const r=[];for(const e of this.#pn)r.push(...f.Overlays.entriesForOverlay(e));if(d.Runtime.experiments.isEnabled("timeline-dim-unrelated-events")){let e=this.#mn?.model.relatedEvents;e?e instanceof Map&&(e=Array.from(e.keys())):e=[],this.#Dn([...r,...e])}if(i.updateTraceWindow){for(const e of r)this.#Un(e);const e=f.Overlays.traceWindowContainingOverlays(this.#pn);if(e){const i=t.Helpers.Timing.expandWindowByPercentOrToOneMillisecond(e,n,100);a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(i,{ignoreMiniMapBounds:!0,shouldAnimate:!0})}}if(0!==r.length){const e=r.reduce(((e,t)=>e.ts<t.ts?e:t),r[0]);this.revealEventVertically(e)}}revealAnnotation(e){const i=a.TraceBounds.BoundsManager.instance().state()?.micro.entireTraceBounds;if(!i)return;const n=ie(e);if(!n)return;const r=te(e);for(const e of r)this.#Un(e);const s=r.at(0);s&&this.revealEventVertically(s);const o=t.Helpers.Timing.expandWindowByPercentOrToOneMillisecond(n,i,100);a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(o,{ignoreMiniMapBounds:!0,shouldAnimate:!0})}setActiveInsight(e){this.#mn=e,this.bulkRemoveOverlays(this.#pn),this.#mn||this.#xn(this.#kn,null)}#Un(e){const t=f.Overlays.chartForEntry(e),i="main"===t?this.mainDataProvider:this.networkDataProvider,n="main"===t?this.mainFlameChart:this.networkFlameChart,r=i.indexForEvent?.(e)??null;if(null===r)return;const a=i.groupForEvent?.(r)??null;if(!a)return;const s=i.timelineData().groups.indexOf(a);!a.expanded&&s>-1&&n.toggleGroupExpand(s)}addTimestampMarkerOverlay(e){this.addOverlay({type:"TIMESTAMP_MARKER",timestamp:e})}async removeTimestampMarkerOverlay(){this.#dn.removeOverlaysOfType("TIMESTAMP_MARKER")>0&&await this.#dn.update()}async#Mn(e){const{mouseEvent:t,timeInMicroSeconds:i}=e;t.shiftKey||await this.removeTimestampMarkerOverlay(),!t.metaKey&&t.shiftKey&&this.addTimestampMarkerOverlay(i)}#Fn(e){2===e.buttons&&this.#hn&&(this.#On(!0),e.stopPropagation())}#On(e){null!==this.#hn&&((e||"connected"!==this.#hn.state)&&Ve.activeManager()?.removeAnnotation(this.#hn),this.mainFlameChart.setLinkSelectionAnnotationIsInProgress(!1),this.networkFlameChart.setLinkSelectionAnnotationIsInProgress(!1),this.#hn=null)}#_n(e){this.mainFlameChart.setLinkSelectionAnnotationIsInProgress(!0),this.networkFlameChart.setLinkSelectionAnnotationIsInProgress(!0),this.#hn=e}#Wn(e,i){this.#cn||(this.#cn={bounds:t.Helpers.Timing.traceWindowFromMicroSeconds(e,i),type:"TIME_RANGE",label:""},Ve.activeManager()?.createAnnotation(this.#cn))}#Vn(e){const i=a.TraceBounds.BoundsManager.instance().state()?.micro.timelineTraceWindow;if(!i)return!1;const n=.02*i.range;switch(e.key){case"ArrowRight":if(!this.#cn){if(e.altKey){let e=i.min;return this.#fn&&(e=bt(this.#fn).min),this.#Wn(e,t.Types.Timing.Micro(e+n)),!0}return!1}return this.#cn.bounds.max=t.Types.Timing.Micro(Math.min(this.#cn.bounds.max+n,i.max)),this.#cn.bounds.range=t.Types.Timing.Micro(this.#cn.bounds.max-this.#cn.bounds.min),Ve.activeManager()?.updateAnnotation(this.#cn),!0;case"ArrowLeft":return!!this.#cn&&(this.#cn.bounds.max=t.Types.Timing.Micro(Math.max(this.#cn.bounds.max-n,this.#cn.bounds.min+1)),this.#cn.bounds.range=t.Types.Timing.Micro(this.#cn.bounds.max-this.#cn.bounds.min),Ve.activeManager()?.updateAnnotation(this.#cn),!0);case"ArrowUp":return!!this.#cn&&(this.#cn.bounds.min=t.Types.Timing.Micro(Math.min(this.#cn.bounds.min+n,this.#cn.bounds.max-1)),this.#cn.bounds.range=t.Types.Timing.Micro(this.#cn.bounds.max-this.#cn.bounds.min),Ve.activeManager()?.updateAnnotation(this.#cn),!0);case"ArrowDown":return!!this.#cn&&(this.#cn.bounds.min=t.Types.Timing.Micro(Math.max(this.#cn.bounds.min-n,i.min)),this.#cn.bounds.range=t.Types.Timing.Micro(this.#cn.bounds.max-this.#cn.bounds.min),Ve.activeManager()?.updateAnnotation(this.#cn),!0);default:return this.#cn=null,!1}}#Rn(e){const t="fixme";this.#hn&&"creation_not_started"===this.#hn.state&&(this.#On(!0),e.stopPropagation()),"Escape"===e.key&&this.#hn&&(this.#On(!0),e.stopPropagation(),e.preventDefault());if(this.#Vn(e))return e.preventDefault(),void e.stopPropagation();e.key===t[this.#sn]?(this.#sn++,clearTimeout(this.#on),this.#on=setTimeout((()=>{this.#sn=0}),2e3)):(this.#sn=0,clearTimeout(this.#on)),5===this.#sn&&this.runBrickBreakerGame()}runBrickBreakerGame(){}#ie(e){if("MINIMAP_BOUNDS"===e.updateType)return;const t=e.state.milli.timelineTraceWindow,i=window.matchMedia("(prefers-reduced-motion: reduce)").matches,n=Boolean(e.options.shouldAnimate)&&!i;this.mainFlameChart.setWindowTimes(t.min,t.max,n),this.networkDataProvider.setWindowTimes(t.min,t.max),this.networkFlameChart.setWindowTimes(t.min,t.max,n);l.Debouncer.debounce((()=>{this.updateSearchResults(!1,!1)}),100)()}isNetworkTrackShownForTests(){return"OnlyMain"!==this.networkSplitWidget.showMode()}getLinkSelectionAnnotation(){return this.#hn}getMainDataProvider(){return this.mainDataProvider}getNetworkDataProvider(){return this.networkDataProvider}refreshMainFlameChart(){this.mainFlameChart.update()}windowChanged(e,i,n){a.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(t.Helpers.Timing.traceWindowFromMilliSeconds(t.Types.Timing.Milli(e),t.Types.Timing.Milli(i)),{shouldAnimate:n})}updateRangeSelection(e,i){this.delegate.select(ft(t.Types.Timing.Milli(e),t.Types.Timing.Milli(i)));const n=t.Helpers.Timing.traceWindowFromMilliSeconds(t.Types.Timing.Milli(e),t.Types.Timing.Milli(i));this.#cn?(this.#cn.bounds=n,Ve.activeManager()?.updateAnnotation(this.#cn)):(this.#cn={type:"TIME_RANGE",label:"",bounds:n},Ve.activeManager()?.deleteEmptyRangeAnnotations(),Ve.activeManager()?.createAnnotation(this.#cn))}getMainFlameChart(){return this.mainFlameChart}getNetworkFlameChart(){return this.networkFlameChart}updateSelectedGroup(e,t){e===this.mainFlameChart&&this.#an!==t?.name&&(this.#an=t?.name||null,this.#le=t?this.mainDataProvider.groupTreeEvents(t):null,this.#Gn())}setModel(e,t){if(e!==this.#t){this.#t=e,this.#nn=t;for(const e of this.#Sn)e.active=!1,e.mainChartIndices=[],e.networkChartIndices=[];this.rebuildDataForTrace()}}rebuildDataForTrace(){this.#t&&(this.#an=null,l.EventTarget.removeEventListeners(this.eventListeners),this.#le=null,this.#de=new s.EntityMapper.EntityMapper(this.#t),this.mainDataProvider.setModel(this.#t,this.#de),this.networkDataProvider.setModel(this.#t,this.#de),this.reset(),this.setupWindowTimes(),this.updateSearchResults(!1,!1),this.refreshMainFlameChart(),this.#zn(),this.resizeToPreferredHeights(),this.setMarkers(this.#t),this.dimThirdPartiesIfRequired(),Ve.activeManager()?.applyAnnotationsFromCache())}setInsights(e,t){this.#rn!==e&&(this.#rn=e,this.#Ii=t,this.#Gn())}reset(){this.networkDataProvider.isEmpty()?(this.mainFlameChart.enableRuler(!0),this.networkSplitWidget.hideSidebar()):(this.mainFlameChart.enableRuler(!1),this.networkSplitWidget.showBoth(),this.resizeToPreferredHeights()),this.#dn.reset(),this.mainFlameChart.reset(),this.networkFlameChart.reset(),this.updateSearchResults(!1,!1)}setupWindowTimes(){const e=a.TraceBounds.BoundsManager.instance().state();if(!e)throw new Error("TimelineFlameChartView could not set the window bounds.");const t=e.milli.timelineTraceWindow;this.mainFlameChart.setWindowTimes(t.min,t.max),this.networkDataProvider.setWindowTimes(t.min,t.max),this.networkFlameChart.setWindowTimes(t.min,t.max)}#Ln(){this.mainDataProvider.timelineData(!0),this.mainFlameChart.scheduleUpdate()}#Gn(){this.countersView.setModel(this.#t,this.#le),this.detailsView.setModel({parsedTrace:this.#t,selectedEvents:this.#le,traceInsightsSets:this.#rn,eventToRelatedInsightsMap:this.#Ii,entityMapper:this.#de})}#zn(){this.mainFlameChart.scheduleUpdate(),this.networkFlameChart.scheduleUpdate(),this.#jn()}#jn(){const e=[...this.mainFlameChart.timelineData()?.groups??[],...this.networkFlameChart.timelineData()?.groups??[]];for(const t of e){if(!t.jslogContext)continue;const e=this.#vn.get(t.jslogContext)??Symbol(t.jslogContext);this.#vn.has(t.jslogContext)||(this.#vn.set(t.jslogContext,e),v.registerLoggable(e,`${v.section().context(`timeline.${t.jslogContext}`)}`,this.delegate.element))}}updateLinkSelectionAnnotationWithToEntry(e,t){if(!this.#hn||"creation_not_started"===this.#hn.state)return;const i=this.#$n(t,e);if(i){if(i===this.#hn.entryFrom)return;const e=Ve.activeManager()?.linkAnnotationBetweenEntriesExists(this.#hn.entryFrom,i);if(e)return;this.#hn.state="connected",this.#hn.entryTo=i}else this.#hn.state="pending_to_event",delete this.#hn.entryTo;Ve.activeManager()?.updateAnnotation(this.#hn)}onEntryHovered(e){o.OverlayModel.OverlayModel.hideDOMNodeHighlight();const i=e.data,n=this.mainDataProvider.eventByIndex(i);if(!n||!this.#t)return;if(t.Types.Events.isLegacyTimelineFrame(n))return;const r=dt(this.#t,n);if(!r)return;const a=t.Extras.FetchNodes.nodeIdsForEvent(this.#t,n);for(const e of a)new o.DOMModel.DeferredDOMNode(r,e).highlight()}highlightEvent(e){const t=e?this.mainDataProvider.entryIndexForSelection(yt(e)):-1;t>=0?this.mainFlameChart.highlightEntry(t):this.mainFlameChart.hideHighlight()}willHide(){this.networkFlameChartGroupExpansionSetting.removeChangeListener(this.resizeToPreferredHeights,this),u.IgnoreListManager.IgnoreListManager.instance().removeChangeListener(this.#in)}wasShown(){super.wasShown(),this.networkFlameChartGroupExpansionSetting.addChangeListener(this.resizeToPreferredHeights,this),u.IgnoreListManager.IgnoreListManager.instance().addChangeListener(this.#in),this.needsResizeToPreferredHeights&&this.resizeToPreferredHeights(),this.#zn()}updateCountersGraphToggle(e){e?this.chartSplitWidget.showBoth():this.chartSplitWidget.hideSidebar()}revealEvent(e){const t=this.mainDataProvider.indexForEvent(e),i=this.networkDataProvider.indexForEvent(e);null!==t?this.mainFlameChart.revealEntry(t):null!==i&&this.networkFlameChart.revealEntry(i)}revealEventVertically(e){const t=this.mainDataProvider.indexForEvent(e),i=this.networkDataProvider.indexForEvent(e);null!==t?this.mainFlameChart.revealEntryVertically(t):null!==i&&this.networkFlameChart.revealEntryVertically(i)}setSelectionAndReveal(e){this.#fn=e,this.#dn.removeOverlaysOfType("ENTRY_SELECTED"),null!==e&&wt(e)||!this.#cn||this.#cn.label||(Ve.activeManager()?.removeAnnotation(this.#cn),this.#cn=null),null===e&&this.#xn(this.#Cn,null);const t=this.mainDataProvider.entryIndexForSelection(e);this.mainDataProvider.buildFlowForInitiator(t),this.mainFlameChart.setSelectedEntry(t);const i=this.networkDataProvider.entryIndexForSelection(e);this.networkDataProvider.buildFlowForInitiator(i),this.networkFlameChart.setSelectedEntry(i),this.detailsView&&this.detailsView.setSelection(e),St(e)&&this.addOverlay({type:"ENTRY_SELECTED",entry:e.event}),this.#hn&&"creation_not_started"===this.#hn.state&&this.#On(!0),St(e)&&this.#t&&requestAnimationFrame((()=>{if(!this.#t)return;const t=s.AICallTree.AICallTree.fromEvent(e.event,this.#t);t&&m.Context.Context.instance().setFlavor(s.AICallTree.AICallTree,t)}))}openSelectionDetailsView(e){this.detailsView&&this.detailsView.setSelection(e)}bulkAddOverlays(e){for(const t of e)this.#dn.add(t);this.#dn.update()}addOverlay(e){const t=this.#dn.add(e);return this.#dn.update(),t}bulkRemoveOverlays(e){if(e.length){for(const t of e)this.#dn.remove(t);this.#dn.update()}}removeOverlay(e){this.#dn.remove(e),this.#dn.update()}updateExistingOverlay(e,t){this.#dn.updateExisting(e,t),this.#dn.update()}enterLabelEditMode(e){this.#dn.enterLabelEditMode(e)}onAddEntryLabelAnnotation(e,t){const i=e.createSelection(t.data.entryIndex);St(i)&&(this.setSelectionAndReveal(i),Ve.activeManager()?.createAnnotation({type:"ENTRY_LABEL",entry:i.event,label:""}),t.data.withLinkCreationButton&&this.onEntriesLinkAnnotationCreate(e,t.data.entryIndex,!0))}onEntriesLinkAnnotationCreate(e,t,i){const n=t?this.#$n(t,e):null;n&&(this.#_n({type:"ENTRIES_LINK",entryFrom:n,state:i?"creation_not_started":"pending_to_event"}),this.#hn&&Ve.activeManager()?.createAnnotation(this.#hn))}#$n(e,t){const i=t.createSelection(e);return St(i)?i.event:null}#Pn(e,t){this.#Kn(e,t);const i=t.data;this.#hn&&this.handleToEntryOfLinkBetweenEntriesSelection(i)}#Kn(e,t){const i=e.timelineData();if(!i)return;const n=t.data,r=i.entryLevels[n],a=wr(i.groups,r);if(a?.jslogContext){const e=this.#vn.get(a.jslogContext)??null;e&&v.logClick(e,new MouseEvent("click"))}e.buildFlowForInitiator(n),this.delegate.select(e.createSelection(n))}onEntrySelected(e,t){this.#Kn(e,t);const i=t.data,n=this.#$n(i,e);n&&n!==this.#hn?.entryTo&&this.updateLinkSelectionAnnotationWithToEntry(e,i)}handleToEntryOfLinkBetweenEntriesSelection(e){if(this.#hn&&-1===e)Ve.activeManager()?.removeAnnotation(this.#hn);else if(this.#hn&&this.#hn?.entryTo&&this.#hn?.entryFrom.ts>this.#hn?.entryTo.ts){const e=this.#hn.entryFrom,t=this.#hn.entryTo;this.#hn.entryTo=e,this.#hn.entryFrom=t,Ve.activeManager()?.updateAnnotation(this.#hn)}this.#On(!1)}resizeToPreferredHeights(){this.isShowing()?(this.needsResizeToPreferredHeights=!1,this.networkPane.element.classList.toggle("timeline-network-resizer-disabled",!this.networkDataProvider.isExpanded()),this.networkSplitWidget.setSidebarSize(this.networkDataProvider.preferredHeight()+this.splitResizer.clientHeight+i.FlameChart.RulerHeight+2)):this.needsResizeToPreferredHeights=!0}setSearchableView(e){this.searchableView=e}searchResultIndexForEntryIndex(e){return this.searchResults?this.searchResults.findIndex((t=>t.index===e)):-1}jumpToNextSearchResult(){if(!this.searchResults?.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):-1;this.#qn(r.NumberUtilities.mod(e+1,this.searchResults.length))}jumpToPreviousSearchResult(){if(!this.searchResults?.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):0;this.#qn(r.NumberUtilities.mod(e-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}#qn(e){this.searchableView.updateCurrentMatchIndex(e);const t=this.searchResults?.at(e)??null;if(t){switch(t.provider){case"main":this.delegate.select(this.mainDataProvider.createSelection(t.index)),this.mainFlameChart.showPopoverForSearchResult(t.index);break;case"network":this.delegate.select(this.networkDataProvider.createSelection(t.index)),this.networkFlameChart.showPopoverForSearchResult(t.index);break;case"other":break;default:r.assertNever(t.provider,`Unknown SearchResult[provider]: ${t.provider}`)}this.selectedSearchResult=t}}updateSearchResults(e,t){const i=a.TraceBounds.BoundsManager.instance().state();if(!i)return;const n=this.selectedSearchResult;if(delete this.selectedSearchResult,this.searchResults=[],!this.searchRegex)return;const r=new Pn(this.searchRegex),s=i.micro.timelineTraceWindow,o=this.mainDataProvider.search(s,r),l=this.networkDataProvider.search(s,r);if(this.searchResults=o.concat(l).sort(((e,t)=>e.startTimeMilli-t.startTimeMilli)),this.searchableView.updateSearchMatchesCount(this.searchResults.length),d.Runtime.experiments.isEnabled("timeline-dim-unrelated-events")&&this.#Nn(this.#wn,o.map((e=>e.index)),l.map((e=>e.index))),!e||!this.searchResults.length)return;let c=this.#Yn(n);-1===c&&(c=t?this.searchResults.length-1:0),this.#qn(c)}#Yn(e){return e?this.searchResults?.findIndex((t=>t.provider===e.provider&&t.index===e.index))??-1:-1}getSearchResults(){return this.searchResults}onSearchCanceled(){void 0!==this.selectedSearchResult&&this.delegate.select(null),delete this.searchResults,delete this.selectedSearchResult,delete this.searchRegex,this.mainFlameChart.showPopoverForSearchResult(null),this.networkFlameChart.showPopoverForSearchResult(null),this.#xn(this.#wn,null)}performSearch(e,t,i){this.searchRegex=e.toSearchRegex().regex,this.updateSearchResults(t,i)}togglePopover({event:e,show:t}){const i=this.mainDataProvider.indexForEvent(e);t&&i?(this.mainFlameChart.setSelectedEntry(i),this.mainFlameChart.showPopoverForSearchResult(i)):this.mainFlameChart.hideHighlight()}overlays(){return this.#dn}selectDetailsViewTab(e,t){this.detailsView.selectTab(e,t)}}class yr{timelineSelection;entryIndex;constructor(e,t){this.timelineSelection=e,this.entryIndex=t}}const fr={textColor:"#333"};class Sr{startTimeInternal;startOffset;style;constructor(e,t,i){this.startTimeInternal=e,this.startOffset=t,this.style=i}startTime(){return this.startTimeInternal}color(){return this.style.color}title(){if(this.style.lowPriority)return null;const t=e.TimeUtilities.millisToString(this.startOffset);return ur(pr.sAtS,{PH1:this.style.title,PH2:t})}draw(e,t,i,n){this.style.lowPriority&&n<4||this.style.tall&&(e.save(),e.strokeStyle=this.style.color,e.lineWidth=this.style.lineWidth,e.translate(this.style.lineWidth<1||1&this.style.lineWidth?.5:0,.5),e.beginPath(),e.moveTo(t,0),e.setLineDash(this.style.dashStyle),e.lineTo(t,e.canvas.height),e.stroke(),e.restore())}}function wr(e,t){return e.find(((i,n)=>{const r=e.at(n+1),a=r?r.startLevel-1:1/0;return i.startLevel<=t&&a>=t}))??null}var br=Object.freeze({__proto__:null,FlameChartStyle:fr,SORT_ORDER_PAGE_LOAD_MARKERS:gr,Selection:yr,TimelineFlameChartMarker:Sr,TimelineFlameChartView:Tr,groupForLevel:wr});const Er={frames:"Frames",idleFrame:"Idle frame",droppedFrame:"Dropped frame",partiallyPresentedFrame:"Partially-presented frame",frame:"Frame",hideFunction:"Hide function",hideChildren:"Hide children",hideRepeatingChildren:"Hide repeating children",removeScriptFromIgnoreList:"Remove script from ignore list",addScriptToIgnoreList:"Add script to ignore list",resetChildren:"Reset children",resetTrace:"Reset trace"},Cr=e.i18n.registerUIStrings("panels/timeline/TimelineFlameChartDataProvider.ts",Er),kr=e.i18n.getLocalizedString.bind(void 0,Cr);class Ir extends l.ObjectWrapper.ObjectWrapper{isReactNative=!1;droppedFramePatternCanvas;partialFramePatternCanvas;timelineDataInternal=null;currentLevel=0;compatibilityTracksAppender=null;parsedTrace=null;#Wi=0;timeSpan=0;framesGroupStyle;screenshotsGroupStyle;entryData=[];entryTypeByLevel=[];entryIndexToTitle=[];lastInitiatorEntry=-1;lastInitiatorsData=[];lastSelection=null;#Hi=`${i.Font.DEFAULT_FONT_SIZE} ${i.Font.getFontFamilyForCanvas()}`;#Ki=new WeakMap;#de=null;constructor(){super(),this.isReactNative=d.Runtime.experiments.isEnabled("react-native-specific-ui"),this.reset(),this.droppedFramePatternCanvas=document.createElement("canvas"),this.partialFramePatternCanvas=document.createElement("canvas"),this.preparePatternCanvas(),this.framesGroupStyle=this.buildGroupStyle({useFirstLineForOverview:!0}),this.screenshotsGroupStyle=this.buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),n.ThemeSupport.instance().addEventListener(n.ThemeChangeEvent.eventName,(()=>{const e=[this.framesGroupStyle,this.screenshotsGroupStyle];for(const t of e)t.color=n.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),t.backgroundColor=n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container")})),s.ImageCache.emitter.addEventListener("screenshot-loaded",(()=>this.dispatchEventToListeners("DataChanged"))),l.Settings.Settings.instance().moduleSetting("skip-stack-frames-pattern").addChangeListener(this.#Jn.bind(this)),l.Settings.Settings.instance().moduleSetting("skip-content-scripts").addChangeListener(this.#Jn.bind(this)),l.Settings.Settings.instance().moduleSetting("automatically-ignore-list-known-third-party-scripts").addChangeListener(this.#Jn.bind(this)),l.Settings.Settings.instance().moduleSetting("enable-ignore-listing").addChangeListener(this.#Jn.bind(this)),l.Settings.Settings.instance().moduleSetting("skip-anonymous-scripts").addChangeListener(this.#Jn.bind(this))}hasTrackConfigurationMode(){return!0}getPossibleActions(e,t){const i=this.timelineData();if(!i)return;const n=i.groups.at(t);return n&&n.expanded&&n.showStackContextMenu?this.findPossibleContextMenuActions(e):void 0}customizedContextMenu(e,i,n){const r=this.eventByIndex(i);if(!r)return;const a=this.getPossibleActions(i,n),o="drjones.performance-panel-context",l=Boolean(r&&this.parsedTrace&&m.ActionRegistry.ActionRegistry.instance().hasAction(o));if(!a&&!l)return;const d=new m.ContextMenu.ContextMenu(e);if(l&&this.parsedTrace){const e=s.AICallTree.AICallTree.fromEvent(r,this.parsedTrace);if(e){const t=m.ActionRegistry.ActionRegistry.instance().getAction(o);d.footerSection().appendItem(t.title(),(()=>{if(this.eventByIndex(i)&&this.parsedTrace)return m.Context.Context.instance().setFlavor(s.AICallTree.AICallTree,e),t.execute()}),{jslogContext:o})}}if(!a)return d;const c=d.defaultSection().appendItem(kr(Er.hideFunction),(()=>{this.modifyTree("MERGE_FUNCTION",i)}),{disabled:!a?.MERGE_FUNCTION,jslogContext:"hide-function"});c.setAccelerator(m.KeyboardShortcut.Keys.H,[m.KeyboardShortcut.Modifiers.None]),c.setIsDevToolsPerformanceMenuItem(!0);const h=d.defaultSection().appendItem(kr(Er.hideChildren),(()=>{this.modifyTree("COLLAPSE_FUNCTION",i)}),{disabled:!a?.COLLAPSE_FUNCTION,jslogContext:"hide-children"});h.setAccelerator(m.KeyboardShortcut.Keys.C,[m.KeyboardShortcut.Modifiers.None]),h.setIsDevToolsPerformanceMenuItem(!0);const p=d.defaultSection().appendItem(kr(Er.hideRepeatingChildren),(()=>{this.modifyTree("COLLAPSE_REPEATING_DESCENDANTS",i)}),{disabled:!a?.COLLAPSE_REPEATING_DESCENDANTS,jslogContext:"hide-repeating-children"});p.setAccelerator(m.KeyboardShortcut.Keys.R,[m.KeyboardShortcut.Modifiers.None]),p.setIsDevToolsPerformanceMenuItem(!0);const g=d.defaultSection().appendItem(kr(Er.resetChildren),(()=>{this.modifyTree("RESET_CHILDREN",i)}),{disabled:!a?.RESET_CHILDREN,jslogContext:"reset-children"});if(g.setAccelerator(m.KeyboardShortcut.Keys.U,[m.KeyboardShortcut.Modifiers.None]),g.setIsDevToolsPerformanceMenuItem(!0),d.defaultSection().appendItem(kr(Er.resetTrace),(()=>{this.modifyTree("UNDO_ALL_ACTIONS",i)}),{disabled:!a?.UNDO_ALL_ACTIONS,jslogContext:"reset-trace"}),!this.parsedTrace||t.Types.Events.isLegacyTimelineFrame(r))return d;const v=s.SourceMapsResolver.SourceMapsResolver.resolvedURLForEntry(this.parsedTrace,r);return v?(s.IgnoreList.isIgnoreListedEntry(r)?d.defaultSection().appendItem(kr(Er.removeScriptFromIgnoreList),(()=>{u.IgnoreListManager.IgnoreListManager.instance().unIgnoreListURL(v),this.#Jn()}),{jslogContext:"remove-from-ignore-list"}):d.defaultSection().appendItem(kr(Er.addScriptToIgnoreList),(()=>{u.IgnoreListManager.IgnoreListManager.instance().ignoreListURL(v),this.#Jn()}),{jslogContext:"add-to-ignore-list"}),d):d}#Jn(){this.timelineData(!0),this.dispatchEventToListeners("DataChanged")}entryHasAnnotations(e){const t=this.eventByIndex(e);if(!t)return!1;const i=Ve.activeManager()?.annotationsForEntry(t);return!!i&&i.length>0}deleteAnnotationsForEntry(e){const t=this.eventByIndex(e);t&&Ve.activeManager()?.deleteEntryAnnotations(t)}modifyTree(e,t){const i=this.entryData[t];Ve.activeManager()?.getEntriesFilter().applyFilterAction({type:e,entry:i}),this.timelineData(!0),this.buildFlowForInitiator(t),this.dispatchEventToListeners("DataChanged")}findPossibleContextMenuActions(e){const t=this.entryData[e];return Ve.activeManager()?.getEntriesFilter().findPossibleActions(t)}handleFlameChartTransformKeyboardEvent(e,t,i){const n=this.getPossibleActions(t,i);if(!n)return;let r=!1;"KeyH"===e.code&&n.MERGE_FUNCTION?(this.modifyTree("MERGE_FUNCTION",t),r=!0):"KeyC"===e.code&&n.COLLAPSE_FUNCTION?(this.modifyTree("COLLAPSE_FUNCTION",t),r=!0):"KeyR"===e.code&&n.COLLAPSE_REPEATING_DESCENDANTS?(this.modifyTree("COLLAPSE_REPEATING_DESCENDANTS",t),r=!0):"KeyU"===e.code&&(this.modifyTree("RESET_CHILDREN",t),r=!0),r&&e.consume(!0)}buildGroupStyle(e){const t={padding:4,height:17,collapsible:!0,color:n.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),backgroundColor:n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"),nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}setModel(e,i){this.reset(),this.parsedTrace=e;const{traceBounds:n}=e.Meta,r=t.Helpers.Timing.microToMilli(n.min),a=t.Helpers.Timing.microToMilli(n.max);this.#Wi=r,this.timeSpan=r===a?1e3:a-this.#Wi,this.#de=i}compatibilityTracksAppenderInstance(e=!1){if(!this.compatibilityTracksAppender||e){if(!this.parsedTrace)throw new Error("Attempted to instantiate a CompatibilityTracksAppender without having set the trace parse data first.");this.timelineDataInternal=this.#Xn(),this.compatibilityTracksAppender=new Ur(this.timelineDataInternal,this.parsedTrace,this.entryData,this.entryTypeByLevel,this.#de)}return this.compatibilityTracksAppender}#Xn(){return this.timelineDataInternal||(this.timelineDataInternal=i.FlameChart.FlameChartTimelineData.createEmpty()),this.timelineDataInternal}buildFromTrackAppendersForTest(e){if(!this.compatibilityTracksAppender)return;const t=this.compatibilityTracksAppender.allVisibleTrackAppenders();for(const i of t){if(i instanceof Ke&&!i.trackName().includes(e?.filterThreadsByName||""))continue;const t=Boolean(e?.expandedTracks?.has(i.appenderName));this.currentLevel=i.appendTrackAtLevel(this.currentLevel,t)}}groupTreeEvents(e){return this.compatibilityTracksAppender?.groupEventsForTreeView(e)??null}mainFrameNavigationStartEvents(){return this.parsedTrace?this.parsedTrace.Meta.mainFrameNavigations:[]}entryTitle(e){const t=this.#Zn(e);if("Screenshot"===t)return"";if("TrackAppender"===t){const t=this.timelineDataInternal.entryLevels[e],i=this.entryData[e];return this.compatibilityTracksAppender?.titleForEvent(i,t)||null}let i=this.entryIndexToTitle[e];return i||(i=`Unexpected entryIndex ${e}`,console.error(i)),i}textColor(e){const t=this.entryData[e];return s.IgnoreList.isIgnoreListedEntry(t)?"#888":fr.textColor}entryFont(e){return this.#Hi}rebuildTimelineData(){this.currentLevel=0,this.entryData=[],this.entryTypeByLevel=[],this.entryIndexToTitle=[],this.#Ki=new Map,this.timelineDataInternal&&(this.compatibilityTracksAppender?.setFlameChartDataAndEntryData(this.timelineDataInternal,this.entryData,this.entryTypeByLevel),this.compatibilityTracksAppender?.threadAppenders().forEach((e=>e.setHeaderAppended(!1))))}reset(){this.currentLevel=0,this.entryData=[],this.entryTypeByLevel=[],this.entryIndexToTitle=[],this.#Ki=new Map,this.#Wi=0,this.timeSpan=0,this.compatibilityTracksAppender?.reset(),this.compatibilityTracksAppender=null,this.timelineDataInternal=null,this.parsedTrace=null,this.#de=null}maxStackDepth(){return this.currentLevel}timelineData(e=!1){return!e&&this.timelineDataInternal&&0!==this.timelineDataInternal.entryLevels.length||(this.timelineDataInternal=i.FlameChart.FlameChartTimelineData.createEmpty(),e&&this.rebuildTimelineData(),this.currentLevel=0,this.parsedTrace&&(this.compatibilityTracksAppender=this.compatibilityTracksAppenderInstance(),this.parsedTrace.Meta.traceIsGeneric?this.#Qn():this.#er())),this.timelineDataInternal}#Qn(){if(!this.compatibilityTracksAppender)return;const e=this.compatibilityTracksAppender.allThreadAppendersByProcess();for(const[t,i]of e){const e=this.buildGroupStyle({shareHeaderLine:!1}),n=this.parsedTrace?.Meta.processNames.get(t)?.args.name||"Process";this.appendHeader(`${n} (${t})`,e,!0,!1);for(const e of i)e.setHeaderNestingLevel(1),this.currentLevel=e.appendTrackAtLevel(this.currentLevel)}}#er(){this.isReactNative||this.#tr();const e=e=>{switch(e.appenderName){case"Animations":return 0;case"Timings":return 1;case"Interactions":return 2;case"LayoutShifts":return 3;case"Extension":return 4;case"Thread":return 5;case"ServerTimings":return 6;case"GPU":return 7;case"Thread_AuctionWorklet":return 8;default:return 9}},t=this.compatibilityTracksAppender?this.compatibilityTracksAppender.allVisibleTrackAppenders():[];t.sort(((t,i)=>e(t)-e(i)));for(const e of t)if(this.parsedTrace&&(this.currentLevel=e.appendTrackAtLevel(this.currentLevel),this.timelineDataInternal&&!this.timelineDataInternal.selectedGroup&&e instanceof Ke&&("MAIN_THREAD"===e.threadType||"CPU_PROFILE"===e.threadType))){const t=this.compatibilityTracksAppender?.groupForAppender(e);t&&(this.timelineDataInternal.selectedGroup=t)}this.timelineDataInternal?.selectedGroup&&(this.timelineDataInternal.selectedGroup.expanded=!0)}minimumBoundary(){return this.#Wi}totalTime(){return this.timeSpan}search(e,i){const n=[];this.timelineData();for(let r=0;r<this.entryData.length;++r){const a=this.entryData[r];if(a&&(!t.Types.Events.isLegacyTimelineFrame(a)&&!t.Types.Events.isLegacyScreenshot(a)&&t.Helpers.Timing.eventIsInBounds(a,e)&&(!i||i.accept(a,this.parsedTrace||void 0)))){const e=t.Helpers.Timing.microToMilli(a.ts);n.push({index:r,startTimeMilli:e,provider:"main"})}}return n}getEntryTypeForLevel(e){return this.entryTypeByLevel[e]}#tr(){if(!this.parsedTrace)return;const e=t.Extras.FilmStrip.fromParsedTrace(this.parsedTrace),i=e.frames.length>0;if(!(this.parsedTrace.Frames.frames.length>0)&&!i)return;this.framesGroupStyle.collapsible=i;const n="frames"===d.Runtime.Runtime.queryParam("flamechart-force-expand");this.appendHeader(kr(Er.frames),this.framesGroupStyle,!1,n),this.entryTypeByLevel[this.currentLevel]="Frame";for(const e of this.parsedTrace.Frames.frames)this.#ir(e);++this.currentLevel,i&&this.#nr(e)}#nr(e){if(!this.timelineDataInternal||!this.parsedTrace)return;let i;this.appendHeader("",this.screenshotsGroupStyle,!1),this.entryTypeByLevel[this.currentLevel]="Screenshot";for(const n of e.frames){const e=t.Helpers.Timing.microToMilli(n.screenshotEvent.ts);this.entryData.push(n.screenshotEvent),this.timelineDataInternal.entryLevels.push(this.currentLevel),this.timelineDataInternal.entryStartTimes.push(e),i&&this.timelineDataInternal.entryTotalTimes.push(e-i),i=e}if(e.frames.length&&void 0!==i){const e=t.Helpers.Timing.traceWindowMilliSeconds(this.parsedTrace.Meta.traceBounds).max;this.timelineDataInternal.entryTotalTimes.push(e-i)}++this.currentLevel}#Zn(e){const t=this.timelineData().entryLevels[e];return this.entryTypeByLevel[t]}preparePopoverElement(i){let n,r="",a=[],s="popoverinfo-time";const o=[],l=this.#Zn(i);if("TrackAppender"===l){if(!this.compatibilityTracksAppender)return null;const e=this.entryData[i],t=this.timelineDataInternal.entryLevels[i],s=this.compatibilityTracksAppender.popoverInfo(e,t);n=s.title,r=s.formattedTime,a=s.warningElements||a,s.additionalElements?.length&&o.push(...s.additionalElements),this.dispatchEventToListeners("FlameChartItemHovered",e)}else{if("Frame"!==l)return this.dispatchEventToListeners("FlameChartItemHovered",null),null;{const a=this.entryData[i];r=e.TimeUtilities.preciseMillisToString(t.Helpers.Timing.microToMilli(a.duration),1),a.idle?n=kr(Er.idleFrame):a.dropped?(n=a.isPartial?kr(Er.partiallyPresentedFrame):kr(Er.droppedFrame),s="popoverinfo-warning"):n=kr(Er.frame)}}const d=document.createElement("div"),c=m.UIUtils.createShadowRootWithCoreStyles(d,{cssFile:et}).createChild("div","timeline-flamechart-popover");c.createChild("span",s).textContent=r,c.createChild("span","popoverinfo-title").textContent=n;for(const e of a)e.classList.add("popoverinfo-warning"),c.appendChild(e);for(const e of o)c.appendChild(e);return d}preparePopoverForCollapsedArrow(e){const t=document.createElement("div"),i=m.UIUtils.createShadowRootWithCoreStyles(t,{cssFile:et}),n=this.entryData[e],r=Ve.activeManager()?.getEntriesFilter().findHiddenDescendantsAmount(n);if(!r)return null;return i.createChild("div","timeline-flamechart-popover").createChild("span","popoverinfo-title").textContent=r+" hidden",t}getDrawOverride(e){if("TrackAppender"!==this.#Zn(e))return;const t=this.timelineDataInternal.entryLevels[e],i=this.entryData[e];return this.compatibilityTracksAppender?.getDrawOverride(i,t)}#rr(e){const t=this.entryData[e];return t.idle?"white":t.dropped?t.isPartial?"#f0e442":"#f08080":"#d7f0d1"}entryColor(e){const t=this.#Zn(e);if("Frame"===t)return this.#rr(e);if("TrackAppender"===t){const t=this.timelineDataInternal.entryLevels[e],i=this.entryData[e];return this.compatibilityTracksAppender?.colorForEvent(i,t)||""}return""}preparePatternCanvas(){const e=17;this.droppedFramePatternCanvas.width=e,this.droppedFramePatternCanvas.height=e,this.partialFramePatternCanvas.width=e,this.partialFramePatternCanvas.height=e;const t=this.droppedFramePatternCanvas.getContext("2d");if(t){t.translate(8.5,8.5),t.rotate(.25*Math.PI),t.translate(-8.5,-8.5),t.fillStyle="rgb(255, 255, 255)";for(let e=-17;e<34;e+=3)t.fillRect(e,-17,1,51)}const i=this.partialFramePatternCanvas.getContext("2d");i&&(i.strokeStyle="rgb(255, 255, 255)",i.lineWidth=2,i.beginPath(),i.moveTo(17,0),i.lineTo(10,7),i.moveTo(8,9),i.lineTo(2,15),i.stroke())}drawFrame(i,n,r,a,s,o,l){const d=this.entryData[i];if(r+=1,s-=2,n.fillStyle=l(this.entryColor(i)),d.dropped)if(d.isPartial){n.fillRect(r,a,s,o);const e=n.createPattern(this.partialFramePatternCanvas,"repeat");n.fillStyle=e||n.fillStyle}else{n.fillRect(r,a,s,o);const e=n.createPattern(this.droppedFramePatternCanvas,"repeat");n.fillStyle=e||n.fillStyle}n.fillRect(r,a,s,o);const c=e.TimeUtilities.preciseMillisToString(t.Helpers.Timing.microToMilli(d.duration),1),h=n.measureText(c).width;h<=s&&(n.fillStyle=this.textColor(i),n.fillText(c,r+(s-h)/2,a+o-4))}async drawScreenshot(e,t,i,n,r,a){const o=this.entryData[e],l=s.ImageCache.getOrQueue(o);if(!l)return;const d=i+1,c=n+1,h=a-2,p=h/l.naturalHeight,m=Math.floor(l.naturalWidth*p);t.save(),t.beginPath(),t.rect(i,n,r,a),t.clip(),t.drawImage(l,d,c,m,h),t.strokeStyle="#ccc",t.strokeRect(d-.5,c-.5,Math.min(r-1,m+1),h),t.restore()}decorateEntry(e,i,n,r,a,s,o,l,d,c){const h=this.#Zn(e);if("Frame"===h)return this.drawFrame(e,i,r,a,s,o,c),!0;if("Screenshot"===h)return this.drawScreenshot(e,i,r,a,s,o),!0;if("TrackAppender"===h){const c=this.entryData[e];if(t.Types.Events.isSyntheticInteraction(c))return this.#ar(i,e,n,c,r,a,l,s,o,d),!0}return!1}#ar(e,i,r,a,s,o,l,d,c,h){const p=t.Helpers.Timing.microToMilli(a.ts),u=s+d;function g(e){const i=t.Helpers.Timing.microToMilli(e);return Math.floor(l+(i-p)*h)}e.save(),e.fillStyle=n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container");let v=g(a.processingStart);const T=g(a.processingEnd);function y(t,i,n){e.moveTo(t,n-3),e.lineTo(t,n+3),e.moveTo(t,n),e.lineTo(i,n)}a.processingEnd-a.processingStart==0&&(v-=1),e.fillRect(s,o-.5,v-s,c),e.fillRect(T,o-.5,u-T,c);const f=g(a.ts),S=g(t.Types.Timing.Micro(a.ts+a.dur));e.beginPath(),e.lineWidth=1,e.strokeStyle="#ccc";const w=Math.floor(o+c/2)+.5,b=S-.5;if(y(f+.5,v,w),y(b,T,w),e.stroke(),r){const t=v>0?v:s;e.font=this.#Hi;const n=5,a=5;m.UIUtils.measureTextWidth(e,r)<=T-t+n&&(e.fillStyle=this.textColor(i),e.fillText(r,t+n,o+c-a))}e.restore()}forceDecoration(e){const i=this.#Zn(e);if("Frame"===i)return!0;if("Screenshot"===i)return!0;const n=this.entryData[e];return!!t.Types.Events.isSyntheticInteraction(n)||Boolean(this.parsedTrace?.Warnings.perEvent.get(n))}appendHeader(e,t,i,n){const r={startLevel:this.currentLevel,name:e,style:t,selectable:i,expanded:n};return this.timelineDataInternal.groups.push(r),r}#ir(i){const n=this.entryData.length;this.entryData.push(i);const r=t.Helpers.Timing.microToMilli(i.duration);this.entryIndexToTitle[n]=e.TimeUtilities.millisToString(r,!0),this.timelineDataInternal&&(this.timelineDataInternal.entryLevels[n]=this.currentLevel,this.timelineDataInternal.entryTotalTimes[n]=r,this.timelineDataInternal.entryStartTimes[n]=t.Helpers.Timing.microToMilli(i.startTime))}createSelection(e){const t=this.entryData[e],i=t?yt(t):null;return i&&(this.lastSelection=new yr(i,e)),i}formatValue(t,i){return e.TimeUtilities.preciseMillisToString(t,i)}groupForEvent(e){if(!this.compatibilityTracksAppender)return null;const t=this.timelineDataInternal?.entryLevels[e]??null;if(null===t)return null;const i=this.compatibilityTracksAppender.groupForLevel(t);return i||null}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||wt(e)||t.Types.Events.isNetworkTrackEntry(e.event))return-1;if(this.lastSelection&&Et(this.lastSelection.timelineSelection,e))return this.lastSelection.entryIndex;const i=this.entryData.indexOf(e.event);return i>-1&&this.timelineDataInternal?.selectedGroup&&(Ve.activeManager()?.getEntriesFilter().revealEntry(e.event),this.timelineData(!0)),-1!==i&&(this.lastSelection=new yr(e,i)),i}indexForEvent(e){const t=this.#Ki.get(e);if("number"==typeof t)return t;const i=this.entryData.indexOf(e),n=i>-1?i:null;return this.#Ki.set(e,n),n}buildFlowForInitiator(e){if(!this.parsedTrace)return!1;if(!this.timelineDataInternal)return!1;const t=this.timelineDataInternal.initiatorsData.length;if(-1===e)return this.lastInitiatorEntry=e,0!==t&&(this.timelineDataInternal.resetFlowData(),!0);if(this.lastInitiatorEntry===e)return this.lastInitiatorsData&&(this.timelineDataInternal.initiatorsData=this.lastInitiatorsData),!1;if(!this.compatibilityTracksAppender)return!1;if("TrackAppender"!==this.#Zn(e))return!1;const i=this.entryData[e];this.timelineDataInternal.resetFlowData(),this.lastInitiatorEntry=e;const n=Ve.activeManager()?.getEntriesFilter().invisibleEntries()??[],r=Ve.activeManager()?.getEntriesFilter().expandableEntries()??[],a=Ye(this.parsedTrace,i,n,r);if(0===t&&0===a.length)return!1;for(const e of a){const t=this.indexForEvent(e.event),i=this.indexForEvent(e.initiator);null!==t&&null!==i&&this.timelineDataInternal.initiatorsData.push({initiatorIndex:i,eventIndex:t,isInitiatorHidden:e.isInitiatorHidden,isEntryHidden:e.isEntryHidden})}return this.lastInitiatorsData=this.timelineDataInternal.initiatorsData,!0}eventByIndex(e){if(e<0)return null;const t=this.#Zn(e);return"TrackAppender"===t||"Frame"===t?this.entryData[e]:null}}const Mr=t.Types.Timing.Milli(.001);var xr=Object.freeze({__proto__:null,InstantEventVisibleDurationMs:Mr,TimelineFlameChartDataProvider:Ir});const Pr={timings:"Timings"},Rr=e.i18n.registerUIStrings("panels/timeline/TimingsTrackAppender.ts",Pr),Fr=e.i18n.getLocalizedString.bind(void 0,Rr),Lr={navigationStart:0,MarkLoad:1,firstContentfulPaint:2,firstPaint:2,MarkDOMContent:3,"largestContentfulPaint::Candidate":4};class Ar{appenderName="Timings";#d;#e;#t;#sr;constructor(e,t,i){this.#e=e,this.#d=i,this.#t=t;const n=rn.extensionDataVisibilitySetting().get();this.#sr=n?this.#t.ExtensionTraceData.extensionMarkers:[]}appendTrackAtLevel(e,i){const n=0===this.#sr.length,r=this.#t.UserTimings.performanceMarks.filter((e=>!t.Handlers.ModelHandlers.ExtensionTraceData.extensionDataInPerformanceTiming(e))),a=this.#t.UserTimings.performanceMeasures.filter((e=>!t.Handlers.ModelHandlers.ExtensionTraceData.extensionDataInPerformanceTiming(e))),s=this.#t.UserTimings.timestampEvents,o=this.#t.UserTimings.consoleTimings;if(n&&0===r.length&&0===a.length&&0===s.length&&0===o.length)return e;this.#r(e,i);let l=this.#or(e);return l=this.#e.appendEventsAtLevel(r,l,this),l=this.#e.appendEventsAtLevel(a,l,this),l=this.#e.appendEventsAtLevel(s,l,this),this.#e.appendEventsAtLevel(o,l,this)}#r(e,t){const i=W({useFirstLineForOverview:!0,collapsible:this.#t.UserTimings.performanceMeasures.length>0}),n=V("timings",e,Fr(Pr.timings),i,!0,t);this.#e.registerTrackForGroup(n,this)}#or(e){let i=[];if(i=i.concat(this.#sr).sort(((e,t)=>e.ts-t.ts)),0===i.length)return e;for(const t of i){const i=this.#e.appendEventAtLevel(t,e,this);this.#e.getFlameChartTimelineData().entryTotalTimes[i]=Number.NaN}const n=t.Helpers.Timing.microToMilli(this.#t.Meta.traceBounds.min),r=i.map((e=>{const i=t.Helpers.Timing.microToMilli(e.ts),r=this.markerStyleForExtensionMarker(e);return new Sr(i,i-n,r)}));return this.#e.getFlameChartTimelineData().markers.push(...r),++e}markerStyleForPageLoadEvent(e){let i="",n="grey";return t.Types.Events.isMarkDOMContent(e)&&(n="#0867CB",i="DCL"),t.Types.Events.isMarkLoad(e)&&(n="#B31412",i="L"),t.Types.Events.isFirstPaint(e)&&(n="#228847",i="FP"),t.Types.Events.isFirstContentfulPaint(e)&&(n="#1A6937",i="FCP"),t.Types.Events.isLargestContentfulPaintCandidate(e)&&(n="#1A3422",i="LCP"),t.Types.Events.isNavigationStart(e)&&(n="#FF9800",i=""),{title:i,dashStyle:[6,4],lineWidth:.5,color:n,tall:!0,lowPriority:!1}}markerStyleForExtensionMarker(e){return{title:e.name,dashStyle:[6,4],lineWidth:.5,color:h.ExtensionUI.extensionEntryColor(e),tall:!0,lowPriority:!1}}colorForEvent(e){return t.Types.Events.eventIsPageLoadEvent(e)?this.markerStyleForPageLoadEvent(e).color:t.Types.Extensions.isSyntheticExtensionEntry(e)?h.ExtensionUI.extensionEntryColor(e):this.#d.colorForID(e.name)}titleForEvent(e){t.Handlers.ModelHandlers.PageLoadMetrics;if(t.Types.Events.eventIsPageLoadEvent(e))switch(e.name){case"MarkDOMContent":return"DCL";case"MarkLoad":return"L";case"firstContentfulPaint":return"FCP";case"firstPaint":return"FP";case"largestContentfulPaint::Candidate":return"LCP";case"navigationStart":return"";default:return e.name}return t.Types.Events.isConsoleTimeStamp(e)?`TimeStamp: ${e.args.data?.message??"(name unknown)"}`:t.Types.Events.isPerformanceMark(e)?`[mark]: ${e.name}`:t.Types.Extensions.isSyntheticExtensionEntry(e)&&e.args.tooltipText?e.args.tooltipText:e.name}setPopoverInfo(e,i){if(t.Types.Events.isMarkerEvent(e)||t.Types.Events.isPerformanceMark(e)||t.Types.Events.isConsoleTimeStamp(e)){const n=t.Helpers.Timing.timeStampForEventAdjustedByClosestNavigation(e,this.#t.Meta.traceBounds,this.#t.Meta.navigationsByNavigationId,this.#t.Meta.navigationsByFrameId);i.formattedTime=G(n)}}}var Nr=Object.freeze({__proto__:null,SORT_ORDER_PAGE_LOAD_MARKERS:Lr,TimingsTrackAppender:Ar});let Dr;function Br(e,i){if(i?.Meta.traceIsGeneric)return!0;if(t.Types.Events.isUpdateCounters(e))return!0;if(void 0===Dr&&(Dr=d.Runtime.experiments.isEnabled("timeline-show-postmessage-events")),Dr&&(t.Types.Events.isSchedulePostMessage(e)||t.Types.Events.isHandlePostMessage(e)))return!0;if(t.Types.Extensions.isSyntheticExtensionEntry(e))return!0;const n=s.EntryStyles.getEventStyle(e.name),r=t.Types.Events.isConsoleTime(e)||t.Types.Events.isPerformanceMeasure(e)||t.Types.Events.isPerformanceMark(e)||t.Types.Events.isConsoleTimeStamp(e);return n&&!n.hidden||r}const Hr=["Animations","Timings","Interactions","GPU","LayoutShifts","Thread","Thread_AuctionWorklet","Extension","ServerTimings"];class Ur{#lr=new Map;#dr=new Map;#cr=new Map;#hr=new Map;#Bi;#t;#pr;#d;#mr=[];#ur=new Set([...Hr]);#gr;#vr;#Tr;#yr;#fr;#Sr;#wr=[];#de;constructor(e,t,i,r,a){this.#Bi=e,this.#t=t,this.#de=a,this.#pr=i,this.#d=new l.Color.Generator({min:30,max:55,count:void 0},{min:70,max:100,count:6},50,.7),this.#gr=r,this.#vr=new Ar(this,this.#t,this.#d),this.#mr.push(this.#vr),this.#yr=new Me(this,this.#t,this.#d),this.#mr.push(this.#yr),this.#Tr=new J(this,this.#t),this.#mr.push(this.#Tr),this.#fr=new be(this,this.#t),this.#mr.push(this.#fr),this.#Sr=new Ae(this,this.#t),this.#mr.push(this.#Sr),this.#br(),this.#Er(),this.onThemeChange=this.onThemeChange.bind(this),n.ThemeSupport.instance().addEventListener(n.ThemeChangeEvent.eventName,this.onThemeChange)}reset(){n.ThemeSupport.instance().removeEventListener(n.ThemeChangeEvent.eventName,this.onThemeChange)}setFlameChartDataAndEntryData(e,t,i){this.#dr.clear(),this.#Bi=e,this.#pr=t,this.#gr=i}getFlameChartTimelineData(){return this.#Bi}onThemeChange(){for(const e of this.#Bi.groups)e.style.color=n.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),e.style.backgroundColor=n.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container")}#Er(){if(!rn.extensionDataVisibilitySetting().get())return;const e=this.#t.ExtensionTraceData.extensionTrackData;for(const t of e)this.#mr.push(new Te(this,t))}#br(){const e=e=>{switch(e.threadType){case"MAIN_THREAD":if(e.isOnMainFrame){const t=e.getUrl();return t.startsWith("about:")||t.startsWith("chrome:")?2:0}return 1;case"WORKER":case"AUCTION_WORKLET":return 3;case"RASTERIZER":return 4;case"THREAD_POOL":return 5;case"OTHER":return 7;default:return 8}},i=t.Handlers.Threads.threadsInTrace(this.#t),n=d.Runtime.experiments.isEnabled("timeline-show-all-events");for(const{pid:e,tid:t,name:r,type:a,entries:s,tree:o}of i){if(this.#t.Meta.traceIsGeneric){this.#wr.push(new Ke(this,this.#t,e,t,r,"OTHER",s,o));continue}if(("Chrome_ChildIOThread"===r||"Compositor"===r||"GpuMemoryThread"===r)&&!n)continue;const i=this.#t.AuctionWorklets.worklets.get(e);if(i){[i.args.data.utilityThread.tid,i.args.data.v8HelperThread.tid].includes(t)&&this.#wr.push(new Ke(this,this.#t,e,t,"","AUCTION_WORKLET",s,o))}else this.#wr.push(new Ke(this,this.#t,e,t,r,a,s,o))}this.#wr.sort(((t,i)=>e(t)-e(i)||i.getEntries().length-t.getEntries().length)),this.#mr.push(...this.#wr)}timingsTrackAppender(){return this.#vr}animationsTrackAppender(){return this.#Tr}interactionsTrackAppender(){return this.#yr}gpuTrackAppender(){return this.#fr}layoutShiftsTrackAppender(){return this.#Sr}threadAppenders(){return this.#wr}eventsInTrack(e){const t=this.#cr.get(e);if(t)return t;let i=null,n=null;for(const[t,r]of this.#lr)r===e&&(null===i&&(i=t),n=t);if(null===i||null===n)throw new Error(`Could not find events for track: ${e}`);const r=this.#Bi.entryLevels,a=[];for(let e=0;e<r.length;e++)i<=r[e]&&r[e]<=n&&a.push(this.#pr[e]);return a.sort(((e,t)=>e.ts-t.ts)),this.#cr.set(e,a),a}eventsForTreeView(e){const i=this.#hr.get(e);if(i)return i;let n=this.eventsInTrack(e);return t.Helpers.TreeHelpers.canBuildTreesFromEvents(n)||(n=n.filter((e=>!t.Types.Events.isPhaseAsync(e.ph)))),this.#hr.set(e,n),n}registerTrackForGroup(e,t){this.#Bi.groups.push(e),this.#dr.set(e,t)}getCurrentTrackCountForThreadType(e){return this.#wr.filter((t=>t.threadType===e&&t.headerAppended())).length}groupForAppender(e){let t=null;for(const[i,n]of this.#dr)if(n===e){t=i;break}return t}groupEventsForTreeView(e){const t=this.#dr.get(e);return t?this.eventsForTreeView(t):null}groupForLevel(e){const t=this.#lr.get(e);return t?this.groupForAppender(t):null}appendEventAtLevel(e,i,n){this.#lr.set(i,n);const r=this.#pr.length;this.#pr.push(e),this.#gr[i]="TrackAppender",this.#Bi.entryLevels[r]=i,this.#Bi.entryStartTimes[r]=t.Helpers.Timing.microToMilli(e.ts);const a=e.dur||t.Helpers.Timing.milliToMicro(Mr);return this.#Bi.entryTotalTimes[r]=t.Helpers.Timing.microToMilli(a),r}appendEventsAtLevel(e,t,i,n){const r=[];for(let a=0;a<e.length;++a){const s=e[a];if(!Br(s,this.#t))continue;const o=z(s,r),l=this.appendEventAtLevel(s,t+o,i);n?.(s,l)}return this.#gr.length=t+r.length,this.#gr.fill("TrackAppender",t),t+r.length}allVisibleTrackAppenders(){return this.#mr.filter((e=>this.#ur.has(e.appenderName)))}allThreadAppendersByProcess(){const e=this.allVisibleTrackAppenders(),t=new Map;for(const i of e){if(!(i instanceof Ke))continue;const e=t.get(i.processId())??[];e.push(i),t.set(i.processId(),e)}return t}setVisibleTracks(e){this.#ur=e||new Set([...Hr])}getDrawOverride(e,t){const i=this.#lr.get(t);if(!i)throw new Error("Track not found for level");return i.getDrawOverride?.(e)}colorForEvent(e,t){const i=this.#lr.get(t);if(!i)throw new Error("Track not found for level");return i.colorForEvent(e)}titleForEvent(e,t){const i=this.#lr.get(t);if(!i)throw new Error("Track not found for level");return i.titleForEvent?i.titleForEvent(e):s.EntryName.nameForEntry(e,this.#t)}popoverInfo(e,t){const i=this.#lr.get(t);if(!i)throw new Error("Track not found for level");const n={title:this.titleForEvent(e,t),formattedTime:G(e.dur),warningElements:c.DetailsView.buildWarningElementsForEvent(e,this.#t),additionalElements:[],url:null};i.setPopoverInfo&&i.setPopoverInfo(e,n);const a=URL.parse(n.url??s.SourceMapsResolver.SourceMapsResolver.resolvedURLForEntry(this.#t,e)??"");if(a){const t=45,i=r.StringUtilities.trimMiddle(a.href.replace(a.origin,""),t),o=document.createElement("div");o.createChild("span","popoverinfo-url-path").textContent=i;const l=this.#de?this.#de.entityForEvent(e):null,d=s.Helpers.formatOriginWithEntity(a,l);o.createChild("span","popoverinfo-url-origin").textContent=`(${d})`,n.additionalElements.push(o)}return n}}var Or=Object.freeze({__proto__:null,CompatibilityTracksAppender:Ur,TrackNames:Hr,entryIsVisibleInTimeline:Br});export{X as AnimationsTrackAppender,le as AnnotationHelpers,$ as AppenderUtils,ce as BenchmarkEvents,me as CLSLinkifier,Or as CompatibilityTracksAppender,lt as CountersGraph,Be as EntriesFilter,Ue as EventsSerializer,Bn as EventsTimelineTreeView,ye as ExtensionTrackAppender,gt as FreshRecording,Ee as GPUTrackAppender,Qe as Initiators,xe as InteractionsTrackAppender,Ne as LayoutShiftsTrackAppender,Ge as ModificationsManager,lr as NetworkTrackAppender,ei as SaveFileFormatter,ct as TargetForEvent,Vt as ThirdPartyTreeView,qe as ThreadAppender,ai as TimelineController,nr as TimelineDetailsView,Ti as TimelineEventOverview,Rn as TimelineFilters,xr as TimelineFlameChartDataProvider,cr as TimelineFlameChartNetworkDataProvider,br as TimelineFlameChartView,Ri as TimelineHistoryManager,Un as TimelineLayersView,Di as TimelineLoader,Ui as TimelineMiniMap,jn as TimelinePaintProfilerView,dn as TimelinePanel,Ct as TimelineSelection,Bt as TimelineTreeView,In as TimelineUIUtils,Nr as TimingsTrackAppender,Ji as UIDevtoolsController,qi as UIDevtoolsUtils};
=======
import*as e from"../../core/i18n/i18n.js";import*as t from"../../ui/legacy/theme_support/theme_support.js";import*as i from"../../models/trace/trace.js";import*as n from"../../core/sdk/sdk.js";import*as r from"../../core/common/common.js";import*as a from"../../core/root/root.js";import*as s from"./components/components.js";import{Utils as o}from"./components/components.js";import*as l from"../../core/host/host.js";import*as c from"../../core/platform/platform.js";import*as d from"../../models/workspace/workspace.js";import*as h from"../../services/trace_bounds/trace_bounds.js";import*as m from"../../ui/components/adorners/adorners.js";import*as p from"../../ui/legacy/components/perf_ui/perf_ui.js";import*as u from"../../ui/legacy/legacy.js";import*as g from"../../ui/visual_logging/visual_logging.js";import*as v from"../mobile_throttling/mobile_throttling.js";import*as T from"./components/insights/insights.js";import*as f from"../../ui/components/menus/menus.js";import*as y from"../../models/source_map_scopes/source_map_scopes.js";import*as w from"../../models/extensions/extensions.js";import*as b from"../../models/bindings/bindings.js";import*as S from"./overlays/overlays.js";import*as C from"../../models/timeline_model/timeline_model.js";import*as E from"../../ui/legacy/components/utils/utils.js";import*as k from"../../ui/legacy/components/data_grid/data_grid.js";import*as x from"../../ui/components/code_highlighter/code_highlighter.js";import*as P from"./extensions/extensions.js";import*as I from"../layer_viewer/layer_viewer.js";import*as M from"../../ui/components/data_grid/data_grid.js";import*as F from"../../ui/components/linkifier/linkifier.js";import*as L from"../../ui/lit-html/lit-html.js";import*as R from"./utils/utils.js";import*as D from"../../ui/components/panel_feedback/panel_feedback.js";import*as A from"../../ui/components/icon_button/icon_button.js";const N={sSelfS:"{PH1} (self {PH2})"},B=e.i18n.registerUIStrings("panels/timeline/AppenderUtils.ts",N),H=e.i18n.getLocalizedString.bind(void 0,B);function U(e){const i={padding:4,height:17,collapsible:!0,color:t.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),backgroundColor:t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"),nestingLevel:0,shareHeaderLine:!0};return Object.assign(i,e)}function W(e,t,i,n,r,a,s,o){const l={startLevel:t,name:i,style:n,selectable:r,expanded:a,showStackContextMenu:s,legends:o};return null!==e&&(l.jslogContext=e),l}function O(t,n){const r=i.Helpers.Timing.microSecondsToMilliseconds(t||0);if(r===i.Types.Timing.MilliSeconds(0))return"";const a=i.Helpers.Timing.microSecondsToMilliseconds(n||0),s=1e-6;return Math.abs(r-a)>s&&a>s?H(N.sSelfS,{PH1:e.TimeUtilities.millisToString(r,!0),PH2:e.TimeUtilities.millisToString(a,!0)}):e.TimeUtilities.millisToString(r,!0)}function V(e,t){let i=0;const n=e.ts,r=e.ts+(e.dur||0);for(;i<t.length&&n<t[i];)++i;return t[i]=r,i}function _(e,t,i){const n=e.entryDecorations[t]||[];n.push(i),e.entryDecorations[t]=n}var z=Object.freeze({__proto__:null,buildGroupStyle:U,buildTrackHeader:W,getFormattedTime:O,getEventLevel:V,addDecorationToEvent:_});const G={animations:"Animations"},j=e.i18n.registerUIStrings("panels/timeline/AnimationsTrackAppender.ts",G),q=e.i18n.getLocalizedString.bind(void 0,j);class ${appenderName="Animations";#e;#t;constructor(e,t){this.#e=e,this.#t=t}appendTrackAtLevel(e,t){const i=this.#t.Animations.animations;return 0===i.length?e:(this.#i(e,t),this.#e.appendEventsAtLevel(i,e,this))}#i(e,t){const i=U({useFirstLineForOverview:!1}),n=W("animations",e,q(G.animations),i,!0,t);this.#e.registerTrackForGroup(n,this)}colorForEvent(){return t.ThemeSupport.instance().getComputedValue("--app-color-rendering")}titleForEvent(e){return e.name}highlightedEntryInfo(e){return{title:this.titleForEvent(e),formattedTime:O(e.dur)}}}var J=Object.freeze({__proto__:null,AnimationsTrackAppender:$});class K extends Event{duration;static eventName="traceload";constructor(e){super(K.eventName,{bubbles:!0,composed:!0}),this.duration=e}}var Y=Object.freeze({__proto__:null,TraceLoadEvent:K});class X{x;y;width;height;color;outlineColor;constructor([e,t,i,n]){this.x=e,this.y=t,this.width=i,this.height=n,this.color={r:238,g:111,b:99,a:.4},this.outlineColor={r:238,g:111,b:99,a:.7}}}let Z;class Q{static instance(e={forceNew:null}){const{forceNew:t}=e;return Z&&!t||(Z=new Q),Z}linkify(e,t){const i=document.createElement("span"),r=e,{x:a,y:s,width:o,height:l}=r;return i.textContent=`Location: [${a},${s}], Size: [${o}x${l}]`,i.addEventListener("mouseover",(()=>n.OverlayModel.OverlayModel.highlightRect(r))),i.addEventListener("mouseleave",(()=>n.OverlayModel.OverlayModel.clearHighlight())),i}}var ee=Object.freeze({__proto__:null,CLSRect:X,Linkifier:Q});const te={loading:"Loading",experience:"Experience",scripting:"Scripting",rendering:"Rendering",painting:"Painting",gpu:"GPU",async:"Async",system:"System",idle:"Idle",task:"Task",other:"Other",animation:"Animation",event:"Event",requestMainThreadFrame:"Request Main Thread Frame",frameStart:"Frame Start",onMessage:"On Message",schedulePostMessage:"Schedule postMessage",messaging:"Messaging",frameStartMainThread:"Frame Start (main thread)",drawFrame:"Draw Frame",profilingOverhead:"Profiling Overhead",hitTest:"Hit Test",scheduleStyleRecalculation:"Schedule Style Recalculation",recalculateStyle:"Recalculate Style",invalidateLayout:"Invalidate Layout",layerize:"Layerize",layout:"Layout",paintSetup:"Paint Setup",paintImage:"Paint Image",prePaint:"Pre-Paint",updateLayer:"Update Layer",updateLayerTree:"Update Layer Tree",paint:"Paint",rasterizePaint:"Rasterize Paint",scroll:"Scroll",commit:"Commit",compositeLayers:"Composite Layers",computeIntersections:"Compute Intersections",parseHtml:"Parse HTML",parseStylesheet:"Parse Stylesheet",installTimer:"Install Timer",removeTimer:"Remove Timer",timerFired:"Timer Fired",xhrReadyStateChange:"`XHR` Ready State Change",xhrLoad:"`XHR` Load",compileScript:"Compile Script",cacheScript:"Cache Script Code",compileCode:"Compile Code",optimizeCode:"Optimize Code",evaluateScript:"Evaluate Script",compileModule:"Compile Module",cacheModule:"Cache Module Code",evaluateModule:"Evaluate Module",streamingCompileTask:"Streaming Compile Task",waitingForNetwork:"Waiting for Network",parseAndCompile:"Parse and Compile",deserializeCodeCache:"Deserialize Code Cache",streamingWasmResponse:"Streaming Wasm Response",compiledWasmModule:"Compiled Wasm Module",cachedWasmModule:"Cached Wasm Module",wasmModuleCacheHit:"Wasm Module Cache Hit",wasmModuleCacheInvalid:"Wasm Module Cache Invalid",frameStartedLoading:"Frame Started Loading",onloadEvent:"Onload Event",domcontentloadedEvent:"DOMContentLoaded Event",firstPaint:"First Paint",firstContentfulPaint:"First Contentful Paint",largestContentfulPaint:"Largest Contentful Paint",timestamp:"Timestamp",consoleTime:"Console Time",userTiming:"User Timing",willSendRequest:"Will Send Request",sendRequest:"Send Request",receiveResponse:"Receive Response",finishLoading:"Finish Loading",receiveData:"Receive Data",runMicrotasks:"Run Microtasks",functionCall:"Function Call",gcEvent:"GC Event",majorGc:"Major GC",minorGc:"Minor GC",requestAnimationFrame:"Request Animation Frame",cancelAnimationFrame:"Cancel Animation Frame",animationFrameFired:"Animation Frame Fired",requestIdleCallback:"Request Idle Callback",cancelIdleCallback:"Cancel Idle Callback",fireIdleCallback:"Fire Idle Callback",createWebsocket:"Create WebSocket",sendWebsocketHandshake:"Send WebSocket Handshake",receiveWebsocketHandshake:"Receive WebSocket Handshake",wsMessageReceived:"Receive WebSocket Message",wsMessageSent:"Send WebSocket Message",destroyWebsocket:"Destroy WebSocket",embedderCallback:"Embedder Callback",imageDecode:"Image Decode",domGc:"DOM GC",cppGc:"CPP GC",encrypt:"Encrypt",encryptReply:"Encrypt Reply",decrypt:"Decrypt",decryptReply:"Decrypt Reply",digest:"Digest",digestReply:"Digest Reply",sign:"Sign",signReply:"Sign Reply",verify:"Verify",verifyReply:"Verify Reply",asyncTask:"Async Task",layoutShift:"Layout Shift",eventTiming:"Event Timing",jsFrame:"JS Frame",rasterizing:"Rasterizing",drawing:"Drawing"};var ie;let ne;!function(e){e.DRAWING="drawing",e.RASTERIZING="rasterizing",e.LAYOUT="layout",e.LOADING="loading",e.EXPERIENCE="experience",e.SCRIPTING="scripting",e.MESSAGING="messaging",e.RENDERING="rendering",e.PAINTING="painting",e.GPU="gpu",e.ASYNC="async",e.OTHER="other",e.IDLE="idle"}(ie||(ie={}));const re=e.i18n.registerUIStrings("panels/timeline/EventUICategory.ts",te),ae=e.i18n.getLocalizedString.bind(void 0,re);class se{title;category;hidden;constructor(e,t,i=!1){this.title=e,this.category=t,this.hidden=i}}class oe{name;title;visible;childColor;colorInternal;hiddenInternal;constructor(e,t,i,n,r){this.name=e,this.title=t,this.visible=i,this.childColor=n,this.colorInternal=r,this.hidden=!1}get hidden(){return Boolean(this.hiddenInternal)}get color(){return this.getComputedColorValue()}getCSSValue(){return`var(${this.colorInternal})`}getComputedColorValue(){return t.ThemeSupport.instance().getComputedValue(this.colorInternal)}set hidden(e){this.hiddenInternal=e}}let le,ce;function de(e){return pe()[e]}function he(e){return Object.values(ie).includes(e)}function me(){return le||(le={loading:new oe(ie.LOADING,ae(te.loading),!0,"--app-color-loading-children","--app-color-loading"),experience:new oe(ie.EXPERIENCE,ae(te.experience),!1,"--app-color-rendering-children","--app-color-rendering"),messaging:new oe(ie.MESSAGING,ae(te.messaging),!0,"--app-color-messaging-children","--app-color-messaging"),scripting:new oe(ie.SCRIPTING,ae(te.scripting),!0,"--app-color-scripting-children","--app-color-scripting"),rendering:new oe(ie.RENDERING,ae(te.rendering),!0,"--app-color-rendering-children","--app-color-rendering"),painting:new oe(ie.PAINTING,ae(te.painting),!0,"--app-color-painting-children","--app-color-painting"),gpu:new oe(ie.GPU,ae(te.gpu),!1,"--app-color-painting-children","--app-color-painting"),async:new oe(ie.ASYNC,ae(te.async),!1,"--app-color-async-children","--app-color-async"),other:new oe(ie.OTHER,ae(te.system),!1,"--app-color-system-children","--app-color-system"),idle:new oe(ie.IDLE,ae(te.idle),!1,"--app-color-idle-children","--app-color-idle"),layout:new oe(ie.LAYOUT,ae(te.layout),!1,"--app-color-loading-children","--app-color-loading"),rasterizing:new oe(ie.RASTERIZING,ae(te.rasterizing),!1,"--app-color-children","--app-color-scripting"),drawing:new oe(ie.DRAWING,ae(te.drawing),!1,"--app-color-rendering-children","--app-color-rendering")},le)}function pe(){if(ce)return ce;const e=me();return ce={RunTask:new se(ae(te.task),e.other),ProfileCall:new se(ae(te.jsFrame),e.scripting),JSSample:new se("JSSample",e.scripting),Program:new se(ae(te.other),e.other),"CpuProfiler::StartProfiling":new se(ae(te.profilingOverhead),e.other),Animation:new se(ae(te.animation),e.rendering),EventDispatch:new se(ae(te.event),e.scripting),RequestMainThreadFrame:new se(ae(te.requestMainThreadFrame),e.rendering,!0),BeginFrame:new se(ae(te.frameStart),e.rendering,!0),BeginMainThreadFrame:new se(ae(te.frameStartMainThread),e.rendering,!0),DrawFrame:new se(ae(te.drawFrame),e.rendering,!0),HitTest:new se(ae(te.hitTest),e.rendering),ScheduleStyleRecalculation:new se(ae(te.scheduleStyleRecalculation),e.rendering),UpdateLayoutTree:new se(ae(te.recalculateStyle),e.rendering),InvalidateLayout:new se(ae(te.invalidateLayout),e.rendering,!0),Layerize:new se(ae(te.layerize),e.rendering),Layout:new se(ae(te.layout),e.rendering),PaintSetup:new se(ae(te.paintSetup),e.painting),PaintImage:new se(ae(te.paintImage),e.painting,!0),UpdateLayer:new se(ae(te.updateLayer),e.painting,!0),UpdateLayerTree:new se(ae(te.updateLayerTree),e.rendering),Paint:new se(ae(te.paint),e.painting),PrePaint:new se(ae(te.prePaint),e.rendering),RasterTask:new se(ae(te.rasterizePaint),e.painting),ScrollLayer:new se(ae(te.scroll),e.rendering),Commit:new se(ae(te.commit),e.painting),CompositeLayers:new se(ae(te.compositeLayers),e.painting),ComputeIntersections:new se(ae(te.computeIntersections),e.rendering),ParseHTML:new se(ae(te.parseHtml),e.loading),ParseAuthorStyleSheet:new se(ae(te.parseStylesheet),e.loading),TimerInstall:new se(ae(te.installTimer),e.scripting),TimerRemove:new se(ae(te.removeTimer),e.scripting),TimerFire:new se(ae(te.timerFired),e.scripting),XHRReadyStateChange:new se(ae(te.xhrReadyStateChange),e.scripting),XHRLoad:new se(ae(te.xhrLoad),e.scripting),"v8.compile":new se(ae(te.compileScript),e.scripting),"v8.produceCache":new se(ae(te.cacheScript),e.scripting),"V8.CompileCode":new se(ae(te.compileCode),e.scripting),"V8.OptimizeCode":new se(ae(te.optimizeCode),e.scripting),EvaluateScript:new se(ae(te.evaluateScript),e.scripting),"V8.CompileModule":new se(ae(te.compileModule),e.scripting),"v8.produceModuleCache":new se(ae(te.cacheModule),e.scripting),"v8.evaluateModule":new se(ae(te.evaluateModule),e.scripting),"v8.parseOnBackground":new se(ae(te.streamingCompileTask),e.other),"v8.parseOnBackgroundWaiting":new se(ae(te.waitingForNetwork),e.idle),"v8.parseOnBackgroundParsing":new se(ae(te.parseAndCompile),e.scripting),"v8.deserializeOnBackground":new se(ae(te.deserializeCodeCache),e.scripting),"V8.FinalizeDeserialization":new se(ae(te.profilingOverhead),e.other),"v8.wasm.streamFromResponseCallback":new se(ae(te.streamingWasmResponse),e.scripting),"v8.wasm.compiledModule":new se(ae(te.compiledWasmModule),e.scripting),"v8.wasm.cachedModule":new se(ae(te.cachedWasmModule),e.scripting),"v8.wasm.moduleCacheHit":new se(ae(te.wasmModuleCacheHit),e.scripting),"v8.wasm.moduleCacheInvalid":new se(ae(te.wasmModuleCacheInvalid),e.scripting),FrameStartedLoading:new se(ae(te.frameStartedLoading),e.loading,!0),MarkLoad:new se(ae(te.onloadEvent),e.scripting,!0),MarkDOMContent:new se(ae(te.domcontentloadedEvent),e.scripting,!0),firstPaint:new se(ae(te.firstPaint),e.painting,!0),firstContentfulPaint:new se(ae(te.firstContentfulPaint),e.rendering,!0),"largestContentfulPaint::Candidate":new se(ae(te.largestContentfulPaint),e.rendering,!0),TimeStamp:new se(ae(te.timestamp),e.scripting),ConsoleTime:new se(ae(te.consoleTime),e.scripting),UserTiming:new se(ae(te.userTiming),e.scripting),ResourceWillSendRequest:new se(ae(te.willSendRequest),e.loading),ResourceSendRequest:new se(ae(te.sendRequest),e.loading),ResourceReceiveResponse:new se(ae(te.receiveResponse),e.loading),ResourceFinish:new se(ae(te.finishLoading),e.loading),ResourceReceivedData:new se(ae(te.receiveData),e.loading),RunMicrotasks:new se(ae(te.runMicrotasks),e.scripting),FunctionCall:new se(ae(te.functionCall),e.scripting),GCEvent:new se(ae(te.gcEvent),e.scripting),MajorGC:new se(ae(te.majorGc),e.scripting),MinorGC:new se(ae(te.minorGc),e.scripting),"CppGC.IncrementalSweep":new se(ae(te.cppGc),e.scripting),RequestAnimationFrame:new se(ae(te.requestAnimationFrame),e.scripting),CancelAnimationFrame:new se(ae(te.cancelAnimationFrame),e.scripting),FireAnimationFrame:new se(ae(te.animationFrameFired),e.scripting),RequestIdleCallback:new se(ae(te.requestIdleCallback),e.scripting),CancelIdleCallback:new se(ae(te.cancelIdleCallback),e.scripting),FireIdleCallback:new se(ae(te.fireIdleCallback),e.scripting),WebSocketCreate:new se(ae(te.createWebsocket),e.scripting),WebSocketSendHandshakeRequest:new se(ae(te.sendWebsocketHandshake),e.scripting),WebSocketReceiveHandshakeResponse:new se(ae(te.receiveWebsocketHandshake),e.scripting),WebSocketDestroy:new se(ae(te.destroyWebsocket),e.scripting),WebSocketSend:new se(ae(te.wsMessageSent),e.scripting),WebSocketReceive:new se(ae(te.wsMessageReceived),e.scripting),EmbedderCallback:new se(ae(te.embedderCallback),e.scripting),"Decode Image":new se(ae(te.imageDecode),e.painting),GPUTask:new se(ae(te.gpu),e.gpu),"BlinkGC.AtomicPhase":new se(ae(te.domGc),e.scripting),DoEncrypt:new se(ae(te.encrypt),e.scripting),DoEncryptReply:new se(ae(te.encryptReply),e.scripting),DoDecrypt:new se(ae(te.decrypt),e.scripting),DoDecryptReply:new se(ae(te.decryptReply),e.scripting),DoDigest:new se(ae(te.digest),e.scripting),DoDigestReply:new se(ae(te.digestReply),e.scripting),DoSign:new se(ae(te.sign),e.scripting),DoSignReply:new se(ae(te.signReply),e.scripting),DoVerify:new se(ae(te.verify),e.scripting),DoVerifyReply:new se(ae(te.verifyReply),e.scripting),AsyncTask:new se(ae(te.asyncTask),e.async),LayoutShift:new se(ae(te.layoutShift),e.experience),EventTiming:new se(ae(te.eventTiming),e.experience),HandlePostMessage:new se(ae(te.onMessage),e.messaging),SchedulePostMessage:new se(ae(te.schedulePostMessage),e.messaging)},ce}function ue(e){ce=e}function ge(e){le=e}function ve(){const e=pe(),t=[];for(const i in e){const n=i;e[n]?.hidden||t.push(i)}return t}function Te(){return ne||(ne=[ie.IDLE,ie.LOADING,ie.PAINTING,ie.RENDERING,ie.SCRIPTING,ie.OTHER],ne)}function fe(e){ne=e}var ye=Object.freeze({__proto__:null,get EventCategory(){return ie},TimelineRecordStyle:se,TimelineCategory:oe,getEventStyle:de,stringIsEventCategory:he,getCategoryStyles:me,maybeInitSylesMap:pe,setEventStylesMap:ue,setCategories:ge,visibleTypes:ve,getTimelineMainEventCategories:Te,setTimelineMainEventCategories:fe});let we=null;class be{static instance(e={forceNew:null}){const t=Boolean(e.forceNew);return we&&!t||(we=new be),we}static removeInstance(){we=null}#n=[];activeFilters(){return this.#n}setFilters(e){this.#n=e}isVisible(e){return this.#n.every((t=>t.accept(e)))}}let Se=null;class Ce{#r=new WeakSet;static instance(e={forceNew:!1}){return Se&&!e.forceNew||(Se=new Ce),Se}registerFreshRecording(e){this.#r.add(e)}recordingIsFresh(e){return this.#r.has(e)}}var Ee=Object.freeze({__proto__:null,Tracker:Ce});const ke=new CSSStyleSheet;ke.replaceSync('.content{margin-left:5px}.history-dropdown-button{width:160px;height:26px;text-align:left;display:flex;border:1px solid transparent}.history-dropdown-button[disabled]{opacity:50%;border:1px solid transparent}.history-dropdown-button > .content{padding-right:5px;overflow:hidden;text-overflow:ellipsis;flex:1 1;min-width:35px;&::after{float:right;user-select:none;mask-image:var(--image-file-triangle-down);width:14px;height:14px;content:"";position:absolute;background-color:var(--icon-default);right:-3px}}.history-dropdown-button:focus-visible::before{content:"";position:absolute;top:2px;left:0;right:0;bottom:2px;border-radius:2px;background:var(--divider-line)}@media (forced-colors: active){.history-dropdown-button[disabled]{opacity:100%}.history-dropdown-button > .content::after{background-color:ButtonText}.history-dropdown-button[disabled] > .content::after{background-color:GrayText}}\n/*# sourceURL=historyToolbarButton.css */\n');const xe={empty:"(empty)",selectJavascriptVmInstance:"Select JavaScript VM instance"},Pe=e.i18n.registerUIStrings("panels/timeline/IsolateSelector.ts",xe),Ie=e.i18n.getLocalizedString.bind(void 0,Pe);class Me extends u.Toolbar.ToolbarItem{menu;options;items;itemByIsolate=new Map;constructor(){const e=new f.SelectMenu.SelectMenu;super(e),this.menu=e,e.buttonTitle=Ie(xe.selectJavascriptVmInstance),e.showArrow=!0,e.style.whiteSpace="normal",e.addEventListener("selectmenuselected",this.#a.bind(this)),n.IsolateManager.IsolateManager.instance().observeIsolates(this),n.TargetManager.TargetManager.instance().addEventListener("NameChanged",this.targetChanged,this),n.TargetManager.TargetManager.instance().addEventListener("InspectedURLChanged",this.targetChanged,this)}#s(e,t){const i=new Map;for(const t of e.models()){const e=t.target(),a=n.TargetManager.TargetManager.instance().rootTarget()!==e?e.name():"",s=new r.ParsedURL.ParsedURL(e.inspectedURL()),o=s.isValid?s.domain():"",l=e.decorateLabel(o&&a?`${o}: ${a}`:a||o||Ie(xe.empty));i.set(l,(i.get(l)||0)+1)}t.removeChildren();for(const[e,n]of i){const i=n>1?`${e} (${n})`:e;t.createChild("div").textContent=i}}#a(e){this.itemByIsolate.forEach(((t,i)=>{if(t.selected=t.value===e.itemValue,t.selected){const e=t.textContent?.slice(0,29);this.menu.buttonTitle=e||Ie(xe.empty);const r=i.runtimeModel();u.Context.Context.instance().setFlavor(n.CPUProfilerModel.CPUProfilerModel,r&&r.target().model(n.CPUProfilerModel.CPUProfilerModel))}}))}isolateAdded(e){const t=new f.Menu.MenuItem;this.menu.appendChild(t),t.value=e.id(),this.itemByIsolate.set(e,t),this.#s(e,t)}isolateRemoved(e){const t=this.itemByIsolate.get(e);t&&(t.selected&&(this.menu.buttonTitle=Ie(xe.selectJavascriptVmInstance),u.Context.Context.instance().setFlavor(n.CPUProfilerModel.CPUProfilerModel,null)),this.menu.removeChild(t))}isolateChanged(e){const t=this.itemByIsolate.get(e);t&&this.#s(e,t)}targetChanged(e){const t=e.data.model(n.RuntimeModel.RuntimeModel);if(!t)return;const i=n.IsolateManager.IsolateManager.instance().isolateByModel(t);i&&this.isolateChanged(i)}}class Fe{#o=new Map;keyForEvent(e){if(i.Types.TraceEvents.isProfileCall(e))return`p-${e.pid}-${e.tid}-${i.Types.TraceEvents.SampleIndex(e.sampleIndex)}-${e.nodeId}`;const t=i.Helpers.SyntheticEvents.SyntheticEventsManager.getActiveManager().getRawTraceEvents(),n=i.Types.TraceEvents.isSyntheticBasedEvent(e)?`s-${t.indexOf(e.rawSourceEvent)}`:`r-${t.indexOf(e)}`;return n.length<3?null:n}eventForKey(e,t){const n=i.Types.File.traceEventKeyToValues(e);if(Fe.isProfileCallKey(n))return this.#l(n,t);if(Fe.isSyntheticEventKey(n)){const e=i.Helpers.SyntheticEvents.SyntheticEventsManager.getActiveManager().getSyntheticTraceEvents().at(n.rawIndex);if(!e)throw new Error(`Attempted to get a synthetic event from an unknown raw event index: ${n.rawIndex}`);return e}if(Fe.isRawEventKey(n)){return i.Helpers.SyntheticEvents.SyntheticEventsManager.getActiveManager().getRawTraceEvents()[n.rawIndex]}throw new Error(`Unknown trace event serializable key values: ${n.join("-")}`)}static isProfileCallKey(e){return"p"===e.type}static isRawEventKey(e){return"r"===e.type}static isSyntheticEventKey(e){return"s"===e.type}#l(e,t){const i=this.#o.get(e);if(i)return i;const n=t.Renderer.processes.get(e.processID)?.threads.get(e.threadID)?.profileCalls;if(!n)throw new Error(`Unknown profile call serializable key: ${e}`);const r=c.ArrayUtilities.nearestIndexFromBeginning(n,(t=>t.sampleIndex>=e.sampleIndex&&t.nodeId>=e.protocol)),a=null!==r&&n.at(r);if(!a)throw new Error(`Unknown profile call serializable key: ${e}`);return this.#o.set(e,a),a}}var Le=Object.freeze({__proto__:null,EventsSerializer:Fe});const Re=[];let De;class Ae extends Event{overlay;action;static eventName="annotationmodifiedevent";constructor(e,t){super(Ae.eventName),this.overlay=e,this.action=t}}class Ne extends EventTarget{#c;#d;#h=null;#t;#m;#p;static activeManager(){return De}static initAndActivateModificationsManager(e,t){Re[t]&&(De=Re[t],Ne.activeManager()?.applyModificationsIfPresent());const i=e.traceParsedData(t);if(!i)throw new Error("ModificationsManager was initialized without a corresponding trace data");const n=i.Meta.traceBounds,r=e.rawTraceEvents(t);if(!r)throw new Error("ModificationsManager was initialized without a corresponding raw trace events array");const a=e.syntheticTraceEventsManager(t);if(!a)throw new Error("ModificationsManager was initialized without a corresponding SyntheticEventsManager");const s=e.metadata(t),o=new Ne({traceParsedData:i,traceBounds:n,rawTraceEvents:r,modifications:s?.modifications,syntheticEvents:a.getSyntheticTraceEvents()});return Re[t]=o,De=o,Ne.activeManager()?.applyModificationsIfPresent(),this.activeManager()}constructor({traceParsedData:e,traceBounds:t,modifications:n}){super();const r=new Map([...e.Samples.entryToNode,...e.Renderer.entryToNode]);this.#c=new i.EntriesFilter.EntriesFilter(r),this.#d=new s.Breadcrumbs.Breadcrumbs(t),this.#h=n||null,this.#t=e,this.#m=new Fe,this.#p=new Map}getEntriesFilter(){return this.#c}getTimelineBreadcrumbs(){return this.#d}createAnnotation(e){const t={type:"ENTRY_LABEL",entry:e.entry,label:e.label};this.#p.set(e,t),this.dispatchEvent(new Ae(t,"Add"))}removeAnnotation(e){const t=this.#p.get(e);t?(this.#p.delete(e),this.dispatchEvent(new Ae(t,"Remove"))):console.warn("Overlay for deleted Annotation does not exist")}removeAnnotationOverlay(e){const t=this.#u(e);t?(this.#p.delete(t),this.dispatchEvent(new Ae(e,"Remove"))):console.warn("Annotation for deleted Overlay does not exist")}updateAnnotationOverlay(e){const t=this.#u(e);t?("ENTRY_LABEL"===e.type&&(t.label=e.label),this.dispatchEvent(new Ae(e,"UpdateLabel"))):console.warn("Annotation for updated Overlay does not exist")}#u(e){for(const[t,i]of this.#p.entries())if(i===e)return t;return null}getAnnotations(){return[...this.#p.keys()]}getOverlays(){return[...this.#p.values()]}toJSON(){const e=this.#c.invisibleEntries().map((e=>this.#m.keyForEvent(e))).filter((e=>null!==e)),t=this.#c.expandableEntries().map((e=>this.#m.keyForEvent(e))).filter((e=>null!==e));return this.#h={entriesModifications:{hiddenEntries:e,expandableEntries:t},initialBreadcrumb:this.#d.initialBreadcrumb,annotations:this.#g()},this.#h}#g(){const e=this.getAnnotations(),t=[];for(let i=0;i<e.length;i++)if("ENTRY_LABEL"===e[i].type){const n=this.#m.keyForEvent(e[i].entry);n&&t.push({entry:n,label:e[i].label})}return{entryLabels:t}}applyModificationsIfPresent(){const e=this.#h;if(!e||!e.annotations)return;const t=e.entriesModifications.hiddenEntries,i=e.entriesModifications.expandableEntries;this.#v(t,i),this.#d.setInitialBreadcrumbFromLoadedModifications(e.initialBreadcrumb);e.annotations.entryLabels.forEach((e=>{this.createAnnotation({type:"ENTRY_LABEL",entry:this.#m.eventForKey(e.entry,this.#t),label:e.label})}))}#v(e,t){const i=e.map((e=>this.#m.eventForKey(e,this.#t))),n=t.map((e=>this.#m.eventForKey(e,this.#t)));this.#c.setHiddenAndExpandableEntries(i,n)}}var Be=Object.freeze({__proto__:null,AnnotationModifiedEvent:Ae,ModificationsManager:Ne});function*He(e){if(yield"[\n",e.length>0){const t=e[Symbol.iterator](),i=t.next().value;yield`  ${JSON.stringify(i)}`;let n=1e4,r="";for(const e of t)r+=`,\n  ${JSON.stringify(e)}`,n--,0===n&&(yield r,n=1e4,r="");yield r}yield"\n]"}function*Ue(e,t){yield`{"metadata": ${JSON.stringify(t||{},null,2)}`,yield',\n"traceEvents": ',yield*He(e),yield"}\n"}function We(e){return JSON.stringify(e)}var Oe=Object.freeze({__proto__:null,arrayOfObjectsJsonGenerator:He,traceJsonGenerator:Ue,cpuprofileJsonGenerator:We});class Ve extends Event{static eventName="nodenamesupdated";constructor(){super(Ve.eventName,{composed:!0,bubbles:!0})}}const _e=new Map;class ze extends EventTarget{#T;#f=!1;#y=new Set;constructor(e){super(),this.#T=e}static clearResolvedNodeNames(){_e.clear()}static resolvedNodeNameForEntry(e){return _e.get(e.pid)?.get(e.tid)?.get(e.nodeId)??null}static storeResolvedNodeNameForEntry(e,t,i,n){const r=_e.get(e)||new Map,a=r.get(t)||new Map;a.set(i,n),r.set(t,a),_e.set(e,r)}async install(){if(this.#T.Samples){for(const e of this.#T.Samples.profilesInProcess.values())for(const[t,i]of e){const e=i.parsedProfile.nodes();if(!e||0===e.length)continue;const r=this.#w(t),a=r?.model(n.DebuggerModel.DebuggerModel);if(a)for(const t of e){const e=a.scriptForId(String(t.callFrame.scriptId));(!e||e.sourceMapURL)&&this.#y.add(a)}}for(const e of this.#y)e.sourceMapManager().addEventListener(n.SourceMapManager.Events.SourceMapAttached,this.#b,this);await this.#S()}}uninstall(){for(const e of this.#y)e.sourceMapManager().removeEventListener(n.SourceMapManager.Events.SourceMapAttached,this.#b,this);this.#y.clear()}async#S(){if(this.#T.Samples){for(const[e,t]of this.#T.Samples.profilesInProcess)for(const[i,n]of t){const t=n.parsedProfile.nodes()??[],r=this.#w(i);if(r)for(const n of t){const t=await y.NamesResolver.resolveProfileFrameFunctionName(n.callFrame,r);n.setFunctionName(t),ze.storeResolvedNodeNameForEntry(e,i,n.id,t)}}this.dispatchEvent(new Ve)}}#b(){this.#f||(this.#f=!0,setTimeout((async()=>{this.#f=!1,await this.#S()}),500))}#w(e){const t=this.#T.Workers.workerIdByThread.get(e);return t?n.TargetManager.TargetManager.instance().targetById(t):n.TargetManager.TargetManager.instance().primaryPageTarget()}}var Ge=Object.freeze({__proto__:null,NodeNamesUpdated:Ve,SourceMapsResolver:ze});const je={tracingNotSupported:"Performance trace recording not supported for this type of target"},qe=e.i18n.registerUIStrings("panels/timeline/TimelineController.ts",je),$e=e.i18n.getLocalizedString.bind(void 0,qe);class Je{primaryPageTarget;rootTarget;tracingManager;#C=[];#E=null;client;tracingCompleteCallback;constructor(e,t,n){this.primaryPageTarget=t,this.rootTarget=e,this.tracingManager=e.model(i.TracingManager.TracingManager),this.client=n}async dispose(){this.tracingManager&&await this.tracingManager.reset()}async startRecording(e){function t(e){return"disabled-by-default-"+e}const r=[a.Runtime.experiments.isEnabled("timeline-show-all-events")?"*":"-*",i.Types.TraceEvents.Categories.Console,i.Types.TraceEvents.Categories.Loading,i.Types.TraceEvents.Categories.UserTiming,"devtools.timeline",t("devtools.timeline"),t("devtools.timeline.frame"),t("devtools.timeline.stack"),t("v8.compile"),t("v8.cpu_profiler.hires"),t("lighthouse"),"v8.execute","v8","cppgc","navigation,rail"];a.Runtime.experiments.isEnabled("timeline-v8-runtime-call-stats")&&e.enableJSSampling&&r.push(t("v8.runtime_stats_sampling")),e.enableJSSampling&&r.push(t("v8.cpu_profiler")),a.Runtime.experiments.isEnabled("timeline-invalidation-tracking")&&r.push(t("devtools.timeline.invalidationTracking")),e.capturePictures&&r.push(t("devtools.timeline.layers"),t("devtools.timeline.picture"),t("blink.graphics_context_annotations")),e.captureFilmStrip&&r.push(t("devtools.screenshot")),e.captureSelectorStats&&r.push(t("blink.debug")),a.Runtime.experiments.isEnabled("timeline-enhanced-traces")&&(r.push(t("devtools.target-rundown")),r.push(t("devtools.v8-source-rundown"))),a.Runtime.experiments.isEnabled("timeline-compiled-sources")&&r.push(t("devtools.v8-source-rundown-sources")),this.#E=Date.now();const s=await this.startRecordingWithCategories(r.join(","));return s.getError()&&(await this.waitForTracingToStop(!1),await n.TargetManager.TargetManager.instance().resumeAllTargets()),s}async stopRecording(){this.tracingManager&&this.tracingManager.stop(),this.client.loadingStarted(),await this.waitForTracingToStop(!0),await this.allSourcesFinished()}async waitForTracingToStop(e){const t=[];this.tracingManager&&e&&t.push(new Promise((e=>{this.tracingCompleteCallback=e}))),await Promise.all(t)}async startRecordingWithCategories(e){if(!this.tracingManager)throw new Error($e(je.tracingNotSupported));await n.TargetManager.TargetManager.instance().suspendAllTargets("performance-timeline");const t=await this.tracingManager.start(this,e,"");return await this.warmupJsProfiler(),w.ExtensionServer.ExtensionServer.instance().profilingStarted(),t}async warmupJsProfiler(){const e=this.primaryPageTarget.model(n.RuntimeModel.RuntimeModel);e&&await e.agent.invoke_evaluate({expression:"(async function(){ await 1; })()",throwOnSideEffect:!0})}traceEventsCollected(e){this.#C.push(...e)}tracingComplete(){this.tracingCompleteCallback&&(this.tracingCompleteCallback(void 0),this.tracingCompleteCallback=null)}async allSourcesFinished(){this.client.processingStarted(),await this.finalizeTrace()}async finalizeTrace(){await n.TargetManager.TargetManager.instance().resumeAllTargets(),w.ExtensionServer.ExtensionServer.instance().profilingStopped(),await this.client.loadingComplete(this.#C,null,!1,this.#E,null),this.client.loadingCompleteForTest()}tracingBufferUsage(e){this.client.recordingProgress(e)}eventsRetrievalProgress(e){this.client.loadingProgress(e)}}var Ke=Object.freeze({__proto__:null,TimelineController:Je});const Ye={jsHeap:"JS Heap",documents:"Documents",nodes:"Nodes",listeners:"Listeners",gpuMemory:"GPU Memory",ss:"[{PH1} – {PH2}]"},Xe=e.i18n.registerUIStrings("panels/timeline/CountersGraph.ts",Ye),Ze=e.i18n.getLocalizedString.bind(void 0,Xe);class Qe extends u.Widget.VBox{delegate;calculator;header;toolbar;graphsContainer;canvasContainer;canvas;timelineGrid;counters;counterUI;countersByName;gpuMemoryCounter;#k=null;currentValuesBar;markerXPosition;#x=this.#P.bind(this);constructor(e){super(),this.element.id="memory-graphs-container",this.delegate=e,this.calculator=new it,this.header=new u.Widget.HBox,this.header.element.classList.add("timeline-memory-header"),this.header.show(this.element),this.toolbar=new u.Toolbar.Toolbar("timeline-memory-toolbar"),this.header.element.appendChild(this.toolbar.element),this.graphsContainer=new u.Widget.VBox,this.graphsContainer.show(this.element);const t=new u.Widget.VBoxWithResizeCallback(this.resize.bind(this));t.show(this.graphsContainer.element),this.createCurrentValuesBar(),this.canvasContainer=t.element,this.canvasContainer.id="memory-graphs-canvas-container",this.canvas=document.createElement("canvas"),this.canvasContainer.appendChild(this.canvas),this.canvas.id="memory-counters-graph",this.canvasContainer.addEventListener("mouseover",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mouseleave",this.onMouseLeave.bind(this),!0),this.canvasContainer.addEventListener("click",this.onClick.bind(this),!0),this.timelineGrid=new p.TimelineGrid.TimelineGrid,this.canvasContainer.appendChild(this.timelineGrid.dividersElement),this.counters=[],this.counterUI=[],this.countersByName=new Map,this.countersByName.set("jsHeapSizeUsed",this.createCounter(Ze(Ye.jsHeap),"js-heap-size-used","hsl(220, 90%, 43%)",c.NumberUtilities.bytesToString)),this.countersByName.set("documents",this.createCounter(Ze(Ye.documents),"documents","hsl(0, 90%, 43%)")),this.countersByName.set("nodes",this.createCounter(Ze(Ye.nodes),"nodes","hsl(120, 90%, 43%)")),this.countersByName.set("jsEventListeners",this.createCounter(Ze(Ye.listeners),"js-event-listeners","hsl(38, 90%, 43%)")),this.gpuMemoryCounter=this.createCounter(Ze(Ye.gpuMemory),"gpu-memory-used-kb","hsl(300, 90%, 43%)",c.NumberUtilities.bytesToString),this.countersByName.set("gpuMemoryUsedKB",this.gpuMemoryCounter),h.TraceBounds.onChange(this.#x)}#P(e){if("RESET"===e.updateType||"VISIBLE_WINDOW"===e.updateType){const t=e.state.milli.timelineTraceWindow;this.calculator.setWindow(t.min,t.max),this.#I()}}setModel(e,t){if(this.#k=t,!t)return;const n=e?i.Helpers.Timing.traceWindowMilliSeconds(e.Meta.traceBounds).min:0;this.calculator.setZeroTime(n);for(let e=0;e<this.counters.length;++e)this.counters[e].reset(),this.counterUI[e].reset();this.#I();for(let e=0;e<t.length;++e){const n=t[e];if(!i.Types.TraceEvents.isTraceEventUpdateCounters(n))continue;const r=n.args.data;if(!r)return;for(const e in r){const t=this.countersByName.get(e);if(t){const{startTime:a}=i.Helpers.Timing.eventTimingsMilliSeconds(n);t.appendSample(a,r[e])}}void 0!==r.gpuMemoryLimitKB&&this.gpuMemoryCounter.setLimit(r.gpuMemoryLimitKB)}}createCurrentValuesBar(){this.currentValuesBar=this.graphsContainer.element.createChild("div"),this.currentValuesBar.id="counter-values-bar"}createCounter(e,t,i,n){const r=new et;return this.counters.push(r),this.counterUI.push(new tt(this,e,t,i,r,n)),r}resizerElement(){return this.header.element}resize(){const e=this.canvas.parentElement;this.canvas.width=e.clientWidth*window.devicePixelRatio,this.canvas.height=e.clientHeight*window.devicePixelRatio,this.calculator.setDisplayWidth(this.canvas.width),this.refresh()}#I(){u.UIUtils.invokeOnceAfterBatchUpdate(this,this.refresh)}draw(){this.clear();for(const e of this.counters)e.calculateVisibleIndexes(this.calculator),e.calculateXValues(this.canvas.width);for(const e of this.counterUI)e.drawGraph(this.canvas)}onClick(e){const t=e.x-this.canvasContainer.getBoundingClientRect().left;let i,n=1/0;for(const e of this.counterUI){if(!e.counter.times.length)continue;const r=e.recordIndexAt(t),a=Math.abs(t*window.devicePixelRatio-e.counter.x[r]);a<n&&(n=a,i=e.counter.times[r])}void 0!==i&&this.#k&&this.delegate.selectEntryAtTime(this.#k,i)}onMouseLeave(e){delete this.markerXPosition,this.clearCurrentValueAndMarker()}clearCurrentValueAndMarker(){for(let e=0;e<this.counterUI.length;e++)this.counterUI[e].clearCurrentValueAndMarker()}onMouseMove(e){const t=e.x-this.canvasContainer.getBoundingClientRect().left;this.markerXPosition=t,this.refreshCurrentValues()}refreshCurrentValues(){if(void 0!==this.markerXPosition)for(let e=0;e<this.counterUI.length;++e)this.counterUI[e].updateCurrentValue(this.markerXPosition)}refresh(){this.timelineGrid.updateDividers(this.calculator),this.draw(),this.refreshCurrentValues()}clear(){const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to get canvas context");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class et{times;values;x;minimumIndex;maximumIndex;maxTime;minTime;limitValue;constructor(){this.times=[],this.values=[],this.x=[],this.minimumIndex=0,this.maximumIndex=0,this.maxTime=0,this.minTime=0}appendSample(e,t){this.values.length&&this.values[this.values.length-1]===t||(this.times.push(e),this.values.push(t))}reset(){this.times=[],this.values=[]}setLimit(e){this.limitValue=e}calculateBounds(){let e,t;for(let i=this.minimumIndex;i<=this.maximumIndex;i++){const n=this.values[i];(void 0===t||n<t)&&(t=n),(void 0===e||n>e)&&(e=n)}return t=t||0,e=e||1,this.limitValue&&(e>.5*this.limitValue&&(e=Math.max(e,this.limitValue)),t=Math.min(t,this.limitValue)),{min:t,max:e}}calculateVisibleIndexes(e){const t=e.minimumBoundary(),i=e.maximumBoundary();this.minimumIndex=c.NumberUtilities.clamp(c.ArrayUtilities.upperBound(this.times,t,c.ArrayUtilities.DEFAULT_COMPARATOR)-1,0,this.times.length-1),this.maximumIndex=c.NumberUtilities.clamp(c.ArrayUtilities.lowerBound(this.times,i,c.ArrayUtilities.DEFAULT_COMPARATOR),0,this.times.length-1),this.minTime=t,this.maxTime=i}calculateXValues(e){if(!this.values.length)return;const t=e/(this.maxTime-this.minTime);this.x=new Array(this.values.length);for(let e=this.minimumIndex+1;e<=this.maximumIndex;e++)this.x[e]=t*(this.times[e]-this.minTime)}}class tt{countersPane;counter;formatter;setting;filter;range;value;graphColor;limitColor;graphYValues;verticalPadding;currentValueLabel;marker;constructor(e,t,i,n,a,s){this.countersPane=e,this.counter=a,this.formatter=s||c.NumberUtilities.withThousandsSeparator,this.setting=r.Settings.Settings.instance().createSetting("timeline-counters-graph-"+i,!0),this.setting.setTitle(t),this.filter=new u.Toolbar.ToolbarSettingCheckbox(this.setting,t),this.filter.inputElement.classList.add("-theme-preserve-input");const o=r.Color.parse(n);if(o){const e=o.setAlpha(.5).asString("rgba"),t=this.filter.element;e&&(t.style.backgroundColor=e),t.style.borderColor="transparent"}this.filter.inputElement.addEventListener("click",this.toggleCounterGraph.bind(this)),e.toolbar.appendToolbarItem(this.filter),this.range=this.filter.element.createChild("span","range"),this.value=e.currentValuesBar.createChild("span","memory-counter-value"),this.value.style.color=n,this.graphColor=n,o&&(this.limitColor=o.setAlpha(.3).asString("rgba")),this.graphYValues=[],this.verticalPadding=10,this.currentValueLabel=t,this.marker=e.canvasContainer.createChild("div","memory-counter-marker"),this.marker.style.backgroundColor=n,this.clearCurrentValueAndMarker()}reset(){this.range.textContent=""}setRange(e,t){const i=this.formatter(e),n=this.formatter(t);this.range.textContent=Ze(Ye.ss,{PH1:i,PH2:n})}toggleCounterGraph(){this.value.classList.toggle("hidden",!this.filter.checked()),this.countersPane.refresh()}recordIndexAt(e){return c.ArrayUtilities.upperBound(this.counter.x,e*window.devicePixelRatio,c.ArrayUtilities.DEFAULT_COMPARATOR,this.counter.minimumIndex+1,this.counter.maximumIndex+1)-1}updateCurrentValue(e){if(!this.visible()||!this.counter.values.length||!this.counter.x)return;const t=this.recordIndexAt(e),i=c.NumberUtilities.withThousandsSeparator(this.counter.values[t]);this.value.textContent=`${this.currentValueLabel}: ${i}`;const n=this.graphYValues[t]/window.devicePixelRatio;this.marker.style.left=e+"px",this.marker.style.top=n+"px",this.marker.classList.remove("hidden")}clearCurrentValueAndMarker(){this.value.textContent="",this.marker.classList.add("hidden")}drawGraph(e){const t=e.getContext("2d");if(!t)throw new Error("Unable to get canvas context");const i=e.width,n=e.height-2*this.verticalPadding;if(n<=0)return void(this.graphYValues=[]);const r=this.verticalPadding,a=this.counter,s=a.values;if(!s.length)return;const o=a.calculateBounds(),l=o.min,c=o.max;if(this.setRange(l,c),!this.visible())return;const d=this.graphYValues,h=c-l,m=h?n/h:1;t.save(),t.lineWidth=window.devicePixelRatio,t.lineWidth%2&&t.translate(.5,.5),t.beginPath();let p=s[a.minimumIndex],u=Math.round(r+n-(p-l)*m);t.moveTo(0,u);let g=a.minimumIndex;for(;g<=a.maximumIndex;g++){const e=Math.round(a.x[g]);t.lineTo(e,u);const i=s[g];void 0!==i&&(p=i),u=Math.round(r+n-(p-l)*m),t.lineTo(e,u),d[g]=u}if(d.length=g,t.lineTo(i,u),t.strokeStyle=this.graphColor,t.stroke(),a.limitValue){const e=Math.round(r+n-(a.limitValue-l)*m);t.moveTo(0,e),t.lineTo(i,e),this.limitColor&&(t.strokeStyle=this.limitColor),t.stroke()}t.closePath(),t.restore()}visible(){return this.filter.checked()}}class it{minimumBoundaryInternal;maximumBoundaryInternal;workingArea;zeroTimeInternal;constructor(){this.minimumBoundaryInternal=0,this.maximumBoundaryInternal=0,this.workingArea=0,this.zeroTimeInternal=0}setZeroTime(e){this.zeroTimeInternal=e}computePosition(e){return(e-this.minimumBoundaryInternal)/this.boundarySpan()*this.workingArea}setWindow(e,t){this.minimumBoundaryInternal=e,this.maximumBoundaryInternal=t}setDisplayWidth(e){this.workingArea=e}formatValue(t,i){return e.TimeUtilities.preciseMillisToString(t-this.zeroTime(),i)}maximumBoundary(){return this.maximumBoundaryInternal}minimumBoundary(){return this.minimumBoundaryInternal}zeroTime(){return this.zeroTimeInternal}boundarySpan(){return this.maximumBoundaryInternal-this.minimumBoundaryInternal}}var nt=Object.freeze({__proto__:null,CountersGraph:Qe,Counter:et,CounterUI:tt,Calculator:it});function rt(e,t){const i=n.TargetManager.TargetManager.instance(),r=e.Workers.workerIdByThread.get(t.tid);return r?i.targetById(r):i.primaryPageTarget()}var at=Object.freeze({__proto__:null,targetForEvent:rt});const st=new CSSStyleSheet;st.replaceSync(".token-variable{color:var(--sys-color-token-variable)}.token-property{color:var(--sys-color-token-property)}.token-type{color:var(--sys-color-token-type)}.token-variable-special{color:var(--sys-color-token-variable-special)}.token-definition{color:var(--sys-color-token-definition)}.token-builtin{color:var(--sys-color-token-builtin)}.token-number{color:var(--sys-color-token-number)}.token-string{color:var(--sys-color-token-string)}.token-string-special{color:var(--sys-color-token-string-special)}.token-atom{color:var(--sys-color-token-atom)}.token-keyword{color:var(--sys-color-token-keyword)}.token-comment{color:var(--sys-color-token-comment)}.token-meta{color:var(--sys-color-token-meta)}.token-invalid{color:var(--sys-color-error)}.token-tag{color:var(--sys-color-token-tag)}.token-attribute{color:var(--sys-color-token-attribute)}.token-attribute-value{color:var(--sys-color-token-attribute-value)}.token-inserted{color:var(--sys-color-token-inserted)}.token-deleted{color:var(--sys-color-token-deleted)}.token-heading{color:var(--sys-color-token-variable-special);font-weight:bold}.token-link{color:var(--sys-color-token-variable-special);text-decoration:underline}.token-strikethrough{text-decoration:strike-through}.token-strong{font-weight:bold}.token-emphasis{font-style:italic}\n/*# sourceURL=codeHighlighter.css */\n");const ot=new CSSStyleSheet;ot.replaceSync(".image-preview-container{background:transparent;text-align:center;border-spacing:0}.image-preview-container img{margin:6px 0;max-width:100px;max-height:100px;background-image:var(--image-file-checker);user-select:text;vertical-align:top;-webkit-user-drag:auto}.image-container{padding:0}.image-container > div{min-height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer}.image-preview-container .row{line-height:1.2;vertical-align:baseline}.image-preview-container .title{padding-right:0.5em;text-align:right;color:var(--sys-color-token-subtle);white-space:nowrap}.image-preview-container .description{white-space:nowrap;text-align:left;color:var(--sys-color-on-surface)}.image-preview-container .description-link{max-width:20em}.image-preview-container .source-link{white-space:normal;word-break:break-all;color:var(--sys-color-primary);cursor:pointer}\n/*# sourceURL=imagePreview.css */\n");const lt=new CSSStyleSheet;lt.replaceSync('*{box-sizing:border-box;min-width:0;min-height:0}:root{height:100%;overflow:hidden;--legacy-accent-color:#1a73e8;--legacy-accent-fg-color:#1a73e8;--legacy-accent-color-hover:#3b86e8;--legacy-accent-fg-color-hover:#1567d3;--legacy-active-control-bg-color:#5a5a5a;--legacy-focus-bg-color:hsl(214deg 40% 92%);--legacy-focus-ring-inactive-shadow-color:#e0e0e0;--legacy-input-validation-error:#db1600;--legacy-toolbar-hover-bg-color:#eaeaea;--legacy-selection-fg-color:#fff;--legacy-selection-bg-color:var(--legacy-accent-color);--legacy-selection-inactive-fg-color:#5a5a5a;--legacy-selection-inactive-bg-color:#dadada;--legacy-divider-border:1px solid var(--sys-color-divider);--legacy-focus-ring-inactive-shadow:0 0 0 1px var(--legacy-focus-ring-inactive-shadow-color);--legacy-focus-ring-active-shadow:0 0 0 1px var(--legacy-accent-color);--legacy-item-selection-bg-color:#cfe8fc;--legacy-item-selection-inactive-bg-color:#e0e0e0;--monospace-font-size:10px;--monospace-font-family:monospace;--source-code-font-size:11px;--source-code-font-family:monospace;--sys-motion-duration-short4:200ms;--sys-motion-duration-medium2:300ms;--sys-motion-duration-long2:500ms;--sys-motion-easing-emphasized:cubic-bezier(0.2,0,0,1);--sys-motion-easing-emphasized-decelerate:cubic-bezier(0.05,0.7,0.1,1);--sys-motion-easing-emphasized-accelerate:cubic-bezier(0.2,0,0,1)}.theme-with-dark-background{color-scheme:dark;--legacy-accent-color:#0e639c;--legacy-accent-fg-color:#ccc;--legacy-accent-fg-color-hover:#fff;--legacy-accent-color-hover:rgb(17 119 187);--legacy-active-control-bg-color:#cdcdcd;--legacy-focus-bg-color:hsl(214deg 19% 27%);--legacy-focus-ring-inactive-shadow-color:#5a5a5a;--legacy-toolbar-hover-bg-color:#202020;--legacy-selection-fg-color:#cdcdcd;--legacy-selection-inactive-fg-color:#cdcdcd;--legacy-selection-inactive-bg-color:hsl(0deg 0% 28%);--legacy-focus-ring-inactive-shadow:0 0 0 1px var(--legacy-focus-ring-inactive-shadow-color);--legacy-item-selection-bg-color:hsl(207deg 88% 22%);--legacy-item-selection-inactive-bg-color:#454545}body{--default-font-family:".SFNSDisplay-Regular","Helvetica Neue","Lucida Grande",sans-serif;height:100%;width:100%;position:relative;overflow:hidden;margin:0;cursor:default;font-family:var(--default-font-family);font-size:12px;tab-size:4;user-select:none;color:var(--sys-color-on-surface);background:var(--sys-color-cdt-base-container)}.platform-linux{--default-font-family:"Google Sans Text","Google Sans",system-ui,sans-serif}.platform-mac{--default-font-family:system-ui,sans-serif}.platform-windows{--default-font-family:system-ui,sans-serif}:focus{outline-width:0}.platform-mac,\n:host-context(.platform-mac){--monospace-font-size:11px;--monospace-font-family:monospace;--source-code-font-size:11px;--source-code-font-family:monospace}.platform-windows,\n:host-context(.platform-windows){--monospace-font-size:12px;--monospace-font-family:monospace;--source-code-font-size:12px;--source-code-font-family:monospace}.platform-linux,\n:host-context(.platform-linux){--monospace-font-size:11px;--monospace-font-family:"Noto Sans Mono","DejaVu Sans Mono",monospace;--source-code-font-size:11px;--source-code-font-family:"Noto Sans Mono","DejaVu Sans Mono",monospace}.monospace{font-family:var(--monospace-font-family);font-size:var(--monospace-font-size)!important}.source-code{font-family:var(--source-code-font-family);font-size:var(--source-code-font-size)!important;white-space:pre-wrap}.source-code .devtools-link.text-button{max-width:100%;overflow:hidden;text-overflow:ellipsis}img{-webkit-user-drag:none}iframe,\na img{border:none}.fill{position:absolute;top:0;left:0;right:0;bottom:0}iframe.fill{width:100%;height:100%}.widget{position:relative;flex:auto;contain:style}.hbox{display:flex;flex-direction:row!important;position:relative}.vbox{display:flex;flex-direction:column!important;position:relative}.view-container > .toolbar{border-bottom:1px solid var(--sys-color-divider)}.flex-auto{flex:auto}.flex-none{flex:none}.flex-centered{display:flex;align-items:center;justify-content:center}.overflow-auto{overflow:auto;background-color:var(--sys-color-cdt-base-container)}iframe.widget{position:absolute;width:100%;height:100%;left:0;right:0;top:0;bottom:0}.hidden{display:none!important}.highlighted-search-result{border-radius:1px;background-color:var(--sys-color-yellow-container);outline:1px solid var(--sys-color-yellow-container)}.link{cursor:pointer;text-decoration:underline;color:var(--sys-color-primary);outline-offset:2px}button,\ninput,\nselect{font-family:inherit;font-size:inherit}select option,\nselect optgroup,\ninput{background-color:var(--sys-color-cdt-base-container)}input{color:inherit;&[type="checkbox"]{position:relative;&:hover::after,\n    &:active::before{content:"";height:24px;width:24px;border-radius:var(--sys-shape-corner-full);position:absolute;top:-6px;left:-6px}&:not(.-theme-preserve){accent-color:var(--sys-color-primary-bright);color:var(--sys-color-on-primary)}&:not(:disabled):hover::after{background-color:var(--sys-color-state-hover-on-subtle)}&:not(:disabled):active::before{background-color:var(--sys-color-state-ripple-neutral-on-subtle)}&:not(:disabled):focus-visible{outline:none;&::before{content:"";height:15px;width:15px;border-radius:5px;position:absolute;top:-3.5px;left:-3.5px;border:2px solid var(--sys-color-state-focus-ring)}}&.small:hover::after,\n    &.small:active::before{height:12px;width:12px;top:0;left:0;border-radius:2px}}}input::placeholder{--override-input-placeholder-color:rgb(0 0 0/54%);color:var(--override-input-placeholder-color)}.theme-with-dark-background input::placeholder,\n:host-context(.theme-with-dark-background) input::placeholder{--override-input-placeholder-color:rgb(230 230 230/54%)}.harmony-input:not([type]),\n.harmony-input[type="number"],\n.harmony-input[type="text"]{padding:3px 6px;height:24px;border:1px solid var(--sys-color-neutral-outline);border-radius:4px;&.error-input,\n  &:invalid{border-color:var(--sys-color-error)}&:not(.error-input):not(:invalid):focus{border-color:var(--sys-color-state-focus-ring)}&:not(.error-input):not(:invalid):hover:not(:focus){background:var(--sys-color-state-hover-on-subtle)}}.highlighted-search-result.current-search-result{--override-current-search-result-background-color:rgb(255 127 0/80%);border-radius:1px;padding:1px;margin:-1px;background-color:var(--override-current-search-result-background-color)}.dimmed{opacity:60%}.editing{box-shadow:var(--drop-shadow);background-color:var(--sys-color-cdt-base-container);text-overflow:clip!important;padding-left:2px;margin-left:-2px;padding-right:2px;margin-right:-2px;margin-bottom:-1px;padding-bottom:1px;opacity:100%!important}.editing,\n.editing *{color:var(--sys-color-on-surface)!important;text-decoration:none!important}.chrome-select{appearance:none;user-select:none;border:1px solid var(--sys-color-neutral-outline);border-radius:4px;color:var(--sys-color-on-surface);font:inherit;margin:0;outline:none;padding-right:20px;padding-left:6px;background-image:var(--image-file-arrow-drop-down-light);background-color:var(--sys-color-surface);background-position:right center;background-repeat:no-repeat;min-height:24px;min-width:80px}.chrome-select:disabled{opacity:38%}.theme-with-dark-background .chrome-select,\n:host-context(.theme-with-dark-background) .chrome-select{background-image:var(--image-file-arrow-drop-down-dark)}.chrome-select:enabled{&:hover{background-color:var(--sys-color-state-hover-on-subtle)}&:active{background-color:var(--sys-color-state-ripple-neutral-on-subtle)}&:focus{outline:2px solid var(--sys-color-state-focus-ring);outline-offset:2px}}@media (forced-colors: active) and (prefers-color-scheme: light){.chrome-select{background-image:var(--image-file-arrow-drop-down-light)}.theme-with-dark-background .chrome-select,\n  :host-context(.theme-with-dark-background) .chrome-select{background-image:var(--image-file-arrow-drop-down-light)}}@media (forced-colors: active) and (prefers-color-scheme: dark){.chrome-select{background-image:var(--image-file-arrow-drop-down-dark)}.theme-with-dark-background .chrome-select,\n  :host-context(.theme-with-dark-background) .chrome-select{background-image:var(--image-file-arrow-drop-down-dark)}}.chrome-select-label{margin:0 22px;flex:none}.chrome-select-label p p{margin-top:0;color:var(--sys-color-token-subtle)}.settings-select{margin:0}.chrome-select optgroup,\n.chrome-select option{background-color:var(--sys-color-cdt-base-container);color:var(--sys-color-on-surface)}.gray-info-message{text-align:center;font-style:italic;padding:6px;color:var(--sys-color-token-subtle);white-space:nowrap}span[is="dt-icon-label"]{flex:none}.full-widget-dimmed-banner a{color:inherit}.full-widget-dimmed-banner{color:var(--sys-color-token-subtle);background-color:var(--sys-color-cdt-base-container);display:flex;justify-content:center;align-items:center;text-align:center;padding:20px;position:absolute;top:0;right:0;bottom:0;left:0;font-size:13px;overflow:auto;z-index:500}.dot::before{content:var(--image-file-empty);width:6px;height:6px;border-radius:50%;outline:1px solid var(--icon-gap-default);left:9px;position:absolute;top:9px;z-index:1}.green::before{background-color:var(--sys-color-green-bright)}.purple::before{background-color:var(--sys-color-purple-bright)}.expandable-inline-button{background-color:var(--sys-color-cdt-base-container);color:var(--sys-color-on-surface);cursor:pointer;border-radius:3px}.undisplayable-text,\n.expandable-inline-button{border:none;padding:1px 3px;margin:0 2px;font-size:11px;font-family:sans-serif;white-space:nowrap;display:inline-block}.undisplayable-text::after,\n.expandable-inline-button::after{content:attr(data-text)}.undisplayable-text{color:var(--sys-color-state-disabled);font-style:italic}.expandable-inline-button:hover,\n.expandable-inline-button:focus-visible{background-color:var(--sys-color-state-hover-on-subtle)}.expandable-inline-button:focus-visible{background-color:var(--sys-color-state-focus-highlight)}::selection{background-color:var(--sys-color-tonal-container)}.reload-warning{align-self:center;margin-left:10px}button.link{border:none;background:none;padding:3px}button.link:focus-visible{outline:2px solid var(--sys-color-state-focus-ring);outline-offset:2px;border-radius:var(--sys-shape-corner-full)}.theme-with-dark-background button.link:focus-visible,\n:host-context(.theme-with-dark-background) button.link:focus-visible{--override-link-focus-background-color:rgb(230 230 230/8%)}@media (forced-colors: active){.dimmed,\n  .chrome-select:disabled{opacity:100%}.harmony-input:not([type]),\n  .harmony-input[type="number"],\n  .harmony-input[type="text"]{border:1px solid ButtonText}.harmony-input:not([type]):focus,\n  .harmony-input[type="number"]:focus,\n  .harmony-input[type="text"]:focus{border:1px solid Highlight}}input.custom-search-input::-webkit-search-cancel-button{appearance:none;width:16px;height:15px;margin-right:0;opacity:70%;mask-image:var(--image-file-cross-circle-filled);mask-position:center;mask-repeat:no-repeat;mask-size:99%;background-color:var(--icon-default)}input.custom-search-input::-webkit-search-cancel-button:hover{opacity:99%}.spinner::before{display:block;width:var(--dimension,24px);height:var(--dimension,24px);border:var(--override-spinner-size,3px) solid var(--override-spinner-color,var(--sys-color-token-subtle));border-radius:12px;clip:rect(0,var(--clip-size,15px),var(--clip-size,15px),0);content:"";position:absolute;animation:spinner-animation 1s linear infinite;box-sizing:border-box}@keyframes spinner-animation{from{transform:rotate(0)}to{transform:rotate(360deg)}}.adorner-container{display:inline-flex;vertical-align:middle}.adorner-container.hidden{display:none}.adorner-container devtools-adorner{margin-left:3px}:host-context(.theme-with-dark-background) devtools-adorner{--override-adorner-border-color:var(--sys-color-tonal-outline);--override-adorner-focus-border-color:var(--sys-color-state-focus-ring);--override-adorner-active-background-color:var(--sys-color-state-riple-neutral-on-subtle)}.panel{display:flex;overflow:hidden;position:absolute;top:0;left:0;right:0;bottom:0;z-index:0;background-color:var(--sys-color-cdt-base-container)}.panel-sidebar{overflow-x:hidden;background-color:var(--sys-color-cdt-base-container)}iframe.extension{flex:auto;width:100%;height:100%}iframe.panel.extension{display:block;height:100%}@media (forced-colors: active){:root{--legacy-accent-color:Highlight;--legacy-focus-ring-inactive-shadow-color:ButtonText}}\n/*# sourceURL=inspectorCommon.css */\n');const ct={interactions:"Interactions"},dt=e.i18n.registerUIStrings("panels/timeline/InteractionsTrackAppender.ts",ct),ht=e.i18n.getLocalizedString.bind(void 0,dt);class mt{appenderName="Interactions";#M;#e;#t;constructor(e,t,i){this.#e=e,this.#M=i,this.#t=t}appendTrackAtLevel(e,t){return 0===this.#t.UserInteractions.interactionEvents.length?e:(this.#i(e,t),this.#F(e))}#i(e,t){const i=U({collapsible:this.#t.UserInteractions.interactionEvents.length>0,useDecoratorsForOverview:!0}),n=W("interactions",e,ht(ct.interactions),i,!0,t);this.#e.registerTrackForGroup(n,this)}#F(e){const{interactionEventsWithNoNesting:t,interactionsOverThreshold:i}=this.#t.UserInteractions;return this.#e.appendEventsAtLevel(t,e,this,((e,t)=>{i.has(e)&&void 0!==t&&this.#L(e,t)}))}#L(e,t){const n=this.#e.getFlameChartTimelineData().entryDecorations[t]||[];n.push({type:"CANDY",startAtTime:i.Handlers.ModelHandlers.UserInteractions.LONG_INTERACTION_THRESHOLD,endAtTime:e.processingEnd},{type:"WARNING_TRIANGLE",customEndTime:e.processingEnd}),this.#e.getFlameChartTimelineData().entryDecorations[t]=n}colorForEvent(e){let t=this.titleForEvent(e);return i.Types.TraceEvents.isSyntheticInteractionEvent(e)&&(t+=e.interactionId),this.#M.colorForID(t)}titleForEvent(e){return i.Types.TraceEvents.isSyntheticInteractionEvent(e)?pt(e):e.name}highlightedEntryInfo(e){return{title:this.titleForEvent(e),formattedTime:O(e.dur)}}}function pt(e){const t=i.Handlers.ModelHandlers.UserInteractions.categoryOfInteraction(e);return"OTHER"===t?"Other":"KEYBOARD"===t?"Keyboard":"POINTER"===t?"Pointer":e.type}var ut=Object.freeze({__proto__:null,InteractionsTrackAppender:mt,titleForInteractionEvent:pt});const gt=Symbol("SelectionRange");class vt{startTime;endTime;object;constructor(e,t,i){this.startTime=e,this.endTime=t,this.object=i}static isFrameObject(e){return e instanceof i.Handlers.ModelHandlers.Frames.TimelineFrame}static fromFrame(e){return new vt(i.Helpers.Timing.microSecondsToMilliseconds(e.startTime),i.Helpers.Timing.microSecondsToMilliseconds(e.endTime),e)}static isSyntheticNetworkRequestDetailsEventSelection(e){return!vt.isFrameObject(e)&&!vt.isRangeSelection(e)&&i.Types.TraceEvents.isSyntheticNetworkRequestEvent(e)}static isNetworkEventSelection(e){return!vt.isFrameObject(e)&&!vt.isRangeSelection(e)&&i.Types.TraceEvents.isNetworkTrackEntry(e)}static isTraceEventSelection(e){return!vt.isFrameObject(e)&&!vt.isRangeSelection(e)&&!i.Types.TraceEvents.isSyntheticNetworkRequestEvent(e)}static fromTraceEvent(e){const{startTime:t,endTime:n}=i.Helpers.Timing.eventTimingsMilliSeconds(e);return new vt(t,i.Types.Timing.MilliSeconds(n||t+1),e)}static isRangeSelection(e){return e===gt}static fromRange(e,t){return new vt(i.Types.Timing.MilliSeconds(e),i.Types.Timing.MilliSeconds(t),gt)}}var Tt=Object.freeze({__proto__:null,TimelineSelection:vt});const ft={emptyPlaceholder:"{PH1}",timestamp:"Timestamp",interactionID:"ID",inputDelay:"Input delay",processingDuration:"Processing duration",presentationDelay:"Presentation delay",compile:"Compile",parse:"Parse",sS:"{PH1}: {PH2}",sCollected:"{PH1} collected",sSs:"{PH1} [{PH2}…{PH3}]",sSSquareBrackets:"{PH1} [{PH2}…]",learnMore:"Learn more",compilationCacheStatus:"Compilation cache status",compilationCacheSize:"Compilation cache size",compilationCacheKind:"Compilation cache kind",scriptLoadedFromCache:"script loaded from cache",failedToLoadScriptFromCache:"failed to load script from cache",scriptNotEligibleToBeLoadedFromCache:"script not eligible",totalTime:"Total Time",selfTime:"Self Time",collected:"Collected",function:"Function",timerId:"Timer ID",timeout:"Timeout",repeats:"Repeats",callbackId:"Callback ID",module:"Module",script:"Script",streamed:"Streamed",eagerCompile:"Compiling all functions eagerly",url:"Url",producedCacheSize:"Produced Cache Size",consumedCacheSize:"Consumed Cache Size",location:"Location",sSCurlyBrackets:"({PH1}, {PH2})",dimensions:"Dimensions",sSDimensions:"{PH1} × {PH2}",layerRoot:"Layer Root",ownerElement:"Owner Element",imageUrl:"Image URL",stylesheetUrl:"Stylesheet URL",elementsAffected:"Elements Affected",nodesThatNeedLayout:"Nodes That Need Layout",sOfS:"{PH1} of {PH2}",layoutRoot:"Layout root",message:"Message",callbackFunction:"Callback Function",state:"State",range:"Range",allottedTime:"Allotted Time",invokedByTimeout:"Invoked by Timeout",type:"Type",size:"Size",details:"Details",cumulativeLayoutShifts:"Cumulative Layout Shifts",evolvedClsLink:"evolved",sCLSInformation:"{PH1} can result in poor user experiences. It has recently {PH2}.",warning:"Warning",score:"Score",cumulativeScore:"Cumulative Score",currentClusterScore:"Current Cluster Score",currentClusterId:"Current Cluster ID",hadRecentInput:"Had recent input",yes:"Yes",no:"No",movedFrom:"Moved from",movedTo:"Moved to",relatedNode:"Related Node",preview:"Preview",aggregatedTime:"Aggregated Time",duration:"Duration",initiatorStackTrace:"Initiator Stack Trace",initiatedBy:"Initiated by",initiatorFor:"Initiator for",traceEvent:"Trace Event",timerInstalled:"Timer Installed",animationFrameRequested:"Animation Frame Requested",idleCallbackRequested:"Idle Callback Requested",recalculationForced:"Recalculation Forced",firstLayoutInvalidation:"First Layout Invalidation",layoutForced:"Layout Forced",stackTrace:"Stack Trace",invalidations:"Invalidations",pendingFor:"Pending for",firstInvalidated:"First Invalidated",paintProfiler:"Paint Profiler",sAtS:"{PH1} at {PH2}",sSelf:"{PH1} (self)",sChildren:"{PH1} (children)",timeSpentInRendering:"Time spent in rendering",frame:"Frame",sAtSParentheses:"{PH1} (at {PH2})",UnknownNode:"[ unknown node ]",invalidationWithCallFrame:"{PH1} at {PH2}",outsideBreadcrumbRange:"(outside of the breadcrumb range)",entryIsHidden:"(entry is hidden)",selectorStatsTitle:"Selector Stats",sSelectorStatsInfo:'Select "{PH1}" to collect detailed CSS selector matching statistics.'},yt=e.i18n.registerUIStrings("panels/timeline/TimelineUIUtils.ts",ft),wt=e.i18n.getLocalizedString.bind(void 0,yt);let bt,St;class Ct{static frameDisplayName(e){if(!C.TimelineJSProfile.TimelineJSProfileProcessor.isNativeRuntimeFrame(e))return u.UIUtils.beautifyFunctionName(e.functionName);switch(C.TimelineJSProfile.TimelineJSProfileProcessor.nativeGroup(e.functionName)){case"Compile":return wt(ft.compile);case"Parse":return wt(ft.parse)}return e.functionName}static testContentMatching(e,t,n){const r=[Ct.eventStyle(e).title];if(i.Types.TraceEvents.isProfileCall(e)&&(n&&n.Samples?r.push(i.Handlers.ModelHandlers.Samples.getProfileCallFunctionName(n.Samples,e)):r.push(e.callFrame.functionName)),n){const t=i.Extras.URLForEntry.get(n,e);t&&r.push(t)}!function e(t,i){if(!i)return;for(const n in t){const a=t[n];"string"==typeof a?r.push(a):"number"==typeof a?r.push(String(a)):"object"==typeof a&&null!==a&&e(a,i-1)}}(e.args,2);const a=r.join("|").match(t);return!!a&&a.length>0}static eventStyle(e){if(i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.Console)||i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.UserTiming))return new se(e.name,me().scripting);if(i.Types.TraceEvents.isProfileCall(e)&&"(idle)"===e.callFrame.functionName)return new se(e.name,me().idle);const t=new se(e.name,me().other);return de(e.name)||t}static eventColor(e){if(i.Types.TraceEvents.isProfileCall(e)){const t=e.callFrame;if(Ct.isUserFrame(t))return Ct.colorForId(t.url)}if(i.Types.Extensions.isSyntheticExtensionEntry(e))return P.ExtensionUI.extensionEntryColor(e);let t=Ct.eventStyle(e).category.getComputedColorValue();if("v8.parseOnBackgroundWaiting"===e.name&&(t=me().scripting.getComputedColorValue(),!t))throw new Error("Unable to parse color from getCategoryStyles().scripting.color");return t}static eventTitle(e){if(i.Types.TraceEvents.isProfileCall(e)){return ze.resolvedNodeNameForEntry(e)||Ct.frameDisplayName(e.callFrame)}if("EventTiming"===e.name&&i.Types.TraceEvents.isSyntheticInteractionEvent(e))return pt(e);const t=Ct.eventStyle(e).title;return i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.Console)?t:i.Types.TraceEvents.isTraceEventTimeStamp(e)?wt(ft.sS,{PH1:t,PH2:e.args.data.message}):i.Types.TraceEvents.isTraceEventAnimation(e)&&e.args.data.name?wt(ft.sS,{PH1:t,PH2:e.args.data.name}):i.Types.TraceEvents.isTraceEventDispatch(e)?wt(ft.sS,{PH1:t,PH2:e.args.data.type}):t}static isUserFrame(e){return"0"!==e.scriptId&&!(e.url&&e.url.startsWith("native "))}static async buildDetailsTextForTraceEvent(e,t){let n;const r=e.args,a=e.args?.data;switch(e.name){case"GCEvent":case"MajorGC":case"MinorGC":{const e=r.usedHeapSizeBefore-r.usedHeapSizeAfter;n=wt(ft.sCollected,{PH1:c.NumberUtilities.bytesToString(e)});break}case"FunctionCall":{const{lineNumber:t,columnNumber:r}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(e);void 0!==t&&void 0!==r&&(n=a.url+":"+(t+1)+":"+(r+1));break}case"EventDispatch":n=a?a.type:null;break;case"Paint":{const e=Ct.quadWidth(a.clip),t=Ct.quadHeight(a.clip);e&&t&&(n=wt(ft.sSDimensions,{PH1:e,PH2:t}));break}case"ParseHTML":{const e=r.beginData.startLine,t=r.endData&&r.endData.endLine,i=b.ResourceUtils.displayNameForURL(r.beginData.url);n=t>=0?wt(ft.sSs,{PH1:i,PH2:e+1,PH3:t+1}):wt(ft.sSSquareBrackets,{PH1:i,PH2:e+1});break}case"V8.CompileModule":case"v8.produceModuleCache":n=b.ResourceUtils.displayNameForURL(r.fileName);break;case"V8.CompileScript":case"v8.produceCache":case"EvaluateScript":{const{lineNumber:t}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(e),r=a&&a.url;r&&(n=b.ResourceUtils.displayNameForURL(r)+":"+((t||0)+1));break}case"v8.wasm.compiledModule":case"v8.wasm.moduleCacheHit":{const e=r.url;e&&(n=b.ResourceUtils.displayNameForURL(e));break}case"v8.parseOnBackground":case"v8.deserializeOnBackground":case"XHRReadyStateChange":case"XHRLoad":{const e=a.url;e&&(n=b.ResourceUtils.displayNameForURL(e));break}case"TimeStamp":n=a.message;break;case"WebSocketCreate":case"WebSocketSendHandshakeRequest":case"WebSocketReceiveHandshakeResponse":case"WebSocketSend":case"WebSocketReceive":case"WebSocketDestroy":case"ResourceWillSendRequest":case"ResourceSendRequest":case"ResourceReceivedData":case"ResourceReceiveResponse":case"ResourceFinish":case"PaintImage":case"Decode Image":case"Decode LazyPixelRef":{const r=i.Extras.URLForEntry.get(t,e);r&&(n=b.ResourceUtils.displayNameForURL(r));break}case"EmbedderCallback":n=a.callbackName;break;case"Animation":n=a&&a.name;break;case"AsyncTask":n=a?a.name:null;break;default:n=i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.Console)?null:function(){const t=i.Helpers.Trace.getZeroIndexedStackTraceForEvent(e)?.at(0)??null;if(!t)return null;return t.url+":"+(t.lineNumber+1)+":"+(t.columnNumber+1)}()}return n}static async buildDetailsNodeForTraceEvent(e,t,n,r=!1,a){let s,o=null;const l=e.args,c=e.args?.data;switch(e.name){case"GCEvent":case"MajorGC":case"MinorGC":case"EventDispatch":case"Paint":case"Animation":case"EmbedderCallback":case"ParseHTML":case"v8.wasm.streamFromResponseCallback":case"v8.wasm.compiledModule":case"v8.wasm.moduleCacheHit":case"v8.wasm.cachedModule":case"v8.wasm.moduleCacheInvalid":case"WebSocketCreate":case"WebSocketSendHandshakeRequest":case"WebSocketReceiveHandshakeResponse":case"WebSocketSend":case"WebSocketReceive":case"WebSocketDestroy":s=await Ct.buildDetailsTextForTraceEvent(e,a);break;case"PaintImage":case"Decode Image":case"Decode LazyPixelRef":case"XHRReadyStateChange":case"XHRLoad":case"ResourceWillSendRequest":case"ResourceSendRequest":case"ResourceReceivedData":case"ResourceReceiveResponse":case"ResourceFinish":{const t=i.Extras.URLForEntry.get(a,e);if(t){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};o=E.Linkifier.Linkifier.linkifyURL(t,e)}break}case"FunctionCall":{o=document.createElement("span"),i.Types.TraceEvents.isTraceEventFunctionCall(e)&&e.args.data&&i.Types.TraceEvents.objectIsTraceEventCallFrame(e.args.data)&&u.UIUtils.createTextChild(o,Ct.frameDisplayName({...e.args.data,scriptId:String(e.args.data.scriptId)}));const{lineNumber:a,columnNumber:s}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(e),l=this.linkifyLocation({scriptId:c.scriptId,url:c.url,lineNumber:a||0,columnNumber:s,target:t,isFreshRecording:r,linkifier:n});l&&(u.UIUtils.createTextChild(o," @ "),o.appendChild(l));break}case"V8.CompileModule":case"v8.produceModuleCache":o=this.linkifyLocation({scriptId:null,url:l.fileName,lineNumber:0,columnNumber:0,target:t,isFreshRecording:r,linkifier:n});break;case"V8.CompileScript":case"v8.produceCache":case"EvaluateScript":{const a=c.url;if(a){const{lineNumber:s}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(e);o=this.linkifyLocation({scriptId:null,url:a,lineNumber:s||0,columnNumber:0,target:t,isFreshRecording:r,linkifier:n})}break}case"v8.deserializeOnBackground":case"v8.parseOnBackground":{const e=c.url;e&&(o=this.linkifyLocation({scriptId:null,url:e,lineNumber:0,columnNumber:0,target:t,isFreshRecording:r,linkifier:n}));break}case"ProfileCall":{if(o=document.createElement("span"),!i.Types.TraceEvents.isProfileCall(e))break;const a=ze.resolvedNodeNameForEntry(e)||Ct.frameDisplayName(e.callFrame);u.UIUtils.createTextChild(o,a);const s=this.linkifyLocation({scriptId:e.callFrame.scriptId,url:e.callFrame.url,lineNumber:e.callFrame.lineNumber,columnNumber:e.callFrame.columnNumber,target:t,isFreshRecording:r,linkifier:n});s&&(u.UIUtils.createTextChild(o," @ "),o.appendChild(s));break}default:i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.Console)?s=null:o=this.linkifyTopCallFrame(e,t,n,r)??null}return!o&&s&&(o=document.createTextNode(s)),o}static linkifyLocation(e){const{scriptId:t,url:i,lineNumber:n,columnNumber:r,isFreshRecording:a,linkifier:s,target:o}=e,l={lineNumber:n,columnNumber:r,showColumnNumber:!0,inlineFrameIndex:0,className:"timeline-details",tabStop:!0};return a?s.linkifyScriptLocation(o,t,i,n,l):E.Linkifier.Linkifier.linkifyURL(i,l)}static linkifyTopCallFrame(e,t,n,r=!1){let a=i.Helpers.Trace.getZeroIndexedStackTraceForEvent(e)?.[0];if(i.Types.TraceEvents.isProfileCall(e)&&(a=e.callFrame),!a)return null;const s={className:"timeline-details",tabStop:!0,inlineFrameIndex:0,showColumnNumber:!0,columnNumber:a.columnNumber,lineNumber:a.lineNumber};return r?n.maybeLinkifyConsoleCallFrame(t,a,{showColumnNumber:!0,inlineFrameIndex:0}):E.Linkifier.Linkifier.linkifyURL(a.url,s)}static buildDetailsNodeForMarkerEvents(e){let t="https://web.dev/user-centric-performance-metrics/",i="page performance metrics";switch(e.name){case"largestContentfulPaint::Candidate":t="https://web.dev/lcp/",i="largest contentful paint";break;case"firstContentfulPaint":t="https://web.dev/first-contentful-paint/",i="first contentful paint"}return u.Fragment.html`<div>${u.XLink.XLink.create(t,wt(ft.learnMore),void 0,void 0,"learn-more")} about ${i}.</div>`}static buildConsumeCacheDetails(e,t){if("number"==typeof e.consumedCacheSize){t.appendTextRow(wt(ft.compilationCacheStatus),wt(ft.scriptLoadedFromCache)),t.appendTextRow(wt(ft.compilationCacheSize),c.NumberUtilities.bytesToString(e.consumedCacheSize));const i=e.cacheKind;i&&t.appendTextRow(wt(ft.compilationCacheKind),i)}else"cacheRejected"in e&&e.cacheRejected?t.appendTextRow(wt(ft.compilationCacheStatus),wt(ft.failedToLoadScriptFromCache)):t.appendTextRow(wt(ft.compilationCacheStatus),wt(ft.scriptNotEligibleToBeLoadedFromCache))}static async buildTraceEventDetails(t,n,o,l){const d=rt(t,n),{duration:h,selfTime:m}=i.Helpers.Timing.eventTimingsMilliSeconds(n),p=await i.Extras.FetchNodes.extractRelatedDOMNodesFromEvent(t,n);if(d&&void 0===n[kt]){let e=null;const r=i.Extras.URLForEntry.get(t,n);r?e=await E.ImagePreview.ImagePreview.build(d,r,!1,{imageAltText:E.ImagePreview.ImagePreview.defaultAltTextForImageURL(r),precomputedFeatures:void 0}):i.Types.TraceEvents.isTraceEventPaint(n)&&(e=await Ct.buildPicturePreviewContent(t,n,d)),n[kt]=e}let g;i.Types.TraceEvents.isSyntheticLayoutShift(n)&&(l=!1);const v=new Pt(rt(t,n),o),T=this.eventColor(n),f=t&&Ft(t,n)?Ct.markerStyleForEvent(n).color:T;v.addSection(Ct.eventTitle(n),f);const y=n.args,w=n.args?.data,b=t.Initiators.eventToInitiator.get(n)??null,S=t.Initiators.initiatorToEvents.get(n)??null;let C=null;if(t){const e=s.DetailsView.buildWarningElementsForEvent(n,t);for(const t of e)v.appendElementRow(wt(ft.warning),t,!0)}if(i.Helpers.Trace.eventHasCategory(n,i.Types.TraceEvents.Categories.UserTiming)){const i=Mt(n,t);v.appendTextRow(wt(ft.timestamp),e.TimeUtilities.preciseMillisToString(i,1))}if(l&&!Number.isNaN(h||0)&&0!==h&&(v.appendTextRow(wt(ft.totalTime),e.TimeUtilities.millisToString(h||0,!0)),v.appendTextRow(wt(ft.selfTime),e.TimeUtilities.millisToString(m,!0))),i.Types.TraceEvents.isTraceEventPerformanceMark(n)&&n.args.data?.detail){const e=Ct.renderObjectJson(JSON.parse(n.args.data?.detail));v.appendElementRow(wt(ft.details),e)}if(i.Types.TraceEvents.isSyntheticUserTiming(n)&&n.args?.data?.beginEvent.args.detail){const e=Ct.renderObjectJson(JSON.parse(n.args?.data?.beginEvent.args.detail));v.appendElementRow(wt(ft.details),e)}if(t.Meta.traceIsGeneric)return Ct.renderEventJson(n,v),v.fragment;if(i.Types.TraceEvents.isTraceEventV8Compile(n)){if(C=n.args.data?.url,C){const{lineNumber:e,columnNumber:t}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(n);v.appendLocationRow(wt(ft.script),C,e||0,t)}Boolean(n.args.data?.eager)&&v.appendTextRow(wt(ft.eagerCompile),!0);const e=Boolean(n.args.data?.streamed);v.appendTextRow(wt(ft.streamed),e+(e?"":`: ${n.args.data?.notStreamedReason||""}`)),n.args.data&&Ct.buildConsumeCacheDetails(n.args.data,v)}if(i.Types.Extensions.isSyntheticExtensionEntry(n))for(const[e,t]of n.args.properties||[])v.appendTextRow(e,t);const k=Boolean(t&&Ce.instance().recordingIsFresh(t));switch(n.name){case"GCEvent":case"MajorGC":case"MinorGC":{const e=y.usedHeapSizeBefore-y.usedHeapSizeAfter;v.appendTextRow(wt(ft.collected),c.NumberUtilities.bytesToString(e));break}case"ProfileCall":case"FunctionCall":{const e=await Ct.buildDetailsNodeForTraceEvent(n,rt(t,n),o,k,t);e&&v.appendElementRow(wt(ft.function),e);break}case"TimerFire":case"TimerInstall":case"TimerRemove":v.appendTextRow(wt(ft.timerId),w.timerId),"TimerInstall"===n.name&&(v.appendTextRow(wt(ft.timeout),e.TimeUtilities.millisToString(w.timeout)),v.appendTextRow(wt(ft.repeats),!w.singleShot));break;case"FireAnimationFrame":v.appendTextRow(wt(ft.callbackId),w.id);break;case"V8.CompileModule":v.appendLocationRow(wt(ft.module),y.fileName,0);break;case"V8.CompileScript":break;case"v8.produceModuleCache":C=w&&w.url,v.appendTextRow(wt(ft.compilationCacheSize),c.NumberUtilities.bytesToString(w.producedCacheSize));break;case"v8.produceCache":if(C=w&&w.url,C){const{lineNumber:e,columnNumber:t}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(n);v.appendLocationRow(wt(ft.script),C,e||0,t)}v.appendTextRow(wt(ft.compilationCacheSize),c.NumberUtilities.bytesToString(w.producedCacheSize));break;case"EvaluateScript":if(C=w&&w.url,C){const{lineNumber:e,columnNumber:t}=i.Helpers.Trace.getZeroIndexedLineAndColumnForEvent(n);v.appendLocationRow(wt(ft.script),C,e||0,t)}break;case"v8.wasm.streamFromResponseCallback":case"v8.wasm.compiledModule":case"v8.wasm.cachedModule":case"v8.wasm.moduleCacheHit":case"v8.wasm.moduleCacheInvalid":if(w){C=y.url,C&&v.appendTextRow(wt(ft.url),C);const e=y.producedCachedSize;e&&v.appendTextRow(wt(ft.producedCacheSize),e);const t=y.consumedCachedSize;t&&v.appendTextRow(wt(ft.consumedCacheSize),t)}break;case"Paint":{const e=w.clip;v.appendTextRow(wt(ft.location),wt(ft.sSCurlyBrackets,{PH1:e[0],PH2:e[1]}));const t=Ct.quadWidth(e),i=Ct.quadHeight(e);v.appendTextRow(wt(ft.dimensions),wt(ft.sSDimensions,{PH1:t,PH2:i}))}case"PaintSetup":case"Rasterize":case"ScrollLayer":g=wt(ft.layerRoot);break;case"PaintImage":case"Decode LazyPixelRef":case"Decode Image":case"Draw LazyPixelRef":if(g=wt(ft.ownerElement),C=i.Extras.URLForEntry.get(t,n),C){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};v.appendElementRow(wt(ft.imageUrl),E.Linkifier.Linkifier.linkifyURL(C,e))}break;case"ParseAuthorStyleSheet":if(C=w.styleSheetUrl,C){const e={tabStop:!0,showColumnNumber:!1,inlineFrameIndex:0};v.appendElementRow(wt(ft.stylesheetUrl),E.Linkifier.Linkifier.linkifyURL(C,e))}break;case"UpdateLayoutTree":{v.appendTextRow(wt(ft.elementsAffected),y.elementCount);const e=r.Settings.Settings.instance().createSetting("timeline-capture-selector-stats",!1);if(!e.get()){const t=document.createElement("span");t.textContent=wt(ft.sSelectorStatsInfo,{PH1:e.title()}),v.appendElementRow(wt(ft.selectorStatsTitle),t)}break}case"Layout":{const e=y.beginData;v.appendTextRow(wt(ft.nodesThatNeedLayout),wt(ft.sOfS,{PH1:e.dirtyObjects,PH2:e.totalObjects})),g=wt(ft.layoutRoot);break}case"ConsoleTime":v.appendTextRow(wt(ft.message),n.name);break;case"WebSocketCreate":case"WebSocketSendHandshakeRequest":case"WebSocketReceiveHandshakeResponse":case"WebSocketSend":case"WebSocketReceive":case"WebSocketDestroy":if(i.Types.TraceEvents.isWebSocketTraceEvent(n)){const e=s.DetailsView.buildRowsForWebSocketEvent(n,t);for(const{key:t,value:i}of e)v.appendTextRow(t,i)}break;case"EmbedderCallback":v.appendTextRow(wt(ft.callbackFunction),w.callbackName);break;case"Animation":"n"===n.ph&&v.appendTextRow(wt(ft.state),w.state);break;case"ParseHTML":{const e=y.beginData,t=e.startLine-1,i=y.endData?y.endData.endLine-1:void 0;C=e.url,C&&v.appendLocationRange(wt(ft.range),C,t,i);break}case"FireIdleCallback":v.appendTextRow(wt(ft.allottedTime),e.TimeUtilities.millisToString(w.allottedMilliseconds)),v.appendTextRow(wt(ft.invokedByTimeout),w.timedOut);case"RequestIdleCallback":case"CancelIdleCallback":v.appendTextRow(wt(ft.callbackId),w.id);break;case"EventDispatch":v.appendTextRow(wt(ft.type),w.type);break;case"largestContentfulPaint::Candidate":v.appendTextRow(wt(ft.type),String(w.type)),v.appendTextRow(wt(ft.size),String(w.size));case"firstPaint":case"firstContentfulPaint":case"MarkLoad":case"MarkDOMContent":{const r=Mt(n,t);v.appendTextRow(wt(ft.timestamp),e.TimeUtilities.preciseMillisToString(r,1)),i.Types.TraceEvents.isTraceEventMarkerEvent(n)&&v.appendElementRow(wt(ft.details),Ct.buildDetailsNodeForMarkerEvents(n));break}case"EventTiming":{const r=await Ct.buildDetailsNodeForTraceEvent(n,rt(t,n),o,k,t);if(r&&v.appendElementRow(wt(ft.details),r),i.Types.TraceEvents.isSyntheticInteractionEvent(n)){const t=e.TimeUtilities.formatMicroSecondsTime(n.inputDelay),i=e.TimeUtilities.formatMicroSecondsTime(n.mainThreadHandling),r=e.TimeUtilities.formatMicroSecondsTime(n.presentationDelay);v.appendTextRow(wt(ft.interactionID),n.interactionId),v.appendTextRow(wt(ft.inputDelay),t),v.appendTextRow(wt(ft.processingDuration),i),v.appendTextRow(wt(ft.presentationDelay),r)}break}case"LayoutShift":{if(!i.Types.TraceEvents.isSyntheticLayoutShift(n)){console.error("Unexpected type for LayoutShift event");break}const t=n,a=t.args.data,s=document.createElement("span"),o=u.XLink.XLink.create("https://web.dev/cls/",wt(ft.cumulativeLayoutShifts),void 0,void 0,"cumulative-layout-shifts"),l=u.XLink.XLink.create("https://web.dev/evolving-cls/",wt(ft.evolvedClsLink),void 0,void 0,"evolved-cls");if(s.appendChild(e.i18n.getFormatLocalizedString(yt,ft.sCLSInformation,{PH1:o,PH2:l})),v.appendElementRow(wt(ft.warning),s,!0),!a)break;v.appendTextRow(wt(ft.score),a.score.toPrecision(4)),v.appendTextRow(wt(ft.cumulativeScore),a.cumulative_score.toPrecision(4)),v.appendTextRow(wt(ft.currentClusterId),t.parsedData.sessionWindowData.id),v.appendTextRow(wt(ft.currentClusterScore),t.parsedData.sessionWindowData.cumulativeWindowScore.toPrecision(4)),v.appendTextRow(wt(ft.hadRecentInput),w.had_recent_input?wt(ft.yes):wt(ft.no));for(const e of w.impacted_nodes){const t=new X(e.old_rect),i=new X(e.new_rect),n=await r.Linkifier.Linkifier.linkify(t),a=await r.Linkifier.Linkifier.linkify(i);v.appendElementRow(wt(ft.movedFrom),n),v.appendElementRow(wt(ft.movedTo),a)}break}default:{const e=await Ct.buildDetailsNodeForTraceEvent(n,rt(t,n),o,k,t);e&&v.appendElementRow(wt(ft.details),e);break}}const x=p?.values()||[];for(const e of x)if(e){const t=await r.Linkifier.Linkifier.linkify(e);v.appendElementRow(g||wt(ft.relatedNode),t)}n[kt]&&(v.addSection(wt(ft.preview)),v.appendElementRow("",n[kt]));const P=i.Helpers.Trace.getZeroIndexedStackTraceForEvent(n);(b||S||P||t?.Invalidations.invalidationsForEvent.get(n))&&await Ct.generateCauses(n,v,t),a.Runtime.experiments.isEnabled("timeline-debug-mode")&&Ct.renderEventJson(n,v);const I={};if(l&&t&&Ct.aggregatedStatsForTraceEvent(I,t,n)){v.addSection(wt(ft.aggregatedTime));const e=Ct.generatePieChart(I,Ct.eventStyle(n).category,m);v.appendElementRow("",e)}return v.fragment}static statsForTimeRange(e,t,n){if(!e.length)return{idle:n-t};!function(e){if(e[It])return;const t={},n=[];let r=0;function a(e,i){let n=t[e];if(n||(n={time:[],value:[]},t[e]=n),n.time.length&&n.time[n.time.length-1]===i||r>i)return;const a=n.value.length>0?n.value[n.value.length-1]:0;n.value.push(a+i-r),n.time.push(i)}function s(e,t,i){e&&a(e,i),r=i,t&&a(t,i)}i.Helpers.Trace.forEachEvent(e,{onStartEvent:function(e){const{startTime:t}=i.Helpers.Timing.eventTimingsMilliSeconds(e),r=de(e.name)?.category.name||me().other.name,a=n.length?n[n.length-1]:null;r!==a&&s(a||null,r,t),n.push(r)},onEndEvent:function(e){const{endTime:t}=i.Helpers.Timing.eventTimingsMilliSeconds(e),r=n.pop(),a=n.length?n[n.length-1]:null;r!==a&&s(r||null,a||null,t||0)}});const o=e;o[It]=t}(e);const r=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(s(n),s(t)),a=Object.values(r).reduce(((e,t)=>e+t),0);return r.idle=Math.max(0,n-t-a),r;function s(t){const i={},n=e[It];for(const e in n){const r=n[e],a=c.ArrayUtilities.upperBound(r.time,t,c.ArrayUtilities.DEFAULT_COMPARATOR);let s;if(0===a)s=0;else if(a===r.time.length)s=r.value[r.value.length-1];else{const e=r.time[a-1],i=r.time[a],n=r.value[a-1];s=n+(r.value[a]-n)*(t-e)/(i-e)}i[e]=s}return i}}static renderEventJson(e,t){t.addSection(wt(ft.traceEvent));const i={args:e.args,...e},n=Ct.renderObjectJson(i);t.appendElementRow("",n)}static renderObjectJson(e){const t=r.Settings.Settings.instance().moduleSetting("text-editor-indent").get().length,i=JSON.stringify(e,null,t).slice(0,1e4).replace(/{\n  /,"{ "),n=document.createElement("div"),a=n.attachShadow({mode:"open"});a.adoptedStyleSheets=[lt,st];const s=a.createChild("div");return s.classList.add("monospace","source-code"),s.textContent=i,x.CodeHighlighter.highlightNode(s,"text/javascript"),n}static stackTraceFromCallFrames(e){return{callFrames:e}}static async generateCauses(t,n,r){const{startTime:a}=i.Helpers.Timing.eventTimingsMilliSeconds(t);let s=wt(ft.initiatorStackTrace),o=wt(ft.stackTrace);switch(t.name){case"TimerFire":s=wt(ft.timerInstalled);break;case"FireAnimationFrame":s=wt(ft.animationFrameRequested);break;case"FireIdleCallback":s=wt(ft.idleCallbackRequested);break;case"UpdateLayoutTree":s=wt(ft.firstInvalidated),o=wt(ft.recalculationForced);break;case"Layout":s=wt(ft.firstLayoutInvalidation),o=wt(ft.layoutForced)}const l=i.Helpers.Trace.getZeroIndexedStackTraceForEvent(t);l&&l.length&&(n.addSection(o),n.createChildStackTraceElement(Ct.stackTraceFromCallFrames(l)));const c=r.Initiators.eventToInitiator.get(t),d=r.Initiators.initiatorToEvents.get(t),h=r.Invalidations.invalidationsForEvent.get(t);if(c){const t=i.Helpers.Trace.getZeroIndexedStackTraceForEvent(c);t&&(n.addSection(s),n.createChildStackTraceElement(Ct.stackTraceFromCallFrames(t.map((e=>({...e,scriptId:String(e.scriptId)}))))));const r=this.createEntryLink(c);n.appendElementRow(wt(ft.initiatedBy),r);const{startTime:o}=i.Helpers.Timing.eventTimingsMilliSeconds(c),l=a-o;n.appendTextRow(wt(ft.pendingFor),e.TimeUtilities.preciseMillisToString(l,1))}if(d){const e=document.createElement("div");d.map(((t,i)=>{e.appendChild(this.createEntryLink(t)),i<d.length-1&&e.append(" ")})),n.appendElementRow(ft.initiatorFor,e)}h&&h.length&&(n.addSection(wt(ft.invalidations)),await Ct.generateInvalidationsList(h,n))}static createEntryLink(e){const t=document.createElement("span"),i=h.TraceBounds.BoundsManager.instance().state();if(!i)return console.error("Tried to link to an entry without any traceBoundsState. This should never happen."),t;const n=i.micro.minimapTraceBounds.min>e.ts+(e.dur||0)||i.micro.minimapTraceBounds.max<e.ts,r=Ne.activeManager()?.getEntriesFilter().inEntryInvisible(e);return n||(t.classList.add("devtools-link"),u.ARIAUtils.markAsLink(t),t.tabIndex=0,t.addEventListener("click",(()=>{nr.instance().select(vt.fromTraceEvent(e))})),t.addEventListener("keydown",(t=>{"Enter"===t.key&&(nr.instance().select(vt.fromTraceEvent(e)),t.consume(!0))}))),t.textContent=r?this.eventTitle(e)+" "+wt(ft.entryIsHidden):n?this.eventTitle(e)+" "+wt(ft.outsideBreadcrumbRange):this.eventTitle(e),t}static async generateInvalidationsList(e,t){const{groupedByReason:i,backendNodeIds:r}=s.DetailsView.generateInvalidationsList(e);let a=null;const o=n.TargetManager.TargetManager.instance().primaryPageTarget(),l=o?.model(n.DOMModel.DOMModel);l&&(a=await l.pushNodesByBackendIdsToFrontend(r)),Object.keys(i).forEach((e=>{Ct.generateInvalidationsForReason(e,i[e],a,t)}))}static generateInvalidationsForReason(t,a,s,o){function l(e){const t=e.args.data.nodeId&&s?s.get(e.args.data.nodeId):null;if(t){const e=document.createElement("span");return r.Linkifier.Linkifier.linkify(t).then((t=>e.appendChild(t))),e}if(e.args.data.nodeName){const t=document.createElement("span");return t.textContent=e.args.data.nodeName,t}const i=document.createElement("span");return u.UIUtils.createTextChild(i,wt(ft.UnknownNode)),i}const c=new Set;for(const r of a){const a=i.Helpers.Trace.getZeroIndexedStackTraceForEvent(r);let s=null;const d=a?.at(0);d&&(s=o.linkifier()?.maybeLinkifyScriptLocation(n.TargetManager.TargetManager.instance().rootTarget(),d.scriptId,d.url,d.lineNumber)||null);const h=l(r),m=s?e.i18n.getFormatLocalizedString(yt,ft.invalidationWithCallFrame,{PH1:h,PH2:s}):h,p="string"==typeof m?m:m.innerText;c.has(p)||(c.add(p),o.appendElementRow(t,m))}}static aggregatedStatsForTraceEvent(e,t,n){const r=t.Renderer?.allTraceEntries||[],{startTime:a,endTime:s}=i.Helpers.Timing.eventTimingsMilliSeconds(n);const o=c.ArrayUtilities.binaryIndexOf(r,a,(function(e,t){const{startTime:n}=i.Helpers.Timing.eventTimingsMilliSeconds(t);return e-n}));if(o<0)return!1;let l=!1;if(s)for(let t=o;t<r.length;t++){const a=r[t],{startTime:c,selfTime:d}=i.Helpers.Timing.eventTimingsMilliSeconds(a);if(c>=s)break;if(!a.selfTime)continue;if(a.tid!==n.tid)continue;t>o&&(l=!0);const h=Ct.eventStyle(a).category.name;e[h]=(e[h]||0)+d}if(i.Types.TraceEvents.isAsyncPhase(n.ph)){if(s){let t=0;for(const i in e)t+=e[i];e.idle=Math.max(0,s-a-t)}return!1}return l}static async buildPicturePreviewContent(e,t,i){const r=e.LayerTree.paintsToSnapshots.get(t);if(!r)return null;const a=i.model(n.PaintProfiler.PaintProfilerModel);if(!a)return null;const s=await a.loadSnapshot(r.args.snapshot.skp64);if(!s)return null;const o={snapshot:s,rect:r.args.snapshot.params?.layer_rect};if(!o)return null;const l=o.snapshot.replay();o.snapshot.release();const c=await l;if(!c)return null;const d=document.createElement("div"),h=d.attachShadow({mode:"open"});h.adoptedStyleSheets=[ot];const m=h.createChild("div");m.classList.add("image-preview-container","vbox","link");const p=m.createChild("img");p.src=c,p.alt=E.ImagePreview.ImagePreview.defaultAltTextForImageURL(c);return m.createChild("a").textContent=wt(ft.paintProfiler),u.ARIAUtils.markAsLink(m),m.tabIndex=0,m.addEventListener("click",(()=>nr.instance().select(vt.fromTraceEvent(t))),!1),m.addEventListener("keydown",(e=>{"Enter"===e.key&&(nr.instance().select(vt.fromTraceEvent(t)),e.consume(!0))})),d}static createEventDivider(t,n){const r=document.createElement("div");r.classList.add("resources-event-divider");const{startTime:a}=i.Helpers.Timing.eventTimingsMilliSeconds(t),s=e.TimeUtilities.millisToString(a-n);u.Tooltip.Tooltip.install(r,wt(ft.sAtS,{PH1:Ct.eventTitle(t),PH2:s}));const o=Ct.markerStyleForEvent(t);return o.tall&&(r.style.backgroundColor=o.color),r}static visibleEventsFilter(){return new C.TimelineModelFilter.TimelineVisibleEventsFilter(ve())}static categories(){return me()}static generatePieChart(t,i,n){let r=0;for(const e in t)r+=t[e];const a=document.createElement("div");a.classList.add("timeline-details-view-pie-chart-wrapper"),a.classList.add("hbox");const s=new p.PieChart.PieChart,o=[];function l(e,t,i,n){i&&o.push({value:i,color:n,title:t})}if(i){n&&l(i.name,wt(ft.sSelf,{PH1:i.title}),n,i.getCSSValue());const e=t[i.name]-(n||0);e>0&&l(i.name,wt(ft.sChildren,{PH1:i.title}),e,i.getCSSValue())}for(const e in me()){const n=me()[e];e!==i?.name&&l(n.name,n.title,t[n.name],n.getCSSValue())}s.data={chartName:wt(ft.timeSpentInRendering),size:110,formatter:t=>e.TimeUtilities.preciseMillisToString(t),showLegend:!0,total:r,slices:o};return a.createChild("div","vbox").appendChild(s),a}static generateDetailsContentForFrame(e,t,i){const n=new Pt(null,null);n.addSection(wt(ft.frame));const r=Ct.frameDuration(e);if(n.appendElementRow(wt(ft.duration),r),t&&i){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview"),u.UIUtils.loadImage(i.screenshotEvent.args.dataUri).then((t=>t&&e.appendChild(t))),n.appendElementRow("",e),e.addEventListener("click",function(e,t){p.FilmStripView.Dialog.fromFilmStrip(e,t.index)}.bind(null,t,i),!1)}return n.fragment}static frameDuration(t){const n=i.Helpers.Timing.microSecondsToMilliseconds(t.startTimeOffset),r=i.Helpers.Timing.microSecondsToMilliseconds(i.Types.Timing.MicroSeconds(t.endTime-t.startTime)),a=wt(ft.sAtSParentheses,{PH1:e.TimeUtilities.millisToString(r,!0),PH2:e.TimeUtilities.millisToString(n,!0)});return e.i18n.getFormatLocalizedString(yt,ft.emptyPlaceholder,{PH1:a})}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(bt)return bt;const e="hsl(40,100%,80%)",t="hsl(40,100%,50%)";return bt=[new xt(1,e,["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new xt(1,e,["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new xt(2,"hsl(90,100%,40%)",["wheel"]),new xt(3,t,["click","mousedown","mouseup"]),new xt(3,t,["touchstart","touchend","touchmove","touchcancel"]),new xt(3,t,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new xt(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],bt}static markerStyleForEvent(e){const t=[6,4],n=Ct.eventTitle(e);if("navigationStart"!==e.name&&i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.Console)||i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.UserTiming))return{title:n,dashStyle:t,lineWidth:.5,color:i.Helpers.Trace.eventHasCategory(e,i.Types.TraceEvents.Categories.Console)?"purple":"orange",tall:!1,lowPriority:!1};let r=!1,a="grey";switch(e.name){case"navigationStart":a="#FF9800",r=!0;break;case"FrameStartedLoading":a="green",r=!0;break;case"MarkDOMContent":a="#0867CB",r=!0;break;case"MarkLoad":a="#B31412",r=!0;break;case"firstPaint":a="#228847",r=!0;break;case"firstContentfulPaint":a="#1A6937",r=!0;break;case"largestContentfulPaint::Candidate":a="#1A3422",r=!0;break;case"TimeStamp":a="orange"}return{title:n,dashStyle:t,lineWidth:.5,color:a,tall:r,lowPriority:!1}}static colorForId(e){return St||(St=new r.Color.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:3},85),St.setColorForID("","#f2ecdc")),St.colorForID(e)}static displayNameForFrame(e,t=80){const i=e.url;return r.ParsedURL.schemeIs(i,"about:")?`"${c.StringUtilities.trimMiddle(e.name,t)}"`:e.url.slice(0,t)}}const Et=Symbol("aggregatedStats"),kt=Symbol("previewElement");class xt{priority;color;eventTypes;constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}class Pt{fragment;linkifierInternal;target;element;tableElement;constructor(e,t){this.fragment=document.createDocumentFragment(),this.linkifierInternal=t,this.target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this.tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),u.UIUtils.createTextChild(i,e)}this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this.linkifierInternal}appendTextRow(e,t){const i=this.tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t.toString()}appendElementRow(e,t,i,n){const r=this.tableElement.createChild("div","timeline-details-view-row");r.setAttribute("data-row-title",e),i&&r.classList.add("timeline-details-warning"),n&&r.classList.add("timeline-details-stack-values");r.createChild("div","timeline-details-view-row-title").textContent=e;const a=r.createChild("div","timeline-details-view-row-value");t instanceof Node?a.appendChild(t):u.UIUtils.createTextChild(a,t||"")}appendLocationRow(e,t,i,n){if(!this.linkifierInternal)return;const r={tabStop:!0,columnNumber:n,showColumnNumber:!0,inlineFrameIndex:0},a=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,r);a&&this.appendElementRow(e,a)}appendLocationRange(e,t,i,n){if(!this.linkifierInternal||!this.target)return;const r=document.createElement("span"),a=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,{tabStop:!0,inlineFrameIndex:0});a&&(r.appendChild(a),u.UIUtils.createTextChild(r,c.StringUtilities.sprintf(" [%s…%s]",i+1,(n||0)+1||"")),this.appendElementRow(e,r))}createChildStackTraceElement(e){if(!this.linkifierInternal)return;const t=this.tableElement.createChild("div","timeline-details-view-row timeline-details-stack-values"),i=E.JSPresentationUtils.buildStackTracePreviewContents(this.target,this.linkifierInternal,{stackTrace:e,tabStops:!0,showColumnNumber:!0});t.appendChild(i.element)}}const It=Symbol("categoryBreakdownCache");function Mt(e,t){if(!t){const{startTime:t}=i.Helpers.Timing.eventTimingsMilliSeconds(e);return t}const n=i.Helpers.Timing.timeStampForEventAdjustedByClosestNavigation(e,t.Meta.traceBounds,t.Meta.navigationsByNavigationId,t.Meta.navigationsByFrameId);return i.Helpers.Timing.microSecondsToMilliseconds(n)}function Ft(e,t){const{KnownEventName:n}=i.Types.TraceEvents;if("TimeStamp"===t.name)return!0;if(i.Types.TraceEvents.isTraceEventFirstContentfulPaint(t)||i.Types.TraceEvents.isTraceEventFirstPaint(t))return t.args.frame===e.Meta.mainFrameId;if(i.Types.TraceEvents.isTraceEventMarkDOMContent(t)||i.Types.TraceEvents.isTraceEventMarkLoad(t)||i.Types.TraceEvents.isTraceEventLargestContentfulPaintCandidate(t)){if(!t.args.data)return!1;const{isOutermostMainFrame:e,isMainFrame:i}=t.args.data;return void 0!==e?e:Boolean(i)}return!1}var Lt=Object.freeze({__proto__:null,TimelineUIUtils:Ct,aggregatedStatsKey:Et,previewElementSymbol:kt,EventDispatchTypeDescriptor:xt,TimelineDetailsContentHelper:Pt,categoryBreakdownCacheSymbol:It,timeStampForEventAdjustedForClosestNavigationIfPossible:Mt,isMarkerEvent:Ft});class Rt extends C.TimelineModelFilter.TimelineModelFilter{#R=i.Types.Timing.MilliSeconds(0);constructor(){super()}setMinimumRecordDuration(e){this.#R=e}accept(e){const{duration:t}=i.Helpers.Timing.eventTimingsMilliSeconds(e);return t>=this.#R}}class Dt extends C.TimelineModelFilter.TimelineModelFilter{constructor(){super()}accept(e){return!Ct.eventStyle(e).category.hidden}}class At extends C.TimelineModelFilter.TimelineModelFilter{regExpInternal;constructor(e){super(),this.setRegExp(e||null)}setRegExp(e){this.regExpInternal=e}regExp(){return this.regExpInternal}accept(e,t){return!this.regExpInternal||Ct.testContentMatching(e,this.regExpInternal,t)}}var Nt=Object.freeze({__proto__:null,IsLong:Rt,Category:Dt,TimelineRegExp:At});const Bt={performance:"Performance",selfTime:"Self Time",totalTime:"Total Time",activity:"Activity",selectItemForDetails:"Select item for details.",fms:"{PH1} ms",percentPlaceholder:"{PH1} %",chromeExtensionsOverhead:"[`Chrome` extensions overhead]",vRuntime:"[`V8` Runtime]",unattributed:"[unattributed]",page:"Page",noGrouping:"No Grouping",groupByActivity:"Group by Activity",groupByCategory:"Group by Category",groupByDomain:"Group by Domain",groupByFrame:"Group by Frame",groupBySubdomain:"Group by Subdomain",groupByUrl:"Group by URL",groupBy:"Group by",heaviestStack:"Heaviest stack",showHeaviestStack:"Show Heaviest stack",hideHeaviestStack:"Hide Heaviest stack",heaviestStackShown:"Heaviest stack sidebar shown",heaviestStackHidden:"Heaviest stack sidebar hidden",timelineStack:"Timeline Stack",matchCase:"Match Case",useRegularExpression:"Use Regular Expression",matchWholeWord:"Match whole word"},Ht=e.i18n.registerUIStrings("panels/timeline/TimelineTreeView.ts",Bt),Ut=e.i18n.getLocalizedString.bind(void 0,Ht);class Wt extends u.Widget.VBox{#D;searchResults;linkifier;dataGrid;lastHoveredProfileNode;textFilterInternal;taskFilter;startTime;endTime;splitWidget;detailsView;searchableView;currentThreadSetting;lastSelectedNodeInternal;root;currentResult;textFilterUI;caseSensitiveButton;regexButton;matchWholeWord;#A=null;constructor(){super(),this.#D=null,this.element.classList.add("timeline-tree-view"),this.searchResults=[]}#N(e){const t=Ct.eventTitle(e)||e.name;return this.#A?t+":@"+i.Extras.URLForEntry.get(this.#A,e):t}setSearchableView(e){this.searchableView=e}setModelWithEvents(e,t=null){this.#A=t,this.#D=e}traceParseData(){return this.#A}init(){this.linkifier=new E.Linkifier.Linkifier,this.taskFilter=new C.TimelineModelFilter.ExclusiveNameFilter(["RunTask"]),this.textFilterInternal=new At,this.currentThreadSetting=r.Settings.Settings.instance().createSetting("timeline-tree-current-thread",0),this.currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this.splitWidget=new u.SplitWidget.SplitWidget(!0,!0,"timeline-tree-view-details-split-widget");const t=new u.Widget.VBox,i=new u.Toolbar.Toolbar("",t.element);i.makeWrappable(!0),this.populateToolbar(i),this.dataGrid=new k.SortableDataGrid.SortableDataGrid({displayName:Ut(Bt.performance),columns:e,refreshCallback:void 0,editCallback:void 0,deleteCallback:void 0}),this.dataGrid.addEventListener("SortingChanged",this.sortingChanged,this),this.dataGrid.element.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.dataGrid.setResizeMethod("last"),this.dataGrid.setRowContextMenuCallback(this.onContextMenu.bind(this)),this.dataGrid.asWidget().show(t.element),this.dataGrid.addEventListener("SelectedNode",this.updateDetailsForSelection,this),this.detailsView=new u.Widget.VBox,this.detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this.splitWidget.setMainWidget(t),this.splitWidget.setSidebarWidget(this.detailsView),this.splitWidget.hideSidebar(),this.splitWidget.show(this.element),this.splitWidget.addEventListener("ShowModeChanged",this.onShowModeChanged,this),this.lastSelectedNodeInternal}lastSelectedNode(){return this.lastSelectedNodeInternal}updateContents(e){this.setRange(e.startTime,e.endTime)}setRange(e,t){this.startTime=e,this.endTime=t,this.refreshTree()}filters(){return[this.taskFilter,this.textFilterInternal,...be.instance().activeFilters()]}filtersWithoutTextFilter(){return[this.taskFilter,...be.instance().activeFilters()]}textFilter(){return this.textFilterInternal}exposePercentages(){return!1}populateToolbar(e){this.caseSensitiveButton=new u.Toolbar.ToolbarToggle(Ut(Bt.matchCase)),this.caseSensitiveButton.setText("Aa"),this.caseSensitiveButton.addEventListener("Click",(()=>{this.#B(this.caseSensitiveButton)}),this),e.appendToolbarItem(this.caseSensitiveButton),this.regexButton=new u.Toolbar.ToolbarToggle(Ut(Bt.useRegularExpression)),this.regexButton.setText(".*"),this.regexButton.addEventListener("Click",(()=>{this.#B(this.regexButton)}),this),e.appendToolbarItem(this.regexButton),this.matchWholeWord=new u.Toolbar.ToolbarToggle(Ut(Bt.matchWholeWord),"match-whole-word"),this.matchWholeWord.addEventListener("Click",(()=>{this.#B(this.matchWholeWord)}),this),e.appendToolbarItem(this.matchWholeWord);const t=new u.Toolbar.ToolbarFilter;this.textFilterUI=t,t.addEventListener("TextChanged",this.#H,this),e.appendToolbarItem(t)}selectedEvents(){return this.#D||[]}onHover(e){}appendContextMenuItems(e,t){}selectProfileNode(e,t){const i=[];let n=e;for(;n;n=n.parent)i.push(n);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t&&t.dataGrid&&t.expand()}const r=this.dataGridNodeForTreeNode(e);r&&r.dataGrid&&(r.reveal(),r.select(t))}refreshTree(){if(!this.element.parentElement)return;if(this.linkifier.reset(),this.dataGrid.rootNode().removeChildren(),!this.#A)return void this.updateDetailsForSelection();this.root=this.buildTree();const e=this.root.children();let t=0,i=0;const n=this.root.totalTime-this.root.selfTime;for(const n of e.values())t=Math.max(t,n.selfTime),i=Math.max(i,n.totalTime);for(const r of e.values()){const e=new Vt(r,n,t,i,this);this.dataGrid.insertChild(e)}this.sortingChanged(),this.updateDetailsForSelection(),this.searchableView&&this.searchableView.refreshSearch();const r=this.dataGrid.rootNode();r.children.length>0&&r.children[0].select(!0)}buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,t){return new C.TimelineProfileTree.TopDownRootNode(this.selectedEvents(),this.filters(),this.startTime,this.endTime,e,t)}populateColumns(e){e.push({id:"self",title:Ut(Bt.selfTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:Ut(Bt.totalTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:Ut(Bt.activity),disclosure:!0,sortable:!0})}sortingChanged(){const e=this.dataGrid.sortColumnId();if(!e)return;let t;const i=(e,t)=>{const i=t,n=e.profileNode.event,r=i.profileNode.event;if(!n||!r)return 0;if(!this.#A)return 0;const a=this.#N(n),s=this.#N(r);return a.localeCompare(s)};switch(e){case"start-time":t=function(e,t){const i=t,n=e.profileNode.event,r=i.profileNode.event;if(!n||!r)return 0;return n.ts-r.ts};break;case"self":t=function(e,t){const i=t;return e.profileNode.selfTime-i.profileNode.selfTime};break;case"total":t=function(e,t){const i=t;return e.profileNode.totalTime-i.profileNode.totalTime};break;case"activity":t=i;break;default:return void console.assert(!1,"Unknown sort field: "+e)}this.dataGrid.sortNodes(t,!this.dataGrid.isSortOrderAscending())}#H(){const e=this.textFilterUI&&this.textFilterUI.value(),t=void 0!==this.caseSensitiveButton&&this.caseSensitiveButton.toggled(),i=void 0!==this.regexButton&&this.regexButton.toggled(),n=void 0!==this.matchWholeWord&&this.matchWholeWord.toggled();this.textFilterInternal.setRegExp(e?c.StringUtilities.createSearchRegex(e,t,i,n):null),this.refreshTree()}#B(e){e&&e.setToggled(!e.toggled()),this.#H()}onShowModeChanged(){"OnlyMain"!==this.splitWidget.showMode()&&(this.lastSelectedNodeInternal=void 0,this.updateDetailsForSelection())}updateDetailsForSelection(){const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;if(e===this.lastSelectedNodeInternal)return;if(this.lastSelectedNodeInternal=e,"OnlyMain"===this.splitWidget.showMode())return;if(this.detailsView.detachChildWidgets(),this.detailsView.element.removeChildren(),e&&this.showDetailsForNode(e))return;const t=this.detailsView.element.createChild("div","full-widget-dimmed-banner");u.UIUtils.createTextChild(t,Ut(Bt.selectItemForDetails))}showDetailsForNode(e){return!1}onMouseMove(e){const t=e.target&&e.target instanceof Node?this.dataGrid.dataGridNodeFromNode(e.target):null,i=t&&t._profileNode;i!==this.lastHoveredProfileNode&&(this.lastHoveredProfileNode=i,this.onHover(i))}onContextMenu(e,t){const i=t;i.linkElement&&e.appendApplicableItems(i.linkElement);const n=i.profileNode;n&&this.appendContextMenuItems(e,n)}dataGridNodeForTreeNode(e){return _t.get(e)||null}onSearchCanceled(){this.searchResults=[],this.currentResult=0}performSearch(e,t,i){if(this.searchResults=[],this.currentResult=0,!this.root)return;const n=e.toSearchRegex();this.searchResults=this.root.searchTree((e=>Ct.testContentMatching(e,n.regex,this.#A||void 0))),this.searchableView.updateSearchMatchesCount(this.searchResults.length)}jumpToNextSearchResult(){this.searchResults.length&&void 0!==this.currentResult&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=c.NumberUtilities.mod(this.currentResult+1,this.searchResults.length))}jumpToPreviousSearchResult(){this.searchResults.length&&void 0!==this.currentResult&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=c.NumberUtilities.mod(this.currentResult-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}class Ot extends k.SortableDataGrid.SortableDataGridNode{populated;profileNode;treeView;grandTotalTime;maxSelfTime;maxTotalTime;linkElement;constructor(e,t,i,n,r){super(null,!1),this.populated=!1,this.profileNode=e,this.treeView=r,this.grandTotalTime=t,this.maxSelfTime=i,this.maxTotalTime=n,this.linkElement=null}createCell(e){return"activity"===e?this.createNameCell(e):this.createValueCell(e)||super.createCell(e)}createNameCell(e){const t=this.createTD(e),n=t.createChild("div","name-container"),r=n.createChild("div","activity-icon-container"),a=r.createChild("div","activity-icon"),s=n.createChild("div","activity-name"),o=this.profileNode.event;if(this.profileNode.isGroupNode()){const e=this.treeView.displayInfoForGroupNode(this.profileNode);s.textContent=e.name,a.style.backgroundColor=e.color,e.icon&&r.insertBefore(e.icon,a)}else if(o){s.textContent=Ct.eventTitle(o);const e=this.treeView.traceParseData(),t=e?rt(e,o):null,r=this.treeView.linkifier,l=Boolean(e&&Ce.instance().recordingIsFresh(e));this.linkElement=Ct.linkifyTopCallFrame(o,t,r,l),this.linkElement&&n.createChild("div","activity-link").appendChild(this.linkElement);const c=Ct.eventStyle(o).category;u.ARIAUtils.setLabel(a,c.title),a.style.backgroundColor=c.getComputedColorValue(),i.Types.Extensions.isSyntheticExtensionEntry(o)&&(a.style.backgroundColor=P.ExtensionUI.extensionEntryColor(o))}return t}createValueCell(e){if("self"!==e&&"total"!==e&&"start-time"!==e)return null;let t,n,r,a=!1;switch(e){case"start-time":{r=this.profileNode.event;const e=this.treeView.traceParseData();if(!e)throw new Error("Unable to load trace data for tree view");const n=r&&i.Helpers.Timing.eventTimingsMilliSeconds(r);t=(n?.startTime??0)-i.Helpers.Timing.microSecondsToMilliseconds(e.Meta.traceBounds.min)}break;case"self":t=this.profileNode.selfTime,n=this.maxSelfTime,a=!0;break;case"total":t=this.profileNode.totalTime,n=this.maxTotalTime,a=!0;break;default:return null}const s=this.createTD(e);s.className="numeric-column",s.setAttribute("title",Ut(Bt.fms,{PH1:t.toFixed(4)}));const o=s.createChild("div");return o.createChild("span").textContent=Ut(Bt.fms,{PH1:t.toFixed(1)}),a&&this.treeView.exposePercentages()&&(o.createChild("span","percent-column").textContent=Ut(Bt.percentPlaceholder,{PH1:(t/this.grandTotalTime*100).toFixed(1)})),n&&(o.classList.add("background-percent-bar"),s.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*t/n).toFixed(1)+"%"),s}}class Vt extends Ot{constructor(e,t,i,n,r){super(e,t,i,n,r),this.setHasChildren(this.profileNode.hasChildren()),_t.set(e,this)}populate(){if(!this.populated&&(this.populated=!0,this.profileNode.children))for(const e of this.profileNode.children().values()){const t=new Vt(e,this.grandTotalTime,this.maxSelfTime,this.maxTotalTime,this.treeView);this.insertChildOrdered(t)}}}const _t=new WeakMap;class zt extends Wt{groupBySetting;stackView;executionContextNamesByOrigin=new Map;constructor(){super(),this.groupBySetting=r.Settings.Settings.instance().createSetting("timeline-tree-group-by",zt.GroupBy.None),this.groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this.stackView=new qt(this),this.stackView.addEventListener("SelectionChanged",this.onStackViewSelectionChanged,this)}setGroupBySettingForTests(e){this.groupBySetting.set(e)}updateContents(e){this.updateExtensionResolver(),super.updateContents(e);const t=this.dataGrid.rootNode();t.children.length&&t.children[0].select(!0)}updateExtensionResolver(){this.executionContextNamesByOrigin=new Map;for(const e of n.TargetManager.TargetManager.instance().models(n.RuntimeModel.RuntimeModel))for(const t of e.executionContexts())this.executionContextNamesByOrigin.set(t.origin,t.name)}beautifyDomainName(e){return zt.isExtensionInternalURL(e)?e=Ut(Bt.chromeExtensionsOverhead):zt.isV8NativeURL(e)?e=Ut(Bt.vRuntime):e.startsWith("chrome-extension")&&(e=this.executionContextNamesByOrigin.get(e)||e),e}displayInfoForGroupNode(e){const t=me(),i=e.id&&e.event?Ct.eventColor(e.event):t.other.color,n=Ut(Bt.unattributed),r="symbol"==typeof e.id?void 0:e.id;switch(this.groupBySetting.get()){case zt.GroupBy.Category:{const e=r&&he(r)?t[r]||t.other:{title:n,color:n};return{name:e.title,color:e.color,icon:void 0}}case zt.GroupBy.Domain:case zt.GroupBy.Subdomain:return{name:(r?this.beautifyDomainName(r):void 0)||n,color:i,icon:void 0};case zt.GroupBy.EventName:if(!e.event)throw new Error("Unable to find event for group by operation");return{name:Ct.eventTitle(e.event),color:i,icon:void 0};case zt.GroupBy.URL:break;case zt.GroupBy.Frame:{const e=r?this.traceParseData()?.PageFrames.frames.get(r):void 0;return{name:e?Ct.displayNameForFrame(e):Ut(Bt.page),color:i,icon:void 0}}default:console.assert(!1,"Unexpected grouping type")}return{name:r||n,color:i,icon:void 0}}populateToolbar(e){super.populateToolbar(e);const t=zt.GroupBy,i=[{label:Ut(Bt.noGrouping),value:t.None},{label:Ut(Bt.groupByActivity),value:t.EventName},{label:Ut(Bt.groupByCategory),value:t.Category},{label:Ut(Bt.groupByDomain),value:t.Domain},{label:Ut(Bt.groupByFrame),value:t.Frame},{label:Ut(Bt.groupBySubdomain),value:t.Subdomain},{label:Ut(Bt.groupByUrl),value:t.URL}];e.appendToolbarItem(new u.Toolbar.ToolbarSettingComboBox(i,this.groupBySetting,Ut(Bt.groupBy))),e.appendSpacer(),e.appendToolbarItem(this.splitWidget.createShowHideSidebarButton(Ut(Bt.showHeaviestStack),Ut(Bt.hideHeaviestStack),Ut(Bt.heaviestStackShown),Ut(Bt.heaviestStackHidden)))}buildHeaviestStack(e){console.assert(Boolean(e.parent),"Attempt to build stack for tree root");let t=[];for(let i=e;i&&i.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i&&i.children()&&i.children().size;){const e=Array.from(i.children().values());i=e.reduce(((e,t)=>e.totalTime>t.totalTime?e:t)),t.push(i)}return t}exposePercentages(){return!0}onStackViewSelectionChanged(){const e=this.stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}showDetailsForNode(e){const t=this.buildHeaviestStack(e);return this.stackView.setStack(t,e),this.stackView.show(this.detailsView.element),!0}groupingFunction(e){const t=zt.GroupBy;switch(e){case t.None:return null;case t.EventName:return e=>Ct.eventStyle(e).title;case t.Category:return e=>Ct.eventStyle(e).category.name;case t.Subdomain:return this.domainByEvent.bind(this,!1);case t.Domain:return this.domainByEvent.bind(this,!0);case t.URL:return e=>{const t=this.traceParseData();return t?i.Extras.URLForEntry.get(t,e)??"":""};case t.Frame:return e=>i.Helpers.Trace.frameIDForEvent(e)||this.traceParseData()?.Meta.mainFrameId||"";default:return console.assert(!1,`Unexpected aggregation setting: ${e}`),null}}domainByEvent(e,t){const n=this.traceParseData();if(!n)return"";const a=i.Extras.URLForEntry.get(n,t);if(!a)return"";if(zt.isExtensionInternalURL(a))return zt.extensionInternalPrefix;if(zt.isV8NativeURL(a))return zt.v8NativePrefix;const s=r.ParsedURL.ParsedURL.fromString(a);if(!s)return"";if("chrome-extension"===s.scheme)return s.scheme+"://"+s.host;if(!e)return s.host;if(/^[.0-9]+$/.test(s.host))return s.host;const o=/([^.]*\.)?[^.]*$/.exec(s.host);return o&&o[0]||""}static isExtensionInternalURL(e){return e.startsWith(zt.extensionInternalPrefix)}static isV8NativeURL(e){return e.startsWith(zt.v8NativePrefix)}static extensionInternalPrefix="extensions::";static v8NativePrefix="native "}!function(e){let t;!function(e){e.None="None",e.EventName="EventName",e.Category="Category",e.Domain="Domain",e.Subdomain="Subdomain",e.URL="URL",e.Frame="Frame"}(t=e.GroupBy||(e.GroupBy={}))}(zt||(zt={}));class Gt extends zt{constructor(){super(),this.dataGrid.markColumnAsSortedBy("total",k.DataGrid.Order.Descending)}buildTree(){const e=this.groupBySetting.get();return this.buildTopDownTree(!1,this.groupingFunction(e))}}class jt extends zt{constructor(){super(),this.dataGrid.markColumnAsSortedBy("self",k.DataGrid.Order.Descending)}buildTree(){return new C.TimelineProfileTree.BottomUpRootNode(this.selectedEvents(),this.textFilter(),this.filtersWithoutTextFilter(),this.startTime,this.endTime,this.groupingFunction(this.groupBySetting.get()))}}class qt extends(r.ObjectWrapper.eventMixin(u.Widget.VBox)){treeView;dataGrid;constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=Ut(Bt.heaviestStack),this.treeView=e;const t=[{id:"total",title:Ut(Bt.totalTime),fixedWidth:!0,width:"110px"},{id:"activity",title:Ut(Bt.activity)}];this.dataGrid=new k.ViewportDataGrid.ViewportDataGrid({displayName:Ut(Bt.timelineStack),columns:t,deleteCallback:void 0,editCallback:void 0,refreshCallback:void 0}),this.dataGrid.setResizeMethod("last"),this.dataGrid.addEventListener("SelectedNode",this.onSelectionChanged,this),this.dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this.dataGrid.rootNode();i.removeChildren();let n=null;const r=Math.max.apply(Math,e.map((e=>e.totalTime)));for(const a of e){const e=new Ot(a,r,r,r,this.treeView);i.appendChild(e),a===t&&(n=e)}n&&n.revealAndSelect()}selectedTreeNode(){const e=this.dataGrid.selectedNode;return e&&e.profileNode}onSelectionChanged(){this.dispatchEventToListeners("SelectionChanged")}}var $t=Object.freeze({__proto__:null,TimelineTreeView:Wt,GridNode:Ot,TreeGridNode:Vt,get AggregatedTimelineTreeView(){return zt},CallTreeTimelineTreeView:Gt,BottomUpTimelineTreeView:jt,TimelineStackView:qt});const Jt={startTime:"Start Time",durationFilter:"Duration filter",Dms:"{PH1} ms",all:"All"},Kt=e.i18n.registerUIStrings("panels/timeline/EventsTimelineTreeView.ts",Jt),Yt=e.i18n.getLocalizedString.bind(void 0,Kt);class Xt extends Wt{filtersControl;delegate;currentTree;constructor(e){super(),this.filtersControl=new Zt,this.filtersControl.addEventListener("FilterChanged",this.onFilterChanged,this),this.init(),this.delegate=e,this.dataGrid.markColumnAsSortedBy("start-time",k.DataGrid.Order.Ascending),this.splitWidget.showBoth()}filters(){return[...super.filters(),...this.filtersControl.filters()]}updateContents(e){super.updateContents(e),vt.isTraceEventSelection(e.object)&&this.selectEvent(e.object,!0)}buildTree(){return this.currentTree=this.buildTopDownTree(!0,null),this.currentTree}onFilterChanged(){const e=this.lastSelectedNode(),t=e&&e.event;this.refreshTree(),t&&this.selectEvent(t,!1)}findNodeWithEvent(e){if("RunTask"===e.name)return null;const t=[this.currentTree.children().values()];for(;t.length;){const{done:i,value:n}=t[t.length-1].next();if(i)t.pop();else{if(n.event===e)return n;t.push(n.children().values())}}return null}selectEvent(e,t){const i=this.findNodeWithEvent(e);if(i&&(this.selectProfileNode(i,!1),t)){const e=this.dataGridNodeForTreeNode(i);e&&e.expand()}}populateColumns(e){e.push({id:"start-time",title:Yt(Jt.startTime),width:"80px",fixedWidth:!0,sortable:!0}),super.populateColumns(e),e.filter((e=>e.fixedWidth)).forEach((e=>{e.width="80px"}))}populateToolbar(e){super.populateToolbar(e),this.filtersControl.populateToolbar(e)}showDetailsForNode(e){const t=this.traceParseData();if(!t)return!1;const i=e.event;return!!i&&(Ct.buildTraceEventDetails(t,i,this.linkifier,!1).then((e=>this.detailsView.element.appendChild(e))),!0)}onHover(e){this.delegate.highlightEvent(e&&e.event)}}class Zt extends r.ObjectWrapper.ObjectWrapper{categoryFilter;durationFilter;filtersInternal;constructor(){super(),this.categoryFilter=new Dt,this.durationFilter=new Rt,this.filtersInternal=[this.categoryFilter,this.durationFilter]}filters(){return this.filtersInternal}populateToolbar(e){const t=new u.Toolbar.ToolbarComboBox(function(){const e=t.selectedOption().value,n=parseInt(e,10);this.durationFilter.setMinimumRecordDuration(i.Types.Timing.MilliSeconds(n)),this.notifyFiltersChanged()}.bind(this),Yt(Jt.durationFilter));for(const e of Zt.durationFilterPresetsMs)t.addOption(t.createOption(e?`≥ ${Yt(Jt.Dms,{PH1:e})}`:Yt(Jt.all),String(e)));e.appendToolbarItem(t);const n=new Map,r=me();for(const t in r){const i=r[t];if(!i.visible)continue;const s=new u.Toolbar.ToolbarCheckbox(i.title,void 0,a.bind(this,t));s.setChecked(!0),s.inputElement.style.backgroundColor=i.color,n.set(i.name,s),e.appendToolbarItem(s)}function a(e){const t=me(),i=n.get(e);t[e].hidden=!i||!i.checked(),this.notifyFiltersChanged()}}notifyFiltersChanged(){this.dispatchEventToListeners("FilterChanged")}static durationFilterPresetsMs=[0,1,15]}var Qt=Object.freeze({__proto__:null,EventsTimelineTreeView:Xt,Filters:Zt});class ei extends u.SplitWidget.SplitWidget{showPaintProfilerCallback;rightSplitWidget;layerViewHost;layers3DView;frameLayerTree;updateWhenVisible;constructor(e){super(!0,!1,"timeline-layers-view"),this.showPaintProfilerCallback=e,this.element.classList.add("timeline-layers-view"),this.rightSplitWidget=new u.SplitWidget.SplitWidget(!0,!0,"timeline-layers-view-details"),this.rightSplitWidget.element.classList.add("timeline-layers-view-properties"),this.setMainWidget(this.rightSplitWidget);const t=new u.Widget.VBox;this.setSidebarWidget(t),this.layerViewHost=new I.LayerViewHost.LayerViewHost;const i=new I.LayerTreeOutline.LayerTreeOutline(this.layerViewHost);t.element.appendChild(i.element),this.layers3DView=new I.Layers3DView.Layers3DView(this.layerViewHost),this.layers3DView.addEventListener("PaintProfilerRequested",this.onPaintProfilerRequested,this),this.rightSplitWidget.setMainWidget(this.layers3DView);const n=new I.LayerDetailsView.LayerDetailsView(this.layerViewHost);this.rightSplitWidget.setSidebarWidget(n),n.addEventListener("PaintProfilerRequested",this.onPaintProfilerRequested,this)}showLayerTree(e){this.frameLayerTree=e,this.isShowing()?this.update():this.updateWhenVisible=!0}wasShown(){this.updateWhenVisible&&(this.updateWhenVisible=!1,this.update())}async onPaintProfilerRequested(e){const t=e.data,i=await this.layers3DView.snapshotForSelection(t);i&&this.showPaintProfilerCallback(i.snapshot)}update(){this.frameLayerTree&&this.frameLayerTree.layerTreePromise().then((e=>this.layerViewHost.setLayerTree(e)))}}var ti=Object.freeze({__proto__:null,TimelineLayersView:ei});const ii=new CSSStyleSheet;ii.replaceSync(".paint-profiler-image-view{overflow:hidden}.paint-profiler-image-view .paint-profiler-image-container{transform-origin:0 0}.paint-profiler-image-view .paint-profiler-image-container div{border-color:1px solid var(--sys-color-divider);border-style:solid;z-index:100;position:absolute;top:0;left:0}.paint-profiler-image-view img{border:solid 1px var(--sys-color-inverse-surface)}\n/*# sourceURL=timelinePaintProfiler.css */\n");class ni extends u.SplitWidget.SplitWidget{logAndImageSplitWidget;imageView;paintProfilerView;logTreeView;needsUpdateWhenVisible;pendingSnapshot;event;paintProfilerModel;lastLoadedSnapshot;#U;constructor(e){super(!1,!1),this.element.classList.add("timeline-paint-profiler-view"),this.setSidebarSize(60),this.setResizable(!1),this.#U=e,this.logAndImageSplitWidget=new u.SplitWidget.SplitWidget(!0,!1),this.logAndImageSplitWidget.element.classList.add("timeline-paint-profiler-log-split"),this.setMainWidget(this.logAndImageSplitWidget),this.imageView=new ri,this.logAndImageSplitWidget.setMainWidget(this.imageView),this.paintProfilerView=new I.PaintProfilerView.PaintProfilerView(this.imageView.showImage.bind(this.imageView)),this.paintProfilerView.addEventListener("WindowChanged",this.onWindowChanged,this),this.setSidebarWidget(this.paintProfilerView),this.logTreeView=new I.PaintProfilerView.PaintProfilerCommandLogView,this.logAndImageSplitWidget.setSidebarWidget(this.logTreeView),this.needsUpdateWhenVisible=!1,this.pendingSnapshot=null,this.event=null,this.paintProfilerModel=null,this.lastLoadedSnapshot=null}wasShown(){super.wasShown(),this.needsUpdateWhenVisible&&(this.needsUpdateWhenVisible=!1,this.update())}setSnapshot(e){this.releaseSnapshot(),this.pendingSnapshot=e,this.event=null,this.updateWhenVisible()}#W(e){const t=e.args.tileData;if(!t)return!1;const i=this.#U.Frames.framesById[t.sourceFrameNumber];return!(!i||!i.layerTree)}setEvent(e,t){if(this.releaseSnapshot(),this.paintProfilerModel=e,this.pendingSnapshot=null,this.event=t,this.updateWhenVisible(),i.Types.TraceEvents.isTraceEventPaint(t)){const e=this.#U.LayerTree.paintsToSnapshots.get(t);return Boolean(e)}return!!i.Types.TraceEvents.isTraceEventRasterTask(t)&&this.#W(t)}updateWhenVisible(){this.isShowing()?this.update():this.needsUpdateWhenVisible=!0}async#O(e){const t=e.args.tileData;if(!t)return null;if(!t.tileId.id_ref)return null;const i=n.TargetManager.TargetManager.instance().rootTarget();if(!i)return null;const r=this.#U.Frames.framesById[t.sourceFrameNumber];if(!r||!r.layerTree)return null;const a=new C.TracingLayerTree.TracingFrameLayerTree(i,r.layerTree),s=await a.layerTreePromise();return s?s.pictureForRasterTile(t.tileId.id_ref):null}update(){let e;if(this.logTreeView.setCommandLog([]),this.paintProfilerView.setSnapshotAndLog(null,[],null),this.pendingSnapshot)e=Promise.resolve({rect:null,snapshot:this.pendingSnapshot});else if(this.event&&this.paintProfilerModel&&i.Types.TraceEvents.isTraceEventPaint(this.event)){const t=this.#U.LayerTree.paintsToSnapshots.get(this.event);if(t){const i=t.args.snapshot.skp64;e=this.paintProfilerModel.loadSnapshot(i).then((e=>e&&{rect:null,snapshot:e}))}else e=Promise.resolve(null)}else{if(!this.event||!i.Types.TraceEvents.isTraceEventRasterTask(this.event))return void console.assert(!1,"Unexpected event type or no snapshot");e=this.#O(this.event)}function t(e,t,i){this.logTreeView.setCommandLog(i||[]),this.paintProfilerView.setSnapshotAndLog(e,i||[],t)}e.then((e=>{if(this.releaseSnapshot(),!e)return void this.imageView.showImage();const i=e.snapshot;this.lastLoadedSnapshot=i,this.imageView.setMask(e.rect),i.commandLog().then((n=>t.call(this,i,e.rect,n||[])))}))}releaseSnapshot(){this.lastLoadedSnapshot&&(this.lastLoadedSnapshot.release(),this.lastLoadedSnapshot=null)}onWindowChanged(){this.logTreeView.updateWindow(this.paintProfilerView.selectionWindow())}}class ri extends u.Widget.Widget{imageContainer;imageElement;maskElement;transformController;maskRectangle;constructor(){super(!0),this.contentElement.classList.add("fill","paint-profiler-image-view"),this.imageContainer=this.contentElement.createChild("div","paint-profiler-image-container"),this.imageElement=this.imageContainer.createChild("img"),this.maskElement=this.imageContainer.createChild("div"),this.imageElement.addEventListener("load",this.updateImagePosition.bind(this),!1),this.transformController=new I.TransformController.TransformController(this.contentElement,!0),this.transformController.addEventListener("TransformChanged",this.updateImagePosition,this)}onResize(){this.imageElement.src&&this.updateImagePosition()}updateImagePosition(){const e=this.imageElement.naturalWidth,t=this.imageElement.naturalHeight,i=this.contentElement.clientWidth,n=this.contentElement.clientHeight,r=.1*i,a=.1*n,s=(i-r)/e,o=(n-a)/t,l=Math.min(s,o);if(this.maskRectangle){const i=this.maskElement.style;i.width=e+"px",i.height=t+"px",i.borderLeftWidth=this.maskRectangle.x+"px",i.borderTopWidth=this.maskRectangle.y+"px",i.borderRightWidth=e-this.maskRectangle.x-this.maskRectangle.width+"px",i.borderBottomWidth=t-this.maskRectangle.y-this.maskRectangle.height+"px"}this.transformController.setScaleConstraints(.5,10/l);let c=(new WebKitCSSMatrix).scale(this.transformController.scale(),this.transformController.scale()).translate(i/2,n/2).scale(l,l).translate(-e/2,-t/2);const d=u.Geometry.boundsForTransformedPoints(c,[0,0,0,e,t,0]);this.transformController.clampOffsets(r-d.maxX,i-r-d.minX,a-d.maxY,n-a-d.minY),c=(new WebKitCSSMatrix).translate(this.transformController.offsetX(),this.transformController.offsetY()).multiply(c),this.imageContainer.style.webkitTransform=c.toString()}showImage(e){this.imageContainer.classList.toggle("hidden",!e),e&&(this.imageElement.src=e)}setMask(e){this.maskRectangle=e,this.maskElement.classList.toggle("hidden",!e)}wasShown(){super.wasShown(),this.registerCSSFiles([ii])}}var ai=Object.freeze({__proto__:null,TimelinePaintProfilerView:ni,TimelinePaintImageView:ri});const si={selectorStats:"Selector Stats",elapsed:"Elapsed (ms)",rejectPercentage:"% of Slow-Path Non-Matches",rejectPercentageExplanation:"The percentage of non-matching nodes (Match Attempts - Match Count) that couldn't be quickly ruled out by the bloom filter. Lower is better.",matchAttempts:"Match Attempts",matchCount:"Match Count",selector:"Selector",styleSheetId:"Style Sheet",copyTable:"Copy Table",unableToLink:"Unable to link",unableToLinkViaStyleSheetId:"Unable to link via {PH1}",tableCopiedToClipboard:"Table copied to clipboard",totalForAllSelectors:"(Totals for all selectors)",lineNumber:"Line {PH1}:{PH2}"},oi=e.i18n.registerUIStrings("panels/timeline/TimelineSelectorStatsView.ts",si),li=e.i18n.getLocalizedString.bind(void 0,oi);class ci extends u.Widget.VBox{#V;#_;#t=null;#z=null;constructor(e){super(),this.#V=new M.DataGridController.DataGridController,this.#_=new Map,this.#t=e,this.#V.data={label:li(si.selectorStats),showScrollbar:!0,autoScrollToBottom:!1,initialSort:{columnId:"elapsed (us)",direction:"DESC"},columns:[{id:"elapsed (us)",title:li(si.elapsed),sortable:!0,widthWeighting:1,visible:!0,hideable:!0,styles:{"text-align":"right"}},{id:"match_attempts",title:li(si.matchAttempts),sortable:!0,widthWeighting:1,visible:!0,hideable:!0,styles:{"text-align":"right"}},{id:"match_count",title:li(si.matchCount),sortable:!0,widthWeighting:1,visible:!0,hideable:!0,styles:{"text-align":"right"}},{id:"reject_percentage",title:li(si.rejectPercentage),titleElement:L.html`<span title=${li(si.rejectPercentageExplanation)}>${li(si.rejectPercentage)}</span>`,sortable:!0,widthWeighting:1,visible:!0,hideable:!0,styles:{"text-align":"right"}},{id:"selector",title:li(si.selector),sortable:!0,widthWeighting:3,visible:!0,hideable:!0},{id:"style_sheet_id",title:li(si.styleSheetId),sortable:!0,widthWeighting:1.5,visible:!0,hideable:!0}],rows:[],contextMenus:{bodyRow:(e,t,i,r)=>{e.defaultSection().appendItem(li(si.copyTable),(()=>{const e=[],i=t.map((e=>e.title));e.push(i.join("\t"));for(const t of r){const i=t.cells.map((e=>{if("style_sheet_id"===e.columnId){const t=li(si.unableToLink);let i="";const r=n.TargetManager.TargetManager.instance().primaryPageTarget(),a=r?.model(n.CSSModel.CSSModel);if(a){const t=a.styleSheetHeaderForId(e.value);t&&(i=t.resourceURL().toString())}return i?i.toString():t}return String(e.value)}));e.push(i.join("\t"))}const a=e.join("\n");navigator.clipboard.writeText(a),u.ARIAUtils.alert(li(si.tableCopiedToClipboard))}))}}},this.contentElement.appendChild(this.#V)}setEvent(e){if(!this.#t)return!1;if(this.#z===e)return!1;this.#z=e;const t=this.#t.SelectorStats.dataForUpdateLayoutEvent.get(e);if(!t)return this.#V.data={...this.#V.data,rows:[]},!1;const i=t.timings;return this.createRowsForTable(i).then((e=>{this.#V.data={...this.#V.data,rows:e}})),!0}setAggregatedEvents(e){const t=[],i=new Map;if(!this.#t)return;const n={"elapsed (us)":0,match_attempts:0,match_count:0,fast_reject_count:0};if(!Array.isArray(this.#z)||this.#z.length!==e.length||!e.every(((e,t)=>e===this.#z[t]))){this.#z=e;for(let t=0;t<e.length;t++){const r=e[t],a=r?this.#t.SelectorStats.dataForUpdateLayoutEvent.get(r):void 0;if(a){const e=a.timings;for(const t of e){const e=t.selector+"_"+t.style_sheet_id,r=i.get(e);void 0!==r?(r["elapsed (us)"]+=t["elapsed (us)"],r.fast_reject_count+=t.fast_reject_count,r.match_attempts+=t.match_attempts,r.match_count+=t.match_count):i.set(e,structuredClone(t)),n["elapsed (us)"]+=t["elapsed (us)"],n.match_attempts+=t.match_attempts,n.match_count+=t.match_count,n.fast_reject_count+=t.fast_reject_count}}}i.size>0?(i.forEach((e=>{t.push(e)})),i.clear(),t.unshift({"elapsed (us)":n["elapsed (us)"],fast_reject_count:n.fast_reject_count,match_attempts:n.match_attempts,match_count:n.match_count,selector:li(si.totalForAllSelectors),style_sheet_id:"n/a"}),this.createRowsForTable(t).then((e=>{this.#V.data={...this.#V.data,rows:e}}))):this.#V.data={...this.#V.data,rows:[]}}}async createRowsForTable(e){const t=n.TargetManager.TargetManager.instance().primaryPageTarget(),i=t?.model(n.CSSModel.CSSModel);if(!i)return[];const r=await Promise.all(e.map((async e=>{const t=e.style_sheet_id,n=e.selector.trim(),r=e["elapsed (us)"]/1e3,a=e.match_attempts-e.match_count,s=100*(a?e.fast_reject_count/a:1),o="n/a"===t?null:await async function(e,t,i,n){if(!e)return;const r=e.styleSheetHeaderForId(t);if(!r||!r.resourceURL())return;const a=JSON.stringify({selectorText:i,styleSheetId:t});let s=n.get(a);if(!s){const r=await e.agent.invoke_getLocationForSelector({styleSheetId:t,selectorText:i});if(r.getError()||!r.ranges)return;s=r.ranges,n.set(a,s)}return s.map((e=>({url:r.resourceURL(),lineNumber:e.startLine,columnNumber:e.startColumn,linkText:li(si.lineNumber,{PH1:e.startLine+1,PH2:e.startColumn+1})})))}(i,t,n,this.#_);return{cells:[{columnId:"elapsed (us)",value:r,renderer:()=>L.html`${r.toFixed(3)}`},{columnId:"reject_percentage",value:s,renderer:()=>L.html`${s.toFixed(1)}`},{columnId:"match_attempts",value:e.match_attempts},{columnId:"match_count",value:e.match_count},{columnId:"selector",title:e.selector,value:e.selector},{columnId:"style_sheet_id",value:e.style_sheet_id,renderer:()=>null===o?L.html`<span></span>`:void 0===o?L.html`<span title=${li(si.unableToLinkViaStyleSheetId,{PH1:e.style_sheet_id})} aria-label=${li(si.unableToLinkViaStyleSheetId,{PH1:e.style_sheet_id})}>${li(si.unableToLink)}</span>`:L.html`
              ${o.map(((e,t)=>t!==o.length-1?L.html`<${F.Linkifier.Linkifier.litTagName} .data=${e}></${F.Linkifier.Linkifier.litTagName}>
                    <a>, </a>`:L.html`<${F.Linkifier.Linkifier.litTagName} .data=${e}></${F.Linkifier.Linkifier.litTagName}>`))}
              `}]}})));return r}}const di={summary:"Summary",bottomup:"Bottom-Up",callTree:"Call Tree",eventLog:"Event Log",paintProfiler:"Paint Profiler",layers:"Layers",rangeSS:"Range:  {PH1} – {PH2}",selectorStats:"Selector Stats"},hi=e.i18n.registerUIStrings("panels/timeline/TimelineDetailsView.ts",di),mi=e.i18n.getLocalizedString.bind(void 0,hi);class pi extends u.Widget.VBox{detailsLinkifier;tabbedPane;defaultDetailsWidget;defaultDetailsContentElement;rangeDetailViews;#D;lazyPaintProfilerView;lazyLayersView;preferredTabId;selection;updateContentsScheduled;lazySelectorStatsView;#U=null;#G=null;#j;#x=this.#P.bind(this);constructor(e){super(),this.element.classList.add("timeline-details"),this.detailsLinkifier=new E.Linkifier.Linkifier,this.tabbedPane=new u.TabbedPane.TabbedPane,this.tabbedPane.show(this.element),this.defaultDetailsWidget=new u.Widget.VBox,this.defaultDetailsWidget.element.classList.add("timeline-details-view"),this.defaultDetailsContentElement=this.defaultDetailsWidget.element.createChild("div","timeline-details-view-body vbox"),this.appendTab(ui.Details,mi(di.summary),this.defaultDetailsWidget),this.setPreferredTab(ui.Details),this.rangeDetailViews=new Map,this.updateContentsScheduled=!1;const t=new jt;this.appendTab(ui.BottomUp,mi(di.bottomup),t),this.rangeDetailViews.set(ui.BottomUp,t);const i=new Gt;this.appendTab(ui.CallTree,mi(di.callTree),i),this.rangeDetailViews.set(ui.CallTree,i);const n=new Xt(e);this.appendTab(ui.EventLog,mi(di.eventLog),n),this.rangeDetailViews.set(ui.EventLog,n),this.#j=new s.NetworkRequestDetails.NetworkRequestDetails(this.detailsLinkifier),this.tabbedPane.addEventListener(u.TabbedPane.Events.TabSelected,this.tabSelected,this),h.TraceBounds.onChange(this.#x),this.lazySelectorStatsView=null}selectorStatsView(){return this.lazySelectorStatsView||(this.lazySelectorStatsView=new ci(this.#U)),this.lazySelectorStatsView}getDetailsContentElementForTest(){return this.defaultDetailsContentElement}async#P(e){"MINIMAP_BOUNDS"===e.updateType&&this.selection&&await this.setSelection(this.selection),"RESET"!==e.updateType&&"VISIBLE_WINDOW"!==e.updateType||this.selection||this.scheduleUpdateContentsFromWindow()}async setModel(e,t){this.#U!==e&&(this.lazySelectorStatsView=null,this.#U=e),e&&(this.#G=i.Extras.FilmStrip.fromTraceData(e)),this.#D=t,this.tabbedPane.closeTabs([ui.PaintProfiler,ui.LayerViewer],!1);for(const i of this.rangeDetailViews.values())i.setModelWithEvents(t,e);this.lazyPaintProfilerView=null,this.lazyLayersView=null,await this.setSelection(null)}setContent(e){const t=this.tabbedPane.otherTabs(ui.Details);for(let e=0;e<t.length;++e)this.rangeDetailViews.has(t[e])||this.tabbedPane.closeTab(t[e]);this.defaultDetailsContentElement.removeChildren(),this.defaultDetailsContentElement.appendChild(e)}updateContents(){const e=this.rangeDetailViews.get(this.tabbedPane.selectedTabId||"");if(e){const t=h.TraceBounds.BoundsManager.instance().state();if(!t)return;const i=t.milli.timelineTraceWindow;e.updateContents(this.selection||vt.fromRange(i.min,i.max))}}appendTab(e,t,i,n){this.tabbedPane.appendTab(e,t,i,void 0,void 0,n),this.preferredTabId!==this.tabbedPane.selectedTabId&&this.tabbedPane.selectTab(e)}headerElement(){return this.tabbedPane.headerElement()}setPreferredTab(e){this.preferredTabId=e}scheduleUpdateContentsFromWindow(e=!1){this.#U?e?this.updateContentsFromWindow():this.updateContentsScheduled||(this.updateContentsScheduled=!0,setTimeout((()=>{this.updateContentsScheduled=!1,this.updateContentsFromWindow()}),100)):this.setContent(u.Fragment.html`<div/>`)}updateContentsFromWindow(){const e=h.TraceBounds.BoundsManager.instance().state();if(!e)return;const t=e.milli.timelineTraceWindow;this.updateSelectedRangeStats(t.min,t.max),this.updateContents()}#q(e){if(!this.#G)return null;const t=e.idle?e.startTime:e.endTime,n=i.Extras.FilmStrip.frameClosestToTimestamp(this.#G,t);if(!n)return null;return i.Helpers.Timing.microSecondsToMilliseconds(n.screenshotEvent.ts)-e.endTime<10?n:null}async setSelection(e){if(!this.#U)return;if(this.detailsLinkifier.reset(),this.selection=e,!this.selection)return void this.scheduleUpdateContentsFromWindow(!0);const t=this.selection.object;if(vt.isSyntheticNetworkRequestDetailsEventSelection(t)){const e=t,i=rt(this.#U,e);await this.#j.setData(e,i),this.setContent(this.#j)}else if(vt.isTraceEventSelection(t)){const e=t,i=await Ct.buildTraceEventDetails(this.#U,e,this.detailsLinkifier,!0);this.appendDetailsTabsForTraceEventAndShowDetails(e,i)}else if(vt.isFrameObject(t)){const e=t,i=this.#q(e);this.setContent(Ct.generateDetailsContentForFrame(e,this.#G,i));const r=n.TargetManager.TargetManager.instance().rootTarget();if(e.layerTree&&r){const t=new C.TracingLayerTree.TracingFrameLayerTree(r,e.layerTree),i=this.layersView();i.showLayerTree(t),this.tabbedPane.hasTab(ui.LayerViewer)||this.appendTab(ui.LayerViewer,mi(di.layers),i)}}else vt.isRangeSelection(t)&&this.updateSelectedRangeStats(this.selection.startTime,this.selection.endTime);this.updateContents()}tabSelected(e){e.data.isUserGesture&&(this.setPreferredTab(e.data.tabId),this.updateContents())}layersView(){return this.lazyLayersView||(this.lazyLayersView=new ei(this.showSnapshotInPaintProfiler.bind(this))),this.lazyLayersView}paintProfilerView(){return this.lazyPaintProfilerView?this.lazyPaintProfilerView:this.#U?(this.lazyPaintProfilerView=new ni(this.#U),this.lazyPaintProfilerView):null}showSnapshotInPaintProfiler(e){const t=this.paintProfilerView();t&&(t.setSnapshot(e),this.tabbedPane.hasTab(ui.PaintProfiler)||this.appendTab(ui.PaintProfiler,mi(di.paintProfiler),t,!0),this.tabbedPane.selectTab(ui.PaintProfiler,!0))}showSelectorStatsForIndividualEvent(e){this.showAggregatedSelectorStats([e])}showAggregatedSelectorStats(e){const t=this.selectorStatsView();t.setAggregatedEvents(e),this.tabbedPane.hasTab(ui.SelectorStats)||this.appendTab(ui.SelectorStats,mi(di.selectorStats),t)}appendDetailsTabsForTraceEventAndShowDetails(e,t){this.setContent(t),(i.Types.TraceEvents.isTraceEventPaint(e)||i.Types.TraceEvents.isTraceEventRasterTask(e))&&this.showEventInPaintProfiler(e),i.Types.TraceEvents.isTraceEventUpdateLayoutTree(e)&&this.showSelectorStatsForIndividualEvent(e)}showEventInPaintProfiler(e){const t=n.TargetManager.TargetManager.instance().models(n.PaintProfiler.PaintProfilerModel)[0];if(!t)return;const i=this.paintProfilerView();if(!i)return;i.setEvent(t,e)&&(this.tabbedPane.hasTab(ui.PaintProfiler)||this.appendTab(ui.PaintProfiler,mi(di.paintProfiler),i))}updateSelectedRangeStats(t,n){if(!this.#D||!this.#U)return;const a=i.Helpers.Timing.traceWindowMilliSeconds(this.#U.Meta.traceBounds).min,s=Ct.statsForTimeRange(this.#D,t,n),o=t-a,l=n-a,c=new Pt(null,null);c.addSection(mi(di.rangeSS,{PH1:e.TimeUtilities.millisToString(o),PH2:e.TimeUtilities.millisToString(l)}));const d=Ct.generatePieChart(s);c.appendElementRow("",d),this.setContent(c.fragment);const h=r.Settings.Settings.instance().createSetting("timeline-capture-selector-stats",!1).get();if(this.#D&&h){const e=i.Helpers.Trace.findUpdateLayoutTreeEvents(this.#D,i.Helpers.Timing.millisecondsToMicroseconds(t),i.Helpers.Timing.millisecondsToMicroseconds(n));e.length>0&&this.showAggregatedSelectorStats(e)}}}var ui;!function(e){e.Details="details",e.EventLog="event-log",e.CallTree="call-tree",e.BottomUp="bottom-up",e.PaintProfiler="paint-profiler",e.LayerViewer="layer-viewer",e.SelectorStats="selector-stats"}(ui||(ui={}));var gi=Object.freeze({__proto__:null,TimelineDetailsView:pi,get Tab(){return ui}});function vi(e,t,i,n){const r=[...fi(e,t,e.Initiators.eventToInitiator),...yi(t,e.Initiators.initiatorToEvents)];return r.forEach((t=>function(e,t,i,n){if(i.includes(e.event)){let i=n.Renderer.entryToNode.get(e.event)?.parent;for(;i?.entry&&!t.includes(i?.entry);)i=i.parent??void 0;e.event=i?.entry??e.event,e.isEntryHidden=!0}if(i.includes(e.initiator)){let i=n.Renderer.entryToNode.get(e.initiator)?.parent;for(;i?.entry&&!t.includes(i?.entry);)i=i.parent??void 0;e.initiator=i?.entry??e.initiator,e.isInitiatorHidden=!0}return e}(t,n,i,e))),r}function Ti(e,t){return fi(e,t,e.NetworkRequests.eventToInitiator)}function fi(e,t,n){const r=[];let a=t;for(;a;){const t=n.get(a);if(t){r.push({event:a,initiator:t}),a=t;continue}if(!i.Types.TraceEvents.isSyntheticTraceEntry(a)){a=null;break}const s=e.Renderer.entryToNode.get(a);if(!s){a=null;break}a=s.parent?.entry||null}return r}function yi(e,t){const i=[],n=t.get(e);return n&&n.forEach((t=>{i.push({event:t,initiator:e})})),i}var wi=Object.freeze({__proto__:null,initiatorsDataToDraw:vi,initiatorsDataToDrawForNetwork:Ti});const bi={onIgnoreList:"On ignore list",mainS:"Main — {PH1}",main:"Main",frameS:"Frame — {PH1}",workerS:"`Worker` — {PH1}",workerSS:"`Worker`: {PH1} — {PH2}",dedicatedWorker:"Dedicated `Worker`",anonymous:"(anonymous)",threadS:"Thread {PH1}",raster:"Raster",threadPool:"Thread Pool",rasterizerThreadS:"Rasterizer Thread {PH1}",threadPoolThreadS:"Thread Pool Worker {PH1}",bidderWorkletS:"Bidder Worklet — {PH1}",bidderWorklet:"Bidder Worklet",sellerWorklet:"Seller Worklet",unknownWorklet:"Auction Worklet",workletService:"Auction Worklet Service",sellerWorkletS:"Seller Worklet — {PH1}",unknownWorkletS:"Auction Worklet — {PH1}",workletServiceS:"Auction Worklet Service — {PH1}",eventDispatchS:"Event: {PH1}"},Si=e.i18n.registerUIStrings("panels/timeline/ThreadAppender.ts",bi),Ci=e.i18n.getLocalizedString.bind(void 0,Si);class Ei{appenderName="Thread";#M;#e;#t;#$=[];#J;#K;#Y;#X;#Z=!1;#Q=!1;threadType="MAIN_THREAD";isOnMainFrame;#ee=a.Runtime.experiments.isEnabled("timeline-show-all-events");#te="";#ie=null;constructor(e,t,i,n,a,s){this.#e=e,this.#M=new r.Color.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:3},85),this.#M.setColorForID("","#f2ecdc"),this.#t=t,this.#K=i,this.#Y=n;const o="CPU_PROFILE"===s?this.#t.Samples?.profilesInProcess.get(i)?.get(n)?.profileCalls:this.#t.Renderer?.processes.get(i)?.threads?.get(n)?.entries,l="CPU_PROFILE"===s?this.#t.Samples?.profilesInProcess.get(i)?.get(n)?.profileTree:this.#t.Renderer?.processes.get(i)?.threads?.get(n)?.tree;if(!o||!l)throw new Error(`Could not find data for thread with id ${n} in process with id ${i}`);this.#$=o,this.#J=l,this.#X=a||Ci(bi.threadS,{PH1:n}),this.isOnMainFrame=Boolean(this.#t.Renderer?.processes.get(i)?.isOnMainFrame),this.threadType=s,this.#t.AuctionWorklets.worklets.has(i)&&(this.appenderName="Thread_AuctionWorklet"),this.#te=this.#t.Renderer?.processes.get(this.#K)?.url||""}processId(){return this.#K}threadId(){return this.#Y}appendTrackAtLevel(e,t=!1){return 0===this.#$.length?e:(this.#Z=t,this.#ne(e))}setHeaderNestingLevel(e){this.#ie=e}#re(e){this.#Q||("RASTERIZER"===this.threadType||"THREAD_POOL"===this.threadType?this.#ae(e,this.threadType):this.#i(e),this.#Q=!0)}setHeaderAppended(e){this.#Q=e}headerAppended(){return this.#Q}#i(e){const t=U({shareHeaderLine:!1,collapsible:this.#$.length>0});null!==this.#ie&&(t.nestingLevel=this.#ie);const i=W(this.#se(),e,this.trackName(),t,!0,this.#Z,!0);this.#e.registerTrackForGroup(i,this)}#se(){switch(this.threadType){case"MAIN_THREAD":return this.isOnMainFrame?"thread.main":"thread.frame";case"WORKER":return"thread.worker";case"RASTERIZER":return"thread.rasterizer";case"AUCTION_WORKLET":return"thread.auction-worklet";case"OTHER":return"thread.other";case"CPU_PROFILE":return"thread.cpu-profile";case"THREAD_POOL":return"thread.pool";default:return null}}#ae(e,t){const i=this.#e.getCurrentTrackCountForThreadType(t);if(0===i){const t=U({shareHeaderLine:!1,collapsible:this.#$.length>0}),i=W(null,e,this.trackName(),t,!1,this.#Z);this.#e.getFlameChartTimelineData().groups.push(i)}const n=U({padding:2,nestingLevel:1,collapsible:!1}),r="RASTERIZER"===this.threadType?Ci(bi.rasterizerThreadS,{PH1:i+1}):Ci(bi.threadPoolThreadS,{PH1:i+1}),a=W(this.#se(),e,r,n,!0,this.#Z);this.#e.registerTrackForGroup(a,this)}trackName(){let e=null;switch(this.threadType){case"MAIN_THREAD":e=this.isOnMainFrame?Ci(bi.mainS,{PH1:this.#te}):Ci(bi.frameS,{PH1:this.#te});break;case"CPU_PROFILE":e=Ci(bi.main);break;case"WORKER":e=this.#oe();break;case"RASTERIZER":e=Ci(bi.raster);break;case"THREAD_POOL":e=Ci(bi.threadPool);break;case"OTHER":break;case"AUCTION_WORKLET":e=this.#le();break;default:return c.assertNever(this.threadType,`Unknown thread type: ${this.threadType}`)}let t="";return this.#t.Meta.traceIsGeneric&&(t+=` (${this.threadId()})`),(e||this.#X)+t}getUrl(){return this.#te}getEntries(){return this.#$}#le(){const e=this.#t.AuctionWorklets.worklets.get(this.#K);if(!e)return Ci(bi.unknownWorklet);const t=e.host?`https://${e.host}`:"",i=t.length>0,n=e.args.data.utilityThread.tid===this.#Y,r=e.args.data.v8HelperThread.tid===this.#Y;if(n)return i?Ci(bi.workletServiceS,{PH1:t}):Ci(bi.workletService);if(r)switch(e.type){case"seller":return i?Ci(bi.sellerWorkletS,{PH1:t}):Ci(bi.sellerWorklet);case"bidder":return i?Ci(bi.bidderWorkletS,{PH1:t}):Ci(bi.bidderWorklet);case"unknown":return i?Ci(bi.unknownWorkletS,{PH1:t}):Ci(bi.unknownWorklet);default:c.assertNever(e.type,`Unexpected Auction Worklet Type ${e.type}`)}return i?Ci(bi.unknownWorkletS,{PH1:t}):Ci(bi.unknownWorklet)}#oe(){const e=this.#t.Renderer?.processes.get(this.#K)?.url||"",t=this.#t.Workers.workerIdByThread.get(this.#Y),i=t?this.#t.Workers.workerURLById.get(t):e;let r=i?Ci(bi.workerS,{PH1:i}):Ci(bi.dedicatedWorker);const a=void 0!==t&&n.TargetManager.TargetManager.instance().targetById(t);return a&&(r=Ci(bi.workerSS,{PH1:a.name(),PH2:e})),r}#ne(e){return this.#ce(this.#J.roots,e)}#ce(e,t,i=!1){const n=Ne.activeManager()?.getEntriesFilter().invisibleEntries()??[];let r=t;for(const a of e){let e=t;const s=a.entry,o=this.isIgnoreListedEntry(s);!n.includes(s)&&(this.#e.entryIsVisibleInTimeline(s)||this.#ee)&&!(o&&i)&&(this.#de(s,t),e++);const l=this.#ce(a.children,e,o);r=Math.max(l,r)}return r}#de(e,t){this.#re(t);const i=this.#e.appendEventAtLevel(e,t,this);this.#he(e,i)}#he(e,t){const n=this.#e.getFlameChartTimelineData();Ne.activeManager()?.getEntriesFilter().isEntryExpandable(e)&&_(n,t,{type:"HIDDEN_DESCENDANTS_ARROW"});const r=this.#t.Warnings.perEvent.get(e);r&&(_(n,t,{type:"WARNING_TRIANGLE"}),r.includes("LONG_TASK")&&_(n,t,{type:"CANDY",startAtTime:i.Handlers.ModelHandlers.Warnings.LONG_MAIN_THREAD_TASK_THRESHOLD}))}isIgnoreListedEntry(e){if(!i.Types.TraceEvents.isProfileCall(e))return!1;const t=e.callFrame.url;return t&&this.isIgnoreListedURL(t)}isIgnoreListedURL(e){return b.IgnoreListManager.IgnoreListManager.instance().isUserIgnoreListedURL(e)}colorForEvent(e){if(this.#t.Meta.traceIsGeneric)return e.name?`hsl(${c.StringUtilities.hashCode(e.name)%300+30}, 40%, 70%)`:"#ccc";if(i.Types.TraceEvents.isProfileCall(e))return"(idle)"===e.callFrame.functionName?me().idle.getComputedColorValue():"0"===e.callFrame.scriptId?me().scripting.getComputedColorValue():this.#M.colorForID(e.callFrame.url);const t=de(e.name)?.category.getComputedColorValue();return t||me().other.getComputedColorValue()}titleForEvent(e){if(this.isIgnoreListedEntry(e))return Ci(bi.onIgnoreList);if(i.Types.TraceEvents.isProfileCall(e)){if(this.#t.Samples){const t=i.Handlers.ModelHandlers.Samples.getProfileCallFunctionName(this.#t.Samples,e);if(t)return t}return e.callFrame.functionName||Ci(bi.anonymous)}if(i.Types.TraceEvents.isTraceEventDispatch(e))return Ci(bi.eventDispatchS,{PH1:e.args.data.type});const t=de(e.name)?.title;return t||e.name}highlightedEntryInfo(e){let t=this.titleForEvent(e);if(i.Types.TraceEvents.isTraceEventParseHTML(e)){const i=e.args.beginData.startLine,n=e.args.endData&&e.args.endData.endLine,r=e.args.beginData.url;t+=` - ${b.ResourceUtils.displayNameForURL(r)} [${-1!==n||n===i?`${i}...${n}`:i}]`}return{title:t,formattedTime:O(e.dur,e.selfTime)}}}var ki=Object.freeze({__proto__:null,ThreadAppender:Ei});const xi=new CSSStyleSheet;xi.replaceSync(".timeline-flamechart-popover{overflow:hidden}.timeline-flamechart-popover devtools-interaction-breakdown{margin-top:10px}.timeline-flamechart-popover span{margin-right:5px}.timeline-flamechart-popover span.timeline-info-network-time{color:var(--sys-color-primary)}.timeline-flamechart-popover span.timeline-info-time{color:var(--sys-color-green)}.timeline-flamechart-popover span.timeline-info-warning{color:var(--sys-color-error)}.timeline-flamechart-popover span.timeline-info-warning *{color:inherit}\n/*# sourceURL=timelineFlamechartPopover.css */\n");const Pi={frames:"Frames",idleFrame:"Idle Frame",droppedFrame:"Dropped Frame",partiallyPresentedFrame:"Partially Presented Frame",frame:"Frame"},Ii=e.i18n.registerUIStrings("panels/timeline/TimelineFlameChartDataProvider.ts",Pi),Mi=e.i18n.getLocalizedString.bind(void 0,Ii);class Fi extends r.ObjectWrapper.ObjectWrapper{isReactNative=!1;droppedFramePatternCanvas;partialFramePatternCanvas;timelineDataInternal;currentLevel;compatibilityTracksAppender;traceEngineData;isCpuProfile=!1;minimumBoundaryInternal;timeSpan;headerLevel1;headerLevel2;staticHeader;framesHeader;screenshotsHeader;entryData;entryTypeByLevel;screenshotImageCache;entryIndexToTitle;lastInitiatorEntry;lastInitiatorsData=[];lastSelection;#me;#pe=new WeakMap;constructor(){super(),this.isReactNative=a.Runtime.experiments.isEnabled("react-native-specific-ui"),this.reset(),this.#me=`${p.Font.DEFAULT_FONT_SIZE} ${p.Font.getFontFamilyForCanvas()}`,this.droppedFramePatternCanvas=document.createElement("canvas"),this.partialFramePatternCanvas=document.createElement("canvas"),this.preparePatternCanvas(),this.timelineDataInternal=null,this.currentLevel=0,this.compatibilityTracksAppender=null,this.traceEngineData=null,this.minimumBoundaryInternal=0,this.timeSpan=0,this.headerLevel1=this.buildGroupStyle({shareHeaderLine:!1}),this.headerLevel2=this.buildGroupStyle({padding:2,nestingLevel:1,collapsible:!1}),this.staticHeader=this.buildGroupStyle({collapsible:!1}),this.framesHeader=this.buildGroupStyle({useFirstLineForOverview:!0}),this.screenshotsHeader=this.buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),t.ThemeSupport.instance().addEventListener(t.ThemeChangeEvent.eventName,(()=>{const e=[this.headerLevel1,this.headerLevel2,this.staticHeader,this.framesHeader,this.screenshotsHeader];for(const i of e)i.color=t.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),i.backgroundColor=t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container")}))}hasTrackConfigurationMode(){return!0}modifyTree(e,t){const i=this.entryData[e];Ne.activeManager()?.getEntriesFilter().applyFilterAction({type:t,entry:i})}findPossibleContextMenuActions(e){const t=this.entryData[e];return Ne.activeManager()?.getEntriesFilter().findPossibleActions(t)}buildGroupStyle(e){const i={padding:4,height:17,collapsible:!0,color:t.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),backgroundColor:t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"),nestingLevel:0,shareHeaderLine:!0};return Object.assign(i,e)}setModel(e,t=!1){if(this.reset(),this.traceEngineData=e,cr.instance().modelChanged(e),this.isCpuProfile=t,e){const{traceBounds:t}=e.Meta,n=i.Helpers.Timing.microSecondsToMilliseconds(t.min),r=i.Helpers.Timing.microSecondsToMilliseconds(t.max);this.minimumBoundaryInternal=n,this.timeSpan=n===r?1e3:r-this.minimumBoundaryInternal}}compatibilityTracksAppenderInstance(e=!1){if(!this.compatibilityTracksAppender||e){if(!this.traceEngineData)throw new Error("Attempted to instantiate a CompatibilityTracksAppender without having set the trace parse data first.");this.timelineDataInternal=this.#ue(),this.compatibilityTracksAppender=new Dr(this.timelineDataInternal,this.traceEngineData,this.entryData,this.entryTypeByLevel)}return this.compatibilityTracksAppender}#ue(){return this.timelineDataInternal||(this.timelineDataInternal=p.FlameChart.FlameChartTimelineData.createEmpty()),this.timelineDataInternal}buildFromTrackAppenders(e){if(!this.compatibilityTracksAppender)return;const t=this.compatibilityTracksAppender.allVisibleTrackAppenders();for(const i of t){if(i instanceof Ei&&!i.trackName().includes(e?.filterThreadsByName||""))continue;const t=Boolean(e?.expandedTracks?.has(i.appenderName));this.currentLevel=i.appendTrackAtLevel(this.currentLevel,t)}}groupTreeEvents(e){return this.compatibilityTracksAppender?.groupEventsForTreeView(e)??null}mainFrameNavigationStartEvents(){return this.traceEngineData?this.traceEngineData.Meta.mainFrameNavigations:[]}entryTitle(e){const t=this.#ge(e);if("Screenshot"===t)return"";if("TrackAppender"===t){const t=this.timelineDataInternal.entryLevels[e],i=this.entryData[e];return this.compatibilityTracksAppender?.titleForEvent(i,t)||null}let i=this.entryIndexToTitle[e];return i||(i=`Unexpected entryIndex ${e}`,console.error(i)),i}textColor(e){const t=this.entryData[e];return Fi.timelineEntryIsTraceEvent(t)&&this.isIgnoreListedEvent(t)?"#888":Ki.textColor}entryFont(e){return this.#me}reset(e=!0){this.currentLevel=0,this.entryData=[],this.entryTypeByLevel=[],this.entryIndexToTitle=[],this.screenshotImageCache=new Map,this.#pe=new Map,e?(this.compatibilityTracksAppender=null,this.timelineDataInternal=null):!e&&this.timelineDataInternal&&(this.compatibilityTracksAppender?.setFlameChartDataAndEntryData(this.timelineDataInternal,this.entryData,this.entryTypeByLevel),this.compatibilityTracksAppender?.threadAppenders().forEach((e=>e.setHeaderAppended(!1))))}maxStackDepth(){return this.currentLevel}timelineData(e=!1){return this.timelineDataInternal&&0!==this.timelineDataInternal.entryLevels.length&&!e||(this.timelineDataInternal=p.FlameChart.FlameChartTimelineData.createEmpty(),e&&this.reset(!1),this.currentLevel=0,this.traceEngineData&&(this.compatibilityTracksAppender=this.compatibilityTracksAppenderInstance(),this.traceEngineData.Meta.traceIsGeneric?this.#ve():this.#Te())),this.timelineDataInternal}#ve(){if(!this.compatibilityTracksAppender)return;const e=this.compatibilityTracksAppender.allThreadAppendersByProcess();for(const[t,i]of e){const e=this.buildGroupStyle({shareHeaderLine:!1}),n=this.traceEngineData?.Meta.processNames.get(t)?.args.name||"Process";this.appendHeader(`${n} (${t})`,e,!0,!1);for(const e of i)e.setHeaderNestingLevel(1),this.currentLevel=e.appendTrackAtLevel(this.currentLevel)}}#Te(){this.isCpuProfile||this.isReactNative||this.#fe();const e=e=>{switch(e.appenderName){case"Animations":return 0;case"Timings":return 1;case"Interactions":return 2;case"LayoutShifts":return 3;case"Extension":return 4;case"Thread":return 5;case"GPU":return 6;case"Thread_AuctionWorklet":return 7;default:return 8}},t=this.compatibilityTracksAppender?this.compatibilityTracksAppender.allVisibleTrackAppenders():[];t.sort(((t,i)=>e(t)-e(i)));for(const e of t)if(this.traceEngineData&&(this.currentLevel=e.appendTrackAtLevel(this.currentLevel),this.timelineDataInternal&&!this.timelineDataInternal.selectedGroup&&e instanceof Ei&&("MAIN_THREAD"===e.threadType||"CPU_PROFILE"===e.threadType))){const t=this.compatibilityTracksAppender?.groupForAppender(e);t&&(this.timelineDataInternal.selectedGroup=t)}this.timelineDataInternal&&this.timelineDataInternal.selectedGroup&&(this.timelineDataInternal.selectedGroup.expanded=!0)}minimumBoundary(){return this.minimumBoundaryInternal}totalTime(){return this.timeSpan}static timelineEntryIsTraceEvent(e){return e instanceof i.Handlers.ModelHandlers.Frames.TimelineFrame==!1}search(e,t,n){const r=[];this.timelineData();for(let a=0;a<this.entryData.length;++a){const s=this.entryData[a];if(!s)continue;if(!Fi.timelineEntryIsTraceEvent(s))continue;if(i.Types.TraceEvents.isTraceEventScreenshot(s))continue;const o=i.Helpers.Timing.eventTimingsMilliSeconds(s).startTime,l=i.Helpers.Timing.eventTimingsMilliSeconds(s).endTime;o>t||((l||o)<e||n.accept(s,this.traceEngineData||void 0)&&r.push(a))}return r.sort(((e,t)=>{const n=this.entryData.at(e);if(!n)return 0;const r=this.entryData.at(t);return r&&Fi.timelineEntryIsTraceEvent(n)&&Fi.timelineEntryIsTraceEvent(r)?i.Helpers.Trace.eventTimeComparator(n,r):0})),r}isIgnoreListedEvent(e){return!!i.Types.TraceEvents.isProfileCall(e)&&this.isIgnoreListedURL(e.callFrame.url)}isIgnoreListedURL(e){return b.IgnoreListManager.IgnoreListManager.instance().isUserIgnoreListedURL(e)}getEntryTypeForLevel(e){return this.entryTypeByLevel[e]}#fe(){if(!this.traceEngineData)return;const e=i.Extras.FilmStrip.fromTraceData(this.traceEngineData),t=e.frames.length>0;this.framesHeader.collapsible=t;const n="frames"===a.Runtime.Runtime.queryParam("flamechart-force-expand");this.appendHeader(Mi(Pi.frames),this.framesHeader,!1,n),this.entryTypeByLevel[this.currentLevel]="Frame";for(const e of this.traceEngineData.Frames.frames)this.#ye(e);++this.currentLevel,t&&this.#we(e)}#we(e){if(!this.timelineDataInternal||!this.traceEngineData)return;let t;this.appendHeader("",this.screenshotsHeader,!1),this.entryTypeByLevel[this.currentLevel]="Screenshot";for(const n of e.frames){const e=i.Helpers.Timing.microSecondsToMilliseconds(n.screenshotEvent.ts);this.entryData.push(n.screenshotEvent),this.timelineDataInternal.entryLevels.push(this.currentLevel),this.timelineDataInternal.entryStartTimes.push(e),t&&this.timelineDataInternal.entryTotalTimes.push(e-t),t=e}if(e.frames.length&&void 0!==t){const e=i.Helpers.Timing.traceWindowMilliSeconds(this.traceEngineData.Meta.traceBounds).max;this.timelineDataInternal.entryTotalTimes.push(e-t)}++this.currentLevel}#ge(e){const t=this.timelineData().entryLevels[e];return this.entryTypeByLevel[t]}prepareHighlightedEntryInfo(t){let n,r="",a=[],o="timeline-info-time";const l=[],c=this.#ge(t);if("TrackAppender"===c){if(!this.compatibilityTracksAppender)return null;const e=this.entryData[t],o=this.timelineDataInternal.entryLevels[t],c=this.compatibilityTracksAppender.highlightedEntryInfo(e,o);if(n=c.title,r=c.formattedTime,a=c.warningElements||a,i.Types.TraceEvents.isSyntheticInteractionEvent(e)){const t=new s.InteractionBreakdown.InteractionBreakdown;t.entry=e,l.push(t)}}else{if("Frame"!==c)return null;{const a=this.entryData[t];r=e.TimeUtilities.preciseMillisToString(i.Helpers.Timing.microSecondsToMilliseconds(a.duration),1),a.idle?n=Mi(Pi.idleFrame):a.dropped?(n=a.isPartial?Mi(Pi.partiallyPresentedFrame):Mi(Pi.droppedFrame),o="timeline-info-warning"):n=Mi(Pi.frame)}}const d=document.createElement("div"),h=u.UIUtils.createShadowRootWithCoreStyles(d,{cssFile:[xi],delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover");if(h.createChild("span",o).textContent=r,h.createChild("span","timeline-info-title").textContent=n,a)for(const e of a)e.classList.add("timeline-info-warning"),h.appendChild(e);for(const e of l)h.appendChild(e);return d}prepareHighlightedHiddenEntriesArrowInfo(e){const t=document.createElement("div"),i=u.UIUtils.createShadowRootWithCoreStyles(t,{cssFile:[xi],delegatesFocus:void 0}),n=this.entryData[e],r=Ne.activeManager()?.getEntriesFilter().findHiddenDescendantsAmount(n);if(!r)return null;return i.createChild("div","timeline-flamechart-popover").createChild("span","timeline-info-title").textContent=r+" hidden",t}entryColor(e){const t=this.#ge(e);if("Frame"===t)return"white";if("TrackAppender"===t){const t=this.timelineDataInternal.entryLevels[e],i=this.entryData[e];return this.compatibilityTracksAppender?.colorForEvent(i,t)||""}return""}preparePatternCanvas(){const e=17;this.droppedFramePatternCanvas.width=e,this.droppedFramePatternCanvas.height=e,this.partialFramePatternCanvas.width=e,this.partialFramePatternCanvas.height=e;const t=this.droppedFramePatternCanvas.getContext("2d");if(t){t.translate(8.5,8.5),t.rotate(.25*Math.PI),t.translate(-8.5,-8.5),t.fillStyle="rgb(255, 255, 255)";for(let e=-17;e<34;e+=3)t.fillRect(e,-17,1,51)}const i=this.partialFramePatternCanvas.getContext("2d");i&&(i.strokeStyle="rgb(255, 255, 255)",i.lineWidth=2,i.beginPath(),i.moveTo(17,0),i.lineTo(10,7),i.moveTo(8,9),i.lineTo(2,15),i.stroke())}drawFrame(t,n,r,a,s,o,l){const c=this.entryData[t];if(a+=1,o-=2,c.idle)n.fillStyle="white";else if(c.dropped)if(c.isPartial){n.fillStyle="#f0e442",n.fillRect(a,s,o,l);const e=n.createPattern(this.partialFramePatternCanvas,"repeat");n.fillStyle=e||n.fillStyle}else{n.fillStyle="#f08080",n.fillRect(a,s,o,l);const e=n.createPattern(this.droppedFramePatternCanvas,"repeat");n.fillStyle=e||n.fillStyle}else n.fillStyle="#d7f0d1";n.fillRect(a,s,o,l);const d=e.TimeUtilities.preciseMillisToString(i.Helpers.Timing.microSecondsToMilliseconds(c.duration),1),h=n.measureText(d).width;h<=o&&(n.fillStyle=this.textColor(t),n.fillText(d,a+(o-h)/2,s+l-4))}async drawScreenshot(e,t,i,n,r,a){const s=this.entryData[e];if(!this.screenshotImageCache.has(s)){this.screenshotImageCache.set(s,null);const e=s.args.dataUri,t=await u.UIUtils.loadImage(e);return this.screenshotImageCache.set(s,t),void this.dispatchEventToListeners("DataChanged")}const o=this.screenshotImageCache.get(s);if(!o)return;const l=i+1,c=n+1,d=a-2,h=d/o.naturalHeight,m=Math.floor(o.naturalWidth*h);t.save(),t.beginPath(),t.rect(i,n,r,a),t.clip(),t.drawImage(o,l,c,m,d),t.strokeStyle="#ccc",t.strokeRect(l-.5,c-.5,Math.min(r-1,m+1),d),t.restore()}decorateEntry(e,t,n,r,a,s,o,l,c){const d=this.#ge(e);if("Frame"===d)return this.drawFrame(e,t,n,r,a,s,o),!0;if("Screenshot"===d)return this.drawScreenshot(e,t,r,a,s,o),!0;if("TrackAppender"===d){const d=this.entryData[e];if(i.Types.TraceEvents.isSyntheticInteractionEvent(d))return this.#be(t,e,n,d,r,a,l,s,o,c),!0}return!1}#be(e,n,r,a,s,o,l,c,d,h){const m=i.Helpers.Timing.microSecondsToMilliseconds(a.ts),p=s+c;function g(e){const t=i.Helpers.Timing.microSecondsToMilliseconds(e);return Math.floor(l+(t-m)*h)}e.save(),e.fillStyle=t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container");let v=g(a.processingStart);const T=g(a.processingEnd);function f(t,i,n){e.moveTo(t,n-3),e.lineTo(t,n+3),e.moveTo(t,n),e.lineTo(i,n)}a.processingEnd-a.processingStart==0&&(v-=1),e.fillRect(s,o-.5,v-s,d),e.fillRect(T,o-.5,p-T,d);const y=g(a.ts),w=g(i.Types.Timing.MicroSeconds(a.ts+a.dur));e.beginPath(),e.lineWidth=1,e.strokeStyle="#ccc";const b=Math.floor(o+d/2)+.5,S=w-.5;if(f(y+.5,v,b),f(S,T,b),e.stroke(),r){const t=v>0?v:s;e.font=this.#me;const i=5,a=5;u.UIUtils.measureTextWidth(e,r)<=T-t+i&&(e.fillStyle=this.textColor(n),e.fillText(r,t+i,o+d-a))}e.restore()}forceDecoration(e){const t=this.#ge(e);if("Frame"===t)return!0;if("Screenshot"===t)return!0;const n=this.entryData[e];return!!i.Types.TraceEvents.isSyntheticInteractionEvent(n)||Boolean(this.traceEngineData?.Warnings.perEvent.get(n))}appendHeader(e,t,i,n){const r={startLevel:this.currentLevel,name:e,style:t,selectable:i,expanded:n};return this.timelineDataInternal.groups.push(r),r}#ye(t){const n=this.entryData.length;this.entryData.push(t);const r=i.Helpers.Timing.microSecondsToMilliseconds(t.duration);this.entryIndexToTitle[n]=e.TimeUtilities.millisToString(r,!0),this.timelineDataInternal&&(this.timelineDataInternal.entryLevels[n]=this.currentLevel,this.timelineDataInternal.entryTotalTimes[n]=r,this.timelineDataInternal.entryStartTimes[n]=i.Helpers.Timing.microSecondsToMilliseconds(t.startTime))}createSelection(e){const t=this.#ge(e);let i=null;const n=this.entryData[e];return n&&Fi.timelineEntryIsTraceEvent(n)?i=vt.fromTraceEvent(n):"Frame"===t&&(i=vt.fromFrame(this.entryData[e])),i&&(this.lastSelection=new Ji(i,e)),i}formatValue(t,i){return e.TimeUtilities.preciseMillisToString(t,i)}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||vt.isRangeSelection(e.object)||vt.isSyntheticNetworkRequestDetailsEventSelection(e.object))return-1;if(this.lastSelection&&this.lastSelection.timelineSelection.object===e.object)return this.lastSelection.entryIndex;-1===this.entryData.indexOf(e.object)&&vt.isTraceEventSelection(e.object)&&this.timelineDataInternal?.selectedGroup&&(Ne.activeManager()?.getEntriesFilter().revealEntry(e.object),this.timelineData(!0));const t=this.entryData.indexOf(e.object);return-1!==t&&(this.lastSelection=new Ji(e,t)),t}indexForEvent(e){const t=this.#pe.get(e);if(t)return t;const i=this.entryData.indexOf(e),n=i>-1?i:null;return this.#pe.set(e,n),n}buildFlowForInitiator(e){if(!this.traceEngineData)return!1;if(!this.timelineDataInternal)return!1;if(this.lastInitiatorEntry===e)return this.lastInitiatorsData&&(this.timelineDataInternal.initiatorsData=this.lastInitiatorsData),!1;if(!this.compatibilityTracksAppender)return!1;const t=this.timelineDataInternal.initiatorsData.length;if(-1===e)return this.lastInitiatorEntry=e,0!==t&&(this.timelineDataInternal.resetFlowData(),!0);if("TrackAppender"!==this.#ge(e))return!1;const i=this.entryData[e];this.timelineDataInternal.resetFlowData(),this.lastInitiatorEntry=e;const n=Ne.activeManager()?.getEntriesFilter().invisibleEntries()??[],r=Ne.activeManager()?.getEntriesFilter().expandableEntries()??[],a=vi(this.traceEngineData,i,n,r);if(0===t&&0===a.length)return!1;for(const e of a){const t=this.indexForEvent(e.event),i=this.indexForEvent(e.initiator);null!==t&&null!==i&&this.timelineDataInternal.initiatorsData.push({initiatorIndex:i,eventIndex:t,isInitiatorHidden:e.isInitiatorHidden,isEntryHidden:e.isEntryHidden})}return this.lastInitiatorsData=this.timelineDataInternal.initiatorsData,!0}eventByIndex(e){if(e<0)return null;const t=this.#ge(e);return"TrackAppender"===t||"Frame"===t?this.entryData[e]:null}}const Li=i.Types.Timing.MilliSeconds(.001);var Ri,Di=Object.freeze({__proto__:null,TimelineFlameChartDataProvider:Fi,InstantEventVisibleDurationMs:Li});function Ai(e){let i="--app-color-system";switch(e){case Ri.Doc:i="--app-color-doc";break;case Ri.JS:i="--app-color-scripting";break;case Ri.CSS:i="--app-color-css";break;case Ri.Img:i="--app-color-image";break;case Ri.Media:i="--app-color-media";break;case Ri.Font:i="--app-color-font";break;case Ri.Wasm:i="--app-color-wasm";break;case Ri.Other:default:i="--app-color-system"}return t.ThemeSupport.instance().getComputedValue(i)}function Ni(e){const t=function(e){switch(e.args.data.mimeType){case"text/html":return Ri.Doc;case"application/javascript":case"application/x-javascript":case"text/javascript":return Ri.JS;case"text/css":return Ri.CSS;case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/webp":case"image/x-icon":return Ri.Img;case"audio/aac":case"audio/midi":case"audio/x-midi":case"audio/mpeg":case"audio/ogg":case"audio/wav":case"audio/webm":return Ri.Media;case"font/opentype":case"font/woff2":case"font/ttf":case"application/font-woff":return Ri.Font;case"application/wasm":return Ri.Wasm;default:return Ri.Other}}(e);return Ai(t)}!function(e){e.Doc="Doc",e.CSS="CSS",e.JS="JS",e.Font="Font",e.Img="Img",e.Media="Media",e.Wasm="Wasm",e.Other="Other"}(Ri||(Ri={}));const Bi={network:"Network",wsConnectionOpened:"WebSocket opened",wsConnectionOpenedWithUrl:"WebSocket opened: {PH1}",wsConnectionClosed:"WebSocket closed"},Hi=e.i18n.registerUIStrings("panels/timeline/NetworkTrackAppender.ts",Bi),Ui=e.i18n.getLocalizedString.bind(void 0,Hi);class Wi{appenderName="Network";#Se;webSocketIdToLevel=new Map;#k=[];#me;#Ce;constructor(e,i){this.#Se=e,this.#k=i,this.#me=`${p.Font.DEFAULT_FONT_SIZE} ${p.Font.getFontFamilyForCanvas()}`,t.ThemeSupport.instance().addEventListener(t.ThemeChangeEvent.eventName,(()=>{this.#Ce&&(this.#Ce.style.color=t.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),this.#Ce.style.backgroundColor=t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"))}))}group(){return this.#Ce}font(){return this.#me}appendTrackAtLevel(e,t){return 0===this.#k.length?e:(this.#i(e,t),this.#Ee(this.#k,e))}#i(e,t){const i=U({shareHeaderLine:!1,useFirstLineForOverview:!1,useDecoratorsForOverview:!0}),n=[];for(const e in Ri)n.push({color:o.colorForNetworkCategory(e),category:e});this.#Ce=W("network",0,Ui(Bi.network),i,!0,t,!1,n),this.#Se.groups.push(this.#Ce)}#Ee(e,t){for(let n=0;n<e.length;++n){const r=e[n];this.#ke(r,t),i.Types.TraceEvents.isSyntheticNetworkRequestEvent(r)&&i.Helpers.Network.isSyntheticNetworkRequestEventRenderBlocking(r)&&_(this.#Se,n,{type:"WARNING_TRIANGLE",customEndTime:r.args.data.syntheticData.finishTime})}return this.relayoutEntriesWithinBounds(e,i.Types.Timing.MilliSeconds(-1/0),i.Types.Timing.MilliSeconds(1/0))}#ke(e,t){const n=this.#Se.entryLevels.length;this.#Se.entryLevels[n]=t,this.#Se.entryStartTimes[n]=i.Helpers.Timing.microSecondsToMilliseconds(e.ts);const r=e.dur||i.Helpers.Timing.millisecondsToMicroseconds(Li);return this.#Se.entryTotalTimes[n]=i.Helpers.Timing.microSecondsToMilliseconds(r),t}relayoutEntriesWithinBounds(e,t,n){if(!this.#Se||0===e.length)return 0;const r=[];this.webSocketIdToLevel=new Map;let a=0;for(let s=0;s<e.length;++s){const o=e[s],l=i.Helpers.Timing.microSecondsToMilliseconds(o.ts),c=o.dur?i.Helpers.Timing.microSecondsToMilliseconds(o.dur):Li;if(!(l<n&&l+c>t)){this.#Se.entryLevels[s]=-1;continue}let d;d="identifier"in o.args.data&&i.Types.TraceEvents.isWebSocketEvent(o)?this.getWebSocketLevel(o,r):V(o,r),this.#Se.entryLevels[s]=d,a=Math.max(a,r.length,d)}for(let t=0;t<e.length;++t)-1===this.#Se.entryLevels[t]&&(this.#Se.entryLevels[t]=a);return a}getWebSocketLevel(e,t){const i=e.args.data.identifier;let n;return this.webSocketIdToLevel.has(i)?n=this.webSocketIdToLevel.get(i)||0:(n=V(e,t),this.webSocketIdToLevel.set(i,n)),n}colorForEvent(e){if(i.Types.TraceEvents.isSyntheticWebSocketConnectionEvent(e))return"";if(i.Types.TraceEvents.isWebSocketTraceEvent(e))return Ai(Ri.JS);if(!i.Types.TraceEvents.isSyntheticNetworkRequestEvent(e))throw new Error(`Unexpected Network Request: The event's type is '${e.name}'`);return Ni(e)}titleForEvent(e){return e.name}highlightedEntryInfo(e){return{title:this.titleForEvent(e),formattedTime:O(e.dur)}}titleForWebSocketEvent(e){return i.Types.TraceEvents.isTraceEventWebSocketCreate(e)?e.args.data.url?Ui(Bi.wsConnectionOpenedWithUrl,{PH1:e.args.data.url}):Ui(Bi.wsConnectionOpened):i.Types.TraceEvents.isTraceEventWebSocketDestroy(e)?Ui(Bi.wsConnectionClosed):e.name}}var Oi=Object.freeze({__proto__:null,NetworkTrackAppender:Wi});class Vi{#xe;#Pe;#k;#Ie;#Me;#Fe;#Le;#A;#pe=new Map;#Re=-1;#De=[];constructor(){this.#xe=0,this.#Pe=0,this.#k=[],this.#Ie=0,this.#Me=null,this.#A=null}setModel(e){this.#Fe=null,this.#k=[],this.#A=e,this.#pe.clear(),this.#A&&(this.setEvents(this.#A),this.#Ae(this.#A))}setEvents(e){e.NetworkRequests.webSocket&&e.NetworkRequests.webSocket.forEach((e=>{e.syntheticConnectionEvent&&this.#k.push(e.syntheticConnectionEvent),this.#k.push(...e.events)})),e.NetworkRequests.byTime&&this.#k.push(...e.NetworkRequests.byTime)}isEmpty(){return this.timelineData(),!this.#k.length}maxStackDepth(){return this.#Ie}hasTrackConfigurationMode(){return!1}timelineData(){return this.#Fe&&0!==this.#Fe.entryLevels.length?this.#Fe:(this.#Fe=p.FlameChart.FlameChartTimelineData.createEmpty(),this.#A?(this.#k.length||this.setEvents(this.#A),this.#Me=new Wi(this.#Fe,this.#k),this.#Ie=this.#Me.appendTrackAtLevel(0),this.#Fe):this.#Fe)}minimumBoundary(){return this.#xe}totalTime(){return this.#Pe}setWindowTimes(e,t){this.#Ne(e,t)}createSelection(e){if(-1===e)return null;const t=this.#k[e];return this.#Le=new Ji(vt.fromTraceEvent(t),e),this.#Le.timelineSelection}customizedContextMenu(e,t){const n=this.eventByIndex(t);if(!n||!i.Types.TraceEvents.isSyntheticNetworkRequestEvent(n))return;const r=new R.NetworkRequest.TimelineNetworkRequest(n),a=new u.ContextMenu.ContextMenu(e,{useSoftMenu:!0});return a.appendApplicableItems(r),a}indexForEvent(e){if(e instanceof i.Handlers.ModelHandlers.Frames.TimelineFrame)return null;if(!i.Types.TraceEvents.isNetworkTrackEntry(e))return null;const t=this.#pe.get(e);if(void 0!==t)return t;const n=this.#k.indexOf(e),r=n>-1?n:null;return this.#pe.set(e,r),r}eventByIndex(e){return this.#k.at(e)??null}entryIndexForSelection(e){if(!e)return-1;if(this.#Le&&this.#Le.timelineSelection.object===e.object)return this.#Le.entryIndex;if(!vt.isNetworkEventSelection(e.object))return-1;const t=this.#k.indexOf(e.object);return-1!==t&&(this.#Le=new Ji(vt.fromTraceEvent(e.object),t)),t}entryColor(e){if(!this.#Me)throw new Error("networkTrackAppender should not be empty");return this.#Me.colorForEvent(this.#k[e])}textColor(e){return Ki.textColor}entryTitle(e){const t=this.#k[e];if(i.Types.TraceEvents.isWebSocketTraceEvent(t)||i.Types.TraceEvents.isSyntheticWebSocketConnectionEvent(t))return this.#Me?.titleForWebSocketEvent(t)||"";const n=new r.ParsedURL.ParsedURL(t.args.data.url);return n.isValid?`${n.displayName} (${n.host})`:t.args.data.url||null}entryFont(e){return this.#Me?.font()||null}getDecorationPixels(e,t,n){const r=i.Helpers.Timing.microSecondsToMilliseconds(e.ts),a=e=>t+(e-r)*n,s=i.Helpers.Timing.microSecondsToMilliseconds(e.ts),o=i.Helpers.Timing.microSecondsToMilliseconds(e.ts+e.dur),l=i.Helpers.Timing.microSecondsToMilliseconds(e.args.data.syntheticData.sendStartTime),c=i.Helpers.Timing.microSecondsToMilliseconds(e.args.data.syntheticData.downloadStart),d=Math.max(a(l),t),h=Math.max(a(c),d),m=Math.max(a(i.Helpers.Timing.microSecondsToMilliseconds(e.args.data.syntheticData.finishTime)),h);return{sendStart:d,headersEnd:h,finish:m,start:a(s),end:Math.max(a(o),m)}}decorateEntry(e,t,n,r,a,s,o,l,c){const d=this.#k[e];return i.Types.TraceEvents.isSyntheticWebSocketConnectionEvent(d)?this.#Be(e,t,a,o,l,c):!!i.Types.TraceEvents.isSyntheticNetworkRequestEvent(d)&&this.#He(e,t,n,r,a,s,o,l,c)}#He(e,n,r,a,s,o,l,c,d){const h=this.#k[e];if(!i.Types.TraceEvents.isSyntheticNetworkRequestEvent(h))return!1;const{sendStart:m,headersEnd:p,finish:g,start:v,end:T}=this.getDecorationPixels(h,c,d);function f(e,t,i){n.moveTo(e,i-3),n.lineTo(e,i+3),n.moveTo(e,i),n.lineTo(t,i)}n.fillStyle="hsla(0, 100%, 100%, 0.8)",n.fillRect(m+.5,s+.5,p-m-.5,l-2),n.fillStyle=t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container"),n.fillRect(a,s-.5,m-a,l),n.fillRect(g,s-.5,a+o-g,l),n.beginPath(),n.lineWidth=1,n.strokeStyle="#ccc";const y=Math.floor(s+l/2)+.5,w=T-.5;f(v+.5,m,y),f(w,g,y),n.stroke();const b=this.#Ue(h.args.data.priority);b&&(n.fillStyle=b,n.fillRect(m+.5,s+.5,3.5,3.5));const S=Math.max(m,0),C=g-S;if(C>=20){let t=this.entryTitle(e)||"";if(h.args.data.fromServiceWorker&&(t="⚙ "+t),t){const e=4,i=l-5,r=u.UIUtils.trimTextEnd(n,t,C-2*e);n.fillStyle="#333",n.fillText(r,S+e,s+i)}}return!0}#Be(e,n,r,a,s,o){n.save();const l=this.#k[e],c=i.Helpers.Timing.microSecondsToMilliseconds(l.ts),d=e=>Math.floor(s+(e-c)*o),h=i.Helpers.Timing.microSecondsToMilliseconds(l.ts+l.dur),m=d(c)+.5,p=d(h)-.5;n.strokeStyle=t.ThemeSupport.instance().getComputedValue("--app-color-rendering");const u=Math.floor(r+a/2)+.5;return n.setLineDash([3,2]),n.moveTo(m,u-1),n.lineTo(p,u-1),n.moveTo(m,u+1),n.lineTo(p,u+1),n.stroke(),n.restore(),!0}forceDecoration(e){return!0}forceDrawableLevel(e){return this.#Me?.webSocketIdToLevel.has(e)||!1}prepareHighlightedEntryInfo(e){const t=this.#k[e];if(i.Types.TraceEvents.isSyntheticNetworkRequestEvent(t)){const e=document.createElement("div"),i=u.UIUtils.createShadowRootWithCoreStyles(e,{cssFile:[xi],delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover"),n=new s.NetworkRequestTooltip.NetworkRequestTooltip;return n.networkRequest=t,i.appendChild(n),e}return null}#Ue(e){const t=p.NetworkPriorities.networkPriorityWeight(e);return t?`hsla(214, 80%, 50%, ${t/5})`:null}#Ae(e){const{traceBounds:t}=e.Meta,n=i.Helpers.Timing.microSecondsToMilliseconds(t.min),r=i.Helpers.Timing.microSecondsToMilliseconds(t.max);this.#xe=n,this.#Pe=n===r?1e3:r-this.#xe}#Ne(e,t){this.#Me&&this.#Fe&&(this.#Ie=this.#Me.relayoutEntriesWithinBounds(this.#k,e,t),this.#Fe=p.FlameChart.FlameChartTimelineData.create({entryLevels:this.#Fe?.entryLevels,entryTotalTimes:this.#Fe?.entryTotalTimes,entryStartTimes:this.#Fe?.entryStartTimes,groups:this.#Fe?.groups,initiatorsData:this.#Fe.initiatorsData,entryDecorations:this.#Fe.entryDecorations}))}preferredHeight(){if(!this.#Me||0===this.#Ie)return 0;const e=this.#Me.group();return e?e.style.height*(this.isExpanded()?c.NumberUtilities.clamp(this.#Ie+1,7,8.5):1):0}isExpanded(){return Boolean(this.#Me?.group()?.expanded)}formatValue(t,i){return e.TimeUtilities.preciseMillisToString(t,i)}canJumpToEntry(e){return!1}mainFrameNavigationStartEvents(){return this.#A?this.#A.Meta.mainFrameNavigations:[]}buildFlowForInitiator(e){if(!this.#A)return!1;if(!this.#Fe)return!1;if(this.#Re===e)return this.#De&&(this.#Fe.initiatorsData=this.#De),!0;if(!this.#Me)return!1;const t=this.#Fe.initiatorsData.length;if(-1===e)return this.#Re=e,0!==t&&(this.#Fe.resetFlowData(),!0);const i=this.#k[e];this.#Fe.resetFlowData(),this.#Re=e;const n=Ti(this.#A,i);if(0===t&&0===n.length)return!1;for(const e of n){const t=this.indexForEvent(e.event),i=this.indexForEvent(e.initiator);null!==t&&null!==i&&this.#Fe.initiatorsData.push({initiatorIndex:i,eventIndex:t})}return this.#De=this.#Fe.initiatorsData,!0}}var _i=Object.freeze({__proto__:null,TimelineFlameChartNetworkDataProvider:Vi});const zi=new CSSStyleSheet;zi.replaceSync(".timeline-overlays-container{position:absolute;top:0;left:0;right:0;bottom:0;z-index:200;pointer-events:none}.overlay-item{position:absolute;top:0;left:0}.overlay-type-ENTRY_SELECTED{pointer-events:none;border:2px solid var(--sys-color-primary);background-color:var(--sys-color-state-ripple-primary);&.cut-off-top{border-top:none}&.cut-off-bottom{border-bottom:none}}.overlay-type-TIME_RANGE{background:linear-gradient(180deg,rgb(255 125 210/0%) 0%,rgb(255 125 210/15%) 85%);border-color:var(--ref-palette-pink80);border-width:1px;border-style:solid;pointer-events:none;top:0;bottom:0;border-bottom-width:5px;&.overlap-1{bottom:55px;border-color:var(--ref-palette-pink70)}&.overlap-2{bottom:105px;border-color:var(--ref-palette-pink60)}}.overlay-type-CURSOR_TIMESTAMP_MARKER{top:0;bottom:0;width:2px;background-color:var(--sys-color-primary);pointer-events:none}.timeline-entry-tooltip-element:not(:empty){z-index:2000;position:absolute;contain:content;background-color:var(--sys-color-cdt-base-container);pointer-events:none;padding:4px 8px;white-space:nowrap;max-width:80%;box-shadow:var(--drop-shadow)}\n/*# sourceURL=timelineFlameChartView.css */\n");const Gi={sAtS:"{PH1} at {PH2}"},ji=e.i18n.registerUIStrings("panels/timeline/TimelineFlameChartView.ts",Gi),qi=e.i18n.getLocalizedString.bind(void 0,ji);class $i extends u.Widget.VBox{delegate;searchResults;eventListeners;networkSplitWidget;mainDataProvider;mainFlameChart;networkFlameChartGroupExpansionSetting;networkDataProvider;networkFlameChart;networkPane;splitResizer;chartSplitWidget;brickGame;countersView;detailsSplitWidget;detailsView;onMainAnnotateEntry;onNetworkAnnotateEntry;onMainEntrySelected;onNetworkEntrySelected;#We;#D;groupBySetting;searchableView;needsResizeToPreferredHeights;selectedSearchResult;searchRegex;#U;#Oe=null;#Ve=null;#x=this.#P.bind(this);#_e=0;#ze=setTimeout((()=>({})),0);#Ge=document.createElement("div");#je;#qe=null;#$e=[];#Je=null;#Ke=document.createElement("div");#Ye=new Map;constructor(e){super(),this.element.classList.add("timeline-flamechart"),this.delegate=e,this.eventListeners=[],this.#U=null;const t=new u.Widget.VBox;t.element.classList.add("flame-charts-container"),this.networkSplitWidget=new u.SplitWidget.SplitWidget(!1,!1,"timeline-flamechart-main-view",150),this.networkSplitWidget.show(t.element),this.#Ge.classList.add("timeline-overlays-container"),t.element.appendChild(this.#Ge),this.#Ke.classList.add("timeline-entry-tooltip-element"),t.element.appendChild(this.#Ke),this.networkSplitWidget.sidebarElement().style.zIndex="120";const i=r.Settings.Settings.instance().createSetting("timeline-flamechart-main-view-group-expansion",{});this.mainDataProvider=new Fi,this.mainDataProvider.addEventListener("DataChanged",(()=>this.mainFlameChart.scheduleUpdate())),this.mainFlameChart=new p.FlameChart.FlameChart(this.mainDataProvider,this,{groupExpansionSetting:i,selectedElementOutline:!1,tooltipElement:this.#Ke,useOverlaysForCursorRuler:!0}),this.mainFlameChart.alwaysShowVerticalScroll(),this.mainFlameChart.enableRuler(!1),this.mainFlameChart.addEventListener("LatestDrawDimensions",(e=>{this.#je.updateChartDimensions("main",e.data.chart),this.#je.updateVisibleWindow(e.data.traceWindow),this.#je.update()})),this.networkFlameChartGroupExpansionSetting=r.Settings.Settings.instance().createSetting("timeline-flamechart-network-view-group-expansion",{}),this.networkDataProvider=new Vi,this.networkFlameChart=new p.FlameChart.FlameChart(this.networkDataProvider,this,{groupExpansionSetting:this.networkFlameChartGroupExpansionSetting,selectedElementOutline:!1,tooltipElement:this.#Ke,useOverlaysForCursorRuler:!0}),this.networkFlameChart.alwaysShowVerticalScroll(),this.networkFlameChart.addEventListener("LatestDrawDimensions",(e=>{this.#je.updateChartDimensions("network",e.data.chart),this.#je.updateVisibleWindow(e.data.traceWindow),this.#je.update(),this.mainFlameChart.setTooltipYPixelAdjustment(this.#je.networkChartOffsetHeight())})),this.mainFlameChart.addEventListener("MouseMove",(e=>{this.#Xe(e.data)})),this.networkFlameChart.addEventListener("MouseMove",(e=>{this.#Xe(e.data)})),this.#je=new S.Overlays.Overlays({container:this.#Ge,charts:{mainChart:this.mainFlameChart,mainProvider:this.mainDataProvider,networkChart:this.networkFlameChart,networkProvider:this.networkDataProvider}}),this.#je.addEventListener(S.Overlays.AnnotationOverlayActionEvent.eventName,(e=>{const{overlay:t,action:i}=e;"Remove"===i?Ne.activeManager()?.removeAnnotationOverlay(t):"Update"===i&&Ne.activeManager()?.updateAnnotationOverlay(t)})),this.networkPane=new u.Widget.VBox,this.networkPane.setMinimumSize(23,23),this.networkFlameChart.show(this.networkPane.element),this.splitResizer=this.networkPane.element.createChild("div","timeline-flamechart-resizer"),this.networkSplitWidget.hideDefaultResizer(!0),this.networkSplitWidget.installResizer(this.splitResizer),this.networkSplitWidget.setMainWidget(this.mainFlameChart),this.networkSplitWidget.setSidebarWidget(this.networkPane),this.chartSplitWidget=new u.SplitWidget.SplitWidget(!1,!0,"timeline-counters-split-view-state"),this.countersView=new Qe(this.delegate),this.chartSplitWidget.setMainWidget(t),this.chartSplitWidget.setSidebarWidget(this.countersView),this.chartSplitWidget.hideDefaultResizer(),this.chartSplitWidget.installResizer(this.countersView.resizerElement()),this.detailsSplitWidget=new u.SplitWidget.SplitWidget(!1,!0,"timeline-panel-details-split-view-state"),this.detailsSplitWidget.element.classList.add("timeline-details-split"),this.detailsView=new pi(e),this.detailsSplitWidget.installResizer(this.detailsView.headerElement()),this.detailsSplitWidget.setMainWidget(this.chartSplitWidget),this.detailsSplitWidget.setSidebarWidget(this.detailsView),this.detailsSplitWidget.show(this.element),this.onMainAnnotateEntry=this.onAnnotateEntry.bind(this,this.mainDataProvider),this.onNetworkAnnotateEntry=this.onAnnotateEntry.bind(this,this.networkDataProvider),a.Runtime.experiments.isEnabled("perf-panel-annotations")&&(this.mainFlameChart.addEventListener("AnnotateEntry",this.onMainAnnotateEntry,this),this.networkFlameChart.addEventListener("AnnotateEntry",this.onNetworkAnnotateEntry,this)),this.onMainEntrySelected=this.onEntrySelected.bind(this,this.mainDataProvider),this.onNetworkEntrySelected=this.onEntrySelected.bind(this,this.networkDataProvider),this.mainFlameChart.addEventListener("EntrySelected",this.onMainEntrySelected,this),this.mainFlameChart.addEventListener("EntryInvoked",this.onMainEntrySelected,this),this.networkFlameChart.addEventListener("EntrySelected",this.onNetworkEntrySelected,this),this.networkFlameChart.addEventListener("EntryInvoked",this.onNetworkEntrySelected,this),this.mainFlameChart.addEventListener("EntryHighlighted",this.onEntryHighlighted,this),this.element.addEventListener("keydown",this.#Ze.bind(this)),this.#We=this.#Qe.bind(this),this.#D=null,this.groupBySetting=r.Settings.Settings.instance().createSetting("timeline-tree-group-by",zt.GroupBy.None),this.groupBySetting.addChangeListener(this.refreshMainFlameChart,this),this.refreshMainFlameChart(),h.TraceBounds.onChange(this.#x)}setActiveInsight(e){this.#Je=e;for(const e of this.#$e)this.removeOverlay(e);if(this.#Je&&e){const t=e.createOverlayFn();this.#$e=t;for(const e of this.#$e)this.addOverlay(e)}}#Xe(e){const{mouseEvent:t,timeInMicroSeconds:i}=e;if(!t.shiftKey){this.#je.removeOverlaysOfType("CURSOR_TIMESTAMP_MARKER")>0&&this.#je.update()}!t.metaKey&&t.shiftKey&&this.addOverlay({type:"CURSOR_TIMESTAMP_MARKER",timestamp:i})}#Ze(e){const t="fixme";e.key===t[this.#_e]?(this.#_e++,clearTimeout(this.#ze),this.#ze=setTimeout((()=>{this.#_e=0}),2e3)):(this.#_e=0,clearTimeout(this.#ze)),5===this.#_e&&this.fixMe()}fixMe(){}#P(e){if("MINIMAP_BOUNDS"===e.updateType)return;const t=e.state.milli.timelineTraceWindow,i=Boolean(e.options.shouldAnimate);this.mainFlameChart.setWindowTimes(t.min,t.max,i),this.networkDataProvider.setWindowTimes(t.min,t.max),this.networkFlameChart.setWindowTimes(t.min,t.max,i),this.updateSearchResults(!1,!1)}isNetworkTrackShownForTests(){return"OnlyMain"!==this.networkSplitWidget.showMode()}getMainDataProvider(){return this.mainDataProvider}refreshMainFlameChart(){this.mainFlameChart.update()}extensionDataVisibilityChanged(){this.#et(),this.mainDataProvider.reset(!0),this.mainDataProvider.timelineData(!0),this.refreshMainFlameChart()}windowChanged(e,t,n){h.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(i.Helpers.Timing.traceWindowFromMilliSeconds(i.Types.Timing.MilliSeconds(e),i.Types.Timing.MilliSeconds(t)),{shouldAnimate:n})}updateRangeSelection(e,t){if(this.delegate.select(vt.fromRange(e,t)),a.Runtime.experiments.isEnabled("perf-panel-annotations")){const n=i.Helpers.Timing.traceWindowFromMilliSeconds(i.Types.Timing.MilliSeconds(e),i.Types.Timing.MilliSeconds(t));this.#qe?this.updateExistingOverlay(this.#qe,{bounds:n}):this.#qe=this.addOverlay({type:"TIME_RANGE",label:"",showDuration:!0,bounds:n})}}getMainFlameChart(){return this.mainFlameChart}getNetworkFlameChart(){return this.networkFlameChart}updateSelectedGroup(e,t){e===this.mainFlameChart&&this.#Ve!==t?.name&&(this.#Ve=t?.name||null,this.#D=t?this.mainDataProvider.groupTreeEvents(t):null,this.#tt())}setModel(e,t=!1){e!==this.#U&&(this.#Ve=null,this.#U=e,r.EventTarget.removeEventListeners(this.eventListeners),this.#D=null,this.mainDataProvider.setModel(e,t),this.networkDataProvider.setModel(e),this.#et(),this.updateSearchResults(!1,!1),this.refreshMainFlameChart(),this.#it())}setInsights(e){this.#Oe!==e&&(this.#Oe=e)}#et(){this.networkDataProvider.isEmpty()?(this.mainFlameChart.enableRuler(!0),this.networkSplitWidget.hideSidebar()):(this.mainFlameChart.enableRuler(!1),this.networkSplitWidget.showBoth(),this.resizeToPreferredHeights()),this.#je.reset(),this.mainFlameChart.reset(),this.networkFlameChart.reset(),this.updateSearchResults(!1,!1);const e=h.TraceBounds.BoundsManager.instance().state();if(!e)throw new Error("TimelineFlameChartView could not set the window bounds.");const t=e.milli.timelineTraceWindow;this.mainFlameChart.setWindowTimes(t.min,t.max),this.networkDataProvider.setWindowTimes(t.min,t.max),this.networkFlameChart.setWindowTimes(t.min,t.max)}#Qe(){this.mainDataProvider.timelineData(!0),this.mainFlameChart.scheduleUpdate()}#tt(){this.countersView.setModel(this.#U,this.#D),this.detailsView.setModel(this.#U,this.#D)}#it(){this.mainFlameChart.scheduleUpdate(),this.networkFlameChart.scheduleUpdate(),this.#nt()}#nt(){const e=[...this.mainFlameChart.timelineData()?.groups??[],...this.networkFlameChart.timelineData()?.groups??[]];for(const t of e){if(!t.jslogContext)continue;const e=this.#Ye.get(t.jslogContext)??Symbol(t.jslogContext);this.#Ye.has(t.jslogContext)||(this.#Ye.set(t.jslogContext,e),g.registerLoggable(e,`${g.section().context(`timeline.${t.jslogContext}`)}`,this.delegate.element))}}onEntryHighlighted(e){n.OverlayModel.OverlayModel.hideDOMNodeHighlight();const t=e.data,r=this.mainDataProvider.eventByIndex(t);if(!r||!this.#U)return;if(r instanceof i.Handlers.ModelHandlers.Frames.TimelineFrame)return;const a=rt(this.#U,r);if(!a)return;const s=i.Extras.FetchNodes.nodeIdsForEvent(this.#U,r);for(const e of s)new n.DOMModel.DeferredDOMNode(a,e).highlight()}highlightEvent(e){const t=e?this.mainDataProvider.entryIndexForSelection(vt.fromTraceEvent(e)):-1;t>=0?this.mainFlameChart.highlightEntry(t):this.mainFlameChart.hideHighlight()}willHide(){this.networkFlameChartGroupExpansionSetting.removeChangeListener(this.resizeToPreferredHeights,this),b.IgnoreListManager.IgnoreListManager.instance().removeChangeListener(this.#We)}wasShown(){this.registerCSSFiles([zi]),this.networkFlameChartGroupExpansionSetting.addChangeListener(this.resizeToPreferredHeights,this),b.IgnoreListManager.IgnoreListManager.instance().addChangeListener(this.#We),this.needsResizeToPreferredHeights&&this.resizeToPreferredHeights(),this.#it()}updateCountersGraphToggle(e){e?this.chartSplitWidget.showBoth():this.chartSplitWidget.hideSidebar()}setSelection(e){const t=this.mainDataProvider.entryIndexForSelection(e),i=this.networkDataProvider.entryIndexForSelection(e);this.mainFlameChart.setSelectedEntry(t),this.networkFlameChart.setSelectedEntry(i),this.#je.removeOverlaysOfType("ENTRY_SELECTED"),null!==e&&vt.isRangeSelection(e.object)||!this.#qe||(this.#je.remove(this.#qe),this.#qe=null);let n=this.mainDataProvider.entryIndexForSelection(e);this.mainFlameChart.setSelectedEntry(n),n=this.networkDataProvider.entryIndexForSelection(e),this.networkFlameChart.setSelectedEntry(n),this.detailsView&&this.detailsView.setSelection(e),e&&(vt.isTraceEventSelection(e.object)||vt.isSyntheticNetworkRequestDetailsEventSelection(e.object)||vt.isFrameObject(e.object))&&this.addOverlay({type:"ENTRY_SELECTED",entry:e.object})}addOverlay(e){const t=this.#je.add(e);return this.#je.update(),t}removeOverlay(e){this.#je.remove(e),this.#je.update()}updateExistingOverlay(e,t){this.#je.updateExisting(e,t),this.#je.update()}onAnnotateEntry(e,t){const i=e.createSelection(t.data);i&&(vt.isTraceEventSelection(i.object)||vt.isSyntheticNetworkRequestDetailsEventSelection(i.object))&&(this.setSelection(i),Ne.activeManager()?.createAnnotation({type:"ENTRY_LABEL",entry:i.object,label:""}))}onEntrySelected(e,t){const i=e.timelineData();if(!i)return;const n=t.data,r=i.entryLevels[n],a=Xi(i.groups,r);if(a&&a.jslogContext){const e=this.#Ye.get(a.jslogContext)??null;e&&g.logClick(e,new MouseEvent("click"))}e.buildFlowForInitiator(n),this.delegate.select(e.createSelection(n))}resizeToPreferredHeights(){this.isShowing()?(this.needsResizeToPreferredHeights=!1,this.networkPane.element.classList.toggle("timeline-network-resizer-disabled",!this.networkDataProvider.isExpanded()),this.networkSplitWidget.setSidebarSize(this.networkDataProvider.preferredHeight()+this.splitResizer.clientHeight+p.FlameChart.RulerHeight+2)):this.needsResizeToPreferredHeights=!0}setSearchableView(e){this.searchableView=e}jumpToNextSearchResult(){if(!this.searchResults||!this.searchResults.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):-1;this.selectSearchResult(c.NumberUtilities.mod(e+1,this.searchResults.length))}jumpToPreviousSearchResult(){if(!this.searchResults||!this.searchResults.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):0;this.selectSearchResult(c.NumberUtilities.mod(e-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}selectSearchResult(e){this.searchableView.updateCurrentMatchIndex(e),this.searchResults&&(this.selectedSearchResult=this.searchResults[e],this.delegate.select(this.mainDataProvider.createSelection(this.selectedSearchResult)),this.mainFlameChart.showPopoverForSearchResult(this.selectedSearchResult))}updateSearchResults(e,t){const i=h.TraceBounds.BoundsManager.instance().state();if(!i)return;const n=this.selectedSearchResult;if(delete this.selectedSearchResult,this.searchResults=[],this.mainFlameChart.removeSearchResultHighlights(),!this.searchRegex)return;const r=new At(this.searchRegex),a=i.milli.timelineTraceWindow;if(this.searchResults=this.mainDataProvider.search(a.min,a.max,r),this.searchableView.updateSearchMatchesCount(this.searchResults.length),this.searchResults.length<=200&&this.mainFlameChart.highlightAllEntries(this.searchResults),!e||!this.searchResults.length)return;let s=this.searchResults.indexOf(n);-1===s&&(s=t?this.searchResults.length-1:0),this.selectSearchResult(s)}getSearchResults(){return this.searchResults}onSearchCanceled(){void 0!==this.selectedSearchResult&&this.delegate.select(null),delete this.searchResults,delete this.selectedSearchResult,delete this.searchRegex,this.mainFlameChart.showPopoverForSearchResult(-1),this.mainFlameChart.removeSearchResultHighlights()}performSearch(e,t,i){this.searchRegex=e.toSearchRegex().regex,this.updateSearchResults(t,i)}}class Ji{timelineSelection;entryIndex;constructor(e,t){this.timelineSelection=e,this.entryIndex=t}}const Ki={textColor:"#333"};class Yi{startTimeInternal;startOffset;style;constructor(e,t,i){this.startTimeInternal=e,this.startOffset=t,this.style=i}startTime(){return this.startTimeInternal}color(){return this.style.color}title(){if(this.style.lowPriority)return null;const t=e.TimeUtilities.millisToString(this.startOffset);return qi(Gi.sAtS,{PH1:this.style.title,PH2:t})}draw(e,t,i,n){this.style.lowPriority&&n<4||(e.save(),this.style.tall&&(e.strokeStyle=this.style.color,e.lineWidth=this.style.lineWidth,e.translate(this.style.lineWidth<1||1&this.style.lineWidth?.5:0,.5),e.beginPath(),e.moveTo(t,0),e.setLineDash(this.style.dashStyle),e.lineTo(t,e.canvas.height),e.stroke()),e.restore())}}function Xi(e,t){return e.find(((i,n)=>{const r=e.at(n+1),a=r?r.startLevel-1:1/0;return i.startLevel<=t&&a>=t}))??null}var Zi=Object.freeze({__proto__:null,TimelineFlameChartView:$i,Selection:Ji,FlameChartStyle:Ki,TimelineFlameChartMarker:Yi,groupForLevel:Xi});const Qi={net:"NET",cpu:"CPU",heap:"HEAP",sSDash:"{PH1} – {PH2}"},en=e.i18n.registerUIStrings("panels/timeline/TimelineEventOverview.ts",Qi),tn=e.i18n.getLocalizedString.bind(void 0,en);class nn extends p.TimelineOverviewPane.TimelineOverviewBase{constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}renderBar(e,t,i,n,r){const a=e,s=t-e,o=this.context();o.fillStyle=r,o.fillRect(a,i,s,n)}}const rn=new Set(["VeryHigh","High","Medium"]);class an extends nn{#t;constructor(e){super("network",tn(Qi.net)),this.#t=e}update(e,t){this.resetCanvas(),this.#rt(e,t)}#rt(e,t){if(!this.#t)return;const n=e&&t?{min:e,max:t,range:t-e}:i.Helpers.Timing.traceWindowMilliSeconds(this.#t.Meta.traceBounds),r=this.height()/2,a=this.width(),s=a/n.range,o=new Path2D,l=new Path2D;for(const e of this.#t.NetworkRequests.byTime){const t=rn.has(e.args.data.priority)?o:l,{startTime:c,endTime:d}=i.Helpers.Timing.eventTimingsMilliSeconds(e),h=Math.max(Math.floor((c-n.min)*s),0),m=Math.min(Math.ceil((d-n.min)*s+1),a);t.rect(h,0,m-h,r-1)}const c=this.context();c.save(),c.fillStyle="hsl(214, 60%, 60%)",c.fill(o),c.translate(0,r),c.fillStyle="hsl(214, 80%, 80%)",c.fill(l),c.restore()}}const sn=new WeakMap;class on extends nn{backgroundCanvas;#t;#at=!1;#st;#ot;constructor(e){super("cpu-activity",tn(Qi.cpu)),this.#t=e,this.backgroundCanvas=this.element.createChild("canvas","fill background"),this.#st=i.Helpers.Timing.traceWindowMilliSeconds(e.Meta.traceBounds).min,this.#ot=i.Helpers.Timing.traceWindowMilliSeconds(e.Meta.traceBounds).max}#lt(e){if(i.Types.TraceEvents.isProfileCall(e)&&"(idle)"===e.callFrame.functionName)return ie.IDLE;return(de(e.name)?.category||me().other).name}resetCanvas(){super.resetCanvas(),this.#at=!1,this.backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this.backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}#ct(e){const t=4*window.devicePixelRatio,n=this.width(),r=this.height(),a=r,s=this.#ot-this.#st,o=t/(n/s),l=me(),c=Te(),d=c.indexOf(ie.OTHER);console.assert(0===c.indexOf(ie.IDLE));for(let e=0;e<c.length;++e)sn.set(l[c[e]],e);const h=(e,h)=>{const m=new hn(this.#st,o,(function(e){let i=a;for(let n=1;n<c.length;++n){i-=(e[n]||0)/o*r,g[n].bezierCurveTo(p,v[n],p,i,p+t/2,i),v[n]=i}p+=t}));let p=0;const u=[],g=[],v=[];for(let e=0;e<c.length;++e)g[e]=new Path2D,g[e].moveTo(0,r),v[e]=r;const T=i.Helpers.Timing.millisecondsToMicroseconds(this.#st),f=i.Helpers.Timing.millisecondsToMicroseconds(this.#ot),y={min:T,max:f,range:i.Types.Timing.MicroSeconds(f-T)},w=i.Types.Timing.MicroSeconds(y.range>2e5?16e3:0);i.Helpers.TreeHelpers.walkEntireTree(h.entryToNode,h.tree,(e=>{const t=this.#lt(e);if(!t||"idle"===t)return;const n=i.Helpers.Timing.microSecondsToMilliseconds(e.ts),r=u.length?u[u.length-1]:0;m.appendInterval(n,r);const a=c.indexOf(t);u.push(a||d)}),(function(e){const t=i.Helpers.Timing.microSecondsToMilliseconds(e.ts)+i.Helpers.Timing.microSecondsToMilliseconds(i.Types.Timing.MicroSeconds(e.dur||0)),n=u.pop();void 0!==t&&n&&m.appendInterval(t,n)}),y,w),m.appendInterval(this.#st+s+o,0);for(let t=c.length-1;t>0;--t){g[t].lineTo(n,r);const i=l[c[t]].getComputedColorValue();e.fillStyle=i,e.fill(g[t]),e.strokeStyle="white",e.lineWidth=1,e.stroke(g[t])}},m=this.backgroundCanvas.getContext("2d");if(!m)throw new Error("Could not find 2d canvas");const p=i.Handlers.Threads.threadsInTrace(e),u=this.context();for(const e of p){h("MAIN_THREAD"===e.type||"CPU_PROFILE"===e.type?u:m,e)}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let i=.5;i<n+r;i+=t)e.moveTo(i,0),e.lineTo(i-r,r);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(m)}update(){const e=h.TraceBounds.BoundsManager.instance().state(),t=e?.milli.minimapTraceBounds;t&&(t.min===this.#st&&t.max===this.#ot&&this.#at||(this.#st=t.min,this.#ot=t.max,this.resetCanvas(),this.#at=!0,this.#ct(this.#t)))}}class ln extends nn{#t;constructor(e){super("responsiveness",null),this.#t=e}#dt(){const{topLevelRendererIds:e}=this.#t.Meta,t=new Set(["LONG_TASK","FORCED_REFLOW","IDLE_CALLBACK_OVER_TIME"]),i=new Set;for(const n of t){const t=this.#t.Warnings.perWarning.get(n);if(t)for(const n of t)e.has(n.pid)&&i.add(n)}return i}update(e,t){this.resetCanvas();const n=this.height(),r=e&&t?{min:i.Helpers.Timing.millisecondsToMicroseconds(e),max:i.Helpers.Timing.millisecondsToMicroseconds(t),range:i.Helpers.Timing.millisecondsToMicroseconds(i.Types.Timing.MilliSeconds(t-e))}:this.#t.Meta.traceBounds,a=r.range,s=this.width()/a,o=this.context(),l=new Path2D,c=new Path2D,d=this.#dt();for(const e of d)h(e);function h(e){const{startTime:t,duration:a}=i.Helpers.Timing.eventTimingsMicroSeconds(e),o=Math.round(s*(t-r.min)),d=Math.round(s*a);l.rect(o,0,d,n),c.moveTo(o+d,0),c.lineTo(o+d,n)}o.fillStyle="hsl(0, 80%, 90%)",o.strokeStyle="red",o.lineWidth=2*window.devicePixelRatio,o.fill(l),o.stroke(c)}}class cn extends nn{frameToImagePromise;lastFrame=null;lastElement;drawGeneration;emptyImage;#G=null;constructor(e){super("filmstrip",null),this.frameToImagePromise=new Map,this.#G=e,this.lastFrame=null,this.lastElement=null,this.reset()}update(e,t){this.resetCanvas();const i=this.#G?this.#G.frames:[];if(!i.length)return;if(0===this.height())return void console.warn("TimelineFilmStrip could not be drawn as its canvas height is 0");const n=Symbol("drawGeneration");this.drawGeneration=n,this.imageByFrame(i[0]).then((i=>{if(this.drawGeneration!==n)return;if(!i||!i.naturalWidth||!i.naturalHeight)return;const r=this.height()-2*cn.Padding,a=Math.ceil(r*i.naturalWidth/i.naturalHeight),s=Math.min(200/i.naturalWidth,1);this.emptyImage=new Image(i.naturalWidth*s,i.naturalHeight*s),this.drawFrames(a,r,e,t)}))}async imageByFrame(e){let t=this.frameToImagePromise.get(e);return t||(t=u.UIUtils.loadImage(e.screenshotEvent.args.dataUri),this.frameToImagePromise.set(e,t)),t}drawFrames(e,t,n,r){if(!e)return;if(!this.#G||this.#G.frames.length<1)return;const a=cn.Padding,s=this.width(),o=n??i.Helpers.Timing.microSecondsToMilliseconds(this.#G.zeroTime),l=(r?r-o:i.Helpers.Timing.microSecondsToMilliseconds(this.#G.spanTime))/s,c=this.context(),d=this.drawGeneration;c.beginPath();for(let n=a;n<s;n+=e+2*a){const r=i.Types.Timing.MilliSeconds(o+(n+e/2)*l),a=i.Helpers.Timing.millisecondsToMicroseconds(r),s=i.Extras.FilmStrip.frameClosestToTimestamp(this.#G,a);s&&(c.rect(n-.5,.5,e+1,t+1),this.imageByFrame(s).then(h.bind(this,n)))}function h(i,n){this.drawGeneration===d&&n&&c.drawImage(n,i,1,e,t)}c.strokeStyle="#ddd",c.stroke()}async overviewInfoPromise(e){if(!this.#G||0===this.#G.frames.length)return null;const t=this.calculator();if(!t)return null;const n=i.Types.Timing.MilliSeconds(t.positionToTime(e)),r=i.Helpers.Timing.millisecondsToMicroseconds(n),a=i.Extras.FilmStrip.frameClosestToTimestamp(this.#G,r);if(a===this.lastFrame)return this.lastElement;const s=a?this.imageByFrame(a):Promise.resolve(this.emptyImage),o=await s,l=document.createElement("div");return l.classList.add("frame"),o&&l.createChild("div","thumbnail").appendChild(o),this.lastFrame=a,this.lastElement=l,l}reset(){this.lastFrame=null,this.lastElement=null,this.frameToImagePromise=new Map}static Padding=2}class dn extends nn{heapSizeLabel;#t;constructor(e){super("memory",tn(Qi.heap)),this.heapSizeLabel=this.element.createChild("div","memory-graph-label"),this.#t=e}resetHeapSizeLabels(){this.heapSizeLabel.textContent=""}update(e,t){this.resetCanvas();const n=window.devicePixelRatio;if(0===this.#t.Memory.updateCountersByProcess.size)return void this.resetHeapSizeLabels();const r=Array.from(this.#t.Meta.topLevelRendererIds).map((e=>this.#t.Memory.updateCountersByProcess.get(e)||[])).filter((e=>e.length>0)),a=3*n;let s=0,o=1e11;const l=e&&t?{min:e,max:t,range:t-e}:i.Helpers.Timing.traceWindowMilliSeconds(this.#t.Meta.traceBounds),d=l.min,h=l.max;function m(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(s=Math.max(s,t.jsHeapSizeUsed),o=Math.min(o,t.jsHeapSizeUsed))}for(let e=0;e<r.length;e++)r[e].forEach(m);o=Math.min(o,s);const p=this.width(),u=this.height()-a,g=p/(h-d),v=(u-1)/Math.max(s-o,1),T=new Array(p);function f(e){const t=e.args.data;if(!t||!t.jsHeapSizeUsed)return;const{startTime:n}=i.Helpers.Timing.eventTimingsMilliSeconds(e),r=Math.round((n-d)*g),a=Math.round((t.jsHeapSizeUsed-o)*v);T[r]=Math.max(T[r]||0,a)}for(let e=0;e<r.length;e++)r[e].forEach(f);const y=this.context(),w=u+a+1;y.translate(.5,.5),y.beginPath(),y.moveTo(-1,w);let b=0,S=!0,C=0;for(let e=0;e<T.length;e++){if(void 0===T[e])continue;S&&(S=!1,b=T[e],y.lineTo(-1,u-b));const t=T[e];Math.abs(t-b)>2&&Math.abs(e-C)>1&&y.lineTo(e,u-b),b=t,y.lineTo(e,u-b),C=e}y.lineTo(p+1,u-b),y.lineTo(p+1,w),y.closePath(),y.fillStyle="hsla(220, 90%, 70%, 0.2)",y.fill(),y.lineWidth=1,y.strokeStyle="hsl(220, 90%, 70%)",y.stroke(),this.heapSizeLabel.textContent=tn(Qi.sSDash,{PH1:c.NumberUtilities.bytesToString(o),PH2:c.NumberUtilities.bytesToString(s)})}}class hn{lastTime;quantDuration;callback;counters;remainder;constructor(e,t,i){this.lastTime=e,this.quantDuration=t,this.callback=i,this.counters=[],this.remainder=t}appendInterval(e,t){let i=e-this.lastTime;if(i<=this.remainder)return this.counters[t]=(this.counters[t]||0)+i,this.remainder-=i,void(this.lastTime=e);for(this.counters[t]=(this.counters[t]||0)+this.remainder,this.callback(this.counters),i-=this.remainder;i>=this.quantDuration;){const e=[];e[t]=this.quantDuration,this.callback(e),i-=this.quantDuration}this.counters=[],this.counters[t]=i,this.lastTime=e,this.remainder=this.quantDuration-i}}var mn=Object.freeze({__proto__:null,TimelineEventOverview:nn,TimelineEventOverviewNetwork:an,TimelineEventOverviewCPUActivity:on,TimelineEventOverviewResponsiveness:ln,TimelineFilmStripOverview:cn,TimelineEventOverviewMemory:dn,Quantizer:hn});const pn=new CSSStyleSheet;pn.replaceSync(".drop-down{padding:1px;box-shadow:var(--drop-shadow);background:var(--sys-color-cdt-base-container)}.preview-item{border-color:transparent;border-style:solid;border-width:1px 5px;padding:2px 0;margin:2px 1px}.preview-item.selected{border-color:var(--sys-color-primary)}.preview-item canvas{width:100%;height:100%}.text-details{font-size:11px;padding:3px}.text-details span{flex:1 0;padding-left:8px;padding-right:8px}.text-details .name{font-weight:bold}.text-details span.time{color:var(--sys-color-token-subtle);text-align:right}.screenshot-thumb{display:flex;border:1px solid var(--sys-color-neutral-outline);margin:2px 4px}.screenshot-thumb img{margin:auto;max-width:100%;max-height:100%}\n/*# sourceURL=timelineHistoryManager.css */\n");const un={currentSessionSS:"Current Session: {PH1}. {PH2}",noRecordings:"(no recordings)",sAgo:"({PH1} ago)",moments:"moments",sM:"{PH1} m",sH:"{PH1} h",sD:"{PH1} #{PH2}",selectTimelineSession:"Select Timeline Session"},gn=e.i18n.registerUIStrings("panels/timeline/TimelineHistoryManager.ts",un),vn=e.i18n.getLocalizedString.bind(void 0,gn);class Tn{recordings;action;nextNumberByDomain;buttonInternal;allOverviews;totalHeight;enabled;lastActiveTraceIndex=null;#ht;constructor(e){this.recordings=[],this.#ht=e,this.action=u.ActionRegistry.ActionRegistry.instance().getAction("timeline.show-history"),this.nextNumberByDomain=new Map,this.buttonInternal=new Sn(this.action),u.ARIAUtils.markAsMenuButton(this.buttonInternal.element),this.clear(),this.allOverviews=[{constructor:e=>{const t=this.#ht?.getControls().find((e=>e instanceof ln));return t||new ln(e)},height:3},{constructor:e=>{const t=this.#ht?.getControls().find((e=>e instanceof on));return t||new on(e)},height:20},{constructor:e=>{const t=this.#ht?.getControls().find((e=>e instanceof an));return t||new an(e)},height:8}],this.totalHeight=this.allOverviews.reduce(((e,t)=>e+t.height),0),this.enabled=!0}addRecording(e){const{traceParseDataIndex:t}=e.data,i=e.filmStripForPreview;this.lastActiveTraceIndex=t,this.recordings.unshift({traceParseDataIndex:t}),this.#mt(t,e.traceParsedData,i,e.startTime);const n=this.title(t);this.buttonInternal.setText(n);const r=this.action.title();if(u.ARIAUtils.setLabel(this.buttonInternal.element,vn(un.currentSessionSS,{PH1:n,PH2:r})),this.updateState(),this.recordings.length<=fn)return;const a=this.recordings.reduce(((e,t)=>s(e.traceParseDataIndex)<s(t.traceParseDataIndex)?e:t));function s(e){const t=Tn.dataForTraceIndex(e);if(!t)throw new Error("Unable to find data for model");return t.lastUsed}this.recordings.splice(this.recordings.indexOf(a),1)}setEnabled(e){this.enabled=e,this.updateState()}button(){return this.buttonInternal}clear(){this.recordings=[],this.lastActiveTraceIndex=null,this.updateState(),this.buttonInternal.setText(vn(un.noRecordings)),this.nextNumberByDomain.clear()}async showHistoryDropDown(){if(this.recordings.length<2||!this.enabled)return null;const e=await bn.show(this.recordings.map((e=>e.traceParseDataIndex)),this.lastActiveTraceIndex,this.buttonInternal.element);if(null===e)return null;const t=this.recordings.findIndex((t=>t.traceParseDataIndex===e));return t<0?(console.assert(!1,"selected recording not found"),null):(this.setCurrentModel(e),this.recordings[t])}cancelIfShowing(){bn.cancelIfShowing()}navigate(e){if(!this.enabled||null===this.lastActiveTraceIndex)return null;const t=this.recordings.findIndex((e=>e.traceParseDataIndex===this.lastActiveTraceIndex));if(t<0)return null;const i=c.NumberUtilities.clamp(t+e,0,this.recordings.length-1),{traceParseDataIndex:n}=this.recordings[i];return this.setCurrentModel(n),this.recordings[i]}setCurrentModel(e){const t=Tn.dataForTraceIndex(e);if(!t)throw new Error("Unable to find data for model");t.lastUsed=Date.now(),this.lastActiveTraceIndex=e;const i=this.title(e),n=this.action.title();this.buttonInternal.setText(i),u.ARIAUtils.setLabel(this.buttonInternal.element,vn(un.currentSessionSS,{PH1:i,PH2:n}))}updateState(){this.action.setEnabled(this.recordings.length>1&&this.enabled)}static previewElement(e){const t=Tn.dataForTraceIndex(e);if(!t)throw new Error("Unable to find data for model");const i=t.startTime;return t.time.textContent=i?vn(un.sAgo,{PH1:Tn.coarseAge(i)}):"",t.preview}static coarseAge(e){const t=Math.round((Date.now()-e)/1e3);if(t<50)return vn(un.moments);const i=Math.round(t/60);if(i<50)return vn(un.sM,{PH1:i});const n=Math.round(i/60);return vn(un.sH,{PH1:n})}title(e){const t=Tn.dataForTraceIndex(e);if(!t)throw new Error("Unable to find data for model");return t.title}#mt(e,t,i,n){const a=r.ParsedURL.ParsedURL.fromString(t.Meta.mainFrameURL),s=a?a.host:"",o=this.nextNumberByDomain.get(s)||1,l=vn(un.sD,{PH1:s,PH2:o});this.nextNumberByDomain.set(s,o+1);const c=document.createElement("span"),d=document.createElement("div");d.classList.add("preview-item"),d.classList.add("vbox"),d.setAttribute("jslog",`${g.dropDown("timeline.history-item").track({click:!0})}`);const h={preview:d,title:l,time:c,lastUsed:Date.now(),startTime:n};wn.set(e,h),d.appendChild(this.#pt(t,s,c));const m=d.createChild("div","hbox");return m.appendChild(this.#ut(i)),m.appendChild(this.#gt(t)),h.preview}#pt(t,n,r){const a=document.createElement("div");a.classList.add("text-details"),a.classList.add("hbox");const s=a.createChild("span","name");s.textContent=n,u.ARIAUtils.setLabel(s,n);const o=i.Helpers.Timing.traceWindowMilliSeconds(t.Meta.traceBounds),l=e.TimeUtilities.millisToString(o.range,!1),c=a.createChild("span","time");return c.appendChild(document.createTextNode(l)),c.appendChild(r),a}#ut(e){const t=document.createElement("div");t.classList.add("screenshot-thumb");if(t.style.width=1.5*this.totalHeight+"px",t.style.height=this.totalHeight+"px",!e)return t;const i=e.frames.at(-1);return i?(u.UIUtils.loadImage(i.screenshotEvent.args.dataUri).then((e=>{e&&t.appendChild(e)})),t):t}#gt(e){const t=document.createElement("div"),i=window.devicePixelRatio;t.style.width=yn+"px",t.style.height=this.totalHeight+"px";const n=t.createChild("canvas");n.width=i*yn,n.height=i*this.totalHeight;const r=n.getContext("2d");let a=0;for(const t of this.allOverviews){const n=t.constructor(e);n.update(),r&&r.drawImage(n.context().canvas,0,a,i*yn,t.height*i),a+=t.height*i}return t}static dataForTraceIndex(e){return wn.get(e)||null}}const fn=5,yn=450,wn=new Map;class bn{glassPane;listControl;focusRestorer;selectionDone;constructor(e){this.glassPane=new u.GlassPane.GlassPane,this.glassPane.setSizeBehavior("MeasureContent"),this.glassPane.setOutsideClickCallback((()=>this.close(null))),this.glassPane.setPointerEventsBehavior("BlockedByGlassPane"),this.glassPane.setAnchorBehavior("PreferBottom"),this.glassPane.element.addEventListener("blur",(()=>this.close(null)));const t=u.UIUtils.createShadowRootWithCoreStyles(this.glassPane.contentElement,{cssFile:[pn],delegatesFocus:void 0}).createChild("div","drop-down"),i=new u.ListModel.ListModel;this.listControl=new u.ListControl.ListControl(i,this,u.ListControl.ListMode.NonViewport),this.listControl.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),i.replaceAll(e),u.ARIAUtils.markAsMenu(this.listControl.element),u.ARIAUtils.setLabel(this.listControl.element,vn(un.selectTimelineSession)),t.appendChild(this.listControl.element),t.addEventListener("keydown",this.onKeyDown.bind(this),!1),t.addEventListener("click",this.onClick.bind(this),!1),this.focusRestorer=new u.UIUtils.ElementFocusRestorer(this.listControl.element),this.selectionDone=null}static show(e,t,i){if(bn.instance)return Promise.resolve(null);return new bn(e).show(i,t)}static cancelIfShowing(){bn.instance&&bn.instance.close(null)}show(e,t){return bn.instance=this,this.glassPane.setContentAnchorBox(e.boxInWindow()),this.glassPane.show(this.glassPane.contentElement.ownerDocument),this.listControl.element.focus(),this.listControl.selectItem(t),new Promise((e=>{this.selectionDone=e}))}onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("preview-item"),i=t&&this.listControl.itemForNode(t);null!==i&&this.listControl.selectItem(i)}onClick(e){e.target.enclosingNodeOrSelfWithClass("preview-item")&&this.close(this.listControl.selectedItem())}onKeyDown(e){switch(e.key){case"Tab":case"Escape":this.close(null);break;case"Enter":this.close(this.listControl.selectedItem());break;default:return}e.consume(!0)}close(e){this.selectionDone&&this.selectionDone(e),this.focusRestorer.restore(),this.glassPane.hide(),bn.instance=null}createElementForItem(e){const t=Tn.previewElement(e);return u.ARIAUtils.markAsMenuItem(t),t.classList.remove("selected"),t}heightForItem(e){return console.assert(!1,"Should not be called"),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,n){i&&i.classList.remove("selected"),n&&n.classList.add("selected")}updateSelectedItemARIA(e,t){return!1}static instance=null}class Sn extends u.Toolbar.ToolbarItem{contentElement;constructor(e){const t=document.createElement("button");t.classList.add("history-dropdown-button"),super(t),this.contentElement=this.element.createChild("span","content"),this.element.addEventListener("click",(()=>{e.execute()}),!1),this.setEnabled(e.enabled()),e.addEventListener("Enabled",(e=>this.setEnabled(e.data))),this.setTitle(e.title())}setText(e){this.contentElement.textContent=e}}var Cn=Object.freeze({__proto__:null,TimelineHistoryManager:Tn,maxRecordings:fn,previewWidth:yn,DropDown:bn,ToolbarButton:Sn});const En={learnmore:"Learn more",wasd:"WASD",clickTheRecordButtonSOrHitSTo:"Click the record button {PH1} or hit {PH2} to start a new recording.",clickTheReloadButtonSOrHitSTo:"Click the reload button {PH1} or hit {PH2} to record the page load.",afterRecordingSelectAnAreaOf:"After recording, select an area of interest in the overview by dragging. Then, zoom and pan the timeline with the mousewheel or {PH1} keys. {PH2}"},kn=e.i18n.registerUIStrings("panels/timeline/TimelineLandingPage.ts",En),xn=e.i18n.getLocalizedString.bind(void 0,kn);class Pn extends u.Widget.VBox{isReactNative=!1;toggleRecordAction;constructor(e,t){super(),this.isReactNative=a.Runtime.experiments.isEnabled("react-native-specific-ui"),this.toggleRecordAction=e,this.contentElement.classList.add("timeline-landing-page","fill"),a.Runtime.experiments.isEnabled("timeline-observations")?this.renderLandingPage():this.renderLegacyLandingPage(t)}renderLandingPage(){const e=new u.Widget.Widget;e.contentElement.append(new s.LiveMetricsView.LiveMetricsView),e.show(this.contentElement)}renderLegacyLandingPage(t){function i(e,t){const i=document.createElement(e);return i.textContent=t,i}const n=u.XLink.XLink.create("https://developer.chrome.com/docs/devtools/evaluate-performance/",xn(En.learnmore),void 0,void 0,"learn-more"),r=i("b",u.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.toggle-recording")[0].title()),a=this.isReactNative?null:i("b",u.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.record-reload")[0].title()),s=i("b",xn(En.wasd));this.contentElement.classList.add("legacy");const o=this.contentElement.createChild("div"),l=u.UIUtils.createInlineButton(u.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),c=this.isReactNative?null:u.UIUtils.createInlineButton(u.Toolbar.Toolbar.createActionButtonForId("timeline.record-reload"));if(o.createChild("p").appendChild(e.i18n.getFormatLocalizedString(kn,En.clickTheRecordButtonSOrHitSTo,{PH1:l,PH2:r})),this.isReactNative||null===c||null===a||o.createChild("p").appendChild(e.i18n.getFormatLocalizedString(kn,En.clickTheReloadButtonSOrHitSTo,{PH1:c,PH2:a})),o.createChild("p").appendChild(e.i18n.getFormatLocalizedString(kn,En.afterRecordingSelectAnAreaOf,{PH1:s,PH2:n})),t?.isNode){const e=new D.PanelFeedback.PanelFeedback;e.data={feedbackUrl:"https://crbug.com/1354548",quickStartUrl:"https://goo.gle/js-profiler-deprecation",quickStartLinkText:xn(En.learnmore)},o.appendChild(e);const t=new D.FeedbackButton.FeedbackButton;t.data={feedbackUrl:"https://crbug.com/1354548"},o.appendChild(t)}}}const In={malformedTimelineDataS:"Malformed timeline data: {PH1}"},Mn=e.i18n.registerUIStrings("panels/timeline/TimelineLoader.ts",In),Fn=e.i18n.getLocalizedString.bind(void 0,Mn);class Ln{client;canceledCallback;buffer;firstRawChunk;totalSize;filter;#vt;#C=[];#Tt;#ft;#yt;constructor(e){this.client=e,this.canceledCallback=null,this.buffer="",this.firstRawChunk=!0,this.filter=null,this.#vt=!1,this.#Tt=null,this.#yt=new Promise((e=>{this.#ft=e}))}static async loadFromFile(e,t){const i=new Ln(t),n=new b.FileUtils.ChunkedFileReader(e);return i.canceledCallback=n.cancel.bind(n),i.totalSize=e.size,setTimeout((async()=>{!await n.read(i)&&n.error()&&i.reportErrorAndCancelLoading(n.error().message)})),i}static loadFromEvents(e,t){const i=new Ln(t);return window.setTimeout((async()=>{i.addEvents(e)})),i}static loadFromCpuProfile(e,t){const n=new Ln(t);n.#vt=!0;try{const t=C.TimelineJSProfile.TimelineJSProfileProcessor.createFakeTraceFromCpuProfile(e,i.Types.TraceEvents.ThreadID(1));window.setTimeout((async()=>{n.addEvents(t)}))}catch(e){console.error(e.stack)}return n}static async loadFromURL(e,t){const i=new Ln(t),n=new r.StringOutputStream.StringOutputStream;await t.loadingStarted();const a=r.Settings.Settings.instance().moduleSetting("network.enable-remote-file-loading").get();return l.ResourceLoader.loadAsStream(e,null,n,(async function(e,t,r){if(!e)return i.reportErrorAndCancelLoading(r.message);try{const e=n.data(),t=JSON.parse(e);i.#wt(t),await i.close()}catch(e){await i.close();const t=e instanceof Error?e.message:"";return i.reportErrorAndCancelLoading(Fn(In.malformedTimelineDataS,{PH1:t}))}}),a),i}#wt(e){if("traceEvents"in e||Array.isArray(e)){const t=Array.isArray(e)?e:e.traceEvents;this.#bt(t)}else{if(!e.nodes)return void this.reportErrorAndCancelLoading(Fn(In.malformedTimelineDataS));this.#St(e),this.#vt=!0}"metadata"in e&&(this.#Tt=e.metadata)}async addEvents(e){await(this.client?.loadingStarted());const t=15e4;for(let i=0;i<e.length;i+=t){const n=e.slice(i,i+t);this.#bt(n),await(this.client?.loadingProgress((i+n.length)/e.length)),await new Promise((e=>window.setTimeout(e,0)))}this.close()}async cancel(){this.client&&(await this.client.loadingComplete([],null,!1,null,null),this.client=null),this.canceledCallback&&this.canceledCallback()}async write(e,t){if(!this.client)return Promise.resolve();if(this.buffer+=e,this.firstRawChunk)await this.client.loadingStarted(),await new Promise((e=>requestAnimationFrame((()=>requestAnimationFrame(e))))),this.firstRawChunk=!1;else{let e;e=this.buffer.length/this.totalSize,e=e>1?e-Math.floor(e):e,await this.client.loadingProgress(e)}if(t){let e;try{return e=JSON.parse(this.buffer),this.#wt(e),Promise.resolve()}catch(e){return void this.reportErrorAndCancelLoading(Fn(In.malformedTimelineDataS,{PH1:e.toString()}))}}}reportErrorAndCancelLoading(e){e&&r.Console.Console.instance().error(e),this.cancel()}async close(){this.client&&(await this.client.processingStarted(),await this.finalizeTrace())}isCpuProfile(){return this.#vt}async finalizeTrace(){await this.client.loadingComplete(this.#C,this.filter,this.isCpuProfile(),null,this.#Tt),this.#ft?.()}traceFinalizedForTest(){return this.#yt}#St(e){const t=C.TimelineJSProfile.TimelineJSProfileProcessor.createFakeTraceFromCpuProfile(e,i.Types.TraceEvents.ThreadID(1));this.#bt(t)}#bt(e){this.#C=this.#C.concat(e)}}var Rn=Object.freeze({__proto__:null,TimelineLoader:Ln});const Dn=new CSSStyleSheet;Dn.replaceSync('.timeline-minimap{position:relative}.timeline-sidebar-floating-icon{position:absolute;top:5px;left:10px;z-index:999;border:none;width:36px;height:36px;border-radius:50%;box-shadow:var(--drop-shadow-depth-1);background:var(--sys-color-cdt-base-container);&:hover{background:var(--sys-color-base-container-elevated)}}.timeline-minimap .overview-strip{margin-top:2px;justify-content:center}.timeline-minimap .overview-strip .timeline-overview-strip-title{color:var(--sys-color-token-subtle);font-size:10px;font-weight:bold;z-index:100;background-color:var(--sys-color-cdt-base-container);padding:0 4px;position:absolute;top:-2px;right:0}.timeline-minimap #timeline-overview-cpu-activity{flex-basis:20px}.timeline-minimap #timeline-overview-network{flex-basis:8px}.timeline-minimap #timeline-overview-filmstrip{flex-basis:30px}.timeline-minimap #timeline-overview-memory{flex-basis:20px}.timeline-minimap #timeline-overview-network::before,\n.timeline-minimap #timeline-overview-cpu-activity::before{content:"";position:absolute;left:0;right:0;bottom:0;border-bottom:1px solid var(--divider-line);z-index:-200}.timeline-minimap .overview-strip .background{z-index:-10}.timeline-minimap #timeline-overview-responsiveness{flex-basis:5px;margin-top:0!important}.timeline-minimap #timeline-overview-input{flex-basis:6px}.timeline-minimap #timeline-overview-pane{flex:auto;position:relative;overflow:hidden}.timeline-minimap #timeline-overview-container{display:flex;flex-direction:column;flex:none;position:relative;overflow:hidden}.timeline-minimap #timeline-overview-container canvas{width:100%;height:100%}.timeline-minimap .memory-graph-label{position:absolute;right:0;bottom:0;font-size:9px;color:var(--sys-color-token-subtle);white-space:nowrap;padding:0 4px;background-color:var(--sys-color-cdt-base-container)}\n/*# sourceURL=timelineMiniMap.css */\n');const An={openSidebarButton:"Open the sidebar"},Nn=e.i18n.registerUIStrings("panels/timeline/TimelineMiniMap.ts",An),Bn=e.i18n.getLocalizedString.bind(void 0,Nn);class Hn extends(r.ObjectWrapper.eventMixin(u.Widget.VBox)){breadcrumbsActivated=!1;#Ct=new p.TimelineOverviewPane.TimelineOverviewPane("timeline");#Et=[];breadcrumbs=null;#kt;#xt=null;#x=this.#P.bind(this);#Pt=document.createElement("button");constructor(){super(),this.element.classList.add("timeline-minimap"),this.#kt=new s.BreadcrumbsUI.BreadcrumbsUI;const e=new A.Icon.Icon;e.setAttribute("name","left-panel-open"),e.setAttribute("jslog",`${g.action("timeline.sidebar-open").track({click:!0})}`),e.addEventListener("click",(()=>{this.dispatchEventToListeners("OpenSidebarButtonClicked",{})})),this.#Pt.setAttribute("aria-label",Bn(An.openSidebarButton)),this.#Pt.appendChild(e),this.#Pt.classList.add("timeline-sidebar-floating-icon"),a.Runtime.experiments.isEnabled("timeline-rpp-sidebar")||this.hideSidebarFloatingIcon(),this.element.appendChild(this.#Pt),this.#Ct.show(this.element),this.#Ct.addEventListener("OverviewPaneWindowChanged",(e=>{this.#It(e)})),this.#Mt(),h.TraceBounds.onChange(this.#x)}showSidebarFloatingIcon(){this.#Pt.removeAttribute("hidden")}hideSidebarFloatingIcon(){this.#Pt.setAttribute("hidden","hidden")}#It(e){const t=this.#xt?.traceParsedData;if(!t)return;const n=h.TraceBounds.BoundsManager.instance().state();if(!n)return;const r=e.data.startTime>0?e.data.startTime:n.milli.entireTraceBounds.min,a=Number.isFinite(e.data.endTime)?e.data.endTime:n.milli.entireTraceBounds.max;h.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(i.Helpers.Timing.traceWindowFromMilliSeconds(i.Types.Timing.MilliSeconds(r),i.Types.Timing.MilliSeconds(a)),{shouldAnimate:!0})}#P(e){"RESET"!==e.updateType&&"VISIBLE_WINDOW"!==e.updateType||this.#Ct.setWindowTimes(e.state.milli.timelineTraceWindow.min,e.state.milli.timelineTraceWindow.max),"RESET"!==e.updateType&&"MINIMAP_BOUNDS"!==e.updateType||this.#Ct.setBounds(e.state.milli.minimapTraceBounds.min,e.state.milli.minimapTraceBounds.max)}#Mt(){this.breadcrumbsActivated=!0,this.element.prepend(this.#kt),this.#Ct.addEventListener("OverviewPaneBreadcrumbAdded",(e=>{this.addBreadcrumb(e.data)})),this.#kt.addEventListener(s.BreadcrumbsUI.BreadcrumbRemovedEvent.eventName,(e=>{const t=e.breadcrumb;this.#Ft(t)})),this.#Ct.enableCreateBreadcrumbsButton()}addBreadcrumb({startTime:e,endTime:t}){const n=h.TraceBounds.BoundsManager.instance().state();if(!n)return;const r=n.milli.minimapTraceBounds,a={startTime:i.Types.Timing.MilliSeconds(Math.max(e,r.min)),endTime:i.Types.Timing.MilliSeconds(Math.min(t,r.max))},s=i.Helpers.Timing.traceWindowFromMilliSeconds(a.startTime,a.endTime);null===this.breadcrumbs?this.breadcrumbs=Ne.activeManager()?.getTimelineBreadcrumbs()??null:this.breadcrumbs.add(s),this.breadcrumbs?this.#kt.data={breadcrumb:this.breadcrumbs.initialBreadcrumb}:console.warn("ModificationsManager has not been created, therefore Breadcrumbs can not be added")}#Ft(e){this.breadcrumbs&&(this.breadcrumbs.setLastBreadcrumb(e),this.#kt.data={breadcrumb:this.breadcrumbs.initialBreadcrumb})}wasShown(){super.wasShown(),this.registerCSSFiles([Dn])}reset(){this.#xt=null,this.#Ct.reset()}#Lt(e){const t=new Map,{Meta:n,PageLoadMetrics:r}=e,a=n.mainFrameNavigations,s=i.Helpers.Timing.microSecondsToMilliseconds(n.traceBounds.min);for(const e of a){const{startTime:n}=i.Helpers.Timing.eventTimingsMilliSeconds(e);t.set(n,Ct.createEventDivider(e,s))}for(const e of r.allMarkerEvents){const{startTime:n}=i.Helpers.Timing.eventTimingsMilliSeconds(e);t.set(n,Ct.createEventDivider(e,s))}this.#Ct.setMarkers(t)}#Rt(e){this.#Ct.setNavStartTimes(e.Meta.mainFrameNavigations)}getControls(){return this.#Et}setData(e){if(this.#xt?.traceParsedData!==e.traceParsedData){if(this.#xt=e,this.#Et=[],this.#Lt(e.traceParsedData),this.#Rt(e.traceParsedData),this.#Et.push(new ln(e.traceParsedData)),this.#Et.push(new on(e.traceParsedData)),this.#Et.push(new an(e.traceParsedData)),e.settings.showScreenshots){const t=i.Extras.FilmStrip.fromTraceData(e.traceParsedData);t.frames.length&&this.#Et.push(new cn(t))}e.settings.showMemory&&this.#Et.push(new dn(e.traceParsedData)),this.#Ct.setOverviewControls(this.#Et),this.#Ct.showingScreenshots=e.settings.showScreenshots}}addInitialBreadcrumb(){this.breadcrumbs=null;const e=h.TraceBounds.BoundsManager.instance().state();e&&this.addBreadcrumb({startTime:e.milli.entireTraceBounds.min,endTime:e.milli.entireTraceBounds.max})}}var Un=Object.freeze({__proto__:null,TimelineMiniMap:Hn});const Wn=new CSSStyleSheet;Wn.replaceSync('.timeline-toolbar-container{display:flex;flex:none}.timeline-toolbar-container > .toolbar{background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider)}.timeline-main-toolbar{flex:1 1 auto}.timeline-settings-pane{flex:none;background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider)}#timeline-overview-panel{flex:none;position:relative;border-bottom:1px solid var(--sys-color-divider)}#timeline-overview-grid{background-color:var(--sys-color-cdt-base-container)}#timeline-overview-grid .timeline-grid-header{height:12px}#timeline-overview-grid .resources-dividers-label-bar{pointer-events:auto;height:12px}#timeline-overview-grid .resources-divider-label{top:1px}.timeline-details-split{flex:auto}.timeline.panel .status-pane-container{z-index:1000;display:flex;align-items:center;pointer-events:none}.timeline.panel .status-pane-container.tinted{background-color:var(--sys-color-cdt-base-container);pointer-events:auto}.popover ul{margin:0;padding:0;list-style-type:none}#memory-graphs-canvas-container{overflow:hidden;flex:auto;position:relative}#memory-counters-graph{flex:auto}#memory-graphs-canvas-container .memory-counter-marker{position:absolute;border-radius:3px;width:5px;height:5px;margin-left:-3px;margin-top:-2px}#memory-graphs-container .timeline-memory-header{flex:0 0 26px;background-color:var(--sys-color-surface2);border-bottom:1px solid var(--sys-color-divider);justify-content:space-between}#memory-graphs-container .timeline-memory-header::after{content:"";background-image:var(--image-file-toolbarResizerVertical);background-repeat:no-repeat;background-position:right center,center;flex:20px 0 0;margin:0 4px}.timeline-memory-toolbar{flex-shrink:1}.memory-counter-value{margin:8px}#counter-values-bar{flex:0 0 20px;border-top:solid 1px var(--sys-color-divider);width:100%;overflow:hidden;line-height:18px}.timeline-details{vertical-align:top}.timeline-details-view{color:var(--sys-color-on-surface);overflow:hidden}.timeline-details-view-body{flex:auto;overflow:auto;position:relative;background-color:var(--sys-color-cdt-base-container);user-select:text}.timeline-details-view-block{flex:none;display:flex;background-color:var(--sys-color-cdt-base-container);flex-direction:column;padding-bottom:5px;border-bottom:1px solid var(--sys-color-divider)}.timeline-details-view-row{padding-left:10px;min-height:20px}.timeline-details-view-block .timeline-details-stack-values{flex-direction:column!important}.timeline-details-chip-title{font-size:12px;padding:8px;display:flex;align-items:center}.timeline-details-view-block:first-child > .timeline-details-chip-title{font-size:13px}.timeline-details-view-row-title:not(:empty){color:var(--sys-color-token-subtle);overflow:hidden;padding-right:10px;display:inline-block;vertical-align:top}.timeline-details-warning{--override-details-warning-background-color:rgb(250 209 209/48%);background-color:var(--override-details-warning-background-color)}.theme-with-dark-background .timeline-details-warning,\n:host-context(.theme-with-dark-background) .timeline-details-warning{--override-details-warning-background-color:rgb(87 10 10/48%)}.timeline-details-warning .timeline-details-view-row-title{color:var(--sys-color-error)}.timeline-details-view-row-value{display:inline-block;user-select:text;text-overflow:ellipsis;overflow:hidden;padding:0 3px}.timeline-details-warning .timeline-details-view-row-value{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.timeline-details-view-pie-chart-wrapper{margin:4px 0}.timeline-details-view-pie-chart{margin-top:5px}.timeline-flamechart{overflow:hidden}.brick-game{background-color:var(--sys-color-neutral-container);position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999}.game-close-button{display:flex;align-items:center;justify-content:center;width:25px;height:25px;position:absolute;right:15px;top:15px;border-radius:50%;cursor:pointer}.scorePanel{display:flex;align-items:center;justify-content:center;flex-direction:column;white-space:pre-line;padding:15px;position:absolute;left:15px;bottom:15px;border:double 7px transparent;border-radius:20px;background-origin:border-box;background-clip:content-box,border-box;font-weight:200}.confetti-100{display:block;top:0;left:0;width:100%;height:100%}.confetti-100 > .confetti-100-particle{opacity:0%;position:fixed;animation:confetti-100-animation 1s none ease-out;font-size:30px}@keyframes confetti-100-animation{0%{opacity:100%;transform:translateY(0%) translateY(0%) rotate(0deg)}100%{opacity:0%;transform:translateY(var(--to-Y)) translateX(var(--to-X)) rotate(var(--rotation))}}@media (prefers-reduced-motion){.confetti-100 > .confetti-100-particle{animation-name:dissolve}}.timeline-flamechart-resizer{flex:8px 0 0;background-color:var(--sys-color-surface2);border:1px var(--sys-color-divider);border-style:solid none;display:flex;flex-direction:row;align-items:flex-end;justify-content:center}.timeline-network-resizer-disabled > .timeline-flamechart-resizer{display:none}.timeline-flamechart-resizer::after{content:"...";font-size:14px;margin-bottom:-1px}.timeline-layers-view-properties table{width:100%;border-collapse:collapse}.timeline-layers-view-properties td{border:1px solid var(--sys-color-divider);line-height:22px}.timeline-filmstrip-preview > img{margin-top:5px;max-width:500px;max-height:300px;cursor:pointer;border:1px solid var(--sys-color-divider)}.timeline-tree-view{display:flex;overflow:hidden}.timeline-tree-view .toolbar{background-color:var(--sys-color-cdt-base-container);border-bottom:1px solid var(--sys-color-divider)}.timeline-tree-view .data-grid{border:none;flex:auto}.timeline-tree-view .data-grid .data-container{overflow-y:scroll}.timeline-tree-view .data-grid.data-grid-fits-viewport .corner{display:table-cell}.timeline-tree-view .data-grid table.data{background:var(--sys-color-cdt-base-container)}.timeline-tree-view .data-grid .odd{background-color:var(--sys-color-surface1)}.timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:var(--sys-color-state-hover-on-subtle)}.timeline-tree-view .data-grid td.numeric-column{text-align:right;position:relative}.timeline-tree-view .data-grid div.background-percent-bar{float:right;position:relative;z-index:1}.timeline-tree-view .data-grid span.percent-column{color:var(--sys-color-token-subtle);width:45px;display:inline-block}.timeline-tree-view .data-grid tr.selected span{color:inherit}.timeline-tree-view .data-grid tr.selected{background-color:var(--sys-color-tonal-container)}.timeline-tree-view .data-grid .name-container{display:flex;align-items:center;padding-left:2px}.timeline-tree-view .data-grid .name-container .activity-icon{width:12px;height:12px;border:1px solid var(--divider-line);margin:3px 0}.timeline-tree-view .data-grid .name-container .activity-icon-container{margin-right:3px;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;width:18px;height:18px;overflow:hidden}.timeline-tree-view .data-grid .name-container .activity-warning::after{content:"[deopt]";margin:0 4px;line-height:12px;font-size:10px;color:var(--sys-color-state-disabled)}.timeline-tree-view .data-grid tr.selected .name-container .activity-warning::after{color:var(--sys-color-on-tonal-container)}.timeline-tree-view .data-grid .name-container .activity-link{flex:auto;text-align:right;overflow:hidden;text-overflow:ellipsis;margin-left:5px}.timeline-tree-view .data-grid .background-bar-container{position:absolute;left:3px;right:0}.timeline-tree-view .data-grid .background-bar{float:right;height:18px;background-color:var(--sys-color-surface-yellow);border-bottom:1px solid var(--sys-color-yellow-outline)}.timeline-tree-view .data-grid .selected .background-bar{background-color:var(--app-color-selected-progress-bar);border-bottom:1px solid var(--app-border-selected-progress-bar)}.timeline-tree-view .timeline-details-view-body .full-widget-dimmed-banner{background-color:inherit}.timeline-details .filter-input-field{width:120px}.timeline-tree-view .data-grid thead{height:21px;z-index:2}.timeline-stack-view-header{height:27px;background-color:var(--sys-color-cdt-base-container);padding:6px 10px;color:var(--sys-color-on-surface);white-space:nowrap;border-bottom:1px solid var(--sys-color-divider)}.timeline-landing-page{position:absolute;background-color:var(--sys-color-cdt-base-container)}.timeline-landing-page.legacy{justify-content:center;align-items:center;overflow:auto;font-size:13px;color:var(--sys-color-on-surface-subtle)}@media (forced-colors: active){.timeline-tree-view .data-grid .name-container .activity-icon{forced-color-adjust:none}.timeline-tree-view .data-grid tr.selected span.percent-column,\n  .timeline-tree-view .data-grid tr.selected div.background-percent-bar span,\n  .timeline-tree-view .data-grid tr.selected .name-container .activity-link .devtools-link{color:HighlightText}.timeline-tree-view .data-grid .background-bar,\n  .timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:transparent}.timeline-tree-view .data-grid tr.selected .background-bar{background-color:transparent;border-bottom-color:HighlightText}}.timeline-details-view-body > div{overflow-y:hidden;overflow-x:hidden}.timeline-details-chip-title > div{width:12px;height:12px;border:1px solid var(--sys-color-divider);display:inline-block;margin-right:4px;content:" "}.timeline-landing-page.legacy > div{max-width:450px;margin:10px}.timeline-paint-profiler-log-split > div:last-child{background-color:var(--color-background-elevation-1);z-index:0}.timeline-layers-view > div:last-child,\n.timeline-layers-view-properties > div:last-child{background-color:var(--color-background-elevation-1)}.timeline.panel .status-pane-container > div{pointer-events:auto}.timeline-landing-page.legacy > div > p{flex:none;white-space:pre-line;line-height:18px}.timeline-tree-view .data-grid .name-container div{flex:none}.status-pane-container > .small-dialog{width:100%;height:100%}.timeline-concurrency-input{width:50px}.timeline-concurrency-hidden{visibility:hidden}devtools-feedback-button{float:right}\n/*# sourceURL=timelinePanel.css */\n');const On=new CSSStyleSheet;On.replaceSync(".timeline-status-dialog{display:flex;flex-direction:column;padding:16px 16px 12px;align-self:center;background-color:var(--sys-color-cdt-base-container);box-shadow:var(--drop-shadow);border-radius:10px}.status-dialog-line{margin:2px;height:14px;min-height:auto;display:flex;align-items:baseline}.status-dialog-line .label{display:inline-block;width:80px;text-align:right;color:var(--sys-color-on-surface);margin-right:10px}.timeline-status-dialog .progress .indicator-container{display:inline-block;width:200px;height:8px;background-color:var(--sys-color-surface5)}.timeline-status-dialog .progress .indicator{background-color:var(--sys-color-primary);height:100%;width:0;margin:0}.timeline-status-dialog .stop-button{margin-top:8px;height:100%;align-self:flex-end}.timeline-status-dialog .stop-button button{border-radius:12px}.timeline-status-dialog.small-dialog{width:inherit;justify-content:center}.small-dialog > .stop-button{align-self:center;margin-top:20px;height:initial}@media (forced-colors: active){.timeline-status-dialog{border:1px solid canvastext}.timeline-status-dialog .progress .indicator-container{border:1px solid ButtonText;background-color:ButtonFace}.timeline-status-dialog .progress .indicator{forced-color-adjust:none;background-color:ButtonText}}\n/*# sourceURL=timelineStatusDialog.css */\n");const Vn={frameStart:"Frame Start",drawFrame:"Draw Frame",layout:"Layout",rasterizing:"Rasterizing",drawing:"Drawing",painting:"Painting",system:"System",idle:"Idle",loading:"Loading",experience:"Experience",scripting:"Scripting",rendering:"Rendering",gpu:"GPU",async:"Async",messaging:"Messaging"},_n=e.i18n.registerUIStrings("panels/timeline/UIDevtoolsUtils.ts",Vn),zn=e.i18n.getLocalizedString.bind(void 0,_n);let Gn=null,jn=null;class qn{static isUiDevTools(){return"true"===a.Runtime.Runtime.queryParam("uiDevTools")}static categorizeEvents(){if(Gn)return Gn;const e=$n,t=qn.categories(),i=t.drawing,n=t.rasterizing,r=t.layout,a=t.painting,s=t.other,o={};return o[e.ViewPaint]=new se("View::Paint",a),o[e.ViewOnPaint]=new se("View::OnPaint",a),o[e.ViewPaintChildren]=new se("View::PaintChildren",a),o[e.ViewOnPaintBackground]=new se("View::OnPaintBackground",a),o[e.ViewOnPaintBorder]=new se("View::OnPaintBorder",a),o[e.LayerPaintContentsToDisplayList]=new se("Layer::PaintContentsToDisplayList",a),o[e.ViewLayout]=new se("View::Layout",r),o[e.ViewLayoutBoundsChanged]=new se("View::Layout(bounds_changed)",r),o[e.RasterTask]=new se("RasterTask",n),o[e.RasterizerTaskImplRunOnWorkerThread]=new se("RasterizerTaskImpl::RunOnWorkerThread",n),o[e.DirectRendererDrawFrame]=new se("DirectRenderer::DrawFrame",i),o[e.BeginFrame]=new se(zn(Vn.frameStart),i,!0),o[e.DrawFrame]=new se(zn(Vn.drawFrame),i,!0),o[e.NeedsBeginFrameChanged]=new se("NeedsBeginFrameChanged",i,!0),o[e.ThreadControllerImplRunTask]=new se("ThreadControllerImpl::RunTask",s),Gn=o,o}static categories(){return jn||(jn={layout:new oe(ie.LAYOUT,zn(Vn.layout),!0,"--app-color-loading-children","--app-color-loading"),rasterizing:new oe(ie.RASTERIZING,zn(Vn.rasterizing),!0,"--app-color-children","--app-color-scripting"),drawing:new oe(ie.DRAWING,zn(Vn.drawing),!0,"--app-color-rendering-children","--app-color-rendering"),painting:new oe(ie.PAINTING,zn(Vn.painting),!0,"--app-color-painting-children","--app-color-painting"),other:new oe(ie.OTHER,zn(Vn.system),!1,"--app-color-system-children","--app-color-system"),idle:new oe(ie.IDLE,zn(Vn.idle),!1,"--app-color-idle-children","--app-color-idle"),loading:new oe(ie.LOADING,zn(Vn.loading),!1,"--app-color-loading-children","--app-color-loading"),experience:new oe(ie.EXPERIENCE,zn(Vn.experience),!1,"--app-color-rendering-children","--pp-color-rendering"),messaging:new oe(ie.MESSAGING,zn(Vn.messaging),!1,"--app-color-messaging-children","--pp-color-messaging"),scripting:new oe(ie.SCRIPTING,zn(Vn.scripting),!1,"--app-color-scripting-children","--pp-color-scripting"),rendering:new oe(ie.RENDERING,zn(Vn.rendering),!1,"--app-color-rendering-children","--pp-color-rendering"),gpu:new oe(ie.GPU,zn(Vn.gpu),!1,"--app-color-painting-children","--app-color-painting"),async:new oe(ie.ASYNC,zn(Vn.async),!1,"--app-color-async-children","--app-color-async")},jn)}static getMainCategoriesList(){return["idle","drawing","painting","rasterizing","layout","other"]}}var $n;!function(e){e.ViewPaint="View::Paint",e.ViewOnPaint="View::OnPaint",e.ViewPaintChildren="View::PaintChildren",e.ViewOnPaintBackground="View::OnPaintBackground",e.ViewOnPaintBorder="View::OnPaintBorder",e.ViewLayout="View::Layout",e.ViewLayoutBoundsChanged="View::Layout(bounds_changed)",e.LayerPaintContentsToDisplayList="Layer::PaintContentsToDisplayList",e.DirectRendererDrawFrame="DirectRenderer::DrawFrame",e.RasterTask="RasterTask",e.RasterizerTaskImplRunOnWorkerThread="RasterizerTaskImpl::RunOnWorkerThread",e.BeginFrame="BeginFrame",e.DrawFrame="DrawFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.ThreadControllerImplRunTask="ThreadControllerImpl::RunTask"}($n||($n={}));var Jn=Object.freeze({__proto__:null,UIDevtoolsUtils:qn,get RecordType(){return $n}});class Kn extends Je{constructor(e,t,i){super(e,t,i),ue(qn.categorizeEvents()),ge(qn.categories()),fe(qn.getMainCategoriesList().filter(he))}}var Yn=Object.freeze({__proto__:null,UIDevtoolsController:Kn});const Xn={dropTimelineFileOrUrlHere:"Drop timeline file or URL here",disableJavascriptSamples:"Disable JavaScript samples",enableAdvancedPaint:"Enable advanced paint instrumentation (slow)",enableSelectorStats:"Enable CSS selector stats (slow)",screenshots:"Screenshots",memory:"Memory",clear:"Clear",fixMe:"Fix me",loadProfile:"Load profile…",saveProfile:"Save profile…",captureScreenshots:"Capture screenshots",showMemoryTimeline:"Show memory timeline",captureSettings:"Capture settings",disablesJavascriptSampling:"Disables JavaScript sampling, reduces overhead when running against mobile devices",capturesAdvancedPaint:"Captures advanced paint instrumentation, introduces significant performance overhead",capturesSelectorStats:"Captures CSS selector statistics",network:"Network:",cpu:"CPU:",networkConditions:"Network conditions",failedToSaveTimelineSS:"Failed to save timeline: {PH1} ({PH2})",CpuThrottlingIsEnabled:"- CPU throttling is enabled",NetworkThrottlingIsEnabled:"- Network throttling is enabled",HardwareConcurrencyIsEnabled:"- Hardware concurrency override is enabled",SignificantOverheadDueToPaint:"- Significant overhead due to paint instrumentation",SelectorStatsEnabled:"- Selector stats is enabled",JavascriptSamplingIsDisabled:"- JavaScript sampling is disabled",stoppingTimeline:"Stopping timeline…",received:"Received",close:"Close",downloadAfterError:"Download raw trace events",recordingFailed:"Recording failed",profiling:"Profiling…",bufferUsage:"Buffer usage",loadingProfile:"Loading profile…",processingProfile:"Processing profile…",initializingProfiler:"Initializing profiler…",status:"Status",time:"Time",description:"Description",stop:"Stop",ssec:"{PH1} sec",exportNormalTraces:"Basic Performance Traces",exportEnhancedTraces:"Enhanced Performance Traces",showDataAddedByExtensions:"Show data added by extensions of the Performance panel",performanceExtension:"Extension data"},Zn=e.i18n.registerUIStrings("panels/timeline/TimelinePanel.ts",Xn),Qn=e.i18n.getLocalizedString.bind(void 0,Zn);let er,tr,ir;class nr extends u.Panel.Panel{dropTarget;recordingOptionUIControls;state;recordingPageReload;millisecondsToRecordAfterLoadEvent;toggleRecordAction;recordReloadAction;#Dt;disableCaptureJSProfileSetting;captureLayersAndPicturesSetting;captureSelectorStatsSetting;#At;showScreenshotsSetting;showMemorySetting;panelToolbar;panelRightToolbar;timelinePane;#ht=new Hn;#Nt=new s.Sidebar.SidebarWidget;statusPaneContainer;flameChart;searchableViewInternal;showSettingsPaneButton;showSettingsPaneSetting;settingsPane;controller;cpuProfiler;clearButton;fixMeButton;fixMeButtonAdded=!1;loadButton;saveButton;statusPane;landingPage;loader;showScreenshotsToolbarCheckbox;showMemoryToolbarCheckbox;networkThrottlingSelect;cpuThrottlingSelect;fileSelectorElement;selection;traceLoadStart;primaryPageTargetPromiseCallback=e=>{};primaryPageTargetPromise=new Promise((e=>{this.primaryPageTargetPromiseCallback=e}));#Bt;#Ht=-1;#Ut=null;#Wt=this.#Ot.bind(this);#Vt;constructor(){super("timeline");const e=document.createElement("span");e.innerHTML='<div style="\n      font-size: 12px;\n      transform: scale(1.25);\n      color: transparent;\n      background: linear-gradient(90deg, rgb(255 0 0 / 100%) 0%, rgb(255 154 0 / 100%) 10%, rgb(208 222 33 / 100%) 20%, rgb(79 220 74 / 100%) 30%, rgb(63 218 216 / 100%) 40%, rgb(47 201 226 / 100%) 50%, rgb(28 127 238 / 100%) 60%, rgb(95 21 242 / 100%) 70%, rgb(186 12 248 / 100%) 80%, rgb(251 7 217 / 100%) 90%, rgb(255 0 0 / 100%) 100%);\n      -webkit-background-clip: text;\n      ">💫</div>';const t=new m.Adorner.Adorner;t.classList.add("fix-perf-icon"),t.data={name:Qn(Xn.fixMe),content:e},this.fixMeButton=new u.Toolbar.ToolbarButton(Qn(Xn.fixMe),t),this.fixMeButton.addEventListener("Click",(()=>this.onFixMe()));const o=i.Types.Configuration.defaults();o.showAllEvents=a.Runtime.experiments.isEnabled("timeline-show-all-events"),o.includeRuntimeCallStats=a.Runtime.experiments.isEnabled("timeline-v8-runtime-call-stats"),o.debugMode=a.Runtime.experiments.isEnabled("timeline-debug-mode"),this.#Bt=i.TraceModel.Model.createWithAllHandlers(o),this.element.addEventListener("contextmenu",this.contextMenu.bind(this),!1),this.dropTarget=new u.DropTarget.DropTarget(this.element,[u.DropTarget.Type.File,u.DropTarget.Type.URI],Qn(Xn.dropTimelineFileOrUrlHere),this.handleDrop.bind(this)),this.recordingOptionUIControls=[],this.state="Idle",this.recordingPageReload=!1,this.millisecondsToRecordAfterLoadEvent=5e3,this.toggleRecordAction=u.ActionRegistry.ActionRegistry.instance().getAction("timeline.toggle-recording"),this.recordReloadAction=ir?null:u.ActionRegistry.ActionRegistry.instance().getAction("timeline.record-reload"),this.#Dt=new Tn(this.#ht),this.traceLoadStart=null,this.disableCaptureJSProfileSetting=r.Settings.Settings.instance().createSetting("timeline-disable-js-sampling",!1),this.disableCaptureJSProfileSetting.setTitle(Qn(Xn.disableJavascriptSamples)),this.captureLayersAndPicturesSetting=r.Settings.Settings.instance().createSetting("timeline-capture-layers-and-pictures",!1,"Session"),this.captureLayersAndPicturesSetting.setTitle(Qn(Xn.enableAdvancedPaint)),this.captureSelectorStatsSetting=r.Settings.Settings.instance().createSetting("timeline-capture-selector-stats",!1,"Session"),this.captureSelectorStatsSetting.setTitle(Qn(Xn.enableSelectorStats)),this.showScreenshotsSetting=r.Settings.Settings.instance().createSetting("timeline-show-screenshots",!tr&&!ir),this.showScreenshotsSetting.setTitle(Qn(Xn.screenshots)),this.showScreenshotsSetting.addChangeListener(this.updateMiniMap,this),ir?this.showMemorySetting=null:(this.showMemorySetting=r.Settings.Settings.instance().createSetting("timeline-show-memory",!1),this.showMemorySetting.setTitle(Qn(Xn.memory)),this.showMemorySetting.addChangeListener(this.onModeChanged,this)),this.#At=nr.extensionDataVisibilitySetting(),this.#At.addChangeListener(this.#_t,this),this.#At.setTitle(Qn(Xn.performanceExtension));const l=this.element.createChild("div","timeline-toolbar-container");l.setAttribute("jslog",`${g.toolbar()}`),this.panelToolbar=new u.Toolbar.Toolbar("timeline-main-toolbar",l),this.panelToolbar.makeWrappable(!0),this.panelRightToolbar=new u.Toolbar.Toolbar("",l),tr||ir||(this.createSettingsPane(),this.updateShowSettingsToolbarButton()),this.timelinePane=new u.Widget.VBox;const c=this.timelinePane.element.createChild("div","hbox");c.id="timeline-overview-panel",this.#ht.show(c),this.#ht.addEventListener("OpenSidebarButtonClicked",this.#zt.bind(this)),this.statusPaneContainer=this.timelinePane.element.createChild("div","status-pane-container fill"),this.createFileSelector(),n.TargetManager.TargetManager.instance().addModelListener(n.ResourceTreeModel.ResourceTreeModel,n.ResourceTreeModel.Events.Load,this.loadEventFired,this),this.flameChart=new $i(this),this.#Vt=this.#Gt.bind(this),this.flameChart.getMainFlameChart().addEventListener("ChartPlayableStateChange",this.#Vt,this),this.searchableViewInternal=new u.SearchableView.SearchableView(this.flameChart,null),this.searchableViewInternal.setMinimumSize(0,100),this.searchableViewInternal.element.classList.add("searchable-view"),this.searchableViewInternal.show(this.timelinePane.element),this.flameChart.show(this.searchableViewInternal.element),this.flameChart.setSearchableView(this.searchableViewInternal),this.searchableViewInternal.hideWidget(),this.#Nt.setMainWidget(this.timelinePane),this.#Nt.show(this.element),this.#Nt.hideSidebar(),this.#Nt.addEventListener("SidebarCollapseClick",this.#jt.bind(this)),this.#Nt.contentElement.addEventListener(T.SidebarInsight.InsightDeactivated.eventName,(()=>{this.#qt(null)})),this.#Nt.contentElement.addEventListener(T.SidebarInsight.InsightActivated.eventName,(e=>{const{name:t,navigationId:i,createOverlayFn:n}=e;this.#qt({name:t,navigationId:i,createOverlayFn:n})})),this.#Nt.contentElement.addEventListener(s.Sidebar.RemoveAnnotation.eventName,(e=>{const{removedAnnotation:t}=e;Ne.activeManager()?.removeAnnotation(t)})),this.onModeChanged(),this.populateToolbar(),this.showLandingPage(),this.updateTimelineControls(),n.TargetManager.TargetManager.instance().addEventListener("SuspendStateChanged",this.onSuspendStateChanged,this);const d=n.TargetManager.TargetManager.instance().models(n.CPUProfilerModel.CPUProfilerModel);for(const e of d)for(const t of e.registeredConsoleProfileMessages)this.consoleProfileFinished(t);n.TargetManager.TargetManager.instance().observeModels(n.CPUProfilerModel.CPUProfilerModel,{modelAdded:e=>{e.addEventListener("ConsoleProfileFinished",(e=>this.consoleProfileFinished(e.data)))},modelRemoved:e=>{}}),n.TargetManager.TargetManager.instance().observeTargets({targetAdded:e=>{e===n.TargetManager.TargetManager.instance().primaryPageTarget()&&this.primaryPageTargetPromiseCallback(e)},targetRemoved:e=>{}})}#zt(){a.Runtime.experiments.isEnabled("timeline-rpp-sidebar")&&(this.#Nt.showBoth(),this.#Nt.updateContentsOnExpand(),this.#Nt.setResizable(!1),this.#ht.hideSidebarFloatingIcon())}#jt(){a.Runtime.experiments.isEnabled("timeline-rpp-sidebar")&&(this.#ht.showSidebarFloatingIcon(),this.#Nt.hideSidebar())}#qt(e){this.#Nt.setActiveInsight(e),this.flameChart.setActiveInsight(e)}static instance(e={forceNew:null,isNode:!1}){const{forceNew:t,isNode:i}=e;return tr=i,ir=a.Runtime.experiments.isEnabled("react-native-specific-ui"),er&&!t||(er=new nr),er}static extensionDataVisibilitySetting(){return r.Settings.Settings.instance().createSetting("timeline-show-extension-data",!0)}searchableView(){return this.searchableViewInternal}wasShown(){super.wasShown(),u.Context.Context.instance().setFlavor(nr,this),this.registerCSSFiles([Wn]),l.userMetrics.panelLoaded("timeline","DevTools.Launch.Timeline")}willHide(){u.Context.Context.instance().setFlavor(nr,null),this.#Dt.cancelIfShowing()}loadFromEvents(e){"Idle"===this.state&&(this.prepareToLoadTimeline(),this.loader=Ln.loadFromEvents(e,this))}getFlameChart(){return this.flameChart}getMinimap(){return this.#ht}getTraceEngineDataForLayoutTests(){const e=this.#Bt.traceParsedData(this.#Ht);if(null===e)throw new Error("No trace engine data found.");return e}getTraceEngineRawTraceEventsForLayoutTests(){const e=this.#Bt.rawTraceEvents(this.#Ht);if(null===e)throw new Error("No trace engine data found.");return e}#Gt(e){if(e.data){const e=new Date,t=e.getUTCMonth()+1,i=e.getUTCDate();4===t&&(1===i||2===i)&&this.fixMeButtonAdded,0}else this.fixMeButtonAdded=!1,this.panelToolbar.removeToolbarItem(this.fixMeButton)}loadFromCpuProfile(e){"Idle"===this.state&&null!==e&&(this.prepareToLoadTimeline(),this.loader=Ln.loadFromCpuProfile(e,this))}setState(e){this.state=e,this.updateTimelineControls()}createSettingCheckbox(e,t){const i=new u.Toolbar.ToolbarSettingCheckbox(e,t);return this.recordingOptionUIControls.push(i),i}populateToolbar(){this.panelToolbar.appendToolbarItem(u.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),ir||null===this.recordReloadAction||this.panelToolbar.appendToolbarItem(u.Toolbar.Toolbar.createActionButton(this.recordReloadAction)),this.clearButton=new u.Toolbar.ToolbarButton(Qn(Xn.clear),"clear"),this.clearButton.addEventListener("Click",(()=>this.onClearButton())),this.panelToolbar.appendToolbarItem(this.clearButton),this.loadButton=new u.Toolbar.ToolbarButton(Qn(Xn.loadProfile),"import",void 0,"timeline.load-from-file"),this.loadButton.addEventListener("Click",(()=>{l.userMetrics.actionTaken(l.UserMetrics.Action.PerfPanelTraceImported),this.selectFileToLoad()})),this.saveButton=new u.Toolbar.ToolbarButton(Qn(Xn.saveProfile),"download",void 0,"timeline.save-to-file"),this.saveButton.addEventListener("Click",(e=>{l.userMetrics.actionTaken(l.UserMetrics.Action.PerfPanelTraceExported),this.saveToFile()})),a.Runtime.experiments.isEnabled("timeline-enhanced-traces")&&this.saveButton.element.addEventListener("contextmenu",(e=>{if(e.preventDefault(),e.stopPropagation(),e.ctrlKey||2===e.button){const t=new u.ContextMenu.ContextMenu(e);t.saveSection().appendItem(Qn(Xn.exportNormalTraces),(()=>{this.saveToFile()})),t.saveSection().appendItem(Qn(Xn.exportEnhancedTraces),(()=>{this.saveToFile(!0)})),t.show()}else this.saveToFile()})),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.loadButton),this.panelToolbar.appendToolbarItem(this.saveButton),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.#Dt.button()),this.panelToolbar.registerCSSFiles([ke]),this.panelToolbar.appendSeparator(),this.panelToolbar.appendSeparator(),tr||ir||(this.showScreenshotsToolbarCheckbox=this.createSettingCheckbox(this.showScreenshotsSetting,Qn(Xn.captureScreenshots)),this.panelToolbar.appendToolbarItem(this.showScreenshotsToolbarCheckbox)),ir||null===this.showMemorySetting||(this.showMemoryToolbarCheckbox=this.createSettingCheckbox(this.showMemorySetting,Qn(Xn.showMemoryTimeline)),this.panelToolbar.appendToolbarItem(this.showMemoryToolbarCheckbox)),this.panelToolbar.appendToolbarItem(u.Toolbar.Toolbar.createActionButtonForId("components.collect-garbage"));const e=new Me;tr&&(this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(e)),tr||ir||(this.panelRightToolbar.appendSeparator(),this.panelRightToolbar.appendToolbarItem(this.showSettingsPaneButton))}createSettingsPane(){this.showSettingsPaneSetting=r.Settings.Settings.instance().createSetting("timeline-show-settings-toolbar",!1),this.showSettingsPaneButton=new u.Toolbar.ToolbarSettingToggle(this.showSettingsPaneSetting,"gear",Qn(Xn.captureSettings),"gear-filled","timeline-settings-toggle"),n.NetworkManager.MultitargetNetworkManager.instance().addEventListener("ConditionsChanged",this.updateShowSettingsToolbarButton,this),n.CPUThrottlingManager.CPUThrottlingManager.instance().addEventListener("RateChanged",this.updateShowSettingsToolbarButton,this),n.CPUThrottlingManager.CPUThrottlingManager.instance().addEventListener("HardwareConcurrencyChanged",this.updateShowSettingsToolbarButton,this),this.disableCaptureJSProfileSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.captureLayersAndPicturesSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.captureSelectorStatsSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.settingsPane=new u.Widget.HBox,this.settingsPane.element.classList.add("timeline-settings-pane"),this.settingsPane.element.setAttribute("jslog",`${g.pane("timeline-settings-pane").track({resize:!0})}`),this.settingsPane.show(this.element);const e=new u.Toolbar.Toolbar("",this.settingsPane.element);e.element.classList.add("flex-auto"),e.makeVertical(),e.appendToolbarItem(this.createSettingCheckbox(this.disableCaptureJSProfileSetting,Qn(Xn.disablesJavascriptSampling))),e.appendToolbarItem(this.createSettingCheckbox(this.captureLayersAndPicturesSetting,Qn(Xn.capturesAdvancedPaint))),e.appendToolbarItem(this.createSettingCheckbox(this.captureSelectorStatsSetting,Qn(Xn.capturesSelectorStats)));const t=new u.Widget.VBox;t.element.classList.add("flex-auto"),t.show(this.settingsPane.element);const i=new u.Toolbar.Toolbar("",t.element);i.appendText(Qn(Xn.cpu)),this.cpuThrottlingSelect=v.ThrottlingManager.throttlingManager().createCPUThrottlingSelector(),i.appendToolbarItem(this.cpuThrottlingSelect);const a=new u.Toolbar.Toolbar("",t.element);a.appendText(Qn(Xn.network)),this.networkThrottlingSelect=this.createNetworkConditionsSelect(),a.appendToolbarItem(this.networkThrottlingSelect);const s=new u.Widget.VBox;s.element.classList.add("flex-auto"),s.show(this.settingsPane.element);const o=new u.Toolbar.Toolbar("",this.settingsPane.element);o.element.classList.add("flex-auto"),o.makeVertical(),o.appendToolbarItem(this.createSettingCheckbox(this.#At,Qn(Xn.showDataAddedByExtensions)));const{toggle:l,input:c,reset:d,warning:h}=v.ThrottlingManager.throttlingManager().createHardwareConcurrencySelector(),m=new u.Toolbar.Toolbar("",s.element);m.registerCSSFiles([Wn]),c.element.classList.add("timeline-concurrency-input"),m.appendToolbarItem(l),m.appendToolbarItem(c),m.appendToolbarItem(d),m.appendToolbarItem(h),this.showSettingsPaneSetting.addChangeListener(this.updateSettingsPaneVisibility.bind(this)),this.updateSettingsPaneVisibility()}createNetworkConditionsSelect(){const e=new u.Toolbar.ToolbarComboBox(null,Qn(Xn.networkConditions));return e.setMaxWidth(140),v.ThrottlingManager.throttlingManager().decorateSelectWithNetworkThrottling(e.selectElement()),e}prepareToLoadTimeline(){console.assert("Idle"===this.state),this.setState("Loading")}createFileSelector(){this.fileSelectorElement&&this.fileSelectorElement.remove(),this.fileSelectorElement=u.UIUtils.createFileSelectorElement(this.loadFromFile.bind(this),".json,.gz,.gzip,.cpuprofile"),this.timelinePane.element.appendChild(this.fileSelectorElement)}contextMenu(e){const t=e;if(-1!==this.flameChart.getMainFlameChart().coordinatesToEntryIndex(t.offsetX,t.offsetY))return;const i=new u.ContextMenu.ContextMenu(e,{useSoftMenu:!0});i.appendItemsAtLocation("timelineMenu"),i.show()}async saveToFile(e=!1){if("Idle"!==this.state)return;const t=this.#Bt.rawTraceEvents(this.#Ht),n=this.#Bt.metadata(this.#Ht);if(a.Runtime.experiments.isEnabled("perf-panel-annotations")&&n&&(n.modifications=Ne.activeManager()?.toJSON()),n&&e&&(n.enhancedTraceVersion=i.Handlers.ModelHandlers.EnhancedTraces.EnhancedTracesVersion),!t)return;const s=c.DateUtilities.toISO8601Compact(new Date);let o;o="CPUProfile"===n?.dataOrigin?`CPU-${s}.cpuprofile`:n&&n.enhancedTraceVersion?`EnhancedTraces-${s}.json`:`Trace-${s}.json`;try{let e;if("CPUProfile"===n?.dataOrigin){const i=t.find((e=>"CpuProfile"===e.name));if(!i||!i.args?.data)return;const n=i.args?.data;if(n.hasOwnProperty("cpuProfile")){e=We(n.cpuProfile)}}else{const i=Ue(t,n);e=Array.from(i).join("")}if(!e)throw new Error("Trace content empty");await d.FileManager.FileManager.instance().save(o,e,!0,!1),d.FileManager.FileManager.instance().close(o)}catch(e){if(console.error(e.stack),"AbortError"===e.name)return;r.Console.Console.instance().error(Qn(Xn.failedToSaveTimelineSS,{PH1:e.message,PH2:e.name}))}}async showHistory(){const e=await this.#Dt.showHistoryDropDown();this.#$t(),e&&e.traceParseDataIndex!==this.#Ht&&this.setModel(e.traceParseDataIndex)}navigateHistory(e){this.#$t();const t=this.#Dt.navigate(e);return t&&t.traceParseDataIndex!==this.#Ht&&this.setModel(t.traceParseDataIndex),!0}#$t(){const e=Ne.activeManager()?.toJSON();e&&this.#Bt.overrideModifications(this.#Ht,e)}selectFileToLoad(){this.fileSelectorElement&&this.fileSelectorElement.click()}async loadFromFile(e){"Idle"===this.state&&(this.prepareToLoadTimeline(),this.loader=await Ln.loadFromFile(e,this),this.createFileSelector())}async loadFromURL(e){"Idle"===this.state&&(this.prepareToLoadTimeline(),this.loader=await Ln.loadFromURL(e,this))}updateMiniMap(){const e=this.#Bt.traceParsedData(this.#Ht),t="CPUProfile"===this.#Bt.metadata(this.#Ht)?.dataOrigin;e&&this.#ht.setData({traceParsedData:e,isCpuProfile:t,settings:{showScreenshots:this.showScreenshotsSetting.get(),showMemory:!ir&&null!==this.showMemorySetting&&this.showMemorySetting.get()}})}onModeChanged(){this.flameChart.updateCountersGraphToggle(!ir&&null!==this.showMemorySetting&&this.showMemorySetting.get()),this.updateMiniMap(),this.doResize(),this.select(null)}#_t(){this.flameChart.extensionDataVisibilityChanged()}updateSettingsPaneVisibility(){tr||ir||(this.showSettingsPaneSetting.get()?(this.showSettingsPaneButton.setToggled(!0),this.settingsPane.showWidget()):(this.showSettingsPaneButton.setToggled(!1),this.settingsPane.hideWidget()))}updateShowSettingsToolbarButton(){const e=[];if(1!==n.CPUThrottlingManager.CPUThrottlingManager.instance().cpuThrottlingRate()&&e.push(Qn(Xn.CpuThrottlingIsEnabled)),v.ThrottlingManager.throttlingManager().hardwareConcurrencyOverrideEnabled&&e.push(Qn(Xn.HardwareConcurrencyIsEnabled)),n.NetworkManager.MultitargetNetworkManager.instance().isThrottling()&&e.push(Qn(Xn.NetworkThrottlingIsEnabled)),this.captureLayersAndPicturesSetting.get()&&e.push(Qn(Xn.SignificantOverheadDueToPaint)),this.captureSelectorStatsSetting.get()&&e.push(Qn(Xn.SelectorStatsEnabled)),this.disableCaptureJSProfileSetting.get()&&e.push(Qn(Xn.JavascriptSamplingIsDisabled)),this.showSettingsPaneButton.setDefaultWithRedColor(e.length>0),this.showSettingsPaneButton.setToggleWithRedColor(e.length>0),e.length){const t=document.createElement("div");e.forEach((e=>{t.createChild("div").textContent=e})),this.showSettingsPaneButton.setTitle(t.textContent||"")}else this.showSettingsPaneButton.setTitle(Qn(Xn.captureSettings))}setUIControlsEnabled(e){this.recordingOptionUIControls.forEach((t=>t.setEnabled(e)))}async#Jt(){if(!this.controller)return c.DevToolsPath.EmptyUrlString;const e=this.controller.primaryPageTarget.inspectedURL(),t=this.controller.primaryPageTarget.model(n.ResourceTreeModel.ResourceTreeModel),i=t&&await t.navigationHistory();if(!t||!i)return e;const{currentIndex:r,entries:a}=i;return a[r].url}async#Kt(){const e=new Promise((async(e,t)=>{if(!this.controller)return void t("Could not find TimelineController");const i=this.controller.primaryPageTarget.model(n.ResourceTreeModel.ResourceTreeModel);i?(i.addEventListener(n.ResourceTreeModel.Events.FrameNavigated,(function r(a){"about:blank"===a.data.url?e():t(`Unexpected navigation to ${a.data.url}`),i?.removeEventListener(n.ResourceTreeModel.Events.FrameNavigated,r)})),await i.navigate("about:blank")):t("Could not load resourceModel")}));await e}async#Yt(){try{if(this.cpuProfiler=u.Context.Context.instance().flavor(n.CPUProfilerModel.CPUProfilerModel),!this.cpuProfiler){const e=n.TargetManager.TargetManager.instance().targets().find((e=>e.type()===n.Target.Type.Node));if(!e)throw new Error("Could not load any Node target.");e&&(this.cpuProfiler=e.model(n.CPUProfilerModel.CPUProfilerModel))}if(this.setUIControlsEnabled(!1),this.hideLandingPage(),!this.cpuProfiler)throw new Error("No Node target is found.");await n.TargetManager.TargetManager.instance().suspendAllTargets("performance-timeline"),await this.cpuProfiler.startRecording(),this.recordingStarted()}catch(e){await this.recordingFailed(e.message)}}async#Xt(){try{const e=n.TargetManager.TargetManager.instance().rootTarget(),t=n.TargetManager.TargetManager.instance().primaryPageTarget();if(!t)throw new Error("Could not load primary page target.");if(!e)throw new Error("Could not load root target.");if(qn.isUiDevTools()?this.controller=new Kn(e,t,this):this.controller=new Je(e,t,this),this.setUIControlsEnabled(!1),this.hideLandingPage(),!this.controller)throw new Error("Could not create Timeline controller");const i=await this.#Jt();this.recordingPageReload&&await this.#Kt();const r={enableJSSampling:!this.disableCaptureJSProfileSetting.get(),capturePictures:this.captureLayersAndPicturesSetting.get(),captureFilmStrip:this.showScreenshotsSetting.get(),captureSelectorStats:this.captureSelectorStatsSetting.get()},a=await this.controller.startRecording(r);if(a.getError())throw new Error(a.getError());const s=this.recordingPageReload?{navigateToUrl:i}:void 0;this.recordingStarted(s)}catch(e){await this.recordingFailed(e.message)}}async startRecording(){this.#$t(),console.assert(!this.statusPane,"Status pane is already opened."),this.setState("StartPending"),this.showRecordingStarted(),tr?await this.#Yt():await this.#Xt()}async stopRecording(){if(this.statusPane&&(this.statusPane.finish(),this.statusPane.updateStatus(Qn(Xn.stoppingTimeline)),this.statusPane.updateProgressBar(Qn(Xn.received),0)),this.setState("StopPending"),this.controller)return await this.controller.stopRecording(),this.setUIControlsEnabled(!0),await this.controller.dispose(),void(this.controller=null);if(this.cpuProfiler){const e=await this.cpuProfiler.stopRecording();this.setState("Idle"),this.loadFromCpuProfile(e),this.setUIControlsEnabled(!0),this.cpuProfiler=null,await n.TargetManager.TargetManager.instance().resumeAllTargets()}}async recordingFailed(e,t){this.statusPane&&this.statusPane.remove(),this.statusPane=new rr({description:e,buttonText:Qn(Xn.close),buttonDisabled:!1,showProgress:void 0,showTimer:void 0},(async()=>{this.statusPane?.remove(),await this.loadingComplete([],null,!1,null,null)})),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Qn(Xn.recordingFailed)),t&&this.statusPane.enableDownloadOfEvents(t),this.setState("RecordingFailed"),this.traceLoadStart=null,this.setUIControlsEnabled(!0),this.controller&&(await this.controller.dispose(),this.controller=null),n.TargetManager.TargetManager.instance().resumeAllTargets()}onSuspendStateChanged(){this.updateTimelineControls()}consoleProfileFinished(e){this.loadFromCpuProfile(e.cpuProfile),u.InspectorView.InspectorView.instance().showPanel("timeline")}updateTimelineControls(){this.toggleRecordAction.setToggled("Recording"===this.state),this.toggleRecordAction.setEnabled("Recording"===this.state||"Idle"===this.state),ir||null===this.recordReloadAction||this.recordReloadAction.setEnabled(!tr&&"Idle"===this.state),this.#Dt.setEnabled("Idle"===this.state),this.clearButton.setEnabled("Idle"===this.state),this.panelToolbar.setEnabled("Loading"!==this.state),this.panelRightToolbar.setEnabled("Loading"!==this.state),this.dropTarget.setEnabled("Idle"===this.state),this.loadButton.setEnabled("Idle"===this.state),this.saveButton.setEnabled("Idle"===this.state&&this.#Zt())}async toggleRecording(){"Idle"===this.state?(this.recordingPageReload=!1,await this.startRecording(),l.userMetrics.actionTaken(l.UserMetrics.Action.TimelineStarted)):"Recording"===this.state&&await this.stopRecording()}recordReload(){"Idle"===this.state&&(this.recordingPageReload=!0,this.startRecording(),l.userMetrics.actionTaken(l.UserMetrics.Action.TimelinePageReloadStarted))}onClearButton(){this.#Dt.clear(),this.clear()}#Zt(){return this.#Ht>-1}onFixMe(){this.#Zt()&&this.flameChart.fixMe()}clear(){this.statusPane&&this.statusPane.remove(),this.showLandingPage(),this.reset()}reset(){p.LineLevelProfile.Performance.instance().reset(),this.#Ut&&(this.#Ut.removeEventListener(Ve.eventName,this.#Wt),this.#Ut.uninstall(),this.#Ut=null),this.setModel(-1)}#Qt(e,t=null){if(e||a.Runtime.experiments.isEnabled("timeline-show-all-events"))return;const i=t?[t]:[Ct.visibleEventsFilter()];be.instance().setFilters(i)}setModel(e,t=null){this.#$t(),this.#Ht=e;const r=this.#Bt.traceParsedData(this.#Ht),a="CPUProfile"===this.#Bt.metadata(this.#Ht)?.dataOrigin;if(this.#ht.reset(),r&&h.TraceBounds.BoundsManager.instance().resetWithNewBounds(r.Meta.traceBounds),this.flameChart.setModel(r,a),this.flameChart.resizeToPreferredHeights(),this.flameChart.setSelection(null),this.#Nt.setTraceParsedData(r),r?(this.searchableViewInternal.showWidget(),this.#Qt(r.Meta.traceIsGeneric,t)):this.searchableViewInternal.hideWidget(),r){const e=Ne.initAndActivateModificationsManager(this.#Bt,this.#Ht);e||console.error("ModificationsManager could not be created or activated."),e?.addEventListener(Ae.eventName,(t=>{const{overlay:i,action:n}=t;"Add"===n?this.flameChart.addOverlay(i):"Remove"===n&&this.flameChart.removeOverlay(i),this.#Nt.setAnnotationsTabContent(e.getAnnotations())})),this.#ht.breadcrumbsActivated&&this.#ht.addInitialBreadcrumb();const t=this.flameChart.getMainDataProvider().compatibilityTracksAppenderInstance().threadAppenders().at(0);if(t){const e=i.Extras.MainThreadActivity.calculateWindow(r.Meta.traceBounds,t.getEntries());h.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(e)}}r||(this.fixMeButtonAdded=!1,this.panelToolbar.removeToolbarItem(this.fixMeButton));const s=Ne.activeManager();if(s&&(s.getOverlays().forEach((e=>{this.flameChart.addOverlay(e)})),this.#Nt.setAnnotationsTabContent(s.getAnnotations())),p.LineLevelProfile.Performance.instance().reset(),r&&r.Samples.profilesInProcess.size){const e=n.TargetManager.TargetManager.instance().primaryPageTarget(),t=Array.from(r.Samples.profilesInProcess).flatMap((([e,t])=>Array.from(t.values()).map((e=>e.parsedProfile))));for(const i of t)p.LineLevelProfile.Performance.instance().appendCPUProfile(i,e)}this.updateMiniMap(),this.updateTimelineControls();const o=this.#Bt.traceInsights(this.#Ht);o&&(this.flameChart.setInsights(o),this.#Nt.setInsights(o),this.#qt(null))}recordingStarted(e){if(e&&this.recordingPageReload&&this.controller){const t=this.controller?.primaryPageTarget.model(n.ResourceTreeModel.ResourceTreeModel);if(!t)return void this.recordingFailed("Could not navigate to original URL");t.navigate(e.navigateToUrl)}this.reset(),this.setState("Recording"),this.showRecordingStarted(),this.statusPane&&(this.statusPane.enableAndFocusButton(),this.statusPane.updateStatus(Qn(Xn.profiling)),this.statusPane.updateProgressBar(Qn(Xn.bufferUsage),0),this.statusPane.startTimer()),this.hideLandingPage()}recordingProgress(e){this.statusPane&&this.statusPane.updateProgressBar(Qn(Xn.bufferUsage),100*e)}showLandingPage(){this.updateSettingsPaneVisibility(),this.#jt(),this.landingPage||(this.landingPage=new Pn(this.toggleRecordAction,{isNode:tr})),this.landingPage.show(this.statusPaneContainer)}hideLandingPage(){this.landingPage.detach(),this.showSettingsPaneButton?.setToggled(!1),this.settingsPane?.hideWidget()}async loadingStarted(){this.hideLandingPage(),this.statusPane&&this.statusPane.remove(),this.statusPane=new rr({showProgress:!0,showTimer:void 0,buttonDisabled:void 0,buttonText:void 0,description:void 0},(()=>this.cancelLoading())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Qn(Xn.loadingProfile)),this.loader||this.statusPane.finish(),this.traceLoadStart=i.Types.Timing.MilliSeconds(performance.now()),await this.loadingProgress(0)}async loadingProgress(e){"number"==typeof e&&this.statusPane&&this.statusPane.updateProgressBar(Qn(Xn.received),100*e)}async processingStarted(){this.statusPane&&this.statusPane.updateStatus(Qn(Xn.processingProfile))}#Ot(){this.flameChart.refreshMainFlameChart()}async loadingComplete(e,t=null,n,r,s){this.#Bt.resetProcessor(),ze.clearResolvedNodeNames(),delete this.loader;const o="StopPending"===this.state;if(this.setState("Idle"),0!==e.length){s=s||await i.Extras.Metadata.forNewRecording(n,r??void 0);try{await this.#ei(e,o,s),this.setModel(this.#Bt.lastTraceIndex(),t),this.statusPane&&this.statusPane.remove(),this.statusPane=null,a.Runtime.experiments.isEnabled("timeline-rpp-sidebar")&&1===this.#Bt.size()&&this.#ht.showSidebarFloatingIcon();const n=this.#Bt.traceParsedData(this.#Ht);if(!n)throw new Error(`Could not get trace data at index ${this.#Ht}`);o&&Ce.instance().registerFreshRecording(n),this.#Ut=new ze(n),this.#Ut.addEventListener(Ve.eventName,this.#Wt),await this.#Ut.install(),this.#Dt.addRecording({data:{traceParseDataIndex:this.#Ht},filmStripForPreview:i.Extras.FilmStrip.fromTraceData(n),traceParsedData:n,startTime:r??null})}catch(t){this.recordingFailed(t.message,e),console.error(t)}finally{this.recordTraceLoadMetric()}}else this.#Bt.size()?(this.statusPane&&this.statusPane.remove(),this.setModel(this.#Bt.lastTraceIndex())):this.clear()}recordTraceLoadMetric(){if(!this.traceLoadStart)return;const e=this.traceLoadStart;requestAnimationFrame((()=>{setTimeout((()=>{const t=i.Types.Timing.MilliSeconds(performance.now()),n=performance.measure("TraceLoad",{start:e,end:t}),r=i.Types.Timing.MilliSeconds(n.duration);this.element.dispatchEvent(new K(r)),l.userMetrics.performanceTraceLoad(n)}),0)}))}async#ei(e,t,i){return this.#Bt.parse(e,{metadata:i,isFreshRecording:t})}loadingCompleteForTest(){}showRecordingStarted(){this.statusPane&&this.statusPane.remove(),this.statusPane=new rr({showTimer:!0,showProgress:!0,buttonDisabled:!0,description:void 0,buttonText:void 0},(()=>this.stopRecording())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Qn(Xn.initializingProfiler))}cancelLoading(){this.loader&&this.loader.cancel()}async loadEventFired(e){if("Recording"!==this.state||!this.recordingPageReload||!this.controller||this.controller.primaryPageTarget!==e.data.resourceTreeModel.target())return;const t=this.controller;await new Promise((e=>window.setTimeout(e,this.millisecondsToRecordAfterLoadEvent))),t===this.controller&&"Recording"===this.state&&this.stopRecording()}frameForSelection(e){if(vt.isFrameObject(e.object))return e.object;if(vt.isRangeSelection(e.object)||vt.isSyntheticNetworkRequestDetailsEventSelection(e.object))return null;if(vt.isTraceEventSelection(e.object)){const t=this.#Bt.traceParsedData(this.#Ht);if(!t)return null;const n=i.Helpers.Timing.millisecondsToMicroseconds(e.endTime);return i.Handlers.ModelHandlers.Frames.framesWithinWindow(t.Frames.frames,n,n).at(0)||null}return console.assert(!1,"Should never be reached"),null}jumpToFrame(e){const t=this.selection&&this.frameForSelection(this.selection);if(!t)return;const n=this.#Bt.traceParsedData(this.#Ht);if(!n)return;let r=n.Frames.frames.indexOf(t);console.assert(r>=0,"Can't find current frame in the frame list"),r=c.NumberUtilities.clamp(r+e,0,n.Frames.frames.length-1);const a=n.Frames.frames[r];return this.#ti(i.Helpers.Timing.microSecondsToMilliseconds(a.startTime),i.Helpers.Timing.microSecondsToMilliseconds(a.endTime)),this.select(vt.fromFrame(a)),!0}select(e){this.selection=e,this.flameChart.setSelection(e)}selectEntryAtTime(e,t){if(e)if(0!==e.length){for(let n=c.ArrayUtilities.upperBound(e,t,((e,t)=>e-t.ts))-1;n>=0;--n){const r=e[n],{endTime:a}=i.Helpers.Timing.eventTimingsMilliSeconds(r);if(i.Helpers.Trace.isTopLevelEvent(r)&&a<t)break;if(be.instance().isVisible(r)&&a>=t)return void this.select(vt.fromTraceEvent(r))}this.select(null)}else this.select(null)}highlightEvent(e){this.flameChart.highlightEvent(e)}#ti(e,t){const n=h.TraceBounds.BoundsManager.instance().state();if(!n)return;const r=n.milli.timelineTraceWindow;let a=0;r.max<t?a=t-r.max:r.min>e&&(a=e-r.min),h.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(i.Helpers.Timing.traceWindowFromMilliSeconds(i.Types.Timing.MilliSeconds(r.min+a),i.Types.Timing.MilliSeconds(r.max+a)),{shouldAnimate:!0})}handleDrop(e){const t=e.items;if(!t.length)return;const i=t[0];if(l.userMetrics.actionTaken(l.UserMetrics.Action.PerfPanelTraceImported),"string"===i.kind){const t=e.getData("text/uri-list");new r.ParsedURL.ParsedURL(t).isValid&&this.loadFromURL(t)}else if("file"===i.kind){const e=t[0].getAsFile();if(!e)return;this.loadFromFile(e)}}}class rr extends u.Widget.VBox{status;time;progressLabel;progressBar;description;button;downloadTraceButton;startTime;timeUpdateTimer;#ii;constructor(e,t){super(!0),this.contentElement.classList.add("timeline-status-dialog");const i=this.contentElement.createChild("div","status-dialog-line status");if(i.createChild("div","label").textContent=Qn(Xn.status),this.status=i.createChild("div","content"),u.ARIAUtils.markAsStatus(this.status),e.showTimer){const e=this.contentElement.createChild("div","status-dialog-line time");e.createChild("div","label").textContent=Qn(Xn.time),this.time=e.createChild("div","content")}if(e.showProgress){const e=this.contentElement.createChild("div","status-dialog-line progress");this.progressLabel=e.createChild("div","label"),this.progressBar=e.createChild("div","indicator-container").createChild("div","indicator"),u.ARIAUtils.markAsProgressBar(this.progressBar)}if("string"==typeof e.description){const t=this.contentElement.createChild("div","status-dialog-line description");t.createChild("div","label").textContent=Qn(Xn.description),this.description=t.createChild("div","content"),this.description.innerText=e.description}const n=this.contentElement.createChild("div","stop-button");this.downloadTraceButton=u.UIUtils.createTextButton(Qn(Xn.downloadAfterError),(()=>{this.#ni()}),{jslogContext:"timeline.download-after-error"}),this.downloadTraceButton.disabled=!0,this.downloadTraceButton.style.visibility="hidden";const r=e.buttonText||Qn(Xn.stop);this.button=u.UIUtils.createTextButton(r,t,{jslogContext:"timeline.stop-recording"}),this.button.disabled=!1==!e.buttonDisabled,n.append(this.downloadTraceButton),n.append(this.button)}finish(){this.stopTimer(),this.button.disabled=!0}async#ni(){if(!this.#ii||0===this.#ii.length)return;const e=`Trace-Load-Error-${c.DateUtilities.toISO8601Compact(new Date)}.json`,t=Ue(this.#ii,{}),i=Array.from(t).join("");await d.FileManager.FileManager.instance().save(e,i,!0,!1),d.FileManager.FileManager.instance().close(e)}enableDownloadOfEvents(e){this.#ii=e,this.downloadTraceButton.disabled=!1,this.downloadTraceButton.style.visibility="visible"}remove(){this.element.parentNode&&(this.element.parentNode.classList.remove("tinted"),this.arrangeDialog(this.element.parentNode)),this.stopTimer(),this.element.remove()}showPane(e){this.arrangeDialog(e),this.show(e),e.classList.add("tinted")}enableAndFocusButton(){this.button.disabled=!1,this.button.focus()}updateStatus(e){this.status.textContent=e}updateProgressBar(e,t){this.progressLabel.textContent=e,this.progressBar.style.width=t.toFixed(1)+"%",u.ARIAUtils.setValueNow(this.progressBar,t),this.updateTimer()}startTimer(){this.startTime=Date.now(),this.timeUpdateTimer=window.setInterval(this.updateTimer.bind(this,!1),1e3),this.updateTimer()}stopTimer(){this.timeUpdateTimer&&(clearInterval(this.timeUpdateTimer),this.updateTimer(!0),delete this.timeUpdateTimer)}updateTimer(e){if(this.arrangeDialog(this.element.parentNode),!this.timeUpdateTimer||!this.time)return;const t=(Date.now()-this.startTime)/1e3;this.time.textContent=Qn(Xn.ssec,{PH1:t.toFixed(e?1:0)})}arrangeDialog(e){const t=e.clientWidth<325;this.element.classList.toggle("small-dialog",t),this.contentElement.classList.toggle("small-dialog",t)}wasShown(){super.wasShown(),this.registerCSSFiles([On])}}let ar;class sr{static instance(e={forceNew:null}){const{forceNew:t}=e;return ar&&!t||(ar=new sr),ar}handleQueryParam(e){u.ViewManager.ViewManager.instance().showView("timeline").then((async()=>{await nr.instance().loadFromURL(window.decodeURIComponent(e))}))}}var or=Object.freeze({__proto__:null,TimelinePanel:nr,rowHeight:18,headerHeight:20,StatusPane:rr,LoadTimelineHandler:sr,ActionDelegate:class{handleAction(e,t){const i=e.flavor(nr);if(null===i)return!1;switch(t){case"timeline.toggle-recording":return i.toggleRecording(),!0;case"timeline.record-reload":return i.recordReload(),!0;case"timeline.save-to-file":return i.saveToFile(),!0;case"timeline.load-from-file":return i.selectFileToLoad(),!0;case"timeline.jump-to-previous-frame":return i.jumpToFrame(-1),!0;case"timeline.jump-to-next-frame":return i.jumpToFrame(1),!0;case"timeline.show-history":return i.showHistory(),!0;case"timeline.previous-recording":return i.navigateHistory(1),!0;case"timeline.next-recording":return i.navigateHistory(-1),!0}return!1}}});let lr;class cr{#t=null;#ri=new Map;static instance(){return lr||(lr=new cr,lr)}static removeInstance(){lr=void 0}getExtensionData(){if(!nr.extensionDataVisibilitySetting().get()||!this.#t||!this.#t.ExtensionTraceData)return{extensionMarkers:[],extensionTrackData:[]};const e=this.#ri.get(this.#t);return e||this.#t.ExtensionTraceData}saveCurrentModelData(){this.#t&&!this.#ri.has(this.#t)&&this.#ri.set(this.#t,this.getExtensionData())}modelChanged(e){e!==this.#t&&(null!==this.#t&&this.saveCurrentModelData(),this.#t=e)}}var dr=Object.freeze({__proto__:null,ExtensionDataGatherer:cr});const hr={customTrackDescription:"This is a custom track added by a third party.",customTrackName:"{PH1} — Custom Track"},mr=e.i18n.registerUIStrings("panels/timeline/ExtensionTrackAppender.ts",hr),pr=e.i18n.getLocalizedString.bind(void 0,mr);class ur{appenderName="Extension";#ai;#e;constructor(e,t){this.#ai=t,this.#e=e}appendTrackAtLevel(e,t){return 0===Object.values(this.#ai.entriesByTrack).reduce(((e,t)=>t.length+e),0)?e:(this.#si(e,t),this.#oi(e))}#si(e,t){const i=U({shareHeaderLine:!1,collapsible:!0}),n=W("extension",e,pr(hr.customTrackName,{PH1:this.#ai.name}),i,!0,t);n.description=pr(hr.customTrackDescription),this.#e.registerTrackForGroup(n,this)}#li(e,t){const i=W("extension",e,t,U({shareHeaderLine:!1,padding:2,nestingLevel:1,collapsible:!0}),!0);this.#e.registerTrackForGroup(i,this)}#oi(e){let t=e;for(const[e,i]of Object.entries(this.#ai.entriesByTrack))this.#ai.isTrackGroup&&this.#li(t,e),t=this.#e.appendEventsAtLevel(i,t,this);return t}colorForEvent(e){const n=t.ThemeSupport.instance().getComputedValue("--app-color-rendering");return i.Types.Extensions.isSyntheticExtensionEntry(e)?P.ExtensionUI.extensionEntryColor(e):n}titleForEvent(e){return i.Types.Extensions.isSyntheticExtensionEntry(e)?e.name:t.ThemeSupport.instance().getComputedValue("--app-color-rendering")}highlightedEntryInfo(e){return{title:i.Types.Extensions.isSyntheticExtensionEntry(e)&&e.args.tooltipText?e.args.tooltipText:this.titleForEvent(e),formattedTime:O(e.dur)}}}var gr=Object.freeze({__proto__:null,ExtensionTrackAppender:ur});const vr={gpu:"GPU"},Tr=e.i18n.registerUIStrings("panels/timeline/GPUTrackAppender.ts",vr),fr=e.i18n.getLocalizedString.bind(void 0,Tr);class yr{appenderName="GPU";#e;#t;constructor(e,t){this.#e=e,this.#t=t}appendTrackAtLevel(e,t){const i=this.#t.GPU.mainGPUThreadTasks;return 0===i.length?e:(this.#i(e,t),this.#e.appendEventsAtLevel(i,e,this))}#i(e,t){const i=U({collapsible:!1}),n=W("gpu",e,fr(vr.gpu),i,!0,t);this.#e.registerTrackForGroup(n,this)}colorForEvent(e){if(!i.Types.TraceEvents.isTraceEventGPUTask(e))throw new Error(`Unexpected GPU Task: The event's type is '${e.name}'`);return t.ThemeSupport.instance().getComputedValue("--app-color-painting")}titleForEvent(e){return i.Types.TraceEvents.isTraceEventGPUTask(e)?"GPU":e.name}highlightedEntryInfo(e){return{title:this.titleForEvent(e),formattedTime:O(e.dur)}}}var wr=Object.freeze({__proto__:null,GPUTrackAppender:yr});const br={layoutShifts:"Layout Shifts"},Sr=e.i18n.registerUIStrings("panels/timeline/LayoutShiftsTrackAppender.ts",br),Cr=e.i18n.getLocalizedString.bind(void 0,Sr),Er=i.Types.Timing.MicroSeconds(5e3);class kr{appenderName="LayoutShifts";#e;#t;constructor(e,t){this.#e=e,this.#t=t}appendTrackAtLevel(e,t){return 0===this.#t.LayoutShifts.clusters.length?e:(this.#i(e,t),this.#ci(e))}#i(e,t){const i=U({collapsible:!1}),n=W("layout-shifts",e,Cr(br.layoutShifts),i,!0,t);this.#e.registerTrackForGroup(n,this)}#ci(e){const t=this.#t.LayoutShifts.clusters.flatMap((e=>e.events));return this.#e.appendEventsAtLevel(t,e,this,((e,t)=>{this.#e.getFlameChartTimelineData().entryTotalTimes[t]=i.Helpers.Timing.microSecondsToMilliseconds(Er)}))}colorForEvent(e){return t.ThemeSupport.instance().getComputedValue("--app-color-rendering")}titleForEvent(e){return i.Types.TraceEvents.isTraceEventLayoutShift(e)?"Layout shift":e.name}highlightedEntryInfo(e){return{title:this.titleForEvent(e),formattedTime:O(e.dur)}}}var xr=Object.freeze({__proto__:null,LAYOUT_SHIFT_SYNTHETIC_DURATION:Er,LayoutShiftsTrackAppender:kr});const Pr={timings:"Timings"},Ir=e.i18n.registerUIStrings("panels/timeline/TimingsTrackAppender.ts",Pr),Mr=e.i18n.getLocalizedString.bind(void 0,Ir);class Fr{appenderName="Timings";#M;#e;#t;constructor(e,t,i){this.#e=e,this.#M=i,this.#t=t}appendTrackAtLevel(e,t){const n=cr.instance().getExtensionData().extensionMarkers,r=this.#t.PageLoadMetrics.allMarkerEvents,a=0===n.length,s=this.#t.UserTimings.performanceMarks.filter((e=>!i.Handlers.ModelHandlers.ExtensionTraceData.extensionDataInTiming(e))),o=this.#t.UserTimings.performanceMeasures.filter((e=>!i.Handlers.ModelHandlers.ExtensionTraceData.extensionDataInTiming(e))),l=this.#t.UserTimings.timestampEvents,c=this.#t.UserTimings.consoleTimings;if(a&&0===r.length&&0===s.length&&0===o.length&&0===l.length&&0===c.length)return e;this.#i(e,t);let d=this.#di(e);return d=this.#e.appendEventsAtLevel(s,d,this),d=this.#e.appendEventsAtLevel(o,d,this),d=this.#e.appendEventsAtLevel(l,d,this),this.#e.appendEventsAtLevel(c,d,this)}#i(e,t){const i=U({useFirstLineForOverview:!0,collapsible:this.#t.UserTimings.performanceMeasures.length>0}),n=W("timings",e,Mr(Pr.timings),i,!0,t);this.#e.registerTrackForGroup(n,this)}#di(e){let t=this.#t.PageLoadMetrics.allMarkerEvents;if(t=t.concat(cr.instance().getExtensionData().extensionMarkers).sort(((e,t)=>e.ts-t.ts)),0===t.length)return e;t.forEach((t=>{const i=this.#e.appendEventAtLevel(t,e,this);this.#e.getFlameChartTimelineData().entryTotalTimes[i]=Number.NaN}));const n=i.Helpers.Timing.microSecondsToMilliseconds(this.#t.Meta.traceBounds.min),r=t.map((e=>{const t=i.Helpers.Timing.microSecondsToMilliseconds(e.ts),r=i.Types.Extensions.isSyntheticExtensionEntry(e)?this.markerStyleForExtensionMarker(e):this.markerStyleForPageLoadEvent(e);return new Yi(t,t-n,r)}));return this.#e.getFlameChartTimelineData().markers.push(...r),++e}markerStyleForPageLoadEvent(e){let t="",n="grey";return i.Types.TraceEvents.isTraceEventMarkDOMContent(e)&&(n="#0867CB",t="DCL"),i.Types.TraceEvents.isTraceEventMarkLoad(e)&&(n="#B31412",t="L"),i.Types.TraceEvents.isTraceEventFirstPaint(e)&&(n="#228847",t="FP"),i.Types.TraceEvents.isTraceEventFirstContentfulPaint(e)&&(n="#1A6937",t="FCP"),i.Types.TraceEvents.isTraceEventLargestContentfulPaintCandidate(e)&&(n="#1A3422",t="LCP"),i.Types.TraceEvents.isTraceEventNavigationStart(e)&&(n="#FF9800",t=""),{title:t,dashStyle:[6,4],lineWidth:.5,color:n,tall:!0,lowPriority:!1}}markerStyleForExtensionMarker(e){return{title:e.name,dashStyle:[6,4],lineWidth:.5,color:P.ExtensionUI.extensionEntryColor(e),tall:!0,lowPriority:!1}}colorForEvent(e){return i.Types.TraceEvents.eventIsPageLoadEvent(e)?this.markerStyleForPageLoadEvent(e).color:i.Types.Extensions.isSyntheticExtensionEntry(e)?P.ExtensionUI.extensionEntryColor(e):this.#M.colorForID(e.name)}titleForEvent(e){i.Handlers.ModelHandlers.PageLoadMetrics;if(i.Types.TraceEvents.eventIsPageLoadEvent(e))switch(e.name){case"MarkDOMContent":return"DCL";case"MarkLoad":return"L";case"firstContentfulPaint":return"FCP";case"firstPaint":return"FP";case"largestContentfulPaint::Candidate":return"LCP";case"navigationStart":return"";default:return e.name}return i.Types.TraceEvents.isTraceEventTimeStamp(e)?`${e.name}: ${e.args.data.message}`:i.Types.TraceEvents.isTraceEventPerformanceMark(e)?`[mark]: ${e.name}`:e.name}highlightedEntryInfo(e){const t=i.Types.Extensions.isSyntheticExtensionEntry(e)&&e.args.tooltipText?e.args.tooltipText:this.titleForEvent(e);if(i.Types.TraceEvents.isTraceEventMarkerEvent(e)||i.Types.TraceEvents.isTraceEventPerformanceMark(e)||i.Types.TraceEvents.isTraceEventTimeStamp(e)){return{title:t,formattedTime:O(i.Helpers.Timing.timeStampForEventAdjustedByClosestNavigation(e,this.#t.Meta.traceBounds,this.#t.Meta.navigationsByNavigationId,this.#t.Meta.navigationsByFrameId))}}return{title:t,formattedTime:O(e.dur)}}}var Lr=Object.freeze({__proto__:null,TimingsTrackAppender:Fr});const Rr=["Animations","Timings","Interactions","GPU","LayoutShifts","Thread","Thread_AuctionWorklet","Extension"];class Dr{#hi=new Map;#mi=new Map;#pi=new Map;#ui=new Map;#Se;#t;#gi;#M;#vi=[];#Ti=new Set([...Rr]);#fi;#yi;#wi;#bi;#Si;#Ci;#Ei=[];constructor(e,i,n,a){this.#Se=e,this.#t=i,this.#gi=n,this.#M=new r.Color.Generator({min:30,max:55,count:void 0},{min:70,max:100,count:6},50,.7),this.#fi=a,this.#yi=new Fr(this,this.#t,this.#M),this.#vi.push(this.#yi),this.#bi=new mt(this,this.#t,this.#M),this.#vi.push(this.#bi),this.#wi=new $(this,this.#t),this.#vi.push(this.#wi),this.#Si=new yr(this,this.#t),this.#vi.push(this.#Si),this.#Ci=new kr(this,this.#t),this.#vi.push(this.#Ci),this.#ki(),this.#xi(),t.ThemeSupport.instance().addEventListener(t.ThemeChangeEvent.eventName,(()=>{for(const e of this.#Se.groups)e.style.color=t.ThemeSupport.instance().getComputedValue("--sys-color-on-surface"),e.style.backgroundColor=t.ThemeSupport.instance().getComputedValue("--sys-color-cdt-base-container")}))}setFlameChartDataAndEntryData(e,t,i){this.#mi.clear(),this.#Se=e,this.#gi=t,this.#fi=i}getFlameChartTimelineData(){return this.#Se}#xi(){const e=cr.instance().getExtensionData().extensionTrackData;for(const t of e)this.#vi.push(new ur(this,t))}#ki(){const e=e=>{switch(e.threadType){case"MAIN_THREAD":if(e.isOnMainFrame){const t=e.getUrl();return t.startsWith("about:")||t.startsWith("chrome:")?2:0}return 1;case"WORKER":return 3;case"RASTERIZER":return 4;case"THREAD_POOL":return 5;case"AUCTION_WORKLET":return 6;case"OTHER":return 7;default:return 8}},t=i.Handlers.Threads.threadsInTrace(this.#t),n=new Set,r=a.Runtime.experiments.isEnabled("timeline-show-all-events");for(const{pid:e,tid:i,name:a,type:s}of t){if(this.#t.Meta.traceIsGeneric){this.#Ei.push(new Ei(this,this.#t,e,i,a,"OTHER"));continue}if(("Chrome_ChildIOThread"===a||"Compositor"===a||"GpuMemoryThread"===a)&&!r)continue;const t=this.#t.AuctionWorklets.worklets.get(e);n.has(e)||(t?(n.add(e),this.#Ei.push(new Ei(this,this.#t,e,t.args.data.utilityThread.tid,"auction-worket-utility","AUCTION_WORKLET")),this.#Ei.push(new Ei(this,this.#t,e,t.args.data.v8HelperThread.tid,"auction-worklet-v8helper","AUCTION_WORKLET"))):this.#Ei.push(new Ei(this,this.#t,e,i,a,s)))}this.#Ei.sort(((t,i)=>e(t)-e(i)||i.getEntries().length-t.getEntries().length)),this.#vi.push(...this.#Ei)}timingsTrackAppender(){return this.#yi}animationsTrackAppender(){return this.#wi}interactionsTrackAppender(){return this.#bi}gpuTrackAppender(){return this.#Si}layoutShiftsTrackAppender(){return this.#Ci}threadAppenders(){return this.#Ei}eventsInTrack(e){const t=this.#pi.get(e);if(t)return t;let i=null,n=null;for(const[t,r]of this.#hi)r===e&&(null===i&&(i=t),n=t);if(null===i||null===n)throw new Error(`Could not find events for track: ${e}`);const r=this.#Se.entryLevels,a=[];for(let e=0;e<r.length;e++)i<=r[e]&&r[e]<=n&&a.push(this.#gi[e]);return a.sort(((e,t)=>e.ts-t.ts)),this.#pi.set(e,a),a}eventsForTreeView(e){const t=this.#ui.get(e);if(t)return t;let n=this.eventsInTrack(e);return i.Helpers.TreeHelpers.canBuildTreesFromEvents(n)||(n=n.filter((e=>!i.Types.TraceEvents.isAsyncPhase(e.ph)))),this.#ui.set(e,n),n}registerTrackForGroup(e,t){this.#Se.groups.push(e),this.#mi.set(e,t)}getCurrentTrackCountForThreadType(e){return this.#Ei.filter((t=>t.threadType===e&&t.headerAppended())).length}groupForAppender(e){let t=null;for(const[i,n]of this.#mi)if(n===e){t=i;break}return t}groupEventsForTreeView(e){const t=this.#mi.get(e);return t?this.eventsForTreeView(t):null}registerTrackForLevel(e,t){this.#hi.set(e,t)}appendEventAtLevel(e,t,n){this.#hi.set(t,n);const r=this.#gi.length;this.#gi.push(e),this.#fi[t]="TrackAppender",this.#Se.entryLevels[r]=t,this.#Se.entryStartTimes[r]=i.Helpers.Timing.microSecondsToMilliseconds(e.ts);const a=e.dur||i.Helpers.Timing.millisecondsToMicroseconds(Li);return this.#Se.entryTotalTimes[r]=i.Helpers.Timing.microSecondsToMilliseconds(a),r}appendEventsAtLevel(e,t,i,n){const r=[];for(let a=0;a<e.length;++a){const s=e[a];if(!this.entryIsVisibleInTimeline(s))continue;const o=V(s,r),l=this.appendEventAtLevel(s,t+o,i);n?.(s,l)}return this.#fi.length=t+r.length,this.#fi.fill("TrackAppender",t),t+r.length}entryIsVisibleInTimeline(e){if(this.#t.Meta.traceIsGeneric)return!0;if(i.Types.TraceEvents.isTraceEventUpdateCounters(e))return!0;if(i.Types.TraceEvents.isTraceEventSchedulePostMessage(e)||i.Types.TraceEvents.isTraceEventHandlePostMessage(e))return a.Runtime.experiments.isEnabled("timeline-show-postmessage-events");if(i.Types.Extensions.isSyntheticExtensionEntry(e))return!0;const t=de(e.name),n=i.Types.TraceEvents.isTraceEventConsoleTime(e)||i.Types.TraceEvents.isTraceEventPerformanceMeasure(e)||i.Types.TraceEvents.isTraceEventPerformanceMark(e);return t&&!t.hidden||n}allVisibleTrackAppenders(){return this.#vi.filter((e=>this.#Ti.has(e.appenderName)))}allThreadAppendersByProcess(){const e=this.allVisibleTrackAppenders(),t=new Map;for(const i of e){if(!(i instanceof Ei))continue;const e=t.get(i.processId())??[];e.push(i),t.set(i.processId(),e)}return t}setVisibleTracks(e){this.#Ti=e||new Set([...Rr])}colorForEvent(e,t){const i=this.#hi.get(t);if(!i)throw new Error("Track not found for level");return i.colorForEvent(e)}titleForEvent(e,t){const i=this.#hi.get(t);if(!i)throw new Error("Track not found for level");return i.titleForEvent(e)}highlightedEntryInfo(e,t){const i=this.#hi.get(t);if(!i)throw new Error("Track not found for level");const n=s.DetailsView.buildWarningElementsForEvent(e,this.#t),{title:r,formattedTime:a,warningElements:o}=i.highlightedEntryInfo(e);return{title:r,formattedTime:a,warningElements:n.concat(o||[])}}}var Ar=Object.freeze({__proto__:null,TrackNames:Rr,CompatibilityTracksAppender:Dr});export{J as AnimationsTrackAppender,z as AppenderUtils,Y as BenchmarkEvents,ee as CLSLinkifier,Ar as CompatibilityTracksAppender,nt as CountersGraph,ye as EventUICategory,Le as EventsSerializer,Qt as EventsTimelineTreeView,dr as ExtensionDataGatherer,gr as ExtensionTrackAppender,Ee as FreshRecording,wr as GPUTrackAppender,wi as Initiators,ut as InteractionsTrackAppender,xr as LayoutShiftsTrackAppender,Be as ModificationsManager,Oi as NetworkTrackAppender,Oe as SaveFileFormatter,Ge as SourceMapsResolver,at as TargetForEvent,ki as ThreadAppender,Ke as TimelineController,gi as TimelineDetailsView,mn as TimelineEventOverview,Nt as TimelineFilters,Di as TimelineFlameChartDataProvider,_i as TimelineFlameChartNetworkDataProvider,Zi as TimelineFlameChartView,Cn as TimelineHistoryManager,ti as TimelineLayersView,Rn as TimelineLoader,Un as TimelineMiniMap,ai as TimelinePaintProfilerView,or as TimelinePanel,Tt as TimelineSelection,$t as TimelineTreeView,Lt as TimelineUIUtils,Lr as TimingsTrackAppender,Yn as UIDevtoolsController,Jn as UIDevtoolsUtils};
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
