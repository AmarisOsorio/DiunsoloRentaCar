/*
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

#pragma once

#include <react/renderer/components/root/RootShadowNode.h>
<<<<<<< HEAD
#include <react/renderer/core/ShadowNodeFamily.h>
=======
#include <react/renderer/core/ShadowNode.h>
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
#include <react/renderer/graphics/Float.h>
#include <react/renderer/graphics/Rect.h>
#include <memory>
#include "IntersectionObserverState.h"

namespace facebook::react {

using IntersectionObserverObserverId = int32_t;

struct IntersectionObserverEntry {
  IntersectionObserverObserverId intersectionObserverId;
<<<<<<< HEAD
  ShadowNodeFamily::Shared shadowNodeFamily;
=======
  ShadowNode::Shared shadowNode;
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
  Rect targetRect;
  Rect rootRect;
  Rect intersectionRect;
  bool isIntersectingAboveThresholds;
<<<<<<< HEAD
  HighResTimeStamp time;

  bool sameShadowNodeFamily(
      const ShadowNodeFamily& otherShadowNodeFamily) const {
    return std::addressof(*shadowNodeFamily) ==
        std::addressof(otherShadowNodeFamily);
  }
=======
  // TODO(T156529385) Define `DOMHighResTimeStamp` as an alias for `double` and
  // use it here.
  double time;
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
};

class IntersectionObserver {
 public:
  IntersectionObserver(
      IntersectionObserverObserverId intersectionObserverId,
<<<<<<< HEAD
      std::optional<ShadowNodeFamily::Shared> observationRootShadowNodeFamily,
      ShadowNodeFamily::Shared targetShadowNodeFamily,
=======
      ShadowNode::Shared targetShadowNode,
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
      std::vector<Float> thresholds,
      std::optional<std::vector<Float>> rootThresholds = std::nullopt);

  // Partially equivalent to
  // https://w3c.github.io/IntersectionObserver/#update-intersection-observations-algo
  std::optional<IntersectionObserverEntry> updateIntersectionObservation(
      const RootShadowNode& rootShadowNode,
<<<<<<< HEAD
      HighResTimeStamp time);

  std::optional<IntersectionObserverEntry>
  updateIntersectionObservationForSurfaceUnmount(HighResTimeStamp time);
=======
      double time);

  std::optional<IntersectionObserverEntry>
  updateIntersectionObservationForSurfaceUnmount(double time);
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767

  IntersectionObserverObserverId getIntersectionObserverId() const {
    return intersectionObserverId_;
  }

<<<<<<< HEAD
  ShadowNodeFamily::Shared getTargetShadowNodeFamily() const {
    return targetShadowNodeFamily_;
=======
  const ShadowNode& getTargetShadowNode() const {
    return *targetShadowNode_;
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
  }

  std::vector<Float> getThresholds() const {
    return thresholds_;
  }

 private:
  std::optional<IntersectionObserverEntry> setIntersectingState(
      const Rect& rootBoundingRect,
      const Rect& targetBoundingRect,
      const Rect& intersectionRect,
      Float threshold,
      Float rootThreshold,
<<<<<<< HEAD
      HighResTimeStamp time);
=======
      double time);
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767

  std::optional<IntersectionObserverEntry> setNotIntersectingState(
      const Rect& rootBoundingRect,
      const Rect& targetBoundingRect,
      const Rect& intersectionRect,
<<<<<<< HEAD
      HighResTimeStamp time);

  IntersectionObserverObserverId intersectionObserverId_;
  std::optional<ShadowNodeFamily::Shared> observationRootShadowNodeFamily_;
  ShadowNodeFamily::Shared targetShadowNodeFamily_;
=======
      double time);

  IntersectionObserverObserverId intersectionObserverId_;
  ShadowNode::Shared targetShadowNode_;
>>>>>>> 2c830f7d0232ead70791aff6968a0e95ce850767
  std::vector<Float> thresholds_;
  std::optional<std::vector<Float>> rootThresholds_;
  mutable IntersectionObserverState state_ =
      IntersectionObserverState::Initial();
};

} // namespace facebook::react
